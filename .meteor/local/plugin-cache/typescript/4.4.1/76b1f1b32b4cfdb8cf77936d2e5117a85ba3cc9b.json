{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/providers/CallProvider/CallProvider.tsx","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"client/providers/CallProvider/CallProvider.tsx","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/providers/CallProvider/CallProvider.tsx","inputSourceMap":{"version":3,"file":"client/providers/CallProvider/CallProvider.tsx","sourceRoot":"","sources":["client/providers/CallProvider/CallProvider.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Random } from 'meteor/random';\nimport React, { useMemo, FC, useRef, useCallback, useEffect, useState } from 'react';\nimport { createPortal } from 'react-dom';\nimport { OutgoingByeRequest } from 'sip.js/lib/core';\n\nimport { CustomSounds } from '../../../app/custom-sounds/client';\nimport { getUserPreference } from '../../../app/utils/client';\nimport { IVoipRoom } from '../../../definition/IRoom';\nimport { IUser } from '../../../definition/IUser';\nimport { ICallerInfo } from '../../../definition/voip/ICallerInfo';\nimport { WrapUpCallModal } from '../../components/voip/modal/WrapUpCallModal';\nimport { CallContext, CallContextValue } from '../../contexts/CallContext';\nimport { useSetModal } from '../../contexts/ModalContext';\nimport { useRoute } from '../../contexts/RouterContext';\nimport { useEndpoint, useStream } from '../../contexts/ServerContext';\nimport { useSetting } from '../../contexts/SettingsContext';\nimport { useUser } from '../../contexts/UserContext';\nimport { roomCoordinator } from '../../lib/rooms/roomCoordinator';\nimport { QueueAggregator } from '../../lib/voip/QueueAggregator';\nimport { useVoipClient } from './hooks/useVoipClient';\n\nconst startRingback = (user: IUser): void => {\n\tconst audioVolume = getUserPreference(user, 'notificationsSoundVolume');\n\tCustomSounds.play('telephone', {\n\t\tvolume: Number((audioVolume / 100).toPrecision(2)),\n\t\tloop: true,\n\t});\n};\n\nconst stopRingback = (): void => {\n\tCustomSounds.pause('telephone');\n\tCustomSounds.remove('telephone');\n};\n\nexport const CallProvider: FC = ({ children }) => {\n\tconst voipEnabled = useSetting('VoIP_Enabled');\n\tconst subscribeToNotifyUser = useStream('notify-user');\n\n\tconst result = useVoipClient();\n\n\tconst user = useUser();\n\tconst homeRoute = useRoute('home');\n\n\tconst remoteAudioMediaRef = useRef<HTMLAudioElement>(null); // TODO: Create a dedicated file for the AUDIO and make the controls accessible\n\n\tconst [queueCounter, setQueueCounter] = useState(0);\n\tconst [queueName, setQueueName] = useState('');\n\n\tconst setModal = useSetModal();\n\n\tconst openWrapUpModal = useCallback((): void => {\n\t\tsetModal(<WrapUpCallModal />);\n\t}, [setModal]);\n\n\tconst [queueAggregator, setQueueAggregator] = useState<QueueAggregator>();\n\n\tuseEffect(() => {\n\t\tif (!result?.voipClient) {\n\t\t\treturn;\n\t\t}\n\n\t\tsetQueueAggregator(result.voipClient.getAggregator());\n\t}, [result]);\n\n\tuseEffect(() => {\n\t\tif (!voipEnabled || !user || !queueAggregator) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst handleAgentCalled = async (queue: {\n\t\t\tqueuename: string;\n\t\t\tcallerId: { id: string; name: string };\n\t\t\tqueuedcalls: string;\n\t\t}): Promise<void> => {\n\t\t\tqueueAggregator.callRinging({ queuename: queue.queuename, callerid: queue.callerId });\n\t\t\tsetQueueName(queueAggregator.getCurrentQueueName());\n\t\t};\n\n\t\treturn subscribeToNotifyUser(`${user._id}/agentcalled`, handleAgentCalled);\n\t}, [subscribeToNotifyUser, user, voipEnabled, queueAggregator]);\n\n\tuseEffect(() => {\n\t\tif (!voipEnabled || !user || !queueAggregator) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst handleQueueJoined = async (joiningDetails: {\n\t\t\tqueuename: string;\n\t\t\tcallerid: { id: string };\n\t\t\tqueuedcalls: string;\n\t\t}): Promise<void> => {\n\t\t\tqueueAggregator.queueJoined(joiningDetails);\n\t\t\tsetQueueCounter(queueAggregator.getCallWaitingCount());\n\t\t};\n\n\t\treturn subscribeToNotifyUser(`${user._id}/callerjoined`, handleQueueJoined);\n\t}, [subscribeToNotifyUser, user, voipEnabled, queueAggregator]);\n\n\tuseEffect(() => {\n\t\tif (!voipEnabled || !user || !queueAggregator) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst handleAgentConnected = (queue: { queuename: string; queuedcalls: string; waittimeinqueue: string }): void => {\n\t\t\tqueueAggregator.callPickedup(queue);\n\t\t\tsetQueueName(queueAggregator.getCurrentQueueName());\n\t\t\tsetQueueCounter(queueAggregator.getCallWaitingCount());\n\t\t};\n\n\t\treturn subscribeToNotifyUser(`${user._id}/agentconnected`, handleAgentConnected);\n\t}, [queueAggregator, subscribeToNotifyUser, user, voipEnabled]);\n\n\tuseEffect(() => {\n\t\tif (!voipEnabled || !user || !queueAggregator) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst handleMemberAdded = (queue: { queuename: string; queuedcalls: string }): void => {\n\t\t\tqueueAggregator.memberAdded(queue);\n\t\t\tsetQueueName(queueAggregator.getCurrentQueueName());\n\t\t\tsetQueueCounter(queueAggregator.getCallWaitingCount());\n\t\t};\n\n\t\treturn subscribeToNotifyUser(`${user._id}/queuememberadded`, handleMemberAdded);\n\t}, [queueAggregator, subscribeToNotifyUser, user, voipEnabled]);\n\n\tuseEffect(() => {\n\t\tif (!voipEnabled || !user || !queueAggregator) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst handleMemberRemoved = (queue: { queuename: string; queuedcalls: string }): void => {\n\t\t\tqueueAggregator.memberRemoved(queue);\n\t\t\tsetQueueCounter(queueAggregator.getCallWaitingCount());\n\t\t};\n\n\t\treturn subscribeToNotifyUser(`${user._id}/queuememberremoved`, handleMemberRemoved);\n\t}, [queueAggregator, subscribeToNotifyUser, user, voipEnabled]);\n\n\tuseEffect(() => {\n\t\tif (!voipEnabled || !user || !queueAggregator) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst handleCallAbandon = (queue: { queuename: string; queuedcallafterabandon: string }): void => {\n\t\t\tqueueAggregator.queueAbandoned(queue);\n\t\t\tsetQueueName(queueAggregator.getCurrentQueueName());\n\t\t\tsetQueueCounter(queueAggregator.getCallWaitingCount());\n\t\t};\n\n\t\treturn subscribeToNotifyUser(`${user._id}/callabandoned`, handleCallAbandon);\n\t}, [queueAggregator, subscribeToNotifyUser, user, voipEnabled]);\n\n\tuseEffect(() => {\n\t\tif (!voipEnabled || !user || !queueAggregator) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst handleCallHangup = (_event: { roomId: string }): void => {\n\t\t\tsetQueueName(queueAggregator.getCurrentQueueName());\n\t\t\topenWrapUpModal();\n\t\t};\n\n\t\treturn subscribeToNotifyUser(`${user._id}/call.callerhangup`, handleCallHangup);\n\t}, [openWrapUpModal, queueAggregator, subscribeToNotifyUser, user, voipEnabled]);\n\n\tuseEffect(() => {\n\t\tif (!result.voipClient) {\n\t\t\treturn;\n\t\t}\n\n\t\t/*\n\t\t * This code may need a revisit when we handle callinqueue differently.\n\t\t * Check clickup taks for more details\n\t\t * https://app.clickup.com/t/22hy1k4\n\t\t * When customer called a queue (Either using skype or using internal number), call would get established\n\t\t * customer would hear agent's voice but agent would not hear anything from customer.\n\t\t * This issue was observed on unstable. It was found to be incosistent to reproduce.\n\t\t * On some developer env, it would happen randomly. On Safari it did not happen if\n\t\t * user refreshes before taking every call.\n\t\t *\n\t\t * The reason behind this was as soon as agent accepts a call, queueCounter would change.\n\t\t * This change will trigger re-rendering of media and creation of audio element.\n\t\t * This audio element gets used by voipClient to render the remote audio.\n\t\t * Because the re-render happend, it would hold a stale reference.\n\t\t *\n\t\t * If the dom is inspected, audio element just before body is usually created by this class.\n\t\t * this audio element.srcObject contains null value. In working case, it should display\n\t\t * valid stream object.\n\t\t *\n\t\t * Reason for inconsistecies :\n\t\t * This element is utilised in VoIPUser::setupRemoteMedia\n\t\t * This function is called when webRTC receives a remote track event. i.e when the webrtc's peer connection\n\t\t * starts receiving media. This event call back depends on several factors. How does asterisk setup streams.\n\t\t * How does it creates a bridge which patches up the agent and customer (Media is flowing thru asterisk).\n\t\t * When it works in de-environment, it was observed that the audio element in dom and the audio element hold\n\t\t * by VoIPUser is different. Nonetheless, this stale audio element holds valid media stream, which is being played.\n\t\t * Hence sometimes the audio is heard.\n\t\t *\n\t\t * Ideally call component once gets stable, should not get rerendered. Queue, Room creation are the parameters\n\t\t * which should be independent and should not control the call component.\n\t\t *\n\t\t * Solution :\n\t\t * Either make the audio elemenent rendered independent of rest of the DOM.\n\t\t * or implement useEffect. This useEffect will reset the rendering elements with the latest audio tag.\n\t\t *\n\t\t * Note : If this code gets refactor, revisit the line below to check if this call is needed.\n\t\t *\n\t\t */\n\t\tremoteAudioMediaRef.current && result.voipClient.switchMediaRenderer({ remoteMediaElement: remoteAudioMediaRef.current });\n\t}, [result.voipClient]);\n\n\tconst visitorEndpoint = useEndpoint('POST', 'livechat/visitor');\n\tconst voipEndpoint = useEndpoint('GET', 'voip/room');\n\tconst voipCloseRoomEndpoint = useEndpoint('POST', 'voip/room.close');\n\n\tconst [roomInfo, setRoomInfo] = useState<{ v: { token?: string }; rid: string }>();\n\n\tconst openRoom = (rid: IVoipRoom['_id']): void => {\n\t\troomCoordinator.openRouteLink('v', { rid });\n\t};\n\n\tconst contextValue: CallContextValue = useMemo(() => {\n\t\tif (!voipEnabled) {\n\t\t\treturn {\n\t\t\t\tenabled: false,\n\t\t\t\tready: false,\n\t\t\t};\n\t\t}\n\n\t\tif (!user?.extension) {\n\t\t\treturn {\n\t\t\t\tenabled: false,\n\t\t\t\tready: false,\n\t\t\t};\n\t\t}\n\n\t\tif (result.error) {\n\t\t\treturn {\n\t\t\t\tenabled: true,\n\t\t\t\tready: false,\n\t\t\t\terror: result.error,\n\t\t\t};\n\t\t}\n\n\t\tif (!result.voipClient) {\n\t\t\treturn {\n\t\t\t\tenabled: true,\n\t\t\t\tready: false,\n\t\t\t};\n\t\t}\n\n\t\tconst { registrationInfo, voipClient } = result;\n\n\t\tvoipClient.on('incomingcall', () => user && startRingback(user));\n\t\tvoipClient.on('callestablished', () => stopRingback());\n\t\tvoipClient.on('callterminated', () => stopRingback());\n\n\t\treturn {\n\t\t\tenabled: true,\n\t\t\tready: true,\n\t\t\topenedRoomInfo: roomInfo,\n\t\t\tvoipClient,\n\t\t\tregistrationInfo,\n\t\t\tqueueCounter,\n\t\t\tqueueName,\n\t\t\tactions: {\n\t\t\t\tmute: (): Promise<void> => voipClient.muteCall(true), // voipClient.mute(),\n\t\t\t\tunmute: (): Promise<void> => voipClient.muteCall(false), // voipClient.unmute()\n\t\t\t\tpause: (): Promise<void> => voipClient.holdCall(true), // voipClient.pause()\n\t\t\t\tresume: (): Promise<void> => voipClient.holdCall(false), // voipClient.resume()\n\t\t\t\tend: (): Promise<OutgoingByeRequest | void> => voipClient.endCall(),\n\t\t\t\tpickUp: async (): Promise<void | null> =>\n\t\t\t\t\tremoteAudioMediaRef.current && voipClient.acceptCall({ remoteMediaElement: remoteAudioMediaRef.current }),\n\t\t\t\treject: (): Promise<void> => voipClient.rejectCall(),\n\t\t\t},\n\t\t\topenRoom,\n\t\t\tcreateRoom: async (caller: ICallerInfo): Promise<IVoipRoom['_id']> => {\n\t\t\t\tif (user) {\n\t\t\t\t\tconst { visitor } = await visitorEndpoint({\n\t\t\t\t\t\tvisitor: {\n\t\t\t\t\t\t\ttoken: Random.id(),\n\t\t\t\t\t\t\tphone: caller.callerId,\n\t\t\t\t\t\t\tname: caller.callerName || caller.callerId,\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t\tconst voipRoom = visitor && (await voipEndpoint({ token: visitor.token, agentId: user._id }));\n\t\t\t\t\topenRoom(voipRoom.room._id);\n\t\t\t\t\tvoipRoom.room && setRoomInfo({ v: { token: voipRoom.room.v.token }, rid: voipRoom.room._id });\n\t\t\t\t\tconst queueAggregator = voipClient.getAggregator();\n\t\t\t\t\tif (queueAggregator) {\n\t\t\t\t\t\tqueueAggregator.callStarted();\n\t\t\t\t\t}\n\t\t\t\t\treturn voipRoom.room._id;\n\t\t\t\t}\n\t\t\t\treturn '';\n\t\t\t},\n\t\t\tcloseRoom: async ({ comment, tags }: { comment: string; tags: string[] }): Promise<void> => {\n\t\t\t\troomInfo && (await voipCloseRoomEndpoint({ rid: roomInfo.rid, token: roomInfo.v.token || '', comment: comment || '', tags }));\n\t\t\t\thomeRoute.push({});\n\t\t\t\tconst queueAggregator = voipClient.getAggregator();\n\t\t\t\tif (queueAggregator) {\n\t\t\t\t\tqueueAggregator.callEnded();\n\t\t\t\t}\n\t\t\t},\n\t\t\topenWrapUpModal,\n\t\t};\n\t}, [\n\t\tvoipEnabled,\n\t\tuser,\n\t\tresult,\n\t\troomInfo,\n\t\tqueueCounter,\n\t\tqueueName,\n\t\topenWrapUpModal,\n\t\tvisitorEndpoint,\n\t\tvoipEndpoint,\n\t\tvoipCloseRoomEndpoint,\n\t\thomeRoute,\n\t]);\n\n\treturn (\n\t\t<CallContext.Provider value={contextValue}>\n\t\t\t{children}\n\t\t\t{contextValue.enabled && createPortal(<audio ref={remoteAudioMediaRef} />, document.body)}\n\t\t</CallContext.Provider>\n\t);\n};\n"]},"targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{}},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/providers/CallProvider/CallProvider.tsx","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/providers/CallProvider/CallProvider.tsx"}},"code":"var _regeneratorRuntime;\n\nmodule.link(\"@babel/runtime/regenerator\", {\n  default: function (v) {\n    _regeneratorRuntime = v;\n  }\n}, 0);\n\nvar _slicedToArray;\n\nmodule.link(\"@babel/runtime/helpers/slicedToArray\", {\n  default: function (v) {\n    _slicedToArray = v;\n  }\n}, 1);\nmodule.export({\n  CallProvider: function () {\n    return CallProvider;\n  }\n});\nvar Random;\nmodule.link(\"meteor/random\", {\n  Random: function (v) {\n    Random = v;\n  }\n}, 0);\nvar React, useMemo, useRef, useCallback, useEffect, useState;\nmodule.link(\"react\", {\n  \"default\": function (v) {\n    React = v;\n  },\n  useMemo: function (v) {\n    useMemo = v;\n  },\n  useRef: function (v) {\n    useRef = v;\n  },\n  useCallback: function (v) {\n    useCallback = v;\n  },\n  useEffect: function (v) {\n    useEffect = v;\n  },\n  useState: function (v) {\n    useState = v;\n  }\n}, 1);\nvar createPortal;\nmodule.link(\"react-dom\", {\n  createPortal: function (v) {\n    createPortal = v;\n  }\n}, 2);\nvar CustomSounds;\nmodule.link(\"../../../app/custom-sounds/client\", {\n  CustomSounds: function (v) {\n    CustomSounds = v;\n  }\n}, 3);\nvar getUserPreference;\nmodule.link(\"../../../app/utils/client\", {\n  getUserPreference: function (v) {\n    getUserPreference = v;\n  }\n}, 4);\nvar WrapUpCallModal;\nmodule.link(\"../../components/voip/modal/WrapUpCallModal\", {\n  WrapUpCallModal: function (v) {\n    WrapUpCallModal = v;\n  }\n}, 5);\nvar CallContext;\nmodule.link(\"../../contexts/CallContext\", {\n  CallContext: function (v) {\n    CallContext = v;\n  }\n}, 6);\nvar useSetModal;\nmodule.link(\"../../contexts/ModalContext\", {\n  useSetModal: function (v) {\n    useSetModal = v;\n  }\n}, 7);\nvar useRoute;\nmodule.link(\"../../contexts/RouterContext\", {\n  useRoute: function (v) {\n    useRoute = v;\n  }\n}, 8);\nvar useEndpoint, useStream;\nmodule.link(\"../../contexts/ServerContext\", {\n  useEndpoint: function (v) {\n    useEndpoint = v;\n  },\n  useStream: function (v) {\n    useStream = v;\n  }\n}, 9);\nvar useSetting;\nmodule.link(\"../../contexts/SettingsContext\", {\n  useSetting: function (v) {\n    useSetting = v;\n  }\n}, 10);\nvar useUser;\nmodule.link(\"../../contexts/UserContext\", {\n  useUser: function (v) {\n    useUser = v;\n  }\n}, 11);\nvar roomCoordinator;\nmodule.link(\"../../lib/rooms/roomCoordinator\", {\n  roomCoordinator: function (v) {\n    roomCoordinator = v;\n  }\n}, 12);\nvar useVoipClient;\nmodule.link(\"./hooks/useVoipClient\", {\n  useVoipClient: function (v) {\n    useVoipClient = v;\n  }\n}, 13);\n\nvar startRingback = function (user) {\n  var audioVolume = getUserPreference(user, 'notificationsSoundVolume');\n  CustomSounds.play('telephone', {\n    volume: Number((audioVolume / 100).toPrecision(2)),\n    loop: true\n  });\n};\n\nvar stopRingback = function () {\n  CustomSounds.pause('telephone');\n  CustomSounds.remove('telephone');\n};\n\nvar CallProvider = function (_ref) {\n  var children = _ref.children;\n  var voipEnabled = useSetting('VoIP_Enabled');\n  var subscribeToNotifyUser = useStream('notify-user');\n  var result = useVoipClient();\n  var user = useUser();\n  var homeRoute = useRoute('home');\n  var remoteAudioMediaRef = useRef(null); // TODO: Create a dedicated file for the AUDIO and make the controls accessible\n\n  var _useState = useState(0),\n      _useState2 = _slicedToArray(_useState, 2),\n      queueCounter = _useState2[0],\n      setQueueCounter = _useState2[1];\n\n  var _useState3 = useState(''),\n      _useState4 = _slicedToArray(_useState3, 2),\n      queueName = _useState4[0],\n      setQueueName = _useState4[1];\n\n  var setModal = useSetModal();\n  var openWrapUpModal = useCallback(function () {\n    setModal( /*#__PURE__*/React.createElement(WrapUpCallModal, null));\n  }, [setModal]);\n\n  var _useState5 = useState(),\n      _useState6 = _slicedToArray(_useState5, 2),\n      queueAggregator = _useState6[0],\n      setQueueAggregator = _useState6[1];\n\n  useEffect(function () {\n    if (!(result !== null && result !== void 0 && result.voipClient)) {\n      return;\n    }\n\n    setQueueAggregator(result.voipClient.getAggregator());\n  }, [result]);\n  useEffect(function () {\n    if (!voipEnabled || !user || !queueAggregator) {\n      return;\n    }\n\n    var handleAgentCalled = function () {\n      function _callee(queue) {\n        return _regeneratorRuntime.async(function () {\n          function _callee$(_context) {\n            while (1) {\n              switch (_context.prev = _context.next) {\n                case 0:\n                  queueAggregator.callRinging({\n                    queuename: queue.queuename,\n                    callerid: queue.callerId\n                  });\n                  setQueueName(queueAggregator.getCurrentQueueName());\n\n                case 2:\n                case \"end\":\n                  return _context.stop();\n              }\n            }\n          }\n\n          return _callee$;\n        }(), null, null, null, Promise);\n      }\n\n      return _callee;\n    }();\n\n    return subscribeToNotifyUser(user._id + \"/agentcalled\", handleAgentCalled);\n  }, [subscribeToNotifyUser, user, voipEnabled, queueAggregator]);\n  useEffect(function () {\n    if (!voipEnabled || !user || !queueAggregator) {\n      return;\n    }\n\n    var handleQueueJoined = function () {\n      function _callee2(joiningDetails) {\n        return _regeneratorRuntime.async(function () {\n          function _callee2$(_context2) {\n            while (1) {\n              switch (_context2.prev = _context2.next) {\n                case 0:\n                  queueAggregator.queueJoined(joiningDetails);\n                  setQueueCounter(queueAggregator.getCallWaitingCount());\n\n                case 2:\n                case \"end\":\n                  return _context2.stop();\n              }\n            }\n          }\n\n          return _callee2$;\n        }(), null, null, null, Promise);\n      }\n\n      return _callee2;\n    }();\n\n    return subscribeToNotifyUser(user._id + \"/callerjoined\", handleQueueJoined);\n  }, [subscribeToNotifyUser, user, voipEnabled, queueAggregator]);\n  useEffect(function () {\n    if (!voipEnabled || !user || !queueAggregator) {\n      return;\n    }\n\n    var handleAgentConnected = function (queue) {\n      queueAggregator.callPickedup(queue);\n      setQueueName(queueAggregator.getCurrentQueueName());\n      setQueueCounter(queueAggregator.getCallWaitingCount());\n    };\n\n    return subscribeToNotifyUser(user._id + \"/agentconnected\", handleAgentConnected);\n  }, [queueAggregator, subscribeToNotifyUser, user, voipEnabled]);\n  useEffect(function () {\n    if (!voipEnabled || !user || !queueAggregator) {\n      return;\n    }\n\n    var handleMemberAdded = function (queue) {\n      queueAggregator.memberAdded(queue);\n      setQueueName(queueAggregator.getCurrentQueueName());\n      setQueueCounter(queueAggregator.getCallWaitingCount());\n    };\n\n    return subscribeToNotifyUser(user._id + \"/queuememberadded\", handleMemberAdded);\n  }, [queueAggregator, subscribeToNotifyUser, user, voipEnabled]);\n  useEffect(function () {\n    if (!voipEnabled || !user || !queueAggregator) {\n      return;\n    }\n\n    var handleMemberRemoved = function (queue) {\n      queueAggregator.memberRemoved(queue);\n      setQueueCounter(queueAggregator.getCallWaitingCount());\n    };\n\n    return subscribeToNotifyUser(user._id + \"/queuememberremoved\", handleMemberRemoved);\n  }, [queueAggregator, subscribeToNotifyUser, user, voipEnabled]);\n  useEffect(function () {\n    if (!voipEnabled || !user || !queueAggregator) {\n      return;\n    }\n\n    var handleCallAbandon = function (queue) {\n      queueAggregator.queueAbandoned(queue);\n      setQueueName(queueAggregator.getCurrentQueueName());\n      setQueueCounter(queueAggregator.getCallWaitingCount());\n    };\n\n    return subscribeToNotifyUser(user._id + \"/callabandoned\", handleCallAbandon);\n  }, [queueAggregator, subscribeToNotifyUser, user, voipEnabled]);\n  useEffect(function () {\n    if (!voipEnabled || !user || !queueAggregator) {\n      return;\n    }\n\n    var handleCallHangup = function (_event) {\n      setQueueName(queueAggregator.getCurrentQueueName());\n      openWrapUpModal();\n    };\n\n    return subscribeToNotifyUser(user._id + \"/call.callerhangup\", handleCallHangup);\n  }, [openWrapUpModal, queueAggregator, subscribeToNotifyUser, user, voipEnabled]);\n  useEffect(function () {\n    if (!result.voipClient) {\n      return;\n    }\n    /*\n     * This code may need a revisit when we handle callinqueue differently.\n     * Check clickup taks for more details\n     * https://app.clickup.com/t/22hy1k4\n     * When customer called a queue (Either using skype or using internal number), call would get established\n     * customer would hear agent's voice but agent would not hear anything from customer.\n     * This issue was observed on unstable. It was found to be incosistent to reproduce.\n     * On some developer env, it would happen randomly. On Safari it did not happen if\n     * user refreshes before taking every call.\n     *\n     * The reason behind this was as soon as agent accepts a call, queueCounter would change.\n     * This change will trigger re-rendering of media and creation of audio element.\n     * This audio element gets used by voipClient to render the remote audio.\n     * Because the re-render happend, it would hold a stale reference.\n     *\n     * If the dom is inspected, audio element just before body is usually created by this class.\n     * this audio element.srcObject contains null value. In working case, it should display\n     * valid stream object.\n     *\n     * Reason for inconsistecies :\n     * This element is utilised in VoIPUser::setupRemoteMedia\n     * This function is called when webRTC receives a remote track event. i.e when the webrtc's peer connection\n     * starts receiving media. This event call back depends on several factors. How does asterisk setup streams.\n     * How does it creates a bridge which patches up the agent and customer (Media is flowing thru asterisk).\n     * When it works in de-environment, it was observed that the audio element in dom and the audio element hold\n     * by VoIPUser is different. Nonetheless, this stale audio element holds valid media stream, which is being played.\n     * Hence sometimes the audio is heard.\n     *\n     * Ideally call component once gets stable, should not get rerendered. Queue, Room creation are the parameters\n     * which should be independent and should not control the call component.\n     *\n     * Solution :\n     * Either make the audio elemenent rendered independent of rest of the DOM.\n     * or implement useEffect. This useEffect will reset the rendering elements with the latest audio tag.\n     *\n     * Note : If this code gets refactor, revisit the line below to check if this call is needed.\n     *\n     */\n\n\n    remoteAudioMediaRef.current && result.voipClient.switchMediaRenderer({\n      remoteMediaElement: remoteAudioMediaRef.current\n    });\n  }, [result.voipClient]);\n  var visitorEndpoint = useEndpoint('POST', 'livechat/visitor');\n  var voipEndpoint = useEndpoint('GET', 'voip/room');\n  var voipCloseRoomEndpoint = useEndpoint('POST', 'voip/room.close');\n\n  var _useState7 = useState(),\n      _useState8 = _slicedToArray(_useState7, 2),\n      roomInfo = _useState8[0],\n      setRoomInfo = _useState8[1];\n\n  var openRoom = function (rid) {\n    roomCoordinator.openRouteLink('v', {\n      rid: rid\n    });\n  };\n\n  var contextValue = useMemo(function () {\n    if (!voipEnabled) {\n      return {\n        enabled: false,\n        ready: false\n      };\n    }\n\n    if (!(user !== null && user !== void 0 && user.extension)) {\n      return {\n        enabled: false,\n        ready: false\n      };\n    }\n\n    if (result.error) {\n      return {\n        enabled: true,\n        ready: false,\n        error: result.error\n      };\n    }\n\n    if (!result.voipClient) {\n      return {\n        enabled: true,\n        ready: false\n      };\n    }\n\n    var registrationInfo = result.registrationInfo,\n        voipClient = result.voipClient;\n    voipClient.on('incomingcall', function () {\n      return user && startRingback(user);\n    });\n    voipClient.on('callestablished', function () {\n      return stopRingback();\n    });\n    voipClient.on('callterminated', function () {\n      return stopRingback();\n    });\n    return {\n      enabled: true,\n      ready: true,\n      openedRoomInfo: roomInfo,\n      voipClient: voipClient,\n      registrationInfo: registrationInfo,\n      queueCounter: queueCounter,\n      queueName: queueName,\n      actions: {\n        mute: function () {\n          return voipClient.muteCall(true);\n        },\n        unmute: function () {\n          return voipClient.muteCall(false);\n        },\n        pause: function () {\n          return voipClient.holdCall(true);\n        },\n        resume: function () {\n          return voipClient.holdCall(false);\n        },\n        end: function () {\n          return voipClient.endCall();\n        },\n        pickUp: function () {\n          function _callee3() {\n            return _regeneratorRuntime.async(function () {\n              function _callee3$(_context3) {\n                while (1) {\n                  switch (_context3.prev = _context3.next) {\n                    case 0:\n                      return _context3.abrupt(\"return\", remoteAudioMediaRef.current && voipClient.acceptCall({\n                        remoteMediaElement: remoteAudioMediaRef.current\n                      }));\n\n                    case 1:\n                    case \"end\":\n                      return _context3.stop();\n                  }\n                }\n              }\n\n              return _callee3$;\n            }(), null, null, null, Promise);\n          }\n\n          return _callee3;\n        }(),\n        reject: function () {\n          return voipClient.rejectCall();\n        }\n      },\n      openRoom: openRoom,\n      createRoom: function () {\n        function _callee4(caller) {\n          var _await$visitorEndpoin, visitor, voipRoom, _queueAggregator;\n\n          return _regeneratorRuntime.async(function () {\n            function _callee4$(_context4) {\n              while (1) {\n                switch (_context4.prev = _context4.next) {\n                  case 0:\n                    if (!user) {\n                      _context4.next = 16;\n                      break;\n                    }\n\n                    _context4.next = 3;\n                    return _regeneratorRuntime.awrap(visitorEndpoint({\n                      visitor: {\n                        token: Random.id(),\n                        phone: caller.callerId,\n                        name: caller.callerName || caller.callerId\n                      }\n                    }));\n\n                  case 3:\n                    _await$visitorEndpoin = _context4.sent;\n                    visitor = _await$visitorEndpoin.visitor;\n                    _context4.t0 = visitor;\n\n                    if (!_context4.t0) {\n                      _context4.next = 10;\n                      break;\n                    }\n\n                    _context4.next = 9;\n                    return _regeneratorRuntime.awrap(voipEndpoint({\n                      token: visitor.token,\n                      agentId: user._id\n                    }));\n\n                  case 9:\n                    _context4.t0 = _context4.sent;\n\n                  case 10:\n                    voipRoom = _context4.t0;\n                    openRoom(voipRoom.room._id);\n                    voipRoom.room && setRoomInfo({\n                      v: {\n                        token: voipRoom.room.v.token\n                      },\n                      rid: voipRoom.room._id\n                    });\n                    _queueAggregator = voipClient.getAggregator();\n\n                    if (_queueAggregator) {\n                      _queueAggregator.callStarted();\n                    }\n\n                    return _context4.abrupt(\"return\", voipRoom.room._id);\n\n                  case 16:\n                    return _context4.abrupt(\"return\", '');\n\n                  case 17:\n                  case \"end\":\n                    return _context4.stop();\n                }\n              }\n            }\n\n            return _callee4$;\n          }(), null, null, null, Promise);\n        }\n\n        return _callee4;\n      }(),\n      closeRoom: function () {\n        function _callee5(_ref2) {\n          var comment, tags, queueAggregator;\n          return _regeneratorRuntime.async(function () {\n            function _callee5$(_context5) {\n              while (1) {\n                switch (_context5.prev = _context5.next) {\n                  case 0:\n                    comment = _ref2.comment, tags = _ref2.tags;\n                    _context5.t0 = roomInfo;\n\n                    if (!_context5.t0) {\n                      _context5.next = 5;\n                      break;\n                    }\n\n                    _context5.next = 5;\n                    return _regeneratorRuntime.awrap(voipCloseRoomEndpoint({\n                      rid: roomInfo.rid,\n                      token: roomInfo.v.token || '',\n                      comment: comment || '',\n                      tags: tags\n                    }));\n\n                  case 5:\n                    homeRoute.push({});\n                    queueAggregator = voipClient.getAggregator();\n\n                    if (queueAggregator) {\n                      queueAggregator.callEnded();\n                    }\n\n                  case 8:\n                  case \"end\":\n                    return _context5.stop();\n                }\n              }\n            }\n\n            return _callee5$;\n          }(), null, null, null, Promise);\n        }\n\n        return _callee5;\n      }(),\n      openWrapUpModal: openWrapUpModal\n    };\n  }, [voipEnabled, user, result, roomInfo, queueCounter, queueName, openWrapUpModal, visitorEndpoint, voipEndpoint, voipCloseRoomEndpoint, homeRoute]);\n  return /*#__PURE__*/React.createElement(CallContext.Provider, {\n    value: contextValue\n  }, children, contextValue.enabled && /*#__PURE__*/createPortal( /*#__PURE__*/React.createElement(\"audio\", {\n    ref: remoteAudioMediaRef\n  }), document.body));\n};","map":{"version":3,"sources":["client/providers/CallProvider/CallProvider.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Random } from 'meteor/random';\nimport React, { useMemo, FC, useRef, useCallback, useEffect, useState } from 'react';\nimport { createPortal } from 'react-dom';\nimport { OutgoingByeRequest } from 'sip.js/lib/core';\n\nimport { CustomSounds } from '../../../app/custom-sounds/client';\nimport { getUserPreference } from '../../../app/utils/client';\nimport { IVoipRoom } from '../../../definition/IRoom';\nimport { IUser } from '../../../definition/IUser';\nimport { ICallerInfo } from '../../../definition/voip/ICallerInfo';\nimport { WrapUpCallModal } from '../../components/voip/modal/WrapUpCallModal';\nimport { CallContext, CallContextValue } from '../../contexts/CallContext';\nimport { useSetModal } from '../../contexts/ModalContext';\nimport { useRoute } from '../../contexts/RouterContext';\nimport { useEndpoint, useStream } from '../../contexts/ServerContext';\nimport { useSetting } from '../../contexts/SettingsContext';\nimport { useUser } from '../../contexts/UserContext';\nimport { roomCoordinator } from '../../lib/rooms/roomCoordinator';\nimport { QueueAggregator } from '../../lib/voip/QueueAggregator';\nimport { useVoipClient } from './hooks/useVoipClient';\n\nconst startRingback = (user: IUser): void => {\n\tconst audioVolume = getUserPreference(user, 'notificationsSoundVolume');\n\tCustomSounds.play('telephone', {\n\t\tvolume: Number((audioVolume / 100).toPrecision(2)),\n\t\tloop: true,\n\t});\n};\n\nconst stopRingback = (): void => {\n\tCustomSounds.pause('telephone');\n\tCustomSounds.remove('telephone');\n};\n\nexport const CallProvider: FC = ({ children }) => {\n\tconst voipEnabled = useSetting('VoIP_Enabled');\n\tconst subscribeToNotifyUser = useStream('notify-user');\n\n\tconst result = useVoipClient();\n\n\tconst user = useUser();\n\tconst homeRoute = useRoute('home');\n\n\tconst remoteAudioMediaRef = useRef<HTMLAudioElement>(null); // TODO: Create a dedicated file for the AUDIO and make the controls accessible\n\n\tconst [queueCounter, setQueueCounter] = useState(0);\n\tconst [queueName, setQueueName] = useState('');\n\n\tconst setModal = useSetModal();\n\n\tconst openWrapUpModal = useCallback((): void => {\n\t\tsetModal(<WrapUpCallModal />);\n\t}, [setModal]);\n\n\tconst [queueAggregator, setQueueAggregator] = useState<QueueAggregator>();\n\n\tuseEffect(() => {\n\t\tif (!result?.voipClient) {\n\t\t\treturn;\n\t\t}\n\n\t\tsetQueueAggregator(result.voipClient.getAggregator());\n\t}, [result]);\n\n\tuseEffect(() => {\n\t\tif (!voipEnabled || !user || !queueAggregator) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst handleAgentCalled = async (queue: {\n\t\t\tqueuename: string;\n\t\t\tcallerId: { id: string; name: string };\n\t\t\tqueuedcalls: string;\n\t\t}): Promise<void> => {\n\t\t\tqueueAggregator.callRinging({ queuename: queue.queuename, callerid: queue.callerId });\n\t\t\tsetQueueName(queueAggregator.getCurrentQueueName());\n\t\t};\n\n\t\treturn subscribeToNotifyUser(`${user._id}/agentcalled`, handleAgentCalled);\n\t}, [subscribeToNotifyUser, user, voipEnabled, queueAggregator]);\n\n\tuseEffect(() => {\n\t\tif (!voipEnabled || !user || !queueAggregator) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst handleQueueJoined = async (joiningDetails: {\n\t\t\tqueuename: string;\n\t\t\tcallerid: { id: string };\n\t\t\tqueuedcalls: string;\n\t\t}): Promise<void> => {\n\t\t\tqueueAggregator.queueJoined(joiningDetails);\n\t\t\tsetQueueCounter(queueAggregator.getCallWaitingCount());\n\t\t};\n\n\t\treturn subscribeToNotifyUser(`${user._id}/callerjoined`, handleQueueJoined);\n\t}, [subscribeToNotifyUser, user, voipEnabled, queueAggregator]);\n\n\tuseEffect(() => {\n\t\tif (!voipEnabled || !user || !queueAggregator) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst handleAgentConnected = (queue: { queuename: string; queuedcalls: string; waittimeinqueue: string }): void => {\n\t\t\tqueueAggregator.callPickedup(queue);\n\t\t\tsetQueueName(queueAggregator.getCurrentQueueName());\n\t\t\tsetQueueCounter(queueAggregator.getCallWaitingCount());\n\t\t};\n\n\t\treturn subscribeToNotifyUser(`${user._id}/agentconnected`, handleAgentConnected);\n\t}, [queueAggregator, subscribeToNotifyUser, user, voipEnabled]);\n\n\tuseEffect(() => {\n\t\tif (!voipEnabled || !user || !queueAggregator) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst handleMemberAdded = (queue: { queuename: string; queuedcalls: string }): void => {\n\t\t\tqueueAggregator.memberAdded(queue);\n\t\t\tsetQueueName(queueAggregator.getCurrentQueueName());\n\t\t\tsetQueueCounter(queueAggregator.getCallWaitingCount());\n\t\t};\n\n\t\treturn subscribeToNotifyUser(`${user._id}/queuememberadded`, handleMemberAdded);\n\t}, [queueAggregator, subscribeToNotifyUser, user, voipEnabled]);\n\n\tuseEffect(() => {\n\t\tif (!voipEnabled || !user || !queueAggregator) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst handleMemberRemoved = (queue: { queuename: string; queuedcalls: string }): void => {\n\t\t\tqueueAggregator.memberRemoved(queue);\n\t\t\tsetQueueCounter(queueAggregator.getCallWaitingCount());\n\t\t};\n\n\t\treturn subscribeToNotifyUser(`${user._id}/queuememberremoved`, handleMemberRemoved);\n\t}, [queueAggregator, subscribeToNotifyUser, user, voipEnabled]);\n\n\tuseEffect(() => {\n\t\tif (!voipEnabled || !user || !queueAggregator) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst handleCallAbandon = (queue: { queuename: string; queuedcallafterabandon: string }): void => {\n\t\t\tqueueAggregator.queueAbandoned(queue);\n\t\t\tsetQueueName(queueAggregator.getCurrentQueueName());\n\t\t\tsetQueueCounter(queueAggregator.getCallWaitingCount());\n\t\t};\n\n\t\treturn subscribeToNotifyUser(`${user._id}/callabandoned`, handleCallAbandon);\n\t}, [queueAggregator, subscribeToNotifyUser, user, voipEnabled]);\n\n\tuseEffect(() => {\n\t\tif (!voipEnabled || !user || !queueAggregator) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst handleCallHangup = (_event: { roomId: string }): void => {\n\t\t\tsetQueueName(queueAggregator.getCurrentQueueName());\n\t\t\topenWrapUpModal();\n\t\t};\n\n\t\treturn subscribeToNotifyUser(`${user._id}/call.callerhangup`, handleCallHangup);\n\t}, [openWrapUpModal, queueAggregator, subscribeToNotifyUser, user, voipEnabled]);\n\n\tuseEffect(() => {\n\t\tif (!result.voipClient) {\n\t\t\treturn;\n\t\t}\n\n\t\t/*\n\t\t * This code may need a revisit when we handle callinqueue differently.\n\t\t * Check clickup taks for more details\n\t\t * https://app.clickup.com/t/22hy1k4\n\t\t * When customer called a queue (Either using skype or using internal number), call would get established\n\t\t * customer would hear agent's voice but agent would not hear anything from customer.\n\t\t * This issue was observed on unstable. It was found to be incosistent to reproduce.\n\t\t * On some developer env, it would happen randomly. On Safari it did not happen if\n\t\t * user refreshes before taking every call.\n\t\t *\n\t\t * The reason behind this was as soon as agent accepts a call, queueCounter would change.\n\t\t * This change will trigger re-rendering of media and creation of audio element.\n\t\t * This audio element gets used by voipClient to render the remote audio.\n\t\t * Because the re-render happend, it would hold a stale reference.\n\t\t *\n\t\t * If the dom is inspected, audio element just before body is usually created by this class.\n\t\t * this audio element.srcObject contains null value. In working case, it should display\n\t\t * valid stream object.\n\t\t *\n\t\t * Reason for inconsistecies :\n\t\t * This element is utilised in VoIPUser::setupRemoteMedia\n\t\t * This function is called when webRTC receives a remote track event. i.e when the webrtc's peer connection\n\t\t * starts receiving media. This event call back depends on several factors. How does asterisk setup streams.\n\t\t * How does it creates a bridge which patches up the agent and customer (Media is flowing thru asterisk).\n\t\t * When it works in de-environment, it was observed that the audio element in dom and the audio element hold\n\t\t * by VoIPUser is different. Nonetheless, this stale audio element holds valid media stream, which is being played.\n\t\t * Hence sometimes the audio is heard.\n\t\t *\n\t\t * Ideally call component once gets stable, should not get rerendered. Queue, Room creation are the parameters\n\t\t * which should be independent and should not control the call component.\n\t\t *\n\t\t * Solution :\n\t\t * Either make the audio elemenent rendered independent of rest of the DOM.\n\t\t * or implement useEffect. This useEffect will reset the rendering elements with the latest audio tag.\n\t\t *\n\t\t * Note : If this code gets refactor, revisit the line below to check if this call is needed.\n\t\t *\n\t\t */\n\t\tremoteAudioMediaRef.current && result.voipClient.switchMediaRenderer({ remoteMediaElement: remoteAudioMediaRef.current });\n\t}, [result.voipClient]);\n\n\tconst visitorEndpoint = useEndpoint('POST', 'livechat/visitor');\n\tconst voipEndpoint = useEndpoint('GET', 'voip/room');\n\tconst voipCloseRoomEndpoint = useEndpoint('POST', 'voip/room.close');\n\n\tconst [roomInfo, setRoomInfo] = useState<{ v: { token?: string }; rid: string }>();\n\n\tconst openRoom = (rid: IVoipRoom['_id']): void => {\n\t\troomCoordinator.openRouteLink('v', { rid });\n\t};\n\n\tconst contextValue: CallContextValue = useMemo(() => {\n\t\tif (!voipEnabled) {\n\t\t\treturn {\n\t\t\t\tenabled: false,\n\t\t\t\tready: false,\n\t\t\t};\n\t\t}\n\n\t\tif (!user?.extension) {\n\t\t\treturn {\n\t\t\t\tenabled: false,\n\t\t\t\tready: false,\n\t\t\t};\n\t\t}\n\n\t\tif (result.error) {\n\t\t\treturn {\n\t\t\t\tenabled: true,\n\t\t\t\tready: false,\n\t\t\t\terror: result.error,\n\t\t\t};\n\t\t}\n\n\t\tif (!result.voipClient) {\n\t\t\treturn {\n\t\t\t\tenabled: true,\n\t\t\t\tready: false,\n\t\t\t};\n\t\t}\n\n\t\tconst { registrationInfo, voipClient } = result;\n\n\t\tvoipClient.on('incomingcall', () => user && startRingback(user));\n\t\tvoipClient.on('callestablished', () => stopRingback());\n\t\tvoipClient.on('callterminated', () => stopRingback());\n\n\t\treturn {\n\t\t\tenabled: true,\n\t\t\tready: true,\n\t\t\topenedRoomInfo: roomInfo,\n\t\t\tvoipClient,\n\t\t\tregistrationInfo,\n\t\t\tqueueCounter,\n\t\t\tqueueName,\n\t\t\tactions: {\n\t\t\t\tmute: (): Promise<void> => voipClient.muteCall(true), // voipClient.mute(),\n\t\t\t\tunmute: (): Promise<void> => voipClient.muteCall(false), // voipClient.unmute()\n\t\t\t\tpause: (): Promise<void> => voipClient.holdCall(true), // voipClient.pause()\n\t\t\t\tresume: (): Promise<void> => voipClient.holdCall(false), // voipClient.resume()\n\t\t\t\tend: (): Promise<OutgoingByeRequest | void> => voipClient.endCall(),\n\t\t\t\tpickUp: async (): Promise<void | null> =>\n\t\t\t\t\tremoteAudioMediaRef.current && voipClient.acceptCall({ remoteMediaElement: remoteAudioMediaRef.current }),\n\t\t\t\treject: (): Promise<void> => voipClient.rejectCall(),\n\t\t\t},\n\t\t\topenRoom,\n\t\t\tcreateRoom: async (caller: ICallerInfo): Promise<IVoipRoom['_id']> => {\n\t\t\t\tif (user) {\n\t\t\t\t\tconst { visitor } = await visitorEndpoint({\n\t\t\t\t\t\tvisitor: {\n\t\t\t\t\t\t\ttoken: Random.id(),\n\t\t\t\t\t\t\tphone: caller.callerId,\n\t\t\t\t\t\t\tname: caller.callerName || caller.callerId,\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t\tconst voipRoom = visitor && (await voipEndpoint({ token: visitor.token, agentId: user._id }));\n\t\t\t\t\topenRoom(voipRoom.room._id);\n\t\t\t\t\tvoipRoom.room && setRoomInfo({ v: { token: voipRoom.room.v.token }, rid: voipRoom.room._id });\n\t\t\t\t\tconst queueAggregator = voipClient.getAggregator();\n\t\t\t\t\tif (queueAggregator) {\n\t\t\t\t\t\tqueueAggregator.callStarted();\n\t\t\t\t\t}\n\t\t\t\t\treturn voipRoom.room._id;\n\t\t\t\t}\n\t\t\t\treturn '';\n\t\t\t},\n\t\t\tcloseRoom: async ({ comment, tags }: { comment: string; tags: string[] }): Promise<void> => {\n\t\t\t\troomInfo && (await voipCloseRoomEndpoint({ rid: roomInfo.rid, token: roomInfo.v.token || '', comment: comment || '', tags }));\n\t\t\t\thomeRoute.push({});\n\t\t\t\tconst queueAggregator = voipClient.getAggregator();\n\t\t\t\tif (queueAggregator) {\n\t\t\t\t\tqueueAggregator.callEnded();\n\t\t\t\t}\n\t\t\t},\n\t\t\topenWrapUpModal,\n\t\t};\n\t}, [\n\t\tvoipEnabled,\n\t\tuser,\n\t\tresult,\n\t\troomInfo,\n\t\tqueueCounter,\n\t\tqueueName,\n\t\topenWrapUpModal,\n\t\tvisitorEndpoint,\n\t\tvoipEndpoint,\n\t\tvoipCloseRoomEndpoint,\n\t\thomeRoute,\n\t]);\n\n\treturn (\n\t\t<CallContext.Provider value={contextValue}>\n\t\t\t{children}\n\t\t\t{contextValue.enabled && createPortal(<audio ref={remoteAudioMediaRef} />, document.body)}\n\t\t</CallContext.Provider>\n\t);\n};\n"],"sourceRoot":""},"sourceType":"module","hash":"76b1f1b32b4cfdb8cf77936d2e5117a85ba3cc9b"}
