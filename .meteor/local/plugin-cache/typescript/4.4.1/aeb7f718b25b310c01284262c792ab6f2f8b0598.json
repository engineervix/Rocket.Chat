{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/providers/OmnichannelProvider.tsx","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"client/providers/OmnichannelProvider.tsx","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/providers/OmnichannelProvider.tsx","inputSourceMap":{"version":3,"file":"client/providers/OmnichannelProvider.tsx","sourceRoot":"","sources":["client/providers/OmnichannelProvider.tsx"],"names":[],"mappings":"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","sourcesContent":["import { useSafely } from '@rocket.chat/fuselage-hooks';\nimport React, { useState, useEffect, FC, useMemo, useCallback, memo, useRef } from 'react';\n\nimport { LivechatInquiry } from '../../app/livechat/client/collections/LivechatInquiry';\nimport { initializeLivechatInquiryStream } from '../../app/livechat/client/lib/stream/queueManager';\nimport { Notifications } from '../../app/notifications/client';\nimport { IOmnichannelAgent } from '../../definition/IOmnichannelAgent';\nimport { IRoom } from '../../definition/IRoom';\nimport { OmichannelRoutingConfig } from '../../definition/OmichannelRoutingConfig';\nimport { ClientLogger } from '../../lib/ClientLogger';\nimport { usePermission } from '../contexts/AuthorizationContext';\nimport { OmnichannelContext, OmnichannelContextValue } from '../contexts/OmnichannelContext';\nimport { useMethod } from '../contexts/ServerContext';\nimport { useSetting } from '../contexts/SettingsContext';\nimport { useUser } from '../contexts/UserContext';\nimport { useReactiveValue } from '../hooks/useReactiveValue';\n\nconst emptyContextValue: OmnichannelContextValue = {\n\tinquiries: { enabled: false },\n\tenabled: false,\n\tagentAvailable: false,\n\tshowOmnichannelQueueLink: false,\n};\n\nconst OmnichannelProvider: FC = ({ children }) => {\n\tconst omniChannelEnabled = useSetting('Livechat_enabled') as boolean;\n\tconst omnichannelRouting = useSetting('Livechat_Routing_Method');\n\tconst showOmnichannelQueueLink = useSetting('Livechat_show_queue_list_link') as boolean;\n\tconst omnichannelPoolMaxIncoming = useSetting('Livechat_guest_pool_max_number_incoming_livechats_displayed') as number;\n\n\tconst loggerRef = useRef(new ClientLogger('OmnichannelProvider'));\n\tconst hasAccess = usePermission('view-l-room');\n\tconst canViewOmnichannelQueue = usePermission('view-livechat-queue');\n\tconst user = useUser() as IOmnichannelAgent;\n\n\tconst agentAvailable = user?.statusLivechat === 'available';\n\tconst voipCallAvailable = true; // TODO: use backend check;\n\n\tconst getRoutingConfig = useMethod('livechat:getRoutingConfig');\n\n\tconst [routeConfig, setRouteConfig] = useSafely(useState<OmichannelRoutingConfig | undefined>(undefined));\n\n\tconst accessible = hasAccess && omniChannelEnabled;\n\tconst iceServersSetting: any = useSetting('WebRTC_Servers');\n\n\tuseEffect(() => {\n\t\tif (!accessible) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst update = async (): Promise<void> => {\n\t\t\ttry {\n\t\t\t\tconst routeConfig = await getRoutingConfig();\n\t\t\t\tsetRouteConfig(routeConfig);\n\t\t\t} catch (error) {\n\t\t\t\tloggerRef.current.error(`update() error in routeConfig ${error}`);\n\t\t\t}\n\t\t};\n\n\t\tif (omnichannelRouting || !omnichannelRouting) {\n\t\t\tupdate();\n\t\t}\n\t}, [accessible, getRoutingConfig, iceServersSetting, omnichannelRouting, setRouteConfig, voipCallAvailable]);\n\n\tconst enabled = accessible && !!user && !!routeConfig;\n\tconst manuallySelected =\n\t\tenabled && canViewOmnichannelQueue && !!routeConfig && routeConfig.showQueue && !routeConfig.autoAssignAgent && agentAvailable;\n\n\tuseEffect(() => {\n\t\tif (!manuallySelected) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst handleDepartmentAgentData = (): void => {\n\t\t\tinitializeLivechatInquiryStream(user?._id);\n\t\t};\n\n\t\tinitializeLivechatInquiryStream(user?._id);\n\t\tNotifications.onUser('departmentAgentData', handleDepartmentAgentData);\n\n\t\treturn (): void => {\n\t\t\tNotifications.unUser('departmentAgentData', handleDepartmentAgentData);\n\t\t};\n\t}, [manuallySelected, user?._id]);\n\n\tconst queue = useReactiveValue<IRoom[] | undefined>(\n\t\tuseCallback(() => {\n\t\t\tif (!manuallySelected) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\n\t\t\treturn LivechatInquiry.find(\n\t\t\t\t{\n\t\t\t\t\tstatus: 'queued',\n\t\t\t\t\t$or: [{ defaultAgent: { $exists: false } }, { 'defaultAgent.agentId': user?._id }],\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tsort: {\n\t\t\t\t\t\tqueueOrder: 1,\n\t\t\t\t\t\testimatedWaitingTimeQueue: 1,\n\t\t\t\t\t\testimatedServiceTimeAt: 1,\n\t\t\t\t\t},\n\t\t\t\t\tlimit: omnichannelPoolMaxIncoming,\n\t\t\t\t},\n\t\t\t).fetch();\n\t\t}, [manuallySelected, omnichannelPoolMaxIncoming, user?._id]),\n\t);\n\n\tconst contextValue = useMemo<OmnichannelContextValue>(() => {\n\t\tif (!enabled) {\n\t\t\treturn emptyContextValue;\n\t\t}\n\n\t\tif (!manuallySelected) {\n\t\t\treturn {\n\t\t\t\t...emptyContextValue,\n\t\t\t\tenabled: true,\n\t\t\t\tagentAvailable,\n\t\t\t\tvoipCallAvailable,\n\t\t\t\trouteConfig,\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\t...emptyContextValue,\n\t\t\tenabled: true,\n\t\t\tagentAvailable,\n\t\t\tvoipCallAvailable,\n\t\t\trouteConfig,\n\t\t\tinquiries: queue\n\t\t\t\t? {\n\t\t\t\t\t\tenabled: true,\n\t\t\t\t\t\tqueue,\n\t\t\t\t  }\n\t\t\t\t: { enabled: false },\n\t\t\tshowOmnichannelQueueLink: showOmnichannelQueueLink && !!agentAvailable,\n\t\t};\n\t}, [agentAvailable, voipCallAvailable, enabled, manuallySelected, queue, routeConfig, showOmnichannelQueueLink]);\n\n\treturn <OmnichannelContext.Provider children={children} value={contextValue} />;\n};\n\nexport default memo<typeof OmnichannelProvider>(OmnichannelProvider);\n"]},"targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{}},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/providers/OmnichannelProvider.tsx","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/providers/OmnichannelProvider.tsx"}},"code":"var _regeneratorRuntime;\n\nmodule.link(\"@babel/runtime/regenerator\", {\n  default: function (v) {\n    _regeneratorRuntime = v;\n  }\n}, 0);\n\nvar _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default: function (v) {\n    _objectSpread = v;\n  }\n}, 1);\n\nvar _slicedToArray;\n\nmodule.link(\"@babel/runtime/helpers/slicedToArray\", {\n  default: function (v) {\n    _slicedToArray = v;\n  }\n}, 2);\nvar useSafely;\nmodule.link(\"@rocket.chat/fuselage-hooks\", {\n  useSafely: function (v) {\n    useSafely = v;\n  }\n}, 0);\nvar React, useState, useEffect, useMemo, useCallback, memo, useRef;\nmodule.link(\"react\", {\n  \"default\": function (v) {\n    React = v;\n  },\n  useState: function (v) {\n    useState = v;\n  },\n  useEffect: function (v) {\n    useEffect = v;\n  },\n  useMemo: function (v) {\n    useMemo = v;\n  },\n  useCallback: function (v) {\n    useCallback = v;\n  },\n  memo: function (v) {\n    memo = v;\n  },\n  useRef: function (v) {\n    useRef = v;\n  }\n}, 1);\nvar LivechatInquiry;\nmodule.link(\"../../app/livechat/client/collections/LivechatInquiry\", {\n  LivechatInquiry: function (v) {\n    LivechatInquiry = v;\n  }\n}, 2);\nvar initializeLivechatInquiryStream;\nmodule.link(\"../../app/livechat/client/lib/stream/queueManager\", {\n  initializeLivechatInquiryStream: function (v) {\n    initializeLivechatInquiryStream = v;\n  }\n}, 3);\nvar Notifications;\nmodule.link(\"../../app/notifications/client\", {\n  Notifications: function (v) {\n    Notifications = v;\n  }\n}, 4);\nvar ClientLogger;\nmodule.link(\"../../lib/ClientLogger\", {\n  ClientLogger: function (v) {\n    ClientLogger = v;\n  }\n}, 5);\nvar usePermission;\nmodule.link(\"../contexts/AuthorizationContext\", {\n  usePermission: function (v) {\n    usePermission = v;\n  }\n}, 6);\nvar OmnichannelContext;\nmodule.link(\"../contexts/OmnichannelContext\", {\n  OmnichannelContext: function (v) {\n    OmnichannelContext = v;\n  }\n}, 7);\nvar useMethod;\nmodule.link(\"../contexts/ServerContext\", {\n  useMethod: function (v) {\n    useMethod = v;\n  }\n}, 8);\nvar useSetting;\nmodule.link(\"../contexts/SettingsContext\", {\n  useSetting: function (v) {\n    useSetting = v;\n  }\n}, 9);\nvar useUser;\nmodule.link(\"../contexts/UserContext\", {\n  useUser: function (v) {\n    useUser = v;\n  }\n}, 10);\nvar useReactiveValue;\nmodule.link(\"../hooks/useReactiveValue\", {\n  useReactiveValue: function (v) {\n    useReactiveValue = v;\n  }\n}, 11);\nvar emptyContextValue = {\n  inquiries: {\n    enabled: false\n  },\n  enabled: false,\n  agentAvailable: false,\n  showOmnichannelQueueLink: false\n};\n\nvar OmnichannelProvider = function (_ref) {\n  var children = _ref.children;\n  var omniChannelEnabled = useSetting('Livechat_enabled');\n  var omnichannelRouting = useSetting('Livechat_Routing_Method');\n  var showOmnichannelQueueLink = useSetting('Livechat_show_queue_list_link');\n  var omnichannelPoolMaxIncoming = useSetting('Livechat_guest_pool_max_number_incoming_livechats_displayed');\n  var loggerRef = useRef(new ClientLogger('OmnichannelProvider'));\n  var hasAccess = usePermission('view-l-room');\n  var canViewOmnichannelQueue = usePermission('view-livechat-queue');\n  var user = useUser();\n  var agentAvailable = (user === null || user === void 0 ? void 0 : user.statusLivechat) === 'available';\n  var voipCallAvailable = true; // TODO: use backend check;\n\n  var getRoutingConfig = useMethod('livechat:getRoutingConfig');\n\n  var _useSafely = useSafely(useState(undefined)),\n      _useSafely2 = _slicedToArray(_useSafely, 2),\n      routeConfig = _useSafely2[0],\n      setRouteConfig = _useSafely2[1];\n\n  var accessible = hasAccess && omniChannelEnabled;\n  var iceServersSetting = useSetting('WebRTC_Servers');\n  useEffect(function () {\n    if (!accessible) {\n      return;\n    }\n\n    var update = function () {\n      function _callee() {\n        var _routeConfig;\n\n        return _regeneratorRuntime.async(function () {\n          function _callee$(_context) {\n            while (1) {\n              switch (_context.prev = _context.next) {\n                case 0:\n                  _context.prev = 0;\n                  _context.next = 3;\n                  return _regeneratorRuntime.awrap(getRoutingConfig());\n\n                case 3:\n                  _routeConfig = _context.sent;\n                  setRouteConfig(_routeConfig);\n                  _context.next = 10;\n                  break;\n\n                case 7:\n                  _context.prev = 7;\n                  _context.t0 = _context[\"catch\"](0);\n                  loggerRef.current.error(\"update() error in routeConfig \" + _context.t0);\n\n                case 10:\n                case \"end\":\n                  return _context.stop();\n              }\n            }\n          }\n\n          return _callee$;\n        }(), null, null, [[0, 7]], Promise);\n      }\n\n      return _callee;\n    }();\n\n    if (omnichannelRouting || !omnichannelRouting) {\n      update();\n    }\n  }, [accessible, getRoutingConfig, iceServersSetting, omnichannelRouting, setRouteConfig, voipCallAvailable]);\n  var enabled = accessible && !!user && !!routeConfig;\n  var manuallySelected = enabled && canViewOmnichannelQueue && !!routeConfig && routeConfig.showQueue && !routeConfig.autoAssignAgent && agentAvailable;\n  useEffect(function () {\n    if (!manuallySelected) {\n      return;\n    }\n\n    var handleDepartmentAgentData = function () {\n      initializeLivechatInquiryStream(user === null || user === void 0 ? void 0 : user._id);\n    };\n\n    initializeLivechatInquiryStream(user === null || user === void 0 ? void 0 : user._id);\n    Notifications.onUser('departmentAgentData', handleDepartmentAgentData);\n    return function () {\n      Notifications.unUser('departmentAgentData', handleDepartmentAgentData);\n    };\n  }, [manuallySelected, user === null || user === void 0 ? void 0 : user._id]);\n  var queue = useReactiveValue(useCallback(function () {\n    if (!manuallySelected) {\n      return undefined;\n    }\n\n    return LivechatInquiry.find({\n      status: 'queued',\n      $or: [{\n        defaultAgent: {\n          $exists: false\n        }\n      }, {\n        'defaultAgent.agentId': user === null || user === void 0 ? void 0 : user._id\n      }]\n    }, {\n      sort: {\n        queueOrder: 1,\n        estimatedWaitingTimeQueue: 1,\n        estimatedServiceTimeAt: 1\n      },\n      limit: omnichannelPoolMaxIncoming\n    }).fetch();\n  }, [manuallySelected, omnichannelPoolMaxIncoming, user === null || user === void 0 ? void 0 : user._id]));\n  var contextValue = useMemo(function () {\n    if (!enabled) {\n      return emptyContextValue;\n    }\n\n    if (!manuallySelected) {\n      return _objectSpread(_objectSpread({}, emptyContextValue), {}, {\n        enabled: true,\n        agentAvailable: agentAvailable,\n        voipCallAvailable: voipCallAvailable,\n        routeConfig: routeConfig\n      });\n    }\n\n    return _objectSpread(_objectSpread({}, emptyContextValue), {}, {\n      enabled: true,\n      agentAvailable: agentAvailable,\n      voipCallAvailable: voipCallAvailable,\n      routeConfig: routeConfig,\n      inquiries: queue ? {\n        enabled: true,\n        queue: queue\n      } : {\n        enabled: false\n      },\n      showOmnichannelQueueLink: showOmnichannelQueueLink && !!agentAvailable\n    });\n  }, [agentAvailable, voipCallAvailable, enabled, manuallySelected, queue, routeConfig, showOmnichannelQueueLink]);\n  return /*#__PURE__*/React.createElement(OmnichannelContext.Provider, {\n    children: children,\n    value: contextValue\n  });\n};\n\nmodule.exportDefault( /*#__PURE__*/memo(OmnichannelProvider));","map":{"version":3,"sources":["client/providers/OmnichannelProvider.tsx"],"names":[],"mappings":"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","sourcesContent":["import { useSafely } from '@rocket.chat/fuselage-hooks';\nimport React, { useState, useEffect, FC, useMemo, useCallback, memo, useRef } from 'react';\n\nimport { LivechatInquiry } from '../../app/livechat/client/collections/LivechatInquiry';\nimport { initializeLivechatInquiryStream } from '../../app/livechat/client/lib/stream/queueManager';\nimport { Notifications } from '../../app/notifications/client';\nimport { IOmnichannelAgent } from '../../definition/IOmnichannelAgent';\nimport { IRoom } from '../../definition/IRoom';\nimport { OmichannelRoutingConfig } from '../../definition/OmichannelRoutingConfig';\nimport { ClientLogger } from '../../lib/ClientLogger';\nimport { usePermission } from '../contexts/AuthorizationContext';\nimport { OmnichannelContext, OmnichannelContextValue } from '../contexts/OmnichannelContext';\nimport { useMethod } from '../contexts/ServerContext';\nimport { useSetting } from '../contexts/SettingsContext';\nimport { useUser } from '../contexts/UserContext';\nimport { useReactiveValue } from '../hooks/useReactiveValue';\n\nconst emptyContextValue: OmnichannelContextValue = {\n\tinquiries: { enabled: false },\n\tenabled: false,\n\tagentAvailable: false,\n\tshowOmnichannelQueueLink: false,\n};\n\nconst OmnichannelProvider: FC = ({ children }) => {\n\tconst omniChannelEnabled = useSetting('Livechat_enabled') as boolean;\n\tconst omnichannelRouting = useSetting('Livechat_Routing_Method');\n\tconst showOmnichannelQueueLink = useSetting('Livechat_show_queue_list_link') as boolean;\n\tconst omnichannelPoolMaxIncoming = useSetting('Livechat_guest_pool_max_number_incoming_livechats_displayed') as number;\n\n\tconst loggerRef = useRef(new ClientLogger('OmnichannelProvider'));\n\tconst hasAccess = usePermission('view-l-room');\n\tconst canViewOmnichannelQueue = usePermission('view-livechat-queue');\n\tconst user = useUser() as IOmnichannelAgent;\n\n\tconst agentAvailable = user?.statusLivechat === 'available';\n\tconst voipCallAvailable = true; // TODO: use backend check;\n\n\tconst getRoutingConfig = useMethod('livechat:getRoutingConfig');\n\n\tconst [routeConfig, setRouteConfig] = useSafely(useState<OmichannelRoutingConfig | undefined>(undefined));\n\n\tconst accessible = hasAccess && omniChannelEnabled;\n\tconst iceServersSetting: any = useSetting('WebRTC_Servers');\n\n\tuseEffect(() => {\n\t\tif (!accessible) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst update = async (): Promise<void> => {\n\t\t\ttry {\n\t\t\t\tconst routeConfig = await getRoutingConfig();\n\t\t\t\tsetRouteConfig(routeConfig);\n\t\t\t} catch (error) {\n\t\t\t\tloggerRef.current.error(`update() error in routeConfig ${error}`);\n\t\t\t}\n\t\t};\n\n\t\tif (omnichannelRouting || !omnichannelRouting) {\n\t\t\tupdate();\n\t\t}\n\t}, [accessible, getRoutingConfig, iceServersSetting, omnichannelRouting, setRouteConfig, voipCallAvailable]);\n\n\tconst enabled = accessible && !!user && !!routeConfig;\n\tconst manuallySelected =\n\t\tenabled && canViewOmnichannelQueue && !!routeConfig && routeConfig.showQueue && !routeConfig.autoAssignAgent && agentAvailable;\n\n\tuseEffect(() => {\n\t\tif (!manuallySelected) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst handleDepartmentAgentData = (): void => {\n\t\t\tinitializeLivechatInquiryStream(user?._id);\n\t\t};\n\n\t\tinitializeLivechatInquiryStream(user?._id);\n\t\tNotifications.onUser('departmentAgentData', handleDepartmentAgentData);\n\n\t\treturn (): void => {\n\t\t\tNotifications.unUser('departmentAgentData', handleDepartmentAgentData);\n\t\t};\n\t}, [manuallySelected, user?._id]);\n\n\tconst queue = useReactiveValue<IRoom[] | undefined>(\n\t\tuseCallback(() => {\n\t\t\tif (!manuallySelected) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\n\t\t\treturn LivechatInquiry.find(\n\t\t\t\t{\n\t\t\t\t\tstatus: 'queued',\n\t\t\t\t\t$or: [{ defaultAgent: { $exists: false } }, { 'defaultAgent.agentId': user?._id }],\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tsort: {\n\t\t\t\t\t\tqueueOrder: 1,\n\t\t\t\t\t\testimatedWaitingTimeQueue: 1,\n\t\t\t\t\t\testimatedServiceTimeAt: 1,\n\t\t\t\t\t},\n\t\t\t\t\tlimit: omnichannelPoolMaxIncoming,\n\t\t\t\t},\n\t\t\t).fetch();\n\t\t}, [manuallySelected, omnichannelPoolMaxIncoming, user?._id]),\n\t);\n\n\tconst contextValue = useMemo<OmnichannelContextValue>(() => {\n\t\tif (!enabled) {\n\t\t\treturn emptyContextValue;\n\t\t}\n\n\t\tif (!manuallySelected) {\n\t\t\treturn {\n\t\t\t\t...emptyContextValue,\n\t\t\t\tenabled: true,\n\t\t\t\tagentAvailable,\n\t\t\t\tvoipCallAvailable,\n\t\t\t\trouteConfig,\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\t...emptyContextValue,\n\t\t\tenabled: true,\n\t\t\tagentAvailable,\n\t\t\tvoipCallAvailable,\n\t\t\trouteConfig,\n\t\t\tinquiries: queue\n\t\t\t\t? {\n\t\t\t\t\t\tenabled: true,\n\t\t\t\t\t\tqueue,\n\t\t\t\t  }\n\t\t\t\t: { enabled: false },\n\t\t\tshowOmnichannelQueueLink: showOmnichannelQueueLink && !!agentAvailable,\n\t\t};\n\t}, [agentAvailable, voipCallAvailable, enabled, manuallySelected, queue, routeConfig, showOmnichannelQueueLink]);\n\n\treturn <OmnichannelContext.Provider children={children} value={contextValue} />;\n};\n\nexport default memo<typeof OmnichannelProvider>(OmnichannelProvider);\n"],"sourceRoot":""},"sourceType":"module","hash":"aeb7f718b25b310c01284262c792ab6f2f8b0598"}
