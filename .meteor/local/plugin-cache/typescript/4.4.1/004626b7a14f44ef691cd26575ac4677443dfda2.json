{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/views/room/threads/ThreadComponent.tsx","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"client/views/room/threads/ThreadComponent.tsx","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/views/room/threads/ThreadComponent.tsx","inputSourceMap":{"version":3,"file":"client/views/room/threads/ThreadComponent.tsx","sourceRoot":"","sources":["client/views/room/threads/ThreadComponent.tsx"],"names":[],"mappings":"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","sourcesContent":["import { useLocalStorage } from '@rocket.chat/fuselage-hooks';\nimport { Blaze } from 'meteor/blaze';\nimport { Template } from 'meteor/templating';\nimport { Tracker } from 'meteor/tracker';\nimport React, { useEffect, useRef, useState, useCallback, useMemo, FC } from 'react';\n\nimport { ChatMessage } from '../../../../app/models/client';\nimport { normalizeThreadTitle } from '../../../../app/threads/client/lib/normalizeThreadTitle';\nimport { IMessage } from '../../../../definition/IMessage';\nimport { IRoom } from '../../../../definition/IRoom';\nimport { useRoute } from '../../../contexts/RouterContext';\nimport { useEndpoint, useMethod } from '../../../contexts/ServerContext';\nimport { useToastMessageDispatch } from '../../../contexts/ToastMessagesContext';\nimport { useUserId, useUserSubscription } from '../../../contexts/UserContext';\nimport { roomCoordinator } from '../../../lib/rooms/roomCoordinator';\nimport { mapMessageFromApi } from '../../../lib/utils/mapMessageFromApi';\nimport { useTabBarOpenUserInfo } from '../providers/ToolboxProvider';\nimport ThreadSkeleton from './ThreadSkeleton';\nimport ThreadView from './ThreadView';\n\nconst subscriptionFields = {};\n\nconst useThreadMessage = (tmid: string): IMessage => {\n\tconst [message, setMessage] = useState<IMessage>(() => Tracker.nonreactive(() => ChatMessage.findOne({ _id: tmid })));\n\tconst getMessage = useEndpoint('GET', 'chat.getMessage');\n\tconst getMessageParsed = useCallback<(params: { msgId: IMessage['_id'] }) => Promise<IMessage>>(\n\t\tasync (params) => {\n\t\t\tconst { message } = await getMessage(params);\n\t\t\treturn mapMessageFromApi(message);\n\t\t},\n\t\t[getMessage],\n\t);\n\n\tuseEffect(() => {\n\t\tconst computation = Tracker.autorun(async (computation) => {\n\t\t\tconst msg = ChatMessage.findOne({ _id: tmid }) || (await getMessageParsed({ msgId: tmid }));\n\n\t\t\tif (!msg || computation.stopped) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tsetMessage((prevMsg) => {\n\t\t\t\tif (!prevMsg || prevMsg._id !== msg._id || prevMsg._updatedAt?.getTime() !== msg._updatedAt?.getTime()) {\n\t\t\t\t\treturn msg;\n\t\t\t\t}\n\n\t\t\t\treturn prevMsg;\n\t\t\t});\n\t\t});\n\n\t\treturn (): void => {\n\t\t\tcomputation.stop();\n\t\t};\n\t}, [getMessageParsed, tmid]);\n\n\treturn message;\n};\n\nconst ThreadComponent: FC<{\n\tmid: string;\n\tjump: unknown;\n\troom: IRoom;\n\tonClickBack: (e: unknown) => void;\n}> = ({ mid, jump, room, onClickBack }) => {\n\tconst subscription = useUserSubscription(room._id, subscriptionFields);\n\tconst channelRoute = useRoute(roomCoordinator.getRoomTypeConfig(room.t).route.name);\n\tconst threadMessage = useThreadMessage(mid);\n\n\tconst openUserInfo = useTabBarOpenUserInfo();\n\n\tconst ref = useRef<HTMLElement>(null);\n\tconst uid = useUserId();\n\n\tconst headerTitle = useMemo(() => (threadMessage ? normalizeThreadTitle(threadMessage) : null), [threadMessage]);\n\tconst [expanded, setExpand] = useLocalStorage('expand-threads', false);\n\tconst following = !uid ? false : threadMessage?.replies?.includes(uid) ?? false;\n\n\tconst dispatchToastMessage = useToastMessageDispatch();\n\tconst followMessage = useMethod('followMessage');\n\tconst unfollowMessage = useMethod('unfollowMessage');\n\n\tconst setFollowing = useCallback<(following: boolean) => void>(\n\t\tasync (following) => {\n\t\t\ttry {\n\t\t\t\tif (following) {\n\t\t\t\t\tawait followMessage({ mid });\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tawait unfollowMessage({ mid });\n\t\t\t} catch (error) {\n\t\t\t\tdispatchToastMessage({\n\t\t\t\t\ttype: 'error',\n\t\t\t\t\tmessage: error,\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\t\t[dispatchToastMessage, followMessage, unfollowMessage, mid],\n\t);\n\n\tconst handleClose = useCallback(() => {\n\t\tchannelRoute.push(room.t === 'd' ? { rid: room._id } : { name: room.name || room._id });\n\t}, [channelRoute, room._id, room.t, room.name]);\n\n\tconst [viewData, setViewData] = useState(() => ({\n\t\tmainMessage: threadMessage,\n\t\tjump,\n\t\tfollowing,\n\t\tsubscription,\n\t\trid: room._id,\n\t\ttabBar: { openUserInfo },\n\t}));\n\n\tuseEffect(() => {\n\t\tsetViewData((viewData) => {\n\t\t\tif (!threadMessage || viewData.mainMessage?._id === threadMessage._id) {\n\t\t\t\treturn viewData;\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tmainMessage: threadMessage,\n\t\t\t\tjump,\n\t\t\t\tfollowing,\n\t\t\t\tsubscription,\n\t\t\t\trid: room._id,\n\t\t\t\ttabBar: { openUserInfo },\n\t\t\t};\n\t\t});\n\t}, [following, jump, openUserInfo, room._id, subscription, threadMessage]);\n\n\tuseEffect(() => {\n\t\tif (!ref.current || !viewData.mainMessage) {\n\t\t\treturn;\n\t\t}\n\t\tconst view = Blaze.renderWithData(Template.thread, viewData, ref.current);\n\n\t\treturn (): void => {\n\t\t\tBlaze.remove(view);\n\t\t};\n\t}, [viewData]);\n\n\tif (!threadMessage) {\n\t\treturn <ThreadSkeleton expanded={expanded} onClose={handleClose} />;\n\t}\n\n\treturn (\n\t\t<ThreadView\n\t\t\tref={ref}\n\t\t\ttitle={headerTitle}\n\t\t\texpanded={expanded}\n\t\t\tfollowing={following}\n\t\t\tonToggleExpand={(expanded): void => setExpand(!expanded)}\n\t\t\tonToggleFollow={(following): void => setFollowing(!following)}\n\t\t\tonClose={handleClose}\n\t\t\tonClickBack={onClickBack}\n\t\t/>\n\t);\n};\n\nexport default ThreadComponent;\n"]},"targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{}},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/views/room/threads/ThreadComponent.tsx","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/views/room/threads/ThreadComponent.tsx"}},"code":"var _regeneratorRuntime;\n\nmodule.link(\"@babel/runtime/regenerator\", {\n  default: function (v) {\n    _regeneratorRuntime = v;\n  }\n}, 0);\n\nvar _slicedToArray;\n\nmodule.link(\"@babel/runtime/helpers/slicedToArray\", {\n  default: function (v) {\n    _slicedToArray = v;\n  }\n}, 1);\nvar useLocalStorage;\nmodule.link(\"@rocket.chat/fuselage-hooks\", {\n  useLocalStorage: function (v) {\n    useLocalStorage = v;\n  }\n}, 0);\nvar Blaze;\nmodule.link(\"meteor/blaze\", {\n  Blaze: function (v) {\n    Blaze = v;\n  }\n}, 1);\nvar Template;\nmodule.link(\"meteor/templating\", {\n  Template: function (v) {\n    Template = v;\n  }\n}, 2);\nvar Tracker;\nmodule.link(\"meteor/tracker\", {\n  Tracker: function (v) {\n    Tracker = v;\n  }\n}, 3);\nvar React, useEffect, useRef, useState, useCallback, useMemo;\nmodule.link(\"react\", {\n  \"default\": function (v) {\n    React = v;\n  },\n  useEffect: function (v) {\n    useEffect = v;\n  },\n  useRef: function (v) {\n    useRef = v;\n  },\n  useState: function (v) {\n    useState = v;\n  },\n  useCallback: function (v) {\n    useCallback = v;\n  },\n  useMemo: function (v) {\n    useMemo = v;\n  }\n}, 4);\nvar ChatMessage;\nmodule.link(\"../../../../app/models/client\", {\n  ChatMessage: function (v) {\n    ChatMessage = v;\n  }\n}, 5);\nvar normalizeThreadTitle;\nmodule.link(\"../../../../app/threads/client/lib/normalizeThreadTitle\", {\n  normalizeThreadTitle: function (v) {\n    normalizeThreadTitle = v;\n  }\n}, 6);\nvar useRoute;\nmodule.link(\"../../../contexts/RouterContext\", {\n  useRoute: function (v) {\n    useRoute = v;\n  }\n}, 7);\nvar useEndpoint, useMethod;\nmodule.link(\"../../../contexts/ServerContext\", {\n  useEndpoint: function (v) {\n    useEndpoint = v;\n  },\n  useMethod: function (v) {\n    useMethod = v;\n  }\n}, 8);\nvar useToastMessageDispatch;\nmodule.link(\"../../../contexts/ToastMessagesContext\", {\n  useToastMessageDispatch: function (v) {\n    useToastMessageDispatch = v;\n  }\n}, 9);\nvar useUserId, useUserSubscription;\nmodule.link(\"../../../contexts/UserContext\", {\n  useUserId: function (v) {\n    useUserId = v;\n  },\n  useUserSubscription: function (v) {\n    useUserSubscription = v;\n  }\n}, 10);\nvar roomCoordinator;\nmodule.link(\"../../../lib/rooms/roomCoordinator\", {\n  roomCoordinator: function (v) {\n    roomCoordinator = v;\n  }\n}, 11);\nvar mapMessageFromApi;\nmodule.link(\"../../../lib/utils/mapMessageFromApi\", {\n  mapMessageFromApi: function (v) {\n    mapMessageFromApi = v;\n  }\n}, 12);\nvar useTabBarOpenUserInfo;\nmodule.link(\"../providers/ToolboxProvider\", {\n  useTabBarOpenUserInfo: function (v) {\n    useTabBarOpenUserInfo = v;\n  }\n}, 13);\nvar ThreadSkeleton;\nmodule.link(\"./ThreadSkeleton\", {\n  \"default\": function (v) {\n    ThreadSkeleton = v;\n  }\n}, 14);\nvar ThreadView;\nmodule.link(\"./ThreadView\", {\n  \"default\": function (v) {\n    ThreadView = v;\n  }\n}, 15);\nvar subscriptionFields = {};\n\nvar useThreadMessage = function (tmid) {\n  var _useState = useState(function () {\n    return Tracker.nonreactive(function () {\n      return ChatMessage.findOne({\n        _id: tmid\n      });\n    });\n  }),\n      _useState2 = _slicedToArray(_useState, 2),\n      message = _useState2[0],\n      setMessage = _useState2[1];\n\n  var getMessage = useEndpoint('GET', 'chat.getMessage');\n  var getMessageParsed = useCallback(function () {\n    function _callee(params) {\n      var _await$getMessage, message;\n\n      return _regeneratorRuntime.async(function () {\n        function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.next = 2;\n                return _regeneratorRuntime.awrap(getMessage(params));\n\n              case 2:\n                _await$getMessage = _context.sent;\n                message = _await$getMessage.message;\n                return _context.abrupt(\"return\", mapMessageFromApi(message));\n\n              case 5:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }\n\n        return _callee$;\n      }(), null, null, null, Promise);\n    }\n\n    return _callee;\n  }(), [getMessage]);\n  useEffect(function () {\n    var computation = Tracker.autorun(function () {\n      function _callee2(computation) {\n        var msg;\n        return _regeneratorRuntime.async(function () {\n          function _callee2$(_context2) {\n            while (1) {\n              switch (_context2.prev = _context2.next) {\n                case 0:\n                  _context2.t0 = ChatMessage.findOne({\n                    _id: tmid\n                  });\n\n                  if (_context2.t0) {\n                    _context2.next = 5;\n                    break;\n                  }\n\n                  _context2.next = 4;\n                  return _regeneratorRuntime.awrap(getMessageParsed({\n                    msgId: tmid\n                  }));\n\n                case 4:\n                  _context2.t0 = _context2.sent;\n\n                case 5:\n                  msg = _context2.t0;\n\n                  if (!(!msg || computation.stopped)) {\n                    _context2.next = 8;\n                    break;\n                  }\n\n                  return _context2.abrupt(\"return\");\n\n                case 8:\n                  setMessage(function (prevMsg) {\n                    var _prevMsg$_updatedAt, _msg$_updatedAt;\n\n                    if (!prevMsg || prevMsg._id !== msg._id || ((_prevMsg$_updatedAt = prevMsg._updatedAt) === null || _prevMsg$_updatedAt === void 0 ? void 0 : _prevMsg$_updatedAt.getTime()) !== ((_msg$_updatedAt = msg._updatedAt) === null || _msg$_updatedAt === void 0 ? void 0 : _msg$_updatedAt.getTime())) {\n                      return msg;\n                    }\n\n                    return prevMsg;\n                  });\n\n                case 9:\n                case \"end\":\n                  return _context2.stop();\n              }\n            }\n          }\n\n          return _callee2$;\n        }(), null, null, null, Promise);\n      }\n\n      return _callee2;\n    }());\n    return function () {\n      computation.stop();\n    };\n  }, [getMessageParsed, tmid]);\n  return message;\n};\n\nvar ThreadComponent = function (_ref) {\n  var _threadMessage$replie, _threadMessage$replie2;\n\n  var mid = _ref.mid,\n      jump = _ref.jump,\n      room = _ref.room,\n      onClickBack = _ref.onClickBack;\n  var subscription = useUserSubscription(room._id, subscriptionFields);\n  var channelRoute = useRoute(roomCoordinator.getRoomTypeConfig(room.t).route.name);\n  var threadMessage = useThreadMessage(mid);\n  var openUserInfo = useTabBarOpenUserInfo();\n  var ref = useRef(null);\n  var uid = useUserId();\n  var headerTitle = useMemo(function () {\n    return threadMessage ? normalizeThreadTitle(threadMessage) : null;\n  }, [threadMessage]);\n\n  var _useLocalStorage = useLocalStorage('expand-threads', false),\n      _useLocalStorage2 = _slicedToArray(_useLocalStorage, 2),\n      expanded = _useLocalStorage2[0],\n      setExpand = _useLocalStorage2[1];\n\n  var following = !uid ? false : (_threadMessage$replie = threadMessage === null || threadMessage === void 0 ? void 0 : (_threadMessage$replie2 = threadMessage.replies) === null || _threadMessage$replie2 === void 0 ? void 0 : _threadMessage$replie2.includes(uid)) !== null && _threadMessage$replie !== void 0 ? _threadMessage$replie : false;\n  var dispatchToastMessage = useToastMessageDispatch();\n  var followMessage = useMethod('followMessage');\n  var unfollowMessage = useMethod('unfollowMessage');\n  var setFollowing = useCallback(function () {\n    function _callee3(following) {\n      return _regeneratorRuntime.async(function () {\n        function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                _context3.prev = 0;\n\n                if (!following) {\n                  _context3.next = 5;\n                  break;\n                }\n\n                _context3.next = 4;\n                return _regeneratorRuntime.awrap(followMessage({\n                  mid: mid\n                }));\n\n              case 4:\n                return _context3.abrupt(\"return\");\n\n              case 5:\n                _context3.next = 7;\n                return _regeneratorRuntime.awrap(unfollowMessage({\n                  mid: mid\n                }));\n\n              case 7:\n                _context3.next = 12;\n                break;\n\n              case 9:\n                _context3.prev = 9;\n                _context3.t0 = _context3[\"catch\"](0);\n                dispatchToastMessage({\n                  type: 'error',\n                  message: _context3.t0\n                });\n\n              case 12:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }\n\n        return _callee3$;\n      }(), null, null, [[0, 9]], Promise);\n    }\n\n    return _callee3;\n  }(), [dispatchToastMessage, followMessage, unfollowMessage, mid]);\n  var handleClose = useCallback(function () {\n    channelRoute.push(room.t === 'd' ? {\n      rid: room._id\n    } : {\n      name: room.name || room._id\n    });\n  }, [channelRoute, room._id, room.t, room.name]);\n\n  var _useState3 = useState(function () {\n    return {\n      mainMessage: threadMessage,\n      jump: jump,\n      following: following,\n      subscription: subscription,\n      rid: room._id,\n      tabBar: {\n        openUserInfo: openUserInfo\n      }\n    };\n  }),\n      _useState4 = _slicedToArray(_useState3, 2),\n      viewData = _useState4[0],\n      setViewData = _useState4[1];\n\n  useEffect(function () {\n    setViewData(function (viewData) {\n      var _viewData$mainMessage;\n\n      if (!threadMessage || ((_viewData$mainMessage = viewData.mainMessage) === null || _viewData$mainMessage === void 0 ? void 0 : _viewData$mainMessage._id) === threadMessage._id) {\n        return viewData;\n      }\n\n      return {\n        mainMessage: threadMessage,\n        jump: jump,\n        following: following,\n        subscription: subscription,\n        rid: room._id,\n        tabBar: {\n          openUserInfo: openUserInfo\n        }\n      };\n    });\n  }, [following, jump, openUserInfo, room._id, subscription, threadMessage]);\n  useEffect(function () {\n    if (!ref.current || !viewData.mainMessage) {\n      return;\n    }\n\n    var view = Blaze.renderWithData(Template.thread, viewData, ref.current);\n    return function () {\n      Blaze.remove(view);\n    };\n  }, [viewData]);\n\n  if (!threadMessage) {\n    return /*#__PURE__*/React.createElement(ThreadSkeleton, {\n      expanded: expanded,\n      onClose: handleClose\n    });\n  }\n\n  return /*#__PURE__*/React.createElement(ThreadView, {\n    ref: ref,\n    title: headerTitle,\n    expanded: expanded,\n    following: following,\n    onToggleExpand: function (expanded) {\n      return setExpand(!expanded);\n    },\n    onToggleFollow: function (following) {\n      return setFollowing(!following);\n    },\n    onClose: handleClose,\n    onClickBack: onClickBack\n  });\n};\n\nmodule.exportDefault(ThreadComponent);","map":{"version":3,"sources":["client/views/room/threads/ThreadComponent.tsx"],"names":[],"mappings":"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","sourcesContent":["import { useLocalStorage } from '@rocket.chat/fuselage-hooks';\nimport { Blaze } from 'meteor/blaze';\nimport { Template } from 'meteor/templating';\nimport { Tracker } from 'meteor/tracker';\nimport React, { useEffect, useRef, useState, useCallback, useMemo, FC } from 'react';\n\nimport { ChatMessage } from '../../../../app/models/client';\nimport { normalizeThreadTitle } from '../../../../app/threads/client/lib/normalizeThreadTitle';\nimport { IMessage } from '../../../../definition/IMessage';\nimport { IRoom } from '../../../../definition/IRoom';\nimport { useRoute } from '../../../contexts/RouterContext';\nimport { useEndpoint, useMethod } from '../../../contexts/ServerContext';\nimport { useToastMessageDispatch } from '../../../contexts/ToastMessagesContext';\nimport { useUserId, useUserSubscription } from '../../../contexts/UserContext';\nimport { roomCoordinator } from '../../../lib/rooms/roomCoordinator';\nimport { mapMessageFromApi } from '../../../lib/utils/mapMessageFromApi';\nimport { useTabBarOpenUserInfo } from '../providers/ToolboxProvider';\nimport ThreadSkeleton from './ThreadSkeleton';\nimport ThreadView from './ThreadView';\n\nconst subscriptionFields = {};\n\nconst useThreadMessage = (tmid: string): IMessage => {\n\tconst [message, setMessage] = useState<IMessage>(() => Tracker.nonreactive(() => ChatMessage.findOne({ _id: tmid })));\n\tconst getMessage = useEndpoint('GET', 'chat.getMessage');\n\tconst getMessageParsed = useCallback<(params: { msgId: IMessage['_id'] }) => Promise<IMessage>>(\n\t\tasync (params) => {\n\t\t\tconst { message } = await getMessage(params);\n\t\t\treturn mapMessageFromApi(message);\n\t\t},\n\t\t[getMessage],\n\t);\n\n\tuseEffect(() => {\n\t\tconst computation = Tracker.autorun(async (computation) => {\n\t\t\tconst msg = ChatMessage.findOne({ _id: tmid }) || (await getMessageParsed({ msgId: tmid }));\n\n\t\t\tif (!msg || computation.stopped) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tsetMessage((prevMsg) => {\n\t\t\t\tif (!prevMsg || prevMsg._id !== msg._id || prevMsg._updatedAt?.getTime() !== msg._updatedAt?.getTime()) {\n\t\t\t\t\treturn msg;\n\t\t\t\t}\n\n\t\t\t\treturn prevMsg;\n\t\t\t});\n\t\t});\n\n\t\treturn (): void => {\n\t\t\tcomputation.stop();\n\t\t};\n\t}, [getMessageParsed, tmid]);\n\n\treturn message;\n};\n\nconst ThreadComponent: FC<{\n\tmid: string;\n\tjump: unknown;\n\troom: IRoom;\n\tonClickBack: (e: unknown) => void;\n}> = ({ mid, jump, room, onClickBack }) => {\n\tconst subscription = useUserSubscription(room._id, subscriptionFields);\n\tconst channelRoute = useRoute(roomCoordinator.getRoomTypeConfig(room.t).route.name);\n\tconst threadMessage = useThreadMessage(mid);\n\n\tconst openUserInfo = useTabBarOpenUserInfo();\n\n\tconst ref = useRef<HTMLElement>(null);\n\tconst uid = useUserId();\n\n\tconst headerTitle = useMemo(() => (threadMessage ? normalizeThreadTitle(threadMessage) : null), [threadMessage]);\n\tconst [expanded, setExpand] = useLocalStorage('expand-threads', false);\n\tconst following = !uid ? false : threadMessage?.replies?.includes(uid) ?? false;\n\n\tconst dispatchToastMessage = useToastMessageDispatch();\n\tconst followMessage = useMethod('followMessage');\n\tconst unfollowMessage = useMethod('unfollowMessage');\n\n\tconst setFollowing = useCallback<(following: boolean) => void>(\n\t\tasync (following) => {\n\t\t\ttry {\n\t\t\t\tif (following) {\n\t\t\t\t\tawait followMessage({ mid });\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tawait unfollowMessage({ mid });\n\t\t\t} catch (error) {\n\t\t\t\tdispatchToastMessage({\n\t\t\t\t\ttype: 'error',\n\t\t\t\t\tmessage: error,\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\t\t[dispatchToastMessage, followMessage, unfollowMessage, mid],\n\t);\n\n\tconst handleClose = useCallback(() => {\n\t\tchannelRoute.push(room.t === 'd' ? { rid: room._id } : { name: room.name || room._id });\n\t}, [channelRoute, room._id, room.t, room.name]);\n\n\tconst [viewData, setViewData] = useState(() => ({\n\t\tmainMessage: threadMessage,\n\t\tjump,\n\t\tfollowing,\n\t\tsubscription,\n\t\trid: room._id,\n\t\ttabBar: { openUserInfo },\n\t}));\n\n\tuseEffect(() => {\n\t\tsetViewData((viewData) => {\n\t\t\tif (!threadMessage || viewData.mainMessage?._id === threadMessage._id) {\n\t\t\t\treturn viewData;\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tmainMessage: threadMessage,\n\t\t\t\tjump,\n\t\t\t\tfollowing,\n\t\t\t\tsubscription,\n\t\t\t\trid: room._id,\n\t\t\t\ttabBar: { openUserInfo },\n\t\t\t};\n\t\t});\n\t}, [following, jump, openUserInfo, room._id, subscription, threadMessage]);\n\n\tuseEffect(() => {\n\t\tif (!ref.current || !viewData.mainMessage) {\n\t\t\treturn;\n\t\t}\n\t\tconst view = Blaze.renderWithData(Template.thread, viewData, ref.current);\n\n\t\treturn (): void => {\n\t\t\tBlaze.remove(view);\n\t\t};\n\t}, [viewData]);\n\n\tif (!threadMessage) {\n\t\treturn <ThreadSkeleton expanded={expanded} onClose={handleClose} />;\n\t}\n\n\treturn (\n\t\t<ThreadView\n\t\t\tref={ref}\n\t\t\ttitle={headerTitle}\n\t\t\texpanded={expanded}\n\t\t\tfollowing={following}\n\t\t\tonToggleExpand={(expanded): void => setExpand(!expanded)}\n\t\t\tonToggleFollow={(following): void => setFollowing(!following)}\n\t\t\tonClose={handleClose}\n\t\t\tonClickBack={onClickBack}\n\t\t/>\n\t);\n};\n\nexport default ThreadComponent;\n"],"sourceRoot":""},"sourceType":"module","hash":"004626b7a14f44ef691cd26575ac4677443dfda2"}
