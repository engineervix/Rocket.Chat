{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/views/room/threads/ThreadComponent.tsx","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"client/views/room/threads/ThreadComponent.tsx","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/views/room/threads/ThreadComponent.tsx","inputSourceMap":{"version":3,"file":"client/views/room/threads/ThreadComponent.tsx","sourceRoot":"","sources":["client/views/room/threads/ThreadComponent.tsx"],"names":[],"mappings":"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","sourcesContent":["import { useLocalStorage } from '@rocket.chat/fuselage-hooks';\nimport { Blaze } from 'meteor/blaze';\nimport { Template } from 'meteor/templating';\nimport { Tracker } from 'meteor/tracker';\nimport React, { useEffect, useRef, useState, useCallback, useMemo, FC } from 'react';\n\nimport { ChatMessage } from '../../../../app/models/client';\nimport { normalizeThreadTitle } from '../../../../app/threads/client/lib/normalizeThreadTitle';\nimport { IMessage } from '../../../../definition/IMessage';\nimport { IRoom } from '../../../../definition/IRoom';\nimport { useRoute } from '../../../contexts/RouterContext';\nimport { useEndpoint, useMethod } from '../../../contexts/ServerContext';\nimport { useToastMessageDispatch } from '../../../contexts/ToastMessagesContext';\nimport { useUserId, useUserSubscription } from '../../../contexts/UserContext';\nimport { roomCoordinator } from '../../../lib/rooms/roomCoordinator';\nimport { mapMessageFromApi } from '../../../lib/utils/mapMessageFromApi';\nimport { useTabBarOpenUserInfo } from '../providers/ToolboxProvider';\nimport ThreadSkeleton from './ThreadSkeleton';\nimport ThreadView from './ThreadView';\n\nconst subscriptionFields = {};\n\nconst useThreadMessage = (tmid: string): IMessage => {\n\tconst [message, setMessage] = useState<IMessage>(() => Tracker.nonreactive(() => ChatMessage.findOne({ _id: tmid })));\n\tconst getMessage = useEndpoint('GET', 'chat.getMessage');\n\tconst getMessageParsed = useCallback<(params: { msgId: IMessage['_id'] }) => Promise<IMessage>>(\n\t\tasync (params) => {\n\t\t\tconst { message } = await getMessage(params);\n\t\t\treturn mapMessageFromApi(message);\n\t\t},\n\t\t[getMessage],\n\t);\n\n\tuseEffect(() => {\n\t\tconst computation = Tracker.autorun(async (computation) => {\n\t\t\tconst msg = ChatMessage.findOne({ _id: tmid }) || (await getMessageParsed({ msgId: tmid }));\n\n\t\t\tif (!msg || computation.stopped) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tsetMessage((prevMsg) => {\n\t\t\t\tif (!prevMsg || prevMsg._id !== msg._id || prevMsg._updatedAt?.getTime() !== msg._updatedAt?.getTime()) {\n\t\t\t\t\treturn msg;\n\t\t\t\t}\n\n\t\t\t\treturn prevMsg;\n\t\t\t});\n\t\t});\n\n\t\treturn (): void => {\n\t\t\tcomputation.stop();\n\t\t};\n\t}, [getMessageParsed, tmid]);\n\n\treturn message;\n};\n\nconst ThreadComponent: FC<{\n\tmid: string;\n\tjump: unknown;\n\troom: IRoom;\n\tonClickBack: (e: unknown) => void;\n}> = ({ mid, jump, room, onClickBack }) => {\n\tconst subscription = useUserSubscription(room._id, subscriptionFields);\n\tconst channelRoute = useRoute(roomCoordinator.getRoomTypeConfig(room.t).route.name);\n\tconst threadMessage = useThreadMessage(mid);\n\n\tconst openUserInfo = useTabBarOpenUserInfo();\n\n\tconst ref = useRef<HTMLElement>(null);\n\tconst uid = useUserId();\n\n\tconst headerTitle = useMemo(() => (threadMessage ? normalizeThreadTitle(threadMessage) : null), [threadMessage]);\n\tconst [expanded, setExpand] = useLocalStorage('expand-threads', false);\n\tconst following = !uid ? false : threadMessage?.replies?.includes(uid) ?? false;\n\n\tconst dispatchToastMessage = useToastMessageDispatch();\n\tconst followMessage = useMethod('followMessage');\n\tconst unfollowMessage = useMethod('unfollowMessage');\n\n\tconst setFollowing = useCallback<(following: boolean) => void>(\n\t\tasync (following) => {\n\t\t\ttry {\n\t\t\t\tif (following) {\n\t\t\t\t\tawait followMessage({ mid });\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tawait unfollowMessage({ mid });\n\t\t\t} catch (error) {\n\t\t\t\tdispatchToastMessage({\n\t\t\t\t\ttype: 'error',\n\t\t\t\t\tmessage: error,\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\t\t[dispatchToastMessage, followMessage, unfollowMessage, mid],\n\t);\n\n\tconst handleClose = useCallback(() => {\n\t\tchannelRoute.push(room.t === 'd' ? { rid: room._id } : { name: room.name || room._id });\n\t}, [channelRoute, room._id, room.t, room.name]);\n\n\tconst [viewData, setViewData] = useState(() => ({\n\t\tmainMessage: threadMessage,\n\t\tjump,\n\t\tfollowing,\n\t\tsubscription,\n\t\trid: room._id,\n\t\ttabBar: { openUserInfo },\n\t}));\n\n\tuseEffect(() => {\n\t\tsetViewData((viewData) => {\n\t\t\tif (!threadMessage || viewData.mainMessage?._id === threadMessage._id) {\n\t\t\t\treturn viewData;\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tmainMessage: threadMessage,\n\t\t\t\tjump,\n\t\t\t\tfollowing,\n\t\t\t\tsubscription,\n\t\t\t\trid: room._id,\n\t\t\t\ttabBar: { openUserInfo },\n\t\t\t};\n\t\t});\n\t}, [following, jump, openUserInfo, room._id, subscription, threadMessage]);\n\n\tuseEffect(() => {\n\t\tif (!ref.current || !viewData.mainMessage) {\n\t\t\treturn;\n\t\t}\n\t\tconst view = Blaze.renderWithData(Template.thread, viewData, ref.current);\n\n\t\treturn (): void => {\n\t\t\tBlaze.remove(view);\n\t\t};\n\t}, [viewData]);\n\n\tif (!threadMessage) {\n\t\treturn <ThreadSkeleton expanded={expanded} onClose={handleClose} />;\n\t}\n\n\treturn (\n\t\t<ThreadView\n\t\t\tref={ref}\n\t\t\ttitle={headerTitle}\n\t\t\texpanded={expanded}\n\t\t\tfollowing={following}\n\t\t\tonToggleExpand={(expanded): void => setExpand(!expanded)}\n\t\t\tonToggleFollow={(following): void => setFollowing(!following)}\n\t\t\tonClose={handleClose}\n\t\t\tonClickBack={onClickBack}\n\t\t/>\n\t);\n};\n\nexport default ThreadComponent;\n"]},"targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/views/room/threads/ThreadComponent.tsx","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/views/room/threads/ThreadComponent.tsx"}},"code":"let useLocalStorage;\nmodule.link(\"@rocket.chat/fuselage-hooks\", {\n  useLocalStorage(v) {\n    useLocalStorage = v;\n  }\n\n}, 0);\nlet Blaze;\nmodule.link(\"meteor/blaze\", {\n  Blaze(v) {\n    Blaze = v;\n  }\n\n}, 1);\nlet Template;\nmodule.link(\"meteor/templating\", {\n  Template(v) {\n    Template = v;\n  }\n\n}, 2);\nlet Tracker;\nmodule.link(\"meteor/tracker\", {\n  Tracker(v) {\n    Tracker = v;\n  }\n\n}, 3);\nlet React, useEffect, useRef, useState, useCallback, useMemo;\nmodule.link(\"react\", {\n  default(v) {\n    React = v;\n  },\n\n  useEffect(v) {\n    useEffect = v;\n  },\n\n  useRef(v) {\n    useRef = v;\n  },\n\n  useState(v) {\n    useState = v;\n  },\n\n  useCallback(v) {\n    useCallback = v;\n  },\n\n  useMemo(v) {\n    useMemo = v;\n  }\n\n}, 4);\nlet ChatMessage;\nmodule.link(\"../../../../app/models/client\", {\n  ChatMessage(v) {\n    ChatMessage = v;\n  }\n\n}, 5);\nlet normalizeThreadTitle;\nmodule.link(\"../../../../app/threads/client/lib/normalizeThreadTitle\", {\n  normalizeThreadTitle(v) {\n    normalizeThreadTitle = v;\n  }\n\n}, 6);\nlet useRoute;\nmodule.link(\"../../../contexts/RouterContext\", {\n  useRoute(v) {\n    useRoute = v;\n  }\n\n}, 7);\nlet useEndpoint, useMethod;\nmodule.link(\"../../../contexts/ServerContext\", {\n  useEndpoint(v) {\n    useEndpoint = v;\n  },\n\n  useMethod(v) {\n    useMethod = v;\n  }\n\n}, 8);\nlet useToastMessageDispatch;\nmodule.link(\"../../../contexts/ToastMessagesContext\", {\n  useToastMessageDispatch(v) {\n    useToastMessageDispatch = v;\n  }\n\n}, 9);\nlet useUserId, useUserSubscription;\nmodule.link(\"../../../contexts/UserContext\", {\n  useUserId(v) {\n    useUserId = v;\n  },\n\n  useUserSubscription(v) {\n    useUserSubscription = v;\n  }\n\n}, 10);\nlet roomCoordinator;\nmodule.link(\"../../../lib/rooms/roomCoordinator\", {\n  roomCoordinator(v) {\n    roomCoordinator = v;\n  }\n\n}, 11);\nlet mapMessageFromApi;\nmodule.link(\"../../../lib/utils/mapMessageFromApi\", {\n  mapMessageFromApi(v) {\n    mapMessageFromApi = v;\n  }\n\n}, 12);\nlet useTabBarOpenUserInfo;\nmodule.link(\"../providers/ToolboxProvider\", {\n  useTabBarOpenUserInfo(v) {\n    useTabBarOpenUserInfo = v;\n  }\n\n}, 13);\nlet ThreadSkeleton;\nmodule.link(\"./ThreadSkeleton\", {\n  default(v) {\n    ThreadSkeleton = v;\n  }\n\n}, 14);\nlet ThreadView;\nmodule.link(\"./ThreadView\", {\n  default(v) {\n    ThreadView = v;\n  }\n\n}, 15);\nconst subscriptionFields = {};\n\nconst useThreadMessage = tmid => {\n  const [message, setMessage] = useState(() => Tracker.nonreactive(() => ChatMessage.findOne({\n    _id: tmid\n  })));\n  const getMessage = useEndpoint('GET', 'chat.getMessage');\n  const getMessageParsed = useCallback(async params => {\n    const {\n      message\n    } = await getMessage(params);\n    return mapMessageFromApi(message);\n  }, [getMessage]);\n  useEffect(() => {\n    const computation = Tracker.autorun(async computation => {\n      const msg = ChatMessage.findOne({\n        _id: tmid\n      }) || (await getMessageParsed({\n        msgId: tmid\n      }));\n\n      if (!msg || computation.stopped) {\n        return;\n      }\n\n      setMessage(prevMsg => {\n        var _prevMsg$_updatedAt, _msg$_updatedAt;\n\n        if (!prevMsg || prevMsg._id !== msg._id || ((_prevMsg$_updatedAt = prevMsg._updatedAt) === null || _prevMsg$_updatedAt === void 0 ? void 0 : _prevMsg$_updatedAt.getTime()) !== ((_msg$_updatedAt = msg._updatedAt) === null || _msg$_updatedAt === void 0 ? void 0 : _msg$_updatedAt.getTime())) {\n          return msg;\n        }\n\n        return prevMsg;\n      });\n    });\n    return () => {\n      computation.stop();\n    };\n  }, [getMessageParsed, tmid]);\n  return message;\n};\n\nconst ThreadComponent = _ref => {\n  var _threadMessage$replie, _threadMessage$replie2;\n\n  let {\n    mid,\n    jump,\n    room,\n    onClickBack\n  } = _ref;\n  const subscription = useUserSubscription(room._id, subscriptionFields);\n  const channelRoute = useRoute(roomCoordinator.getRoomTypeConfig(room.t).route.name);\n  const threadMessage = useThreadMessage(mid);\n  const openUserInfo = useTabBarOpenUserInfo();\n  const ref = useRef(null);\n  const uid = useUserId();\n  const headerTitle = useMemo(() => threadMessage ? normalizeThreadTitle(threadMessage) : null, [threadMessage]);\n  const [expanded, setExpand] = useLocalStorage('expand-threads', false);\n  const following = !uid ? false : (_threadMessage$replie = threadMessage === null || threadMessage === void 0 ? void 0 : (_threadMessage$replie2 = threadMessage.replies) === null || _threadMessage$replie2 === void 0 ? void 0 : _threadMessage$replie2.includes(uid)) !== null && _threadMessage$replie !== void 0 ? _threadMessage$replie : false;\n  const dispatchToastMessage = useToastMessageDispatch();\n  const followMessage = useMethod('followMessage');\n  const unfollowMessage = useMethod('unfollowMessage');\n  const setFollowing = useCallback(async following => {\n    try {\n      if (following) {\n        await followMessage({\n          mid\n        });\n        return;\n      }\n\n      await unfollowMessage({\n        mid\n      });\n    } catch (error) {\n      dispatchToastMessage({\n        type: 'error',\n        message: error\n      });\n    }\n  }, [dispatchToastMessage, followMessage, unfollowMessage, mid]);\n  const handleClose = useCallback(() => {\n    channelRoute.push(room.t === 'd' ? {\n      rid: room._id\n    } : {\n      name: room.name || room._id\n    });\n  }, [channelRoute, room._id, room.t, room.name]);\n  const [viewData, setViewData] = useState(() => ({\n    mainMessage: threadMessage,\n    jump,\n    following,\n    subscription,\n    rid: room._id,\n    tabBar: {\n      openUserInfo\n    }\n  }));\n  useEffect(() => {\n    setViewData(viewData => {\n      var _viewData$mainMessage;\n\n      if (!threadMessage || ((_viewData$mainMessage = viewData.mainMessage) === null || _viewData$mainMessage === void 0 ? void 0 : _viewData$mainMessage._id) === threadMessage._id) {\n        return viewData;\n      }\n\n      return {\n        mainMessage: threadMessage,\n        jump,\n        following,\n        subscription,\n        rid: room._id,\n        tabBar: {\n          openUserInfo\n        }\n      };\n    });\n  }, [following, jump, openUserInfo, room._id, subscription, threadMessage]);\n  useEffect(() => {\n    if (!ref.current || !viewData.mainMessage) {\n      return;\n    }\n\n    const view = Blaze.renderWithData(Template.thread, viewData, ref.current);\n    return () => {\n      Blaze.remove(view);\n    };\n  }, [viewData]);\n\n  if (!threadMessage) {\n    return /*#__PURE__*/React.createElement(ThreadSkeleton, {\n      expanded: expanded,\n      onClose: handleClose\n    });\n  }\n\n  return /*#__PURE__*/React.createElement(ThreadView, {\n    ref: ref,\n    title: headerTitle,\n    expanded: expanded,\n    following: following,\n    onToggleExpand: expanded => setExpand(!expanded),\n    onToggleFollow: following => setFollowing(!following),\n    onClose: handleClose,\n    onClickBack: onClickBack\n  });\n};\n\nmodule.exportDefault(ThreadComponent);","map":{"version":3,"sources":["client/views/room/threads/ThreadComponent.tsx"],"names":[],"mappings":"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","sourcesContent":["import { useLocalStorage } from '@rocket.chat/fuselage-hooks';\nimport { Blaze } from 'meteor/blaze';\nimport { Template } from 'meteor/templating';\nimport { Tracker } from 'meteor/tracker';\nimport React, { useEffect, useRef, useState, useCallback, useMemo, FC } from 'react';\n\nimport { ChatMessage } from '../../../../app/models/client';\nimport { normalizeThreadTitle } from '../../../../app/threads/client/lib/normalizeThreadTitle';\nimport { IMessage } from '../../../../definition/IMessage';\nimport { IRoom } from '../../../../definition/IRoom';\nimport { useRoute } from '../../../contexts/RouterContext';\nimport { useEndpoint, useMethod } from '../../../contexts/ServerContext';\nimport { useToastMessageDispatch } from '../../../contexts/ToastMessagesContext';\nimport { useUserId, useUserSubscription } from '../../../contexts/UserContext';\nimport { roomCoordinator } from '../../../lib/rooms/roomCoordinator';\nimport { mapMessageFromApi } from '../../../lib/utils/mapMessageFromApi';\nimport { useTabBarOpenUserInfo } from '../providers/ToolboxProvider';\nimport ThreadSkeleton from './ThreadSkeleton';\nimport ThreadView from './ThreadView';\n\nconst subscriptionFields = {};\n\nconst useThreadMessage = (tmid: string): IMessage => {\n\tconst [message, setMessage] = useState<IMessage>(() => Tracker.nonreactive(() => ChatMessage.findOne({ _id: tmid })));\n\tconst getMessage = useEndpoint('GET', 'chat.getMessage');\n\tconst getMessageParsed = useCallback<(params: { msgId: IMessage['_id'] }) => Promise<IMessage>>(\n\t\tasync (params) => {\n\t\t\tconst { message } = await getMessage(params);\n\t\t\treturn mapMessageFromApi(message);\n\t\t},\n\t\t[getMessage],\n\t);\n\n\tuseEffect(() => {\n\t\tconst computation = Tracker.autorun(async (computation) => {\n\t\t\tconst msg = ChatMessage.findOne({ _id: tmid }) || (await getMessageParsed({ msgId: tmid }));\n\n\t\t\tif (!msg || computation.stopped) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tsetMessage((prevMsg) => {\n\t\t\t\tif (!prevMsg || prevMsg._id !== msg._id || prevMsg._updatedAt?.getTime() !== msg._updatedAt?.getTime()) {\n\t\t\t\t\treturn msg;\n\t\t\t\t}\n\n\t\t\t\treturn prevMsg;\n\t\t\t});\n\t\t});\n\n\t\treturn (): void => {\n\t\t\tcomputation.stop();\n\t\t};\n\t}, [getMessageParsed, tmid]);\n\n\treturn message;\n};\n\nconst ThreadComponent: FC<{\n\tmid: string;\n\tjump: unknown;\n\troom: IRoom;\n\tonClickBack: (e: unknown) => void;\n}> = ({ mid, jump, room, onClickBack }) => {\n\tconst subscription = useUserSubscription(room._id, subscriptionFields);\n\tconst channelRoute = useRoute(roomCoordinator.getRoomTypeConfig(room.t).route.name);\n\tconst threadMessage = useThreadMessage(mid);\n\n\tconst openUserInfo = useTabBarOpenUserInfo();\n\n\tconst ref = useRef<HTMLElement>(null);\n\tconst uid = useUserId();\n\n\tconst headerTitle = useMemo(() => (threadMessage ? normalizeThreadTitle(threadMessage) : null), [threadMessage]);\n\tconst [expanded, setExpand] = useLocalStorage('expand-threads', false);\n\tconst following = !uid ? false : threadMessage?.replies?.includes(uid) ?? false;\n\n\tconst dispatchToastMessage = useToastMessageDispatch();\n\tconst followMessage = useMethod('followMessage');\n\tconst unfollowMessage = useMethod('unfollowMessage');\n\n\tconst setFollowing = useCallback<(following: boolean) => void>(\n\t\tasync (following) => {\n\t\t\ttry {\n\t\t\t\tif (following) {\n\t\t\t\t\tawait followMessage({ mid });\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tawait unfollowMessage({ mid });\n\t\t\t} catch (error) {\n\t\t\t\tdispatchToastMessage({\n\t\t\t\t\ttype: 'error',\n\t\t\t\t\tmessage: error,\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\t\t[dispatchToastMessage, followMessage, unfollowMessage, mid],\n\t);\n\n\tconst handleClose = useCallback(() => {\n\t\tchannelRoute.push(room.t === 'd' ? { rid: room._id } : { name: room.name || room._id });\n\t}, [channelRoute, room._id, room.t, room.name]);\n\n\tconst [viewData, setViewData] = useState(() => ({\n\t\tmainMessage: threadMessage,\n\t\tjump,\n\t\tfollowing,\n\t\tsubscription,\n\t\trid: room._id,\n\t\ttabBar: { openUserInfo },\n\t}));\n\n\tuseEffect(() => {\n\t\tsetViewData((viewData) => {\n\t\t\tif (!threadMessage || viewData.mainMessage?._id === threadMessage._id) {\n\t\t\t\treturn viewData;\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tmainMessage: threadMessage,\n\t\t\t\tjump,\n\t\t\t\tfollowing,\n\t\t\t\tsubscription,\n\t\t\t\trid: room._id,\n\t\t\t\ttabBar: { openUserInfo },\n\t\t\t};\n\t\t});\n\t}, [following, jump, openUserInfo, room._id, subscription, threadMessage]);\n\n\tuseEffect(() => {\n\t\tif (!ref.current || !viewData.mainMessage) {\n\t\t\treturn;\n\t\t}\n\t\tconst view = Blaze.renderWithData(Template.thread, viewData, ref.current);\n\n\t\treturn (): void => {\n\t\t\tBlaze.remove(view);\n\t\t};\n\t}, [viewData]);\n\n\tif (!threadMessage) {\n\t\treturn <ThreadSkeleton expanded={expanded} onClose={handleClose} />;\n\t}\n\n\treturn (\n\t\t<ThreadView\n\t\t\tref={ref}\n\t\t\ttitle={headerTitle}\n\t\t\texpanded={expanded}\n\t\t\tfollowing={following}\n\t\t\tonToggleExpand={(expanded): void => setExpand(!expanded)}\n\t\t\tonToggleFollow={(following): void => setFollowing(!following)}\n\t\t\tonClose={handleClose}\n\t\t\tonClickBack={onClickBack}\n\t\t/>\n\t);\n};\n\nexport default ThreadComponent;\n"],"sourceRoot":""},"sourceType":"module","hash":"811bc3ddf6bc903b2c7ffac54512d689c60841cf"}
