{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/views/room/contextualBar/Apps/AppsWithData.tsx","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"client/views/room/contextualBar/Apps/AppsWithData.tsx","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/views/room/contextualBar/Apps/AppsWithData.tsx","inputSourceMap":{"version":3,"file":"client/views/room/contextualBar/Apps/AppsWithData.tsx","sourceRoot":"","sources":["client/views/room/contextualBar/Apps/AppsWithData.tsx"],"names":[],"mappings":"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","sourcesContent":["import {\n\tIUIKitContextualBarInteraction,\n\tIUIKitErrorInteraction,\n\tIUIKitSurface,\n\tIInputElement,\n\tIInputBlock,\n\tIBlock,\n\tIBlockElement,\n\tIActionsBlock,\n} from '@rocket.chat/apps-engine/definition/uikit';\nimport { UIKitIncomingInteractionContainerType } from '@rocket.chat/apps-engine/definition/uikit/UIKitIncomingInteractionContainer';\nimport { useMutableCallback } from '@rocket.chat/fuselage-hooks';\nimport { kitContext } from '@rocket.chat/fuselage-ui-kit';\nimport React, { memo, useState, useEffect, useReducer, Dispatch, SyntheticEvent } from 'react';\n\nimport { triggerBlockAction, triggerCancel, triggerSubmitView, on, off } from '../../../../../app/ui-message/client/ActionManager';\nimport { App } from '../../../admin/apps/types';\nimport { useTabBarClose } from '../../providers/ToolboxProvider';\nimport Apps from './Apps';\n\ntype FieldStateValue = string | Array<string> | undefined;\ntype FieldState = { value: FieldStateValue; blockId: string };\ntype InputFieldStateTuple = [string, FieldState];\ntype InputFieldStateObject = { [key: string]: FieldState };\ntype InputFieldStateByBlockId = { [blockId: string]: { [actionId: string]: FieldStateValue } };\ntype ActionParams = {\n\tblockId: string;\n\tappId: string;\n\tactionId: string;\n\tvalue: unknown;\n\tviewId?: string;\n};\n\ntype ViewState = IUIKitContextualBarInteraction & {\n\terrors?: { [field: string]: string };\n};\n\nconst isInputBlock = (block: any): block is IInputBlock => block?.element?.initialValue;\n\nconst useValues = (view: IUIKitSurface): [any, Dispatch<any>] => {\n\tconst reducer = useMutableCallback((values, { actionId, payload }) => ({\n\t\t...values,\n\t\t[actionId]: payload,\n\t}));\n\n\tconst initializer = useMutableCallback(() => {\n\t\tconst filterInputFields = (block: IBlock): boolean => {\n\t\t\tif (isInputBlock(block)) {\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\t((block as IActionsBlock).elements as IInputElement[])?.filter((element) => filterInputFields({ element } as IInputBlock)).length\n\t\t\t) {\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\treturn false;\n\t\t};\n\n\t\tconst mapElementToState = (block: IBlock): InputFieldStateTuple | InputFieldStateTuple[] => {\n\t\t\tif (isInputBlock(block)) {\n\t\t\t\tconst { element, blockId } = block;\n\t\t\t\treturn [element.actionId, { value: element.initialValue, blockId } as FieldState];\n\t\t\t}\n\n\t\t\tconst { elements, blockId }: { elements: IBlockElement[]; blockId?: string } = block as IActionsBlock;\n\n\t\t\treturn elements\n\t\t\t\t.filter((element) => filterInputFields({ element } as IInputBlock))\n\t\t\t\t.map((element) => mapElementToState({ element, blockId } as IInputBlock)) as InputFieldStateTuple[];\n\t\t};\n\n\t\treturn view.blocks\n\t\t\t.filter(filterInputFields)\n\t\t\t.map(mapElementToState)\n\t\t\t.reduce((obj: InputFieldStateObject, el: InputFieldStateTuple | InputFieldStateTuple[]) => {\n\t\t\t\tif (Array.isArray(el[0])) {\n\t\t\t\t\treturn { ...obj, ...Object.fromEntries(el as InputFieldStateTuple[]) };\n\t\t\t\t}\n\n\t\t\t\tconst [key, value] = el as InputFieldStateTuple;\n\t\t\t\treturn { ...obj, [key]: value };\n\t\t\t}, {} as InputFieldStateObject);\n\t});\n\n\treturn useReducer(reducer, null, initializer);\n};\n\nconst AppsWithData = ({\n\tviewId,\n\troomId,\n\tpayload,\n\tappInfo,\n}: {\n\tviewId: string;\n\troomId: string;\n\tpayload: IUIKitContextualBarInteraction;\n\tappInfo: App;\n}): JSX.Element => {\n\tconst closeTabBar = useTabBarClose();\n\n\tconst { id: appId, name: appName } = appInfo;\n\tconst [state, setState] = useState<ViewState>(payload);\n\tconst { view } = state;\n\tconst [values, updateValues] = useValues(view);\n\n\tuseEffect(() => {\n\t\tconst handleUpdate = ({ type, ...data }: IUIKitContextualBarInteraction | IUIKitErrorInteraction): void => {\n\t\t\tif (type === 'errors') {\n\t\t\t\tconst { errors } = data as Omit<IUIKitErrorInteraction, 'type'>;\n\t\t\t\tsetState((state: ViewState) => ({ ...state, errors }));\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tsetState(data as IUIKitContextualBarInteraction);\n\t\t};\n\n\t\ton(viewId, handleUpdate);\n\n\t\treturn (): void => {\n\t\t\toff(viewId, handleUpdate);\n\t\t};\n\t}, [state, viewId]);\n\n\tconst groupStateByBlockId = (obj: InputFieldStateObject): InputFieldStateByBlockId =>\n\t\tObject.entries(obj).reduce((obj: InputFieldStateByBlockId, [key, { blockId, value }]: InputFieldStateTuple) => {\n\t\t\tobj[blockId] = obj[blockId] || {};\n\t\t\tobj[blockId][key] = value;\n\t\t\treturn obj;\n\t\t}, {} as InputFieldStateByBlockId);\n\n\tconst prevent = (e: SyntheticEvent): void => {\n\t\tif (e) {\n\t\t\t(e.nativeEvent || e).stopImmediatePropagation();\n\t\t\te.stopPropagation();\n\t\t\te.preventDefault();\n\t\t}\n\t};\n\n\tconst context = {\n\t\taction: ({ actionId, appId, value, blockId }: ActionParams): Promise<void> =>\n\t\t\ttriggerBlockAction({\n\t\t\t\tcontainer: {\n\t\t\t\t\ttype: UIKitIncomingInteractionContainerType.VIEW,\n\t\t\t\t\tid: viewId,\n\t\t\t\t},\n\t\t\t\tactionId,\n\t\t\t\tappId,\n\t\t\t\trid: roomId,\n\t\t\t\tvalue,\n\t\t\t\tblockId,\n\t\t\t}),\n\t\tstate: ({ actionId, value, blockId = 'default' }: ActionParams): void => {\n\t\t\tupdateValues({\n\t\t\t\tactionId,\n\t\t\t\tpayload: {\n\t\t\t\t\tblockId,\n\t\t\t\t\tvalue,\n\t\t\t\t},\n\t\t\t});\n\t\t},\n\t\t...state,\n\t\tvalues,\n\t};\n\n\tconst handleSubmit = useMutableCallback((e) => {\n\t\tprevent(e);\n\t\tcloseTabBar(e);\n\t\ttriggerSubmitView({\n\t\t\tviewId,\n\t\t\tappId,\n\t\t\tpayload: {\n\t\t\t\tview: {\n\t\t\t\t\t...view,\n\t\t\t\t\tid: viewId,\n\t\t\t\t\tstate: groupStateByBlockId(values),\n\t\t\t\t},\n\t\t\t},\n\t\t});\n\t});\n\n\tconst handleCancel = useMutableCallback((e) => {\n\t\tprevent(e);\n\t\tcloseTabBar(e);\n\t\treturn triggerCancel({\n\t\t\tappId,\n\t\t\tviewId,\n\t\t\tview: {\n\t\t\t\t...view,\n\t\t\t\tid: viewId,\n\t\t\t\tstate: groupStateByBlockId(values),\n\t\t\t},\n\t\t});\n\t});\n\n\tconst handleClose = useMutableCallback((e) => {\n\t\tprevent(e);\n\t\tcloseTabBar(e);\n\t\treturn triggerCancel({\n\t\t\tappId,\n\t\t\tviewId,\n\t\t\tview: {\n\t\t\t\t...view,\n\t\t\t\tid: viewId,\n\t\t\t\tstate: groupStateByBlockId(values),\n\t\t\t},\n\t\t\tisCleared: true,\n\t\t});\n\t});\n\n\treturn (\n\t\t<kitContext.Provider value={context}>\n\t\t\t<Apps onClose={handleClose} onCancel={handleCancel} onSubmit={handleSubmit} view={view} appInfo={{ name: appName, id: appId }} />\n\t\t</kitContext.Provider>\n\t);\n};\n\nexport default memo(AppsWithData);\n"]},"targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/views/room/contextualBar/Apps/AppsWithData.tsx","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/views/room/contextualBar/Apps/AppsWithData.tsx"}},"code":"const _excluded = [\"type\"];\n\nlet _objectWithoutProperties;\n\nmodule.link(\"@babel/runtime/helpers/objectWithoutProperties\", {\n  default(v) {\n    _objectWithoutProperties = v;\n  }\n\n}, 0);\n\nlet _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default(v) {\n    _objectSpread = v;\n  }\n\n}, 1);\nlet UIKitIncomingInteractionContainerType;\nmodule.link(\"@rocket.chat/apps-engine/definition/uikit/UIKitIncomingInteractionContainer\", {\n  UIKitIncomingInteractionContainerType(v) {\n    UIKitIncomingInteractionContainerType = v;\n  }\n\n}, 0);\nlet useMutableCallback;\nmodule.link(\"@rocket.chat/fuselage-hooks\", {\n  useMutableCallback(v) {\n    useMutableCallback = v;\n  }\n\n}, 1);\nlet kitContext;\nmodule.link(\"@rocket.chat/fuselage-ui-kit\", {\n  kitContext(v) {\n    kitContext = v;\n  }\n\n}, 2);\nlet React, memo, useState, useEffect, useReducer;\nmodule.link(\"react\", {\n  default(v) {\n    React = v;\n  },\n\n  memo(v) {\n    memo = v;\n  },\n\n  useState(v) {\n    useState = v;\n  },\n\n  useEffect(v) {\n    useEffect = v;\n  },\n\n  useReducer(v) {\n    useReducer = v;\n  }\n\n}, 3);\nlet triggerBlockAction, triggerCancel, triggerSubmitView, on, off;\nmodule.link(\"../../../../../app/ui-message/client/ActionManager\", {\n  triggerBlockAction(v) {\n    triggerBlockAction = v;\n  },\n\n  triggerCancel(v) {\n    triggerCancel = v;\n  },\n\n  triggerSubmitView(v) {\n    triggerSubmitView = v;\n  },\n\n  on(v) {\n    on = v;\n  },\n\n  off(v) {\n    off = v;\n  }\n\n}, 4);\nlet useTabBarClose;\nmodule.link(\"../../providers/ToolboxProvider\", {\n  useTabBarClose(v) {\n    useTabBarClose = v;\n  }\n\n}, 5);\nlet Apps;\nmodule.link(\"./Apps\", {\n  default(v) {\n    Apps = v;\n  }\n\n}, 6);\n\nconst isInputBlock = block => {\n  var _block$element;\n\n  return block === null || block === void 0 ? void 0 : (_block$element = block.element) === null || _block$element === void 0 ? void 0 : _block$element.initialValue;\n};\n\nconst useValues = view => {\n  const reducer = useMutableCallback((values, _ref) => {\n    let {\n      actionId,\n      payload\n    } = _ref;\n    return _objectSpread(_objectSpread({}, values), {}, {\n      [actionId]: payload\n    });\n  });\n  const initializer = useMutableCallback(() => {\n    const filterInputFields = block => {\n      var _block$elements;\n\n      if (isInputBlock(block)) {\n        return true;\n      }\n\n      if ((_block$elements = block.elements) !== null && _block$elements !== void 0 && _block$elements.filter(element => filterInputFields({\n        element\n      })).length) {\n        return true;\n      }\n\n      return false;\n    };\n\n    const mapElementToState = block => {\n      if (isInputBlock(block)) {\n        const {\n          element,\n          blockId\n        } = block;\n        return [element.actionId, {\n          value: element.initialValue,\n          blockId\n        }];\n      }\n\n      const {\n        elements,\n        blockId\n      } = block;\n      return elements.filter(element => filterInputFields({\n        element\n      })).map(element => mapElementToState({\n        element,\n        blockId\n      }));\n    };\n\n    return view.blocks.filter(filterInputFields).map(mapElementToState).reduce((obj, el) => {\n      if (Array.isArray(el[0])) {\n        return _objectSpread(_objectSpread({}, obj), Object.fromEntries(el));\n      }\n\n      const [key, value] = el;\n      return _objectSpread(_objectSpread({}, obj), {}, {\n        [key]: value\n      });\n    }, {});\n  });\n  return useReducer(reducer, null, initializer);\n};\n\nconst AppsWithData = _ref2 => {\n  let {\n    viewId,\n    roomId,\n    payload,\n    appInfo\n  } = _ref2;\n  const closeTabBar = useTabBarClose();\n  const {\n    id: appId,\n    name: appName\n  } = appInfo;\n  const [state, setState] = useState(payload);\n  const {\n    view\n  } = state;\n  const [values, updateValues] = useValues(view);\n  useEffect(() => {\n    const handleUpdate = _ref3 => {\n      let {\n        type\n      } = _ref3,\n          data = _objectWithoutProperties(_ref3, _excluded);\n\n      if (type === 'errors') {\n        const {\n          errors\n        } = data;\n        setState(state => _objectSpread(_objectSpread({}, state), {}, {\n          errors\n        }));\n        return;\n      }\n\n      setState(data);\n    };\n\n    on(viewId, handleUpdate);\n    return () => {\n      off(viewId, handleUpdate);\n    };\n  }, [state, viewId]);\n\n  const groupStateByBlockId = obj => Object.entries(obj).reduce((obj, _ref4) => {\n    let [key, {\n      blockId,\n      value\n    }] = _ref4;\n    obj[blockId] = obj[blockId] || {};\n    obj[blockId][key] = value;\n    return obj;\n  }, {});\n\n  const prevent = e => {\n    if (e) {\n      (e.nativeEvent || e).stopImmediatePropagation();\n      e.stopPropagation();\n      e.preventDefault();\n    }\n  };\n\n  const context = _objectSpread(_objectSpread({\n    action: _ref5 => {\n      let {\n        actionId,\n        appId,\n        value,\n        blockId\n      } = _ref5;\n      return triggerBlockAction({\n        container: {\n          type: UIKitIncomingInteractionContainerType.VIEW,\n          id: viewId\n        },\n        actionId,\n        appId,\n        rid: roomId,\n        value,\n        blockId\n      });\n    },\n    state: _ref6 => {\n      let {\n        actionId,\n        value,\n        blockId = 'default'\n      } = _ref6;\n      updateValues({\n        actionId,\n        payload: {\n          blockId,\n          value\n        }\n      });\n    }\n  }, state), {}, {\n    values\n  });\n\n  const handleSubmit = useMutableCallback(e => {\n    prevent(e);\n    closeTabBar(e);\n    triggerSubmitView({\n      viewId,\n      appId,\n      payload: {\n        view: _objectSpread(_objectSpread({}, view), {}, {\n          id: viewId,\n          state: groupStateByBlockId(values)\n        })\n      }\n    });\n  });\n  const handleCancel = useMutableCallback(e => {\n    prevent(e);\n    closeTabBar(e);\n    return triggerCancel({\n      appId,\n      viewId,\n      view: _objectSpread(_objectSpread({}, view), {}, {\n        id: viewId,\n        state: groupStateByBlockId(values)\n      })\n    });\n  });\n  const handleClose = useMutableCallback(e => {\n    prevent(e);\n    closeTabBar(e);\n    return triggerCancel({\n      appId,\n      viewId,\n      view: _objectSpread(_objectSpread({}, view), {}, {\n        id: viewId,\n        state: groupStateByBlockId(values)\n      }),\n      isCleared: true\n    });\n  });\n  return /*#__PURE__*/React.createElement(kitContext.Provider, {\n    value: context\n  }, /*#__PURE__*/React.createElement(Apps, {\n    onClose: handleClose,\n    onCancel: handleCancel,\n    onSubmit: handleSubmit,\n    view: view,\n    appInfo: {\n      name: appName,\n      id: appId\n    }\n  }));\n};\n\nmodule.exportDefault( /*#__PURE__*/memo(AppsWithData));","map":{"version":3,"sources":["client/views/room/contextualBar/Apps/AppsWithData.tsx"],"names":[],"mappings":"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","sourcesContent":["import {\n\tIUIKitContextualBarInteraction,\n\tIUIKitErrorInteraction,\n\tIUIKitSurface,\n\tIInputElement,\n\tIInputBlock,\n\tIBlock,\n\tIBlockElement,\n\tIActionsBlock,\n} from '@rocket.chat/apps-engine/definition/uikit';\nimport { UIKitIncomingInteractionContainerType } from '@rocket.chat/apps-engine/definition/uikit/UIKitIncomingInteractionContainer';\nimport { useMutableCallback } from '@rocket.chat/fuselage-hooks';\nimport { kitContext } from '@rocket.chat/fuselage-ui-kit';\nimport React, { memo, useState, useEffect, useReducer, Dispatch, SyntheticEvent } from 'react';\n\nimport { triggerBlockAction, triggerCancel, triggerSubmitView, on, off } from '../../../../../app/ui-message/client/ActionManager';\nimport { App } from '../../../admin/apps/types';\nimport { useTabBarClose } from '../../providers/ToolboxProvider';\nimport Apps from './Apps';\n\ntype FieldStateValue = string | Array<string> | undefined;\ntype FieldState = { value: FieldStateValue; blockId: string };\ntype InputFieldStateTuple = [string, FieldState];\ntype InputFieldStateObject = { [key: string]: FieldState };\ntype InputFieldStateByBlockId = { [blockId: string]: { [actionId: string]: FieldStateValue } };\ntype ActionParams = {\n\tblockId: string;\n\tappId: string;\n\tactionId: string;\n\tvalue: unknown;\n\tviewId?: string;\n};\n\ntype ViewState = IUIKitContextualBarInteraction & {\n\terrors?: { [field: string]: string };\n};\n\nconst isInputBlock = (block: any): block is IInputBlock => block?.element?.initialValue;\n\nconst useValues = (view: IUIKitSurface): [any, Dispatch<any>] => {\n\tconst reducer = useMutableCallback((values, { actionId, payload }) => ({\n\t\t...values,\n\t\t[actionId]: payload,\n\t}));\n\n\tconst initializer = useMutableCallback(() => {\n\t\tconst filterInputFields = (block: IBlock): boolean => {\n\t\t\tif (isInputBlock(block)) {\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\t((block as IActionsBlock).elements as IInputElement[])?.filter((element) => filterInputFields({ element } as IInputBlock)).length\n\t\t\t) {\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\treturn false;\n\t\t};\n\n\t\tconst mapElementToState = (block: IBlock): InputFieldStateTuple | InputFieldStateTuple[] => {\n\t\t\tif (isInputBlock(block)) {\n\t\t\t\tconst { element, blockId } = block;\n\t\t\t\treturn [element.actionId, { value: element.initialValue, blockId } as FieldState];\n\t\t\t}\n\n\t\t\tconst { elements, blockId }: { elements: IBlockElement[]; blockId?: string } = block as IActionsBlock;\n\n\t\t\treturn elements\n\t\t\t\t.filter((element) => filterInputFields({ element } as IInputBlock))\n\t\t\t\t.map((element) => mapElementToState({ element, blockId } as IInputBlock)) as InputFieldStateTuple[];\n\t\t};\n\n\t\treturn view.blocks\n\t\t\t.filter(filterInputFields)\n\t\t\t.map(mapElementToState)\n\t\t\t.reduce((obj: InputFieldStateObject, el: InputFieldStateTuple | InputFieldStateTuple[]) => {\n\t\t\t\tif (Array.isArray(el[0])) {\n\t\t\t\t\treturn { ...obj, ...Object.fromEntries(el as InputFieldStateTuple[]) };\n\t\t\t\t}\n\n\t\t\t\tconst [key, value] = el as InputFieldStateTuple;\n\t\t\t\treturn { ...obj, [key]: value };\n\t\t\t}, {} as InputFieldStateObject);\n\t});\n\n\treturn useReducer(reducer, null, initializer);\n};\n\nconst AppsWithData = ({\n\tviewId,\n\troomId,\n\tpayload,\n\tappInfo,\n}: {\n\tviewId: string;\n\troomId: string;\n\tpayload: IUIKitContextualBarInteraction;\n\tappInfo: App;\n}): JSX.Element => {\n\tconst closeTabBar = useTabBarClose();\n\n\tconst { id: appId, name: appName } = appInfo;\n\tconst [state, setState] = useState<ViewState>(payload);\n\tconst { view } = state;\n\tconst [values, updateValues] = useValues(view);\n\n\tuseEffect(() => {\n\t\tconst handleUpdate = ({ type, ...data }: IUIKitContextualBarInteraction | IUIKitErrorInteraction): void => {\n\t\t\tif (type === 'errors') {\n\t\t\t\tconst { errors } = data as Omit<IUIKitErrorInteraction, 'type'>;\n\t\t\t\tsetState((state: ViewState) => ({ ...state, errors }));\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tsetState(data as IUIKitContextualBarInteraction);\n\t\t};\n\n\t\ton(viewId, handleUpdate);\n\n\t\treturn (): void => {\n\t\t\toff(viewId, handleUpdate);\n\t\t};\n\t}, [state, viewId]);\n\n\tconst groupStateByBlockId = (obj: InputFieldStateObject): InputFieldStateByBlockId =>\n\t\tObject.entries(obj).reduce((obj: InputFieldStateByBlockId, [key, { blockId, value }]: InputFieldStateTuple) => {\n\t\t\tobj[blockId] = obj[blockId] || {};\n\t\t\tobj[blockId][key] = value;\n\t\t\treturn obj;\n\t\t}, {} as InputFieldStateByBlockId);\n\n\tconst prevent = (e: SyntheticEvent): void => {\n\t\tif (e) {\n\t\t\t(e.nativeEvent || e).stopImmediatePropagation();\n\t\t\te.stopPropagation();\n\t\t\te.preventDefault();\n\t\t}\n\t};\n\n\tconst context = {\n\t\taction: ({ actionId, appId, value, blockId }: ActionParams): Promise<void> =>\n\t\t\ttriggerBlockAction({\n\t\t\t\tcontainer: {\n\t\t\t\t\ttype: UIKitIncomingInteractionContainerType.VIEW,\n\t\t\t\t\tid: viewId,\n\t\t\t\t},\n\t\t\t\tactionId,\n\t\t\t\tappId,\n\t\t\t\trid: roomId,\n\t\t\t\tvalue,\n\t\t\t\tblockId,\n\t\t\t}),\n\t\tstate: ({ actionId, value, blockId = 'default' }: ActionParams): void => {\n\t\t\tupdateValues({\n\t\t\t\tactionId,\n\t\t\t\tpayload: {\n\t\t\t\t\tblockId,\n\t\t\t\t\tvalue,\n\t\t\t\t},\n\t\t\t});\n\t\t},\n\t\t...state,\n\t\tvalues,\n\t};\n\n\tconst handleSubmit = useMutableCallback((e) => {\n\t\tprevent(e);\n\t\tcloseTabBar(e);\n\t\ttriggerSubmitView({\n\t\t\tviewId,\n\t\t\tappId,\n\t\t\tpayload: {\n\t\t\t\tview: {\n\t\t\t\t\t...view,\n\t\t\t\t\tid: viewId,\n\t\t\t\t\tstate: groupStateByBlockId(values),\n\t\t\t\t},\n\t\t\t},\n\t\t});\n\t});\n\n\tconst handleCancel = useMutableCallback((e) => {\n\t\tprevent(e);\n\t\tcloseTabBar(e);\n\t\treturn triggerCancel({\n\t\t\tappId,\n\t\t\tviewId,\n\t\t\tview: {\n\t\t\t\t...view,\n\t\t\t\tid: viewId,\n\t\t\t\tstate: groupStateByBlockId(values),\n\t\t\t},\n\t\t});\n\t});\n\n\tconst handleClose = useMutableCallback((e) => {\n\t\tprevent(e);\n\t\tcloseTabBar(e);\n\t\treturn triggerCancel({\n\t\t\tappId,\n\t\t\tviewId,\n\t\t\tview: {\n\t\t\t\t...view,\n\t\t\t\tid: viewId,\n\t\t\t\tstate: groupStateByBlockId(values),\n\t\t\t},\n\t\t\tisCleared: true,\n\t\t});\n\t});\n\n\treturn (\n\t\t<kitContext.Provider value={context}>\n\t\t\t<Apps onClose={handleClose} onCancel={handleCancel} onSubmit={handleSubmit} view={view} appInfo={{ name: appName, id: appId }} />\n\t\t</kitContext.Provider>\n\t);\n};\n\nexport default memo(AppsWithData);\n"],"sourceRoot":""},"sourceType":"module","hash":"4d4883da11db54c17c145f76e1f1018a39c1fbaa"}
