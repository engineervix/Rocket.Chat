{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/views/admin/viewLogs/ServerLogs.tsx","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"client/views/admin/viewLogs/ServerLogs.tsx","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/views/admin/viewLogs/ServerLogs.tsx","inputSourceMap":{"version":3,"file":"client/views/admin/viewLogs/ServerLogs.tsx","sourceRoot":"","sources":["client/views/admin/viewLogs/ServerLogs.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Box, Icon, Scrollable } from '@rocket.chat/fuselage';\nimport React, { useEffect, useRef, useState, useCallback, ReactElement } from 'react';\n\nimport { Serialized } from '../../../../definition/Serialized';\nimport { useEndpoint, useStream } from '../../../contexts/ServerContext';\nimport { useToastMessageDispatch } from '../../../contexts/ToastMessagesContext';\nimport { useTranslation } from '../../../contexts/TranslationContext';\nimport { ansispan } from './ansispan';\n\ntype StdOutLogEntry = {\n\tid: string;\n\tstring: string;\n\tts: Date;\n};\n\nconst compareEntries = (a: StdOutLogEntry, b: StdOutLogEntry): number => a.ts.getTime() - b.ts.getTime();\n\nconst unserializeEntry = ({ ts, ...entry }: Serialized<StdOutLogEntry>): StdOutLogEntry => ({\n\tts: new Date(ts),\n\t...entry,\n});\n\nconst ServerLogs = (): ReactElement => {\n\tconst [entries, setEntries] = useState<StdOutLogEntry[]>([]);\n\n\tconst dispatchToastMessage = useToastMessageDispatch();\n\n\tconst getStdoutQueue = useEndpoint('GET', 'stdout.queue');\n\tconst subscribeToStdout = useStream('stdout');\n\n\tuseEffect(() => {\n\t\tconst fetchLines = async (): Promise<void> => {\n\t\t\ttry {\n\t\t\t\tconst { queue } = await getStdoutQueue(undefined);\n\t\t\t\tsetEntries(queue.map(unserializeEntry).sort(compareEntries));\n\t\t\t} catch (error) {\n\t\t\t\tdispatchToastMessage({ type: 'error', message: error });\n\t\t\t}\n\t\t};\n\n\t\tfetchLines();\n\t}, [dispatchToastMessage, getStdoutQueue]);\n\n\tuseEffect(\n\t\t() =>\n\t\t\tsubscribeToStdout('stdout', (entry: StdOutLogEntry) => {\n\t\t\t\tsetEntries((entries) => [...entries, entry]);\n\t\t\t}),\n\t\t[subscribeToStdout],\n\t);\n\n\tconst t = useTranslation();\n\n\tconst wrapperRef = useRef<HTMLElement>();\n\tconst atBottomRef = useRef<boolean>(false);\n\n\tconst [newLogsVisible, setNewLogsVisible] = useState(false);\n\n\tconst isAtBottom = useCallback((scrollThreshold = 0) => {\n\t\tconst wrapper = wrapperRef.current;\n\n\t\tif (!wrapper) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (wrapper.scrollTop + scrollThreshold >= wrapper.scrollHeight - wrapper.clientHeight) {\n\t\t\tsetNewLogsVisible(false);\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}, []);\n\n\tconst sendToBottom = useCallback(() => {\n\t\tconst wrapper = wrapperRef.current;\n\n\t\tif (!wrapper) {\n\t\t\treturn;\n\t\t}\n\n\t\twrapper.scrollTop = wrapper.scrollHeight - wrapper.clientHeight;\n\t\tsetNewLogsVisible(false);\n\t}, []);\n\n\tconst checkIfScrollIsAtBottom = useCallback(() => {\n\t\tatBottomRef.current = isAtBottom(100);\n\t}, [isAtBottom]);\n\n\tconst sendToBottomIfNecessary = useCallback(() => {\n\t\tif (atBottomRef.current === true && isAtBottom() !== true) {\n\t\t\tsendToBottom();\n\t\t} else if (atBottomRef.current === false) {\n\t\t\tsetNewLogsVisible(true);\n\t\t}\n\t}, [isAtBottom, sendToBottom]);\n\n\tuseEffect(() => {\n\t\tconst wrapper = wrapperRef.current;\n\n\t\tif (!wrapper) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (window.MutationObserver) {\n\t\t\tconst observer = new MutationObserver((mutations) => {\n\t\t\t\tmutations.forEach(() => {\n\t\t\t\t\tsendToBottomIfNecessary();\n\t\t\t\t});\n\t\t\t});\n\t\t\tobserver.observe(wrapper, { childList: true });\n\n\t\t\treturn (): void => {\n\t\t\t\tobserver.disconnect();\n\t\t\t};\n\t\t}\n\n\t\tconst handleSubtreeModified = (): void => {\n\t\t\tsendToBottomIfNecessary();\n\t\t};\n\t\twrapper.addEventListener('DOMSubtreeModified', handleSubtreeModified);\n\n\t\treturn (): void => {\n\t\t\twrapper.removeEventListener('DOMSubtreeModified', handleSubtreeModified);\n\t\t};\n\t}, [sendToBottomIfNecessary]);\n\n\tuseEffect(() => {\n\t\tconst handleWindowResize = (): void => {\n\t\t\tsetTimeout(() => {\n\t\t\t\tsendToBottomIfNecessary();\n\t\t\t}, 100);\n\t\t};\n\n\t\twindow.addEventListener('resize', handleWindowResize);\n\n\t\treturn (): void => {\n\t\t\twindow.removeEventListener('resize', handleWindowResize);\n\t\t};\n\t}, [sendToBottomIfNecessary]);\n\n\tconst handleWheel = useCallback(() => {\n\t\tatBottomRef.current = false;\n\t\tsetTimeout(() => {\n\t\t\tcheckIfScrollIsAtBottom();\n\t\t}, 100);\n\t}, [checkIfScrollIsAtBottom]);\n\n\tconst handleTouchStart = (): void => {\n\t\tatBottomRef.current = false;\n\t};\n\n\tconst handleTouchEnd = useCallback(() => {\n\t\tsetTimeout(() => {\n\t\t\tcheckIfScrollIsAtBottom();\n\t\t}, 100);\n\t}, [checkIfScrollIsAtBottom]);\n\n\tconst handleScroll = useCallback(() => {\n\t\tatBottomRef.current = false;\n\t\tsetTimeout(() => {\n\t\t\tcheckIfScrollIsAtBottom();\n\t\t}, 100);\n\t}, [checkIfScrollIsAtBottom]);\n\n\tconst handleClick = useCallback(() => {\n\t\tatBottomRef.current = true;\n\t\tsendToBottomIfNecessary();\n\t}, [sendToBottomIfNecessary]);\n\n\treturn (\n\t\t<Box width='full' height='full' overflow='hidden' position='relative' display='flex' marginBlock='x8'>\n\t\t\t<Scrollable vertical>\n\t\t\t\t<Box\n\t\t\t\t\tref={wrapperRef}\n\t\t\t\t\tdisplay='flex'\n\t\t\t\t\tflexDirection='column'\n\t\t\t\t\tpadding='x8'\n\t\t\t\t\tflexGrow={1}\n\t\t\t\t\tfontFamily='mono'\n\t\t\t\t\tcolor='alternative'\n\t\t\t\t\tbackgroundColor='neutral-800'\n\t\t\t\t\tstyle={{ wordBreak: 'break-all' }}\n\t\t\t\t\tonWheel={handleWheel}\n\t\t\t\t\tonTouchStart={handleTouchStart}\n\t\t\t\t\tonTouchEnd={handleTouchEnd}\n\t\t\t\t\tonScroll={handleScroll}\n\t\t\t\t>\n\t\t\t\t\t{entries.sort(compareEntries).map(({ string }, i) => (\n\t\t\t\t\t\t<span key={i} dangerouslySetInnerHTML={{ __html: ansispan(string) }} />\n\t\t\t\t\t))}\n\t\t\t\t</Box>\n\t\t\t</Scrollable>\n\t\t\t<Box\n\t\t\t\tposition='absolute'\n\t\t\t\tinsetBlockEnd='x8'\n\t\t\t\tinsetInlineStart='50%'\n\t\t\t\twidth='x132'\n\t\t\t\theight='x32'\n\t\t\t\tmarginInline='neg-x64'\n\t\t\t\tpaddingBlock='x8'\n\t\t\t\tfontScale='c1'\n\t\t\t\tborderRadius='full'\n\t\t\t\tcolor='primary-500'\n\t\t\t\tbackgroundColor='surface'\n\t\t\t\tonClick={handleClick}\n\t\t\t\ttextAlign='center'\n\t\t\t\tstyle={{\n\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\ttransition: 'transform 0.3s ease-out',\n\t\t\t\t\ttransform: newLogsVisible ? 'translateY(0)' : 'translateY(150%)',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<Icon name='jump' size='x16' /> {t('New_logs')}\n\t\t\t</Box>\n\t\t</Box>\n\t);\n};\n\nexport default ServerLogs;\n"]},"targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/views/admin/viewLogs/ServerLogs.tsx","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/views/admin/viewLogs/ServerLogs.tsx"}},"code":"const _excluded = [\"ts\"];\n\nlet _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default(v) {\n    _objectSpread = v;\n  }\n\n}, 0);\n\nlet _objectWithoutProperties;\n\nmodule.link(\"@babel/runtime/helpers/objectWithoutProperties\", {\n  default(v) {\n    _objectWithoutProperties = v;\n  }\n\n}, 1);\nlet Box, Icon, Scrollable;\nmodule.link(\"@rocket.chat/fuselage\", {\n  Box(v) {\n    Box = v;\n  },\n\n  Icon(v) {\n    Icon = v;\n  },\n\n  Scrollable(v) {\n    Scrollable = v;\n  }\n\n}, 0);\nlet React, useEffect, useRef, useState, useCallback;\nmodule.link(\"react\", {\n  default(v) {\n    React = v;\n  },\n\n  useEffect(v) {\n    useEffect = v;\n  },\n\n  useRef(v) {\n    useRef = v;\n  },\n\n  useState(v) {\n    useState = v;\n  },\n\n  useCallback(v) {\n    useCallback = v;\n  }\n\n}, 1);\nlet useEndpoint, useStream;\nmodule.link(\"../../../contexts/ServerContext\", {\n  useEndpoint(v) {\n    useEndpoint = v;\n  },\n\n  useStream(v) {\n    useStream = v;\n  }\n\n}, 2);\nlet useToastMessageDispatch;\nmodule.link(\"../../../contexts/ToastMessagesContext\", {\n  useToastMessageDispatch(v) {\n    useToastMessageDispatch = v;\n  }\n\n}, 3);\nlet useTranslation;\nmodule.link(\"../../../contexts/TranslationContext\", {\n  useTranslation(v) {\n    useTranslation = v;\n  }\n\n}, 4);\nlet ansispan;\nmodule.link(\"./ansispan\", {\n  ansispan(v) {\n    ansispan = v;\n  }\n\n}, 5);\n\nconst compareEntries = (a, b) => a.ts.getTime() - b.ts.getTime();\n\nconst unserializeEntry = _ref => {\n  let {\n    ts\n  } = _ref,\n      entry = _objectWithoutProperties(_ref, _excluded);\n\n  return _objectSpread({\n    ts: new Date(ts)\n  }, entry);\n};\n\nconst ServerLogs = () => {\n  const [entries, setEntries] = useState([]);\n  const dispatchToastMessage = useToastMessageDispatch();\n  const getStdoutQueue = useEndpoint('GET', 'stdout.queue');\n  const subscribeToStdout = useStream('stdout');\n  useEffect(() => {\n    const fetchLines = async () => {\n      try {\n        const {\n          queue\n        } = await getStdoutQueue(undefined);\n        setEntries(queue.map(unserializeEntry).sort(compareEntries));\n      } catch (error) {\n        dispatchToastMessage({\n          type: 'error',\n          message: error\n        });\n      }\n    };\n\n    fetchLines();\n  }, [dispatchToastMessage, getStdoutQueue]);\n  useEffect(() => subscribeToStdout('stdout', entry => {\n    setEntries(entries => [...entries, entry]);\n  }), [subscribeToStdout]);\n  const t = useTranslation();\n  const wrapperRef = useRef();\n  const atBottomRef = useRef(false);\n  const [newLogsVisible, setNewLogsVisible] = useState(false);\n  const isAtBottom = useCallback(function () {\n    let scrollThreshold = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 0;\n    const wrapper = wrapperRef.current;\n\n    if (!wrapper) {\n      return false;\n    }\n\n    if (wrapper.scrollTop + scrollThreshold >= wrapper.scrollHeight - wrapper.clientHeight) {\n      setNewLogsVisible(false);\n      return true;\n    }\n\n    return false;\n  }, []);\n  const sendToBottom = useCallback(() => {\n    const wrapper = wrapperRef.current;\n\n    if (!wrapper) {\n      return;\n    }\n\n    wrapper.scrollTop = wrapper.scrollHeight - wrapper.clientHeight;\n    setNewLogsVisible(false);\n  }, []);\n  const checkIfScrollIsAtBottom = useCallback(() => {\n    atBottomRef.current = isAtBottom(100);\n  }, [isAtBottom]);\n  const sendToBottomIfNecessary = useCallback(() => {\n    if (atBottomRef.current === true && isAtBottom() !== true) {\n      sendToBottom();\n    } else if (atBottomRef.current === false) {\n      setNewLogsVisible(true);\n    }\n  }, [isAtBottom, sendToBottom]);\n  useEffect(() => {\n    const wrapper = wrapperRef.current;\n\n    if (!wrapper) {\n      return;\n    }\n\n    if (window.MutationObserver) {\n      const observer = new MutationObserver(mutations => {\n        mutations.forEach(() => {\n          sendToBottomIfNecessary();\n        });\n      });\n      observer.observe(wrapper, {\n        childList: true\n      });\n      return () => {\n        observer.disconnect();\n      };\n    }\n\n    const handleSubtreeModified = () => {\n      sendToBottomIfNecessary();\n    };\n\n    wrapper.addEventListener('DOMSubtreeModified', handleSubtreeModified);\n    return () => {\n      wrapper.removeEventListener('DOMSubtreeModified', handleSubtreeModified);\n    };\n  }, [sendToBottomIfNecessary]);\n  useEffect(() => {\n    const handleWindowResize = () => {\n      setTimeout(() => {\n        sendToBottomIfNecessary();\n      }, 100);\n    };\n\n    window.addEventListener('resize', handleWindowResize);\n    return () => {\n      window.removeEventListener('resize', handleWindowResize);\n    };\n  }, [sendToBottomIfNecessary]);\n  const handleWheel = useCallback(() => {\n    atBottomRef.current = false;\n    setTimeout(() => {\n      checkIfScrollIsAtBottom();\n    }, 100);\n  }, [checkIfScrollIsAtBottom]);\n\n  const handleTouchStart = () => {\n    atBottomRef.current = false;\n  };\n\n  const handleTouchEnd = useCallback(() => {\n    setTimeout(() => {\n      checkIfScrollIsAtBottom();\n    }, 100);\n  }, [checkIfScrollIsAtBottom]);\n  const handleScroll = useCallback(() => {\n    atBottomRef.current = false;\n    setTimeout(() => {\n      checkIfScrollIsAtBottom();\n    }, 100);\n  }, [checkIfScrollIsAtBottom]);\n  const handleClick = useCallback(() => {\n    atBottomRef.current = true;\n    sendToBottomIfNecessary();\n  }, [sendToBottomIfNecessary]);\n  return /*#__PURE__*/React.createElement(Box, {\n    width: \"full\",\n    height: \"full\",\n    overflow: \"hidden\",\n    position: \"relative\",\n    display: \"flex\",\n    marginBlock: \"x8\"\n  }, /*#__PURE__*/React.createElement(Scrollable, {\n    vertical: true\n  }, /*#__PURE__*/React.createElement(Box, {\n    ref: wrapperRef,\n    display: \"flex\",\n    flexDirection: \"column\",\n    padding: \"x8\",\n    flexGrow: 1,\n    fontFamily: \"mono\",\n    color: \"alternative\",\n    backgroundColor: \"neutral-800\",\n    style: {\n      wordBreak: 'break-all'\n    },\n    onWheel: handleWheel,\n    onTouchStart: handleTouchStart,\n    onTouchEnd: handleTouchEnd,\n    onScroll: handleScroll\n  }, entries.sort(compareEntries).map((_ref2, i) => {\n    let {\n      string\n    } = _ref2;\n    return /*#__PURE__*/React.createElement(\"span\", {\n      key: i,\n      dangerouslySetInnerHTML: {\n        __html: ansispan(string)\n      }\n    });\n  }))), /*#__PURE__*/React.createElement(Box, {\n    position: \"absolute\",\n    insetBlockEnd: \"x8\",\n    insetInlineStart: \"50%\",\n    width: \"x132\",\n    height: \"x32\",\n    marginInline: \"neg-x64\",\n    paddingBlock: \"x8\",\n    fontScale: \"c1\",\n    borderRadius: \"full\",\n    color: \"primary-500\",\n    backgroundColor: \"surface\",\n    onClick: handleClick,\n    textAlign: \"center\",\n    style: {\n      cursor: 'pointer',\n      transition: 'transform 0.3s ease-out',\n      transform: newLogsVisible ? 'translateY(0)' : 'translateY(150%)'\n    }\n  }, /*#__PURE__*/React.createElement(Icon, {\n    name: \"jump\",\n    size: \"x16\"\n  }), \" \", t('New_logs')));\n};\n\nmodule.exportDefault(ServerLogs);","map":{"version":3,"sources":["client/views/admin/viewLogs/ServerLogs.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Box, Icon, Scrollable } from '@rocket.chat/fuselage';\nimport React, { useEffect, useRef, useState, useCallback, ReactElement } from 'react';\n\nimport { Serialized } from '../../../../definition/Serialized';\nimport { useEndpoint, useStream } from '../../../contexts/ServerContext';\nimport { useToastMessageDispatch } from '../../../contexts/ToastMessagesContext';\nimport { useTranslation } from '../../../contexts/TranslationContext';\nimport { ansispan } from './ansispan';\n\ntype StdOutLogEntry = {\n\tid: string;\n\tstring: string;\n\tts: Date;\n};\n\nconst compareEntries = (a: StdOutLogEntry, b: StdOutLogEntry): number => a.ts.getTime() - b.ts.getTime();\n\nconst unserializeEntry = ({ ts, ...entry }: Serialized<StdOutLogEntry>): StdOutLogEntry => ({\n\tts: new Date(ts),\n\t...entry,\n});\n\nconst ServerLogs = (): ReactElement => {\n\tconst [entries, setEntries] = useState<StdOutLogEntry[]>([]);\n\n\tconst dispatchToastMessage = useToastMessageDispatch();\n\n\tconst getStdoutQueue = useEndpoint('GET', 'stdout.queue');\n\tconst subscribeToStdout = useStream('stdout');\n\n\tuseEffect(() => {\n\t\tconst fetchLines = async (): Promise<void> => {\n\t\t\ttry {\n\t\t\t\tconst { queue } = await getStdoutQueue(undefined);\n\t\t\t\tsetEntries(queue.map(unserializeEntry).sort(compareEntries));\n\t\t\t} catch (error) {\n\t\t\t\tdispatchToastMessage({ type: 'error', message: error });\n\t\t\t}\n\t\t};\n\n\t\tfetchLines();\n\t}, [dispatchToastMessage, getStdoutQueue]);\n\n\tuseEffect(\n\t\t() =>\n\t\t\tsubscribeToStdout('stdout', (entry: StdOutLogEntry) => {\n\t\t\t\tsetEntries((entries) => [...entries, entry]);\n\t\t\t}),\n\t\t[subscribeToStdout],\n\t);\n\n\tconst t = useTranslation();\n\n\tconst wrapperRef = useRef<HTMLElement>();\n\tconst atBottomRef = useRef<boolean>(false);\n\n\tconst [newLogsVisible, setNewLogsVisible] = useState(false);\n\n\tconst isAtBottom = useCallback((scrollThreshold = 0) => {\n\t\tconst wrapper = wrapperRef.current;\n\n\t\tif (!wrapper) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (wrapper.scrollTop + scrollThreshold >= wrapper.scrollHeight - wrapper.clientHeight) {\n\t\t\tsetNewLogsVisible(false);\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}, []);\n\n\tconst sendToBottom = useCallback(() => {\n\t\tconst wrapper = wrapperRef.current;\n\n\t\tif (!wrapper) {\n\t\t\treturn;\n\t\t}\n\n\t\twrapper.scrollTop = wrapper.scrollHeight - wrapper.clientHeight;\n\t\tsetNewLogsVisible(false);\n\t}, []);\n\n\tconst checkIfScrollIsAtBottom = useCallback(() => {\n\t\tatBottomRef.current = isAtBottom(100);\n\t}, [isAtBottom]);\n\n\tconst sendToBottomIfNecessary = useCallback(() => {\n\t\tif (atBottomRef.current === true && isAtBottom() !== true) {\n\t\t\tsendToBottom();\n\t\t} else if (atBottomRef.current === false) {\n\t\t\tsetNewLogsVisible(true);\n\t\t}\n\t}, [isAtBottom, sendToBottom]);\n\n\tuseEffect(() => {\n\t\tconst wrapper = wrapperRef.current;\n\n\t\tif (!wrapper) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (window.MutationObserver) {\n\t\t\tconst observer = new MutationObserver((mutations) => {\n\t\t\t\tmutations.forEach(() => {\n\t\t\t\t\tsendToBottomIfNecessary();\n\t\t\t\t});\n\t\t\t});\n\t\t\tobserver.observe(wrapper, { childList: true });\n\n\t\t\treturn (): void => {\n\t\t\t\tobserver.disconnect();\n\t\t\t};\n\t\t}\n\n\t\tconst handleSubtreeModified = (): void => {\n\t\t\tsendToBottomIfNecessary();\n\t\t};\n\t\twrapper.addEventListener('DOMSubtreeModified', handleSubtreeModified);\n\n\t\treturn (): void => {\n\t\t\twrapper.removeEventListener('DOMSubtreeModified', handleSubtreeModified);\n\t\t};\n\t}, [sendToBottomIfNecessary]);\n\n\tuseEffect(() => {\n\t\tconst handleWindowResize = (): void => {\n\t\t\tsetTimeout(() => {\n\t\t\t\tsendToBottomIfNecessary();\n\t\t\t}, 100);\n\t\t};\n\n\t\twindow.addEventListener('resize', handleWindowResize);\n\n\t\treturn (): void => {\n\t\t\twindow.removeEventListener('resize', handleWindowResize);\n\t\t};\n\t}, [sendToBottomIfNecessary]);\n\n\tconst handleWheel = useCallback(() => {\n\t\tatBottomRef.current = false;\n\t\tsetTimeout(() => {\n\t\t\tcheckIfScrollIsAtBottom();\n\t\t}, 100);\n\t}, [checkIfScrollIsAtBottom]);\n\n\tconst handleTouchStart = (): void => {\n\t\tatBottomRef.current = false;\n\t};\n\n\tconst handleTouchEnd = useCallback(() => {\n\t\tsetTimeout(() => {\n\t\t\tcheckIfScrollIsAtBottom();\n\t\t}, 100);\n\t}, [checkIfScrollIsAtBottom]);\n\n\tconst handleScroll = useCallback(() => {\n\t\tatBottomRef.current = false;\n\t\tsetTimeout(() => {\n\t\t\tcheckIfScrollIsAtBottom();\n\t\t}, 100);\n\t}, [checkIfScrollIsAtBottom]);\n\n\tconst handleClick = useCallback(() => {\n\t\tatBottomRef.current = true;\n\t\tsendToBottomIfNecessary();\n\t}, [sendToBottomIfNecessary]);\n\n\treturn (\n\t\t<Box width='full' height='full' overflow='hidden' position='relative' display='flex' marginBlock='x8'>\n\t\t\t<Scrollable vertical>\n\t\t\t\t<Box\n\t\t\t\t\tref={wrapperRef}\n\t\t\t\t\tdisplay='flex'\n\t\t\t\t\tflexDirection='column'\n\t\t\t\t\tpadding='x8'\n\t\t\t\t\tflexGrow={1}\n\t\t\t\t\tfontFamily='mono'\n\t\t\t\t\tcolor='alternative'\n\t\t\t\t\tbackgroundColor='neutral-800'\n\t\t\t\t\tstyle={{ wordBreak: 'break-all' }}\n\t\t\t\t\tonWheel={handleWheel}\n\t\t\t\t\tonTouchStart={handleTouchStart}\n\t\t\t\t\tonTouchEnd={handleTouchEnd}\n\t\t\t\t\tonScroll={handleScroll}\n\t\t\t\t>\n\t\t\t\t\t{entries.sort(compareEntries).map(({ string }, i) => (\n\t\t\t\t\t\t<span key={i} dangerouslySetInnerHTML={{ __html: ansispan(string) }} />\n\t\t\t\t\t))}\n\t\t\t\t</Box>\n\t\t\t</Scrollable>\n\t\t\t<Box\n\t\t\t\tposition='absolute'\n\t\t\t\tinsetBlockEnd='x8'\n\t\t\t\tinsetInlineStart='50%'\n\t\t\t\twidth='x132'\n\t\t\t\theight='x32'\n\t\t\t\tmarginInline='neg-x64'\n\t\t\t\tpaddingBlock='x8'\n\t\t\t\tfontScale='c1'\n\t\t\t\tborderRadius='full'\n\t\t\t\tcolor='primary-500'\n\t\t\t\tbackgroundColor='surface'\n\t\t\t\tonClick={handleClick}\n\t\t\t\ttextAlign='center'\n\t\t\t\tstyle={{\n\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\ttransition: 'transform 0.3s ease-out',\n\t\t\t\t\ttransform: newLogsVisible ? 'translateY(0)' : 'translateY(150%)',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<Icon name='jump' size='x16' /> {t('New_logs')}\n\t\t\t</Box>\n\t\t</Box>\n\t);\n};\n\nexport default ServerLogs;\n"],"sourceRoot":""},"sourceType":"module","hash":"c2c2eaa493bf0be127874c7d988043a609ca8d02"}
