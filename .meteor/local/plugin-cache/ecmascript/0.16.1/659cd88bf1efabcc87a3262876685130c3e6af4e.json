{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui-message/client/messageBox/messageBoxActions.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"app/ui-message/client/messageBox/messageBoxActions.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui-message/client/messageBox/messageBoxActions.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui-message/client/messageBox/messageBoxActions.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/ui-message/client/messageBox/messageBoxActions.js"}},"code":"let Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet Random;\nmodule.link(\"meteor/random\", {\n  Random(v) {\n    Random = v;\n  }\n\n}, 1);\nlet ReactiveVar;\nmodule.link(\"meteor/reactive-var\", {\n  ReactiveVar(v) {\n    ReactiveVar = v;\n  }\n\n}, 2);\nlet Tracker;\nmodule.link(\"meteor/tracker\", {\n  Tracker(v) {\n    Tracker = v;\n  }\n\n}, 3);\nlet VRecDialog;\nmodule.link(\"../../../ui-vrecord/client\", {\n  VRecDialog(v) {\n    VRecDialog = v;\n  }\n\n}, 4);\nlet messageBox, modal;\nmodule.link(\"../../../ui-utils\", {\n  messageBox(v) {\n    messageBox = v;\n  },\n\n  modal(v) {\n    modal = v;\n  }\n\n}, 5);\nlet fileUpload;\nmodule.link(\"../../../ui\", {\n  fileUpload(v) {\n    fileUpload = v;\n  }\n\n}, 6);\nlet settings;\nmodule.link(\"../../../settings\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 7);\nlet t;\nmodule.link(\"../../../utils\", {\n  t(v) {\n    t = v;\n  }\n\n}, 8);\nmessageBox.actions.add('Create_new', 'Video_message', {\n  id: 'video-message',\n  icon: 'video',\n  condition: () => (navigator.mediaDevices || navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia) && window.MediaRecorder && settings.get('FileUpload_Enabled') && settings.get('Message_VideoRecorderEnabled') && (!settings.get('FileUpload_MediaTypeBlackList') || !settings.get('FileUpload_MediaTypeBlackList').match(/video\\/webm|video\\/\\*/i)) && (!settings.get('FileUpload_MediaTypeWhiteList') || settings.get('FileUpload_MediaTypeWhiteList').match(/video\\/webm|video\\/\\*/i)),\n  action: _ref => {\n    let {\n      rid,\n      tmid,\n      messageBox\n    } = _ref;\n    return VRecDialog.opened ? VRecDialog.close() : VRecDialog.open(messageBox, {\n      rid,\n      tmid\n    });\n  }\n});\nmessageBox.actions.add('Add_files_from', 'Computer', {\n  id: 'file-upload',\n  icon: 'computer',\n  condition: () => settings.get('FileUpload_Enabled'),\n\n  action(_ref2) {\n    let {\n      rid,\n      tmid,\n      event,\n      messageBox\n    } = _ref2;\n    event.preventDefault();\n    const $input = $(document.createElement('input'));\n    $input.css('display', 'none');\n    $input.attr({\n      id: 'fileupload-input',\n      type: 'file',\n      multiple: 'multiple'\n    });\n    $(document.body).append($input);\n    $input.one('change', async function (e) {\n      const {\n        mime\n      } = await module.dynamicImport('../../../utils/lib/mimeTypes');\n      const filesToUpload = [...e.target.files].map(file => {\n        Object.defineProperty(file, 'type', {\n          value: mime.lookup(file.name)\n        });\n        return {\n          file,\n          name: file.name\n        };\n      });\n      fileUpload(filesToUpload, $('.js-input-message', messageBox).get(0), {\n        rid,\n        tmid\n      });\n      $input.remove();\n    });\n    $input.click(); // Simple hack for iOS aka codegueira\n\n    if (navigator.userAgent.match(/(iPad|iPhone|iPod)/g)) {\n      $input.click();\n    }\n  }\n\n});\nconst canGetGeolocation = new ReactiveVar(false);\n\nconst getGeolocationPermission = () => new Promise(resolve => {\n  if (!navigator.permissions) {\n    resolve(true);\n  }\n\n  navigator.permissions.query({\n    name: 'geolocation'\n  }).then(_ref3 => {\n    let {\n      state\n    } = _ref3;\n    resolve(state);\n  });\n});\n\nconst getGeolocationPosition = () => new Promise(resolvePos => {\n  navigator.geolocation.getCurrentPosition(resolvePos, () => {\n    resolvePos(false);\n  }, {\n    enableHighAccuracy: true,\n    maximumAge: 0,\n    timeout: 10000\n  });\n});\n\nconst getCoordinates = async () => {\n  const status = await getGeolocationPermission();\n\n  if (status === 'prompt') {\n    let resolveModal;\n    const modalAnswer = new Promise(resolve => {\n      resolveModal = resolve;\n    });\n    modal.open({\n      title: t('You_will_be_asked_for_permissions'),\n      confirmButtonText: t('Continue'),\n      showCancelButton: true,\n      closeOnConfirm: true,\n      closeOnCancel: true\n    }, async isConfirm => {\n      if (!isConfirm) {\n        resolveModal(false);\n      }\n\n      const position = await getGeolocationPosition();\n\n      if (!position) {\n        const newStatus = getGeolocationPermission();\n        resolveModal(newStatus);\n      }\n\n      resolveModal(position);\n    });\n    const position = await modalAnswer;\n    return position;\n  }\n\n  if (status === 'denied') {\n    return status;\n  }\n\n  const position = await getGeolocationPosition();\n  return position;\n};\n\nmessageBox.actions.add('Share', 'My_location', {\n  id: 'share-location',\n  icon: 'map-pin',\n  condition: () => canGetGeolocation.get(),\n\n  async action(_ref4) {\n    let {\n      rid,\n      tmid\n    } = _ref4;\n    const position = await getCoordinates();\n\n    if (!position) {\n      return;\n    }\n\n    if (position === 'denied') {\n      modal.open({\n        title: t('Cannot_share_your_location'),\n        text: t('The_necessary_browser_permissions_for_location_sharing_are_not_granted'),\n        confirmButtonText: t('Ok'),\n        closeOnConfirm: true\n      });\n      return;\n    }\n\n    const {\n      coords: {\n        latitude,\n        longitude\n      }\n    } = position;\n    const text = \"<div class=\\\"upload-preview\\\"><div class=\\\"upload-preview-file\\\" style=\\\"background-size: cover; box-shadow: 0 0 0px 1px #dfdfdf; border-radius: 2px; height: 250px; width:100%; max-width: 500px; background-image:url(https://maps.googleapis.com/maps/api/staticmap?zoom=14&size=500x250&markers=color:gray%7Clabel:%7C\".concat(latitude, \",\").concat(longitude, \"&key=\").concat(settings.get('MapView_GMapsAPIKey'), \")\\\" ></div></div>\");\n    modal.open({\n      title: t('Share_Location_Title'),\n      text,\n      showCancelButton: true,\n      closeOnConfirm: true,\n      closeOnCancel: true,\n      html: true\n    }, function (isConfirm) {\n      if (isConfirm !== true) {\n        return;\n      }\n\n      Meteor.call('sendMessage', {\n        _id: Random.id(),\n        rid,\n        tmid,\n        msg: '',\n        location: {\n          type: 'Point',\n          coordinates: [longitude, latitude]\n        }\n      });\n    });\n  }\n\n});\nMeteor.startup(() => {\n  Tracker.autorun(() => {\n    const isMapViewEnabled = settings.get('MapView_Enabled') === true;\n    const isGeolocationCurrentPositionSupported = navigator.geolocation && navigator.geolocation.getCurrentPosition;\n    const googleMapsApiKey = settings.get('MapView_GMapsAPIKey');\n    canGetGeolocation.set(isMapViewEnabled && isGeolocationCurrentPositionSupported && googleMapsApiKey && googleMapsApiKey.length);\n  });\n});","map":{"version":3,"sources":["app/ui-message/client/messageBox/messageBoxActions.js"],"names":["Meteor","module","link","v","Random","ReactiveVar","Tracker","VRecDialog","messageBox","modal","fileUpload","settings","t","actions","add","id","icon","condition","navigator","mediaDevices","getUserMedia","webkitGetUserMedia","mozGetUserMedia","msGetUserMedia","window","MediaRecorder","get","match","action","rid","tmid","opened","close","open","event","preventDefault","$input","$","document","createElement","css","attr","type","multiple","body","append","one","e","mime","filesToUpload","target","files","map","file","Object","defineProperty","value","lookup","name","remove","click","userAgent","canGetGeolocation","getGeolocationPermission","Promise","resolve","permissions","query","then","state","getGeolocationPosition","resolvePos","geolocation","getCurrentPosition","enableHighAccuracy","maximumAge","timeout","getCoordinates","status","resolveModal","modalAnswer","title","confirmButtonText","showCancelButton","closeOnConfirm","closeOnCancel","isConfirm","position","newStatus","text","coords","latitude","longitude","html","call","_id","msg","location","coordinates","startup","autorun","isMapViewEnabled","isGeolocationCurrentPositionSupported","googleMapsApiKey","set","length"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { Random } from 'meteor/random';\nimport { ReactiveVar } from 'meteor/reactive-var';\nimport { Tracker } from 'meteor/tracker';\n\nimport { VRecDialog } from '../../../ui-vrecord/client';\nimport { messageBox, modal } from '../../../ui-utils';\nimport { fileUpload } from '../../../ui';\nimport { settings } from '../../../settings';\nimport { t } from '../../../utils';\n\nmessageBox.actions.add('Create_new', 'Video_message', {\n\tid: 'video-message',\n\ticon: 'video',\n\tcondition: () =>\n\t\t(navigator.mediaDevices ||\n\t\t\tnavigator.getUserMedia ||\n\t\t\tnavigator.webkitGetUserMedia ||\n\t\t\tnavigator.mozGetUserMedia ||\n\t\t\tnavigator.msGetUserMedia) &&\n\t\twindow.MediaRecorder &&\n\t\tsettings.get('FileUpload_Enabled') &&\n\t\tsettings.get('Message_VideoRecorderEnabled') &&\n\t\t(!settings.get('FileUpload_MediaTypeBlackList') || !settings.get('FileUpload_MediaTypeBlackList').match(/video\\/webm|video\\/\\*/i)) &&\n\t\t(!settings.get('FileUpload_MediaTypeWhiteList') || settings.get('FileUpload_MediaTypeWhiteList').match(/video\\/webm|video\\/\\*/i)),\n\taction: ({ rid, tmid, messageBox }) => (VRecDialog.opened ? VRecDialog.close() : VRecDialog.open(messageBox, { rid, tmid })),\n});\n\nmessageBox.actions.add('Add_files_from', 'Computer', {\n\tid: 'file-upload',\n\ticon: 'computer',\n\tcondition: () => settings.get('FileUpload_Enabled'),\n\taction({ rid, tmid, event, messageBox }) {\n\t\tevent.preventDefault();\n\t\tconst $input = $(document.createElement('input'));\n\t\t$input.css('display', 'none');\n\t\t$input.attr({\n\t\t\tid: 'fileupload-input',\n\t\t\ttype: 'file',\n\t\t\tmultiple: 'multiple',\n\t\t});\n\n\t\t$(document.body).append($input);\n\n\t\t$input.one('change', async function (e) {\n\t\t\tconst { mime } = await import('../../../utils/lib/mimeTypes');\n\t\t\tconst filesToUpload = [...e.target.files].map((file) => {\n\t\t\t\tObject.defineProperty(file, 'type', {\n\t\t\t\t\tvalue: mime.lookup(file.name),\n\t\t\t\t});\n\t\t\t\treturn {\n\t\t\t\t\tfile,\n\t\t\t\t\tname: file.name,\n\t\t\t\t};\n\t\t\t});\n\n\t\t\tfileUpload(filesToUpload, $('.js-input-message', messageBox).get(0), { rid, tmid });\n\t\t\t$input.remove();\n\t\t});\n\n\t\t$input.click();\n\n\t\t// Simple hack for iOS aka codegueira\n\t\tif (navigator.userAgent.match(/(iPad|iPhone|iPod)/g)) {\n\t\t\t$input.click();\n\t\t}\n\t},\n});\n\nconst canGetGeolocation = new ReactiveVar(false);\n\nconst getGeolocationPermission = () =>\n\tnew Promise((resolve) => {\n\t\tif (!navigator.permissions) {\n\t\t\tresolve(true);\n\t\t}\n\t\tnavigator.permissions.query({ name: 'geolocation' }).then(({ state }) => {\n\t\t\tresolve(state);\n\t\t});\n\t});\n\nconst getGeolocationPosition = () =>\n\tnew Promise((resolvePos) => {\n\t\tnavigator.geolocation.getCurrentPosition(\n\t\t\tresolvePos,\n\t\t\t() => {\n\t\t\t\tresolvePos(false);\n\t\t\t},\n\t\t\t{\n\t\t\t\tenableHighAccuracy: true,\n\t\t\t\tmaximumAge: 0,\n\t\t\t\ttimeout: 10000,\n\t\t\t},\n\t\t);\n\t});\n\nconst getCoordinates = async () => {\n\tconst status = await getGeolocationPermission();\n\tif (status === 'prompt') {\n\t\tlet resolveModal;\n\t\tconst modalAnswer = new Promise((resolve) => {\n\t\t\tresolveModal = resolve;\n\t\t});\n\t\tmodal.open(\n\t\t\t{\n\t\t\t\ttitle: t('You_will_be_asked_for_permissions'),\n\t\t\t\tconfirmButtonText: t('Continue'),\n\t\t\t\tshowCancelButton: true,\n\t\t\t\tcloseOnConfirm: true,\n\t\t\t\tcloseOnCancel: true,\n\t\t\t},\n\t\t\tasync (isConfirm) => {\n\t\t\t\tif (!isConfirm) {\n\t\t\t\t\tresolveModal(false);\n\t\t\t\t}\n\t\t\t\tconst position = await getGeolocationPosition();\n\t\t\t\tif (!position) {\n\t\t\t\t\tconst newStatus = getGeolocationPermission();\n\t\t\t\t\tresolveModal(newStatus);\n\t\t\t\t}\n\t\t\t\tresolveModal(position);\n\t\t\t},\n\t\t);\n\t\tconst position = await modalAnswer;\n\t\treturn position;\n\t}\n\n\tif (status === 'denied') {\n\t\treturn status;\n\t}\n\n\tconst position = await getGeolocationPosition();\n\treturn position;\n};\n\nmessageBox.actions.add('Share', 'My_location', {\n\tid: 'share-location',\n\ticon: 'map-pin',\n\tcondition: () => canGetGeolocation.get(),\n\tasync action({ rid, tmid }) {\n\t\tconst position = await getCoordinates();\n\n\t\tif (!position) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (position === 'denied') {\n\t\t\tmodal.open({\n\t\t\t\ttitle: t('Cannot_share_your_location'),\n\t\t\t\ttext: t('The_necessary_browser_permissions_for_location_sharing_are_not_granted'),\n\t\t\t\tconfirmButtonText: t('Ok'),\n\t\t\t\tcloseOnConfirm: true,\n\t\t\t});\n\t\t\treturn;\n\t\t}\n\n\t\tconst {\n\t\t\tcoords: { latitude, longitude },\n\t\t} = position;\n\t\tconst text = `<div class=\"upload-preview\"><div class=\"upload-preview-file\" style=\"background-size: cover; box-shadow: 0 0 0px 1px #dfdfdf; border-radius: 2px; height: 250px; width:100%; max-width: 500px; background-image:url(https://maps.googleapis.com/maps/api/staticmap?zoom=14&size=500x250&markers=color:gray%7Clabel:%7C${latitude},${longitude}&key=${settings.get(\n\t\t\t'MapView_GMapsAPIKey',\n\t\t)})\" ></div></div>`;\n\n\t\tmodal.open(\n\t\t\t{\n\t\t\t\ttitle: t('Share_Location_Title'),\n\t\t\t\ttext,\n\t\t\t\tshowCancelButton: true,\n\t\t\t\tcloseOnConfirm: true,\n\t\t\t\tcloseOnCancel: true,\n\t\t\t\thtml: true,\n\t\t\t},\n\t\t\tfunction (isConfirm) {\n\t\t\t\tif (isConfirm !== true) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tMeteor.call('sendMessage', {\n\t\t\t\t\t_id: Random.id(),\n\t\t\t\t\trid,\n\t\t\t\t\ttmid,\n\t\t\t\t\tmsg: '',\n\t\t\t\t\tlocation: {\n\t\t\t\t\t\ttype: 'Point',\n\t\t\t\t\t\tcoordinates: [longitude, latitude],\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t},\n\t\t);\n\t},\n});\n\nMeteor.startup(() => {\n\tTracker.autorun(() => {\n\t\tconst isMapViewEnabled = settings.get('MapView_Enabled') === true;\n\t\tconst isGeolocationCurrentPositionSupported = navigator.geolocation && navigator.geolocation.getCurrentPosition;\n\t\tconst googleMapsApiKey = settings.get('MapView_GMapsAPIKey');\n\t\tcanGetGeolocation.set(isMapViewEnabled && isGeolocationCurrentPositionSupported && googleMapsApiKey && googleMapsApiKey.length);\n\t});\n});\n"]},"sourceType":"module","hash":"659cd88bf1efabcc87a3262876685130c3e6af4e"}
