{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/livestream/client/views/broadcastView.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"app/livestream/client/views/broadcastView.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/livestream/client/views/broadcastView.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/livestream/client/views/broadcastView.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/livestream/client/views/broadcastView.js"}},"code":"module.export({\n  call: () => call\n});\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet ReactiveVar;\nmodule.link(\"meteor/reactive-var\", {\n  ReactiveVar(v) {\n    ReactiveVar = v;\n  }\n\n}, 1);\nlet Session;\nmodule.link(\"meteor/session\", {\n  Session(v) {\n    Session = v;\n  }\n\n}, 2);\nlet Template;\nmodule.link(\"meteor/templating\", {\n  Template(v) {\n    Template = v;\n  }\n\n}, 3);\nlet handleError;\nmodule.link(\"../../../../client/lib/utils/handleError\", {\n  handleError(v) {\n    handleError = v;\n  }\n\n}, 4);\nlet settings;\nmodule.link(\"../../../settings/client\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 5);\n\nconst getMedia = () => navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;\n\nconst createAndConnect = url => {\n  if (!('WebSocket' in window)) {\n    // eslint-disable-line no-negated-in-lhs\n    return false;\n  }\n\n  const ws = new WebSocket(url);\n\n  ws.onerror = evt => console.error(\"Error: \".concat(evt.data));\n\n  return ws;\n};\n\nconst sendMessageToWebSocket = (message, ws) => {\n  if (ws != null) {\n    if (ws.readyState === 1) {\n      ws.send(message);\n    }\n  }\n};\n\nconst call = function () {\n  for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n    args[_key] = arguments[_key];\n  }\n\n  return new Promise(function (resolve, reject) {\n    Meteor.call(...args, function (err, result) {\n      if (err) {\n        handleError(err);\n        reject(err);\n      }\n\n      resolve(result);\n    });\n  });\n};\n\nconst delay = time => new Promise(resolve => setTimeout(resolve, time));\n\nconst waitForStreamStatus = async (id, status) => {\n  const streamActive = new Promise(async resolve => {\n    // eslint-disable-next-line no-constant-condition\n    while (true) {\n      const currentStatus = await call('livestreamStreamStatus', {\n        streamId: id\n      }); // eslint-disable-line no-await-in-loop\n\n      if (currentStatus === status) {\n        return resolve(status);\n      }\n\n      await delay(1500); // eslint-disable-line no-await-in-loop\n    }\n  });\n  await streamActive;\n};\n\nconst waitForBroadcastStatus = async (id, status) => {\n  const broadcastActive = new Promise(async resolve => {\n    // eslint-disable-next-line no-constant-condition\n    while (true) {\n      const currentStatus = await call('getBroadcastStatus', {\n        broadcastId: id\n      }); // eslint-disable-line no-await-in-loop\n\n      if (currentStatus === status) {\n        return resolve(status);\n      }\n\n      await delay(1500); // eslint-disable-line no-await-in-loop\n    }\n  });\n  await broadcastActive;\n};\n\nTemplate.broadcastView.helpers({\n  broadcastSource() {\n    return Template.instance().mediaStream.get() ? window.URL.createObjectURL(Template.instance().mediaStream.get()) : '';\n  },\n\n  mediaRecorder() {\n    Template.instance().mediaRecorder.get();\n  }\n\n});\nTemplate.broadcastView.onCreated(async function () {\n  const connection = createAndConnect(\"\".concat(settings.get('Broadcasting_media_server_url'), \"/\").concat(this.data.id));\n  this.mediaStream = new ReactiveVar(null);\n  this.mediaRecorder = new ReactiveVar(null);\n  this.connection = new ReactiveVar(connection);\n});\nTemplate.broadcastView.onDestroyed(function () {\n  if (this.connection.get()) {\n    this.connection.get().close();\n  }\n\n  if (this.mediaRecorder.get()) {\n    this.mediaRecorder.get().stop();\n    this.mediaRecorder.set(null);\n  }\n\n  if (this.mediaStream.get()) {\n    this.mediaStream.get().getTracks().map(track => track.stop());\n    this.mediaStream.set(null);\n  }\n});\nTemplate.broadcastView.onRendered(async function () {\n  navigator.getMedia = getMedia();\n\n  if (!navigator.getMedia) {\n    return alert('getUserMedia() is not supported in your browser!');\n  }\n\n  const localMediaStream = await new Promise((resolve, reject) => navigator.getMedia({\n    video: true,\n    audio: true\n  }, resolve, reject));\n  const connection = this.connection.get();\n  this.mediaStream.set(localMediaStream);\n  let options = {\n    mimeType: 'video/webm;codecs=vp9'\n  };\n\n  if (!MediaRecorder.isTypeSupported(options.mimeType)) {\n    options = {\n      mimeType: 'video/webm;codecs=vp8'\n    };\n\n    if (!MediaRecorder.isTypeSupported(options.mimeType)) {\n      options = {\n        mimeType: 'video/webm'\n      };\n\n      if (!MediaRecorder.isTypeSupported(options.mimeType)) {\n        options = {\n          mimeType: ''\n        };\n      }\n    }\n  }\n\n  try {\n    const mediaRecorder = new MediaRecorder(localMediaStream, options);\n\n    mediaRecorder.ondataavailable = event => {\n      if (!(event.data || event.data.size > 0)) {\n        return;\n      }\n\n      sendMessageToWebSocket(event.data, connection);\n    };\n\n    mediaRecorder.start(100); // collect 100ms of data\n\n    this.mediaRecorder.set(mediaRecorder);\n    await waitForStreamStatus(this.data.stream.id, 'active');\n    await call('setLivestreamStatus', {\n      broadcastId: this.data.broadcast.id,\n      status: 'testing'\n    });\n    await waitForBroadcastStatus(this.data.broadcast.id, 'testing');\n    document.querySelector('.streaming-popup').dispatchEvent(new Event('broadcastStreamReady'));\n  } catch (e) {\n    console.log(e);\n  }\n});\nTemplate.broadcastView.events({\n  async 'startStreaming .streaming-popup'(e, i) {\n    await call('setLivestreamStatus', {\n      broadcastId: i.data.broadcast.id,\n      status: 'live'\n    });\n    document.querySelector('.streaming-popup').dispatchEvent(new Event('broadcastStream'));\n    await call('saveRoomSettings', Session.get('openedRoom'), 'streamingOptions', {\n      id: i.data.broadcast.id,\n      url: \"https://www.youtube.com/embed/\".concat(i.data.broadcast.id),\n      thumbnail: \"https://img.youtube.com/vi/\".concat(i.data.broadcast.id, \"/0.jpg\")\n    });\n  },\n\n  async 'stopStreaming .streaming-popup'(e, i) {\n    await call('setBroadcastStatus', {\n      broadcastId: i.data.broadcast.id,\n      status: 'complete'\n    });\n    await call('saveRoomSettings', Session.get('openedRoom'), 'streamingOptions', {}, err => {\n      if (err) {\n        return handleError(err);\n      }\n\n      i.editing.set(false);\n      i.streamingOptions.set({});\n    });\n\n    if (i.mediaRecorder.get()) {\n      i.mediaRecorder.get().stop();\n      i.mediaRecorder.set(null);\n    }\n\n    if (i.mediaStream.get()) {\n      i.mediaStream.get().getTracks().map(track => track.stop());\n      i.mediaStream.set(null);\n    }\n  }\n\n});","map":{"version":3,"sources":["app/livestream/client/views/broadcastView.js"],"names":["module","export","call","Meteor","link","v","ReactiveVar","Session","Template","handleError","settings","getMedia","navigator","getUserMedia","webkitGetUserMedia","mozGetUserMedia","msGetUserMedia","createAndConnect","url","window","ws","WebSocket","onerror","evt","console","error","data","sendMessageToWebSocket","message","readyState","send","args","Promise","resolve","reject","err","result","delay","time","setTimeout","waitForStreamStatus","id","status","streamActive","currentStatus","streamId","waitForBroadcastStatus","broadcastActive","broadcastId","broadcastView","helpers","broadcastSource","instance","mediaStream","get","URL","createObjectURL","mediaRecorder","onCreated","connection","onDestroyed","close","stop","set","getTracks","map","track","onRendered","alert","localMediaStream","video","audio","options","mimeType","MediaRecorder","isTypeSupported","ondataavailable","event","size","start","stream","broadcast","document","querySelector","dispatchEvent","Event","e","log","events","i","thumbnail","editing","streamingOptions"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { ReactiveVar } from 'meteor/reactive-var';\nimport { Session } from 'meteor/session';\nimport { Template } from 'meteor/templating';\n\nimport { handleError } from '../../../../client/lib/utils/handleError';\nimport { settings } from '../../../settings/client';\n\nconst getMedia = () => navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;\nconst createAndConnect = (url) => {\n\tif (!('WebSocket' in window)) {\n\t\t// eslint-disable-line no-negated-in-lhs\n\t\treturn false;\n\t}\n\n\tconst ws = new WebSocket(url);\n\tws.onerror = (evt) => console.error(`Error: ${evt.data}`);\n\treturn ws;\n};\nconst sendMessageToWebSocket = (message, ws) => {\n\tif (ws != null) {\n\t\tif (ws.readyState === 1) {\n\t\t\tws.send(message);\n\t\t}\n\t}\n};\nexport const call = (...args) =>\n\tnew Promise(function (resolve, reject) {\n\t\tMeteor.call(...args, function (err, result) {\n\t\t\tif (err) {\n\t\t\t\thandleError(err);\n\t\t\t\treject(err);\n\t\t\t}\n\t\t\tresolve(result);\n\t\t});\n\t});\n\nconst delay = (time) => new Promise((resolve) => setTimeout(resolve, time));\n\nconst waitForStreamStatus = async (id, status) => {\n\tconst streamActive = new Promise(async (resolve) => {\n\t\t// eslint-disable-next-line no-constant-condition\n\t\twhile (true) {\n\t\t\tconst currentStatus = await call('livestreamStreamStatus', { streamId: id }); // eslint-disable-line no-await-in-loop\n\t\t\tif (currentStatus === status) {\n\t\t\t\treturn resolve(status);\n\t\t\t}\n\t\t\tawait delay(1500); // eslint-disable-line no-await-in-loop\n\t\t}\n\t});\n\tawait streamActive;\n};\nconst waitForBroadcastStatus = async (id, status) => {\n\tconst broadcastActive = new Promise(async (resolve) => {\n\t\t// eslint-disable-next-line no-constant-condition\n\t\twhile (true) {\n\t\t\tconst currentStatus = await call('getBroadcastStatus', { broadcastId: id }); // eslint-disable-line no-await-in-loop\n\t\t\tif (currentStatus === status) {\n\t\t\t\treturn resolve(status);\n\t\t\t}\n\t\t\tawait delay(1500); // eslint-disable-line no-await-in-loop\n\t\t}\n\t});\n\tawait broadcastActive;\n};\n\nTemplate.broadcastView.helpers({\n\tbroadcastSource() {\n\t\treturn Template.instance().mediaStream.get() ? window.URL.createObjectURL(Template.instance().mediaStream.get()) : '';\n\t},\n\tmediaRecorder() {\n\t\tTemplate.instance().mediaRecorder.get();\n\t},\n});\n\nTemplate.broadcastView.onCreated(async function () {\n\tconst connection = createAndConnect(`${settings.get('Broadcasting_media_server_url')}/${this.data.id}`);\n\tthis.mediaStream = new ReactiveVar(null);\n\tthis.mediaRecorder = new ReactiveVar(null);\n\tthis.connection = new ReactiveVar(connection);\n});\nTemplate.broadcastView.onDestroyed(function () {\n\tif (this.connection.get()) {\n\t\tthis.connection.get().close();\n\t}\n\tif (this.mediaRecorder.get()) {\n\t\tthis.mediaRecorder.get().stop();\n\t\tthis.mediaRecorder.set(null);\n\t}\n\tif (this.mediaStream.get()) {\n\t\tthis.mediaStream\n\t\t\t.get()\n\t\t\t.getTracks()\n\t\t\t.map((track) => track.stop());\n\t\tthis.mediaStream.set(null);\n\t}\n});\nTemplate.broadcastView.onRendered(async function () {\n\tnavigator.getMedia = getMedia();\n\tif (!navigator.getMedia) {\n\t\treturn alert('getUserMedia() is not supported in your browser!');\n\t}\n\tconst localMediaStream = await new Promise((resolve, reject) => navigator.getMedia({ video: true, audio: true }, resolve, reject));\n\n\tconst connection = this.connection.get();\n\n\tthis.mediaStream.set(localMediaStream);\n\tlet options = { mimeType: 'video/webm;codecs=vp9' };\n\tif (!MediaRecorder.isTypeSupported(options.mimeType)) {\n\t\toptions = { mimeType: 'video/webm;codecs=vp8' };\n\t\tif (!MediaRecorder.isTypeSupported(options.mimeType)) {\n\t\t\toptions = { mimeType: 'video/webm' };\n\t\t\tif (!MediaRecorder.isTypeSupported(options.mimeType)) {\n\t\t\t\toptions = { mimeType: '' };\n\t\t\t}\n\t\t}\n\t}\n\ttry {\n\t\tconst mediaRecorder = new MediaRecorder(localMediaStream, options);\n\t\tmediaRecorder.ondataavailable = (event) => {\n\t\t\tif (!(event.data || event.data.size > 0)) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tsendMessageToWebSocket(event.data, connection);\n\t\t};\n\t\tmediaRecorder.start(100); // collect 100ms of data\n\t\tthis.mediaRecorder.set(mediaRecorder);\n\n\t\tawait waitForStreamStatus(this.data.stream.id, 'active');\n\t\tawait call('setLivestreamStatus', { broadcastId: this.data.broadcast.id, status: 'testing' });\n\t\tawait waitForBroadcastStatus(this.data.broadcast.id, 'testing');\n\t\tdocument.querySelector('.streaming-popup').dispatchEvent(new Event('broadcastStreamReady'));\n\t} catch (e) {\n\t\tconsole.log(e);\n\t}\n});\n\nTemplate.broadcastView.events({\n\tasync 'startStreaming .streaming-popup'(e, i) {\n\t\tawait call('setLivestreamStatus', { broadcastId: i.data.broadcast.id, status: 'live' });\n\t\tdocument.querySelector('.streaming-popup').dispatchEvent(new Event('broadcastStream'));\n\t\tawait call('saveRoomSettings', Session.get('openedRoom'), 'streamingOptions', {\n\t\t\tid: i.data.broadcast.id,\n\t\t\turl: `https://www.youtube.com/embed/${i.data.broadcast.id}`,\n\t\t\tthumbnail: `https://img.youtube.com/vi/${i.data.broadcast.id}/0.jpg`,\n\t\t});\n\t},\n\tasync 'stopStreaming .streaming-popup'(e, i) {\n\t\tawait call('setBroadcastStatus', { broadcastId: i.data.broadcast.id, status: 'complete' });\n\t\tawait call('saveRoomSettings', Session.get('openedRoom'), 'streamingOptions', {}, (err) => {\n\t\t\tif (err) {\n\t\t\t\treturn handleError(err);\n\t\t\t}\n\t\t\ti.editing.set(false);\n\t\t\ti.streamingOptions.set({});\n\t\t});\n\t\tif (i.mediaRecorder.get()) {\n\t\t\ti.mediaRecorder.get().stop();\n\t\t\ti.mediaRecorder.set(null);\n\t\t}\n\t\tif (i.mediaStream.get()) {\n\t\t\ti.mediaStream\n\t\t\t\t.get()\n\t\t\t\t.getTracks()\n\t\t\t\t.map((track) => track.stop());\n\t\t\ti.mediaStream.set(null);\n\t\t}\n\t},\n});\n"]},"sourceType":"module","hash":"eab711bc59d543cd0941ce112203c8f1c48a310b"}
