{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui-message/client/popup/messagePopupConfig.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"app/ui-message/client/popup/messagePopupConfig.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui-message/client/popup/messagePopupConfig.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{}},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui-message/client/popup/messagePopupConfig.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/ui-message/client/popup/messagePopupConfig.js"}},"code":"var _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default: function (v) {\n    _objectSpread = v;\n  }\n}, 0);\n\nvar _regeneratorRuntime;\n\nmodule.link(\"@babel/runtime/regenerator\", {\n  default: function (v) {\n    _regeneratorRuntime = v;\n  }\n}, 1);\n\nvar _;\n\nmodule.link(\"underscore\", {\n  \"default\": function (v) {\n    _ = v;\n  }\n}, 0);\nvar Blaze;\nmodule.link(\"meteor/blaze\", {\n  Blaze: function (v) {\n    Blaze = v;\n  }\n}, 1);\nvar Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 2);\nvar Mongo;\nmodule.link(\"meteor/mongo\", {\n  Mongo: function (v) {\n    Mongo = v;\n  }\n}, 3);\nvar Tracker;\nmodule.link(\"meteor/tracker\", {\n  Tracker: function (v) {\n    Tracker = v;\n  }\n}, 4);\nvar Session;\nmodule.link(\"meteor/session\", {\n  Session: function (v) {\n    Session = v;\n  }\n}, 5);\nvar Template;\nmodule.link(\"meteor/templating\", {\n  Template: function (v) {\n    Template = v;\n  }\n}, 6);\nvar TAPi18n;\nmodule.link(\"meteor/rocketchat:tap-i18n\", {\n  TAPi18n: function (v) {\n    TAPi18n = v;\n  }\n}, 7);\nvar escapeRegExp;\nmodule.link(\"@rocket.chat/string-helpers\", {\n  escapeRegExp: function (v) {\n    escapeRegExp = v;\n  }\n}, 8);\nvar Messages, Subscriptions;\nmodule.link(\"../../../models/client\", {\n  Messages: function (v) {\n    Messages = v;\n  },\n  Subscriptions: function (v) {\n    Subscriptions = v;\n  }\n}, 9);\nvar settings;\nmodule.link(\"../../../settings/client\", {\n  settings: function (v) {\n    settings = v;\n  }\n}, 10);\nvar hasAllPermission, hasAtLeastOnePermission;\nmodule.link(\"../../../authorization/client\", {\n  hasAllPermission: function (v) {\n    hasAllPermission = v;\n  },\n  hasAtLeastOnePermission: function (v) {\n    hasAtLeastOnePermission = v;\n  }\n}, 11);\nvar EmojiPicker, emoji;\nmodule.link(\"../../../emoji\", {\n  EmojiPicker: function (v) {\n    EmojiPicker = v;\n  },\n  emoji: function (v) {\n    emoji = v;\n  }\n}, 12);\nvar callWithErrorHandling;\nmodule.link(\"../../../../client/lib/utils/callWithErrorHandling\", {\n  callWithErrorHandling: function (v) {\n    callWithErrorHandling = v;\n  }\n}, 13);\nvar t, getUserPreference, slashCommands;\nmodule.link(\"../../../utils/client\", {\n  t: function (v) {\n    t = v;\n  },\n  getUserPreference: function (v) {\n    getUserPreference = v;\n  },\n  slashCommands: function (v) {\n    slashCommands = v;\n  }\n}, 14);\nvar customMessagePopups;\nmodule.link(\"./customMessagePopups\", {\n  customMessagePopups: function (v) {\n    customMessagePopups = v;\n  }\n}, 15);\nmodule.link(\"./messagePopupConfig.html\");\nmodule.link(\"./messagePopupSlashCommand.html\");\nmodule.link(\"./messagePopupUser.html\");\n\nvar reloadUsersFromRoomMessages = function (rid, template) {\n  var user = Meteor.userId() && Meteor.users.findOne(Meteor.userId(), {\n    fields: {\n      username: 1\n    }\n  });\n\n  if (!rid || !user) {\n    return;\n  }\n\n  template.usersFromRoomMessages.remove({});\n  var uniqueMessageUsersControl = {};\n  Messages.find({\n    rid: rid,\n    'u.username': {\n      $ne: user.username\n    },\n    't': {\n      $exists: false\n    }\n  }, {\n    fields: {\n      'u.username': 1,\n      'u.name': 1,\n      'ts': 1\n    },\n    sort: {\n      ts: -1\n    }\n  }).fetch().filter(function (_ref) {\n    var username = _ref.u.username;\n    var notMapped = !uniqueMessageUsersControl[username];\n    uniqueMessageUsersControl[username] = true;\n    return notMapped;\n  }).forEach(function (_ref2) {\n    var _ref2$u = _ref2.u,\n        username = _ref2$u.username,\n        name = _ref2$u.name,\n        ts = _ref2.ts;\n    return template.usersFromRoomMessages.upsert(username, {\n      _id: username,\n      username: username,\n      name: name,\n      status: Tracker.nonreactive(function () {\n        return Session.get(\"user_\" + username + \"_status\") || 'offline';\n      }),\n      ts: ts\n    });\n  });\n};\n\nvar fetchUsersFromServer = _.throttle(function () {\n  function _callee(filterText, records, rid, cb) {\n    var usernames, _await$callWithErrorH, users;\n\n    return _regeneratorRuntime.async(function () {\n      function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              usernames = records.map(function (_ref3) {\n                var username = _ref3.username;\n                return username;\n              });\n              _context.next = 3;\n              return _regeneratorRuntime.awrap(callWithErrorHandling('spotlight', filterText, usernames, {\n                users: true,\n                mentions: true\n              }, rid));\n\n            case 3:\n              _await$callWithErrorH = _context.sent;\n              users = _await$callWithErrorH.users;\n\n              if (!(!users || users.length <= 0)) {\n                _context.next = 7;\n                break;\n              }\n\n              return _context.abrupt(\"return\");\n\n            case 7:\n              users // .slice(0, 5)\n              .forEach(function (_ref4) {\n                var username = _ref4.username,\n                    nickname = _ref4.nickname,\n                    name = _ref4.name,\n                    status = _ref4.status,\n                    avatarETag = _ref4.avatarETag,\n                    outside = _ref4.outside;\n                // if (records.length < 5) {\n                records.push({\n                  _id: username,\n                  username: username,\n                  nickname: nickname,\n                  name: name,\n                  status: status,\n                  avatarETag: avatarETag,\n                  outside: outside,\n                  sort: 3\n                }); // }\n              });\n              records.sort(function (_ref5, _ref6) {\n                var sortA = _ref5.sort;\n                var sortB = _ref6.sort;\n                return sortA - sortB;\n              });\n              cb && cb(records);\n\n            case 10:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }\n\n      return _callee$;\n    }(), null, null, null, Promise);\n  }\n\n  return _callee;\n}(), 1000);\n\nvar fetchRoomsFromServer = _.throttle(function () {\n  function _callee2(filterText, records, rid, cb) {\n    var _await$callWithErrorH2, rooms;\n\n    return _regeneratorRuntime.async(function () {\n      function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              if (hasAllPermission('view-outside-room')) {\n                _context2.next = 3;\n                break;\n              }\n\n              cb && cb([]);\n              return _context2.abrupt(\"return\");\n\n            case 3:\n              _context2.next = 5;\n              return _regeneratorRuntime.awrap(callWithErrorHandling('spotlight', filterText, null, {\n                rooms: true,\n                mentions: true\n              }, rid));\n\n            case 5:\n              _await$callWithErrorH2 = _context2.sent;\n              rooms = _await$callWithErrorH2.rooms;\n\n              if (!(!rooms || rooms.length <= 0)) {\n                _context2.next = 9;\n                break;\n              }\n\n              return _context2.abrupt(\"return\");\n\n            case 9:\n              rooms.slice(0, 5).forEach(function (room) {\n                if (records.length < 5) {\n                  records.push(room);\n                }\n              });\n              cb && cb(records);\n\n            case 11:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }\n\n      return _callee2$;\n    }(), null, null, null, Promise);\n  }\n\n  return _callee2;\n}(), 1000);\n\nvar emojiSort = function (recents) {\n  return function (a, b) {\n    var idA = a._id;\n    var idB = a._id;\n\n    if (recents.includes(a._id)) {\n      idA = recents.indexOf(a._id) + idA;\n    }\n\n    if (recents.includes(b._id)) {\n      idB = recents.indexOf(b._id) + idB;\n    }\n\n    if (idA < idB) {\n      return -1;\n    }\n\n    if (idA > idB) {\n      return 1;\n    }\n\n    return 0;\n  };\n};\n\nvar exactFinalTone = new RegExp('^tone[1-5]:*$');\nvar colorBlind = new RegExp('tone[1-5]:*$');\nvar seeColor = new RegExp('_t(?:o|$)(?:n|$)(?:e|$)(?:[1-5]|$)(?::|$)$');\n\nvar getEmojis = function (collection, filter) {\n  var key = \":\" + filter;\n\n  if (!getUserPreference(Meteor.userId(), 'useEmojis')) {\n    return [];\n  }\n\n  if (!emoji.packages.emojione || emoji.packages.emojione.asciiList[key]) {\n    return [];\n  }\n\n  var regExp = new RegExp(escapeRegExp(filter), 'i');\n  var recents = EmojiPicker.getRecent().map(function (item) {\n    return \":\" + item + \":\";\n  });\n  return Object.keys(collection).map(function (_id) {\n    var data = collection[key];\n    return {\n      _id: _id,\n      data: data\n    };\n  }).filter(function (_ref7) {\n    var _id = _ref7._id;\n    return regExp.test(_id) && (exactFinalTone.test(_id.substring(key.length)) || seeColor.test(key) || !colorBlind.test(_id));\n  }).sort(emojiSort(recents)).slice(0, 10);\n};\n\nvar addEmojiToRecents = function (emoji) {\n  var pickerEl = document.querySelector('.emoji-picker');\n\n  if (!pickerEl) {\n    return;\n  }\n\n  var view = Blaze.getView(pickerEl);\n\n  if (!view) {\n    return;\n  }\n\n  Template._withTemplateInstanceFunc(view.templateInstance, function () {\n    EmojiPicker.addRecent(emoji.replace(/:/g, ''));\n  });\n};\n\nTemplate.messagePopupConfig.onCreated(function () {\n  var _this = this;\n\n  this.usersFromRoomMessages = new Mongo.Collection(null);\n  this.autorun(function () {\n    var rid = _this.data.rid;\n    reloadUsersFromRoomMessages(rid, _this);\n  });\n});\nTemplate.messagePopupConfig.helpers({\n  customMessagePopups: function () {\n    return customMessagePopups.get();\n  },\n  getCustomConfig: function () {\n    var template = Template.instance();\n    return this.configGetter(template);\n  },\n  popupUserConfig: function () {\n    var _this2 = this;\n\n    var template = Template.instance();\n    var suggestionsCount = settings.get('Number_of_users_autocomplete_suggestions');\n    return {\n      title: t('People'),\n      collection: template.usersFromRoomMessages,\n      template: 'messagePopupUser',\n      rid: this.rid,\n      getInput: this.getInput,\n      textFilterDelay: 500,\n      trigger: '@',\n      suffix: ' ',\n      getFilter: function (collection) {\n        var filter = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : '';\n        var cb = arguments.length > 2 ? arguments[2] : undefined;\n        var rid = _this2.rid;\n        var filterText = filter.trim();\n        var filterRegex = filterText !== '' && new RegExp(\"\" + escapeRegExp(filterText), 'i');\n        var items = template.usersFromRoomMessages.find(_objectSpread({\n          ts: {\n            $exists: true\n          }\n        }, filterText && {\n          $or: [{\n            username: filterRegex\n          }, {\n            name: filterRegex\n          }]\n        }), {\n          limit: filterText ? 2 : suggestionsCount,\n          sort: {\n            ts: -1\n          }\n        }).fetch().map(function (u) {\n          u.suggestion = true;\n          return u;\n        }); // // If needed, add to list the online users\n        // if (items.length < 5 && filterRegex) {\n        // \tconst usernamesAlreadyFetched = items.map(({ username }) => username);\n        // \tif (!hasAllPermission('view-outside-room')) {\n        // \t\tconst usernamesFromDMs = Subscriptions\n        // \t\t\t.find(\n        // \t\t\t\t{\n        // \t\t\t\t\tt: 'd',\n        // \t\t\t\t\t$and: [\n        // \t\t\t\t\t\t{\n        // \t\t\t\t\t\t\t...filterRegex && {\n        // \t\t\t\t\t\t\t\t$or: [\n        // \t\t\t\t\t\t\t\t\t{ name: filterRegex },\n        // \t\t\t\t\t\t\t\t\t{ fname: filterRegex },\n        // \t\t\t\t\t\t\t\t],\n        // \t\t\t\t\t\t\t},\n        // \t\t\t\t\t\t},\n        // \t\t\t\t\t\t{\n        // \t\t\t\t\t\t\tname: { $nin: usernamesAlreadyFetched },\n        // \t\t\t\t\t\t},\n        // \t\t\t\t\t],\n        // \t\t\t\t},\n        // \t\t\t\t{\n        // \t\t\t\t\tfields: { name: 1 },\n        // \t\t\t\t},\n        // \t\t\t)\n        // \t\t\t.map(({ name }) => name);\n        // \t\tconst newItems = Users\n        // \t\t\t.find(\n        // \t\t\t\t{\n        // \t\t\t\t\tusername: {\n        // \t\t\t\t\t\t$in: usernamesFromDMs,\n        // \t\t\t\t\t},\n        // \t\t\t\t},\n        // \t\t\t\t{\n        // \t\t\t\t\tfields: {\n        // \t\t\t\t\t\tusername: 1,\n        // \t\t\t\t\t\tnickname: 1,\n        // \t\t\t\t\t\tname: 1,\n        // \t\t\t\t\t\tstatus: 1,\n        // \t\t\t\t\t},\n        // \t\t\t\t\tlimit: 5 - usernamesAlreadyFetched.length,\n        // \t\t\t\t},\n        // \t\t\t)\n        // \t\t\t.fetch()\n        // \t\t\t.map(({ username, name, status, nickname }) => ({\n        // \t\t\t\t_id: username,\n        // \t\t\t\tusername,\n        // \t\t\t\tnickname,\n        // \t\t\t\tname,\n        // \t\t\t\tstatus,\n        // \t\t\t\tsort: 1,\n        // \t\t\t}));\n        // \t\titems.push(...newItems);\n        // \t} else {\n        // \t\tconst user = Meteor.users.findOne(Meteor.userId(), { fields: { username: 1 } });\n        // \t\tconst newItems = Meteor.users.find({\n        // \t\t\t$and: [\n        // \t\t\t\t{\n        // \t\t\t\t\t...filterRegex && {\n        // \t\t\t\t\t\t$or: [\n        // \t\t\t\t\t\t\t{ username: filterRegex },\n        // \t\t\t\t\t\t\t{ name: filterRegex },\n        // \t\t\t\t\t\t],\n        // \t\t\t\t\t},\n        // \t\t\t\t},\n        // \t\t\t\t{\n        // \t\t\t\t\tusername: {\n        // \t\t\t\t\t\t$nin: [\n        // \t\t\t\t\t\t\tuser && user.username,\n        // \t\t\t\t\t\t\t...usernamesAlreadyFetched,\n        // \t\t\t\t\t\t],\n        // \t\t\t\t\t},\n        // \t\t\t\t},\n        // \t\t\t],\n        // \t\t},\n        // \t\t{\n        // \t\t\tfields: {\n        // \t\t\t\tusername: 1,\n        // \t\t\t\tnickname: 1,\n        // \t\t\t\tname: 1,\n        // \t\t\t\tstatus: 1,\n        // \t\t\t},\n        // \t\t\tlimit: 5 - usernamesAlreadyFetched.length,\n        // \t\t})\n        // \t\t\t.fetch()\n        // \t\t\t.map(({ username, name, status, nickname }) => ({\n        // \t\t\t\t_id: username,\n        // \t\t\t\tusername,\n        // \t\t\t\tnickname,\n        // \t\t\t\tname,\n        // \t\t\t\tstatus,\n        // \t\t\t\tsort: 1,\n        // \t\t\t}));\n        // \t\titems.push(...newItems);\n        // \t}\n        // }\n        // Get users from Server\n\n        if (items.length < suggestionsCount && filterText !== '') {\n          fetchUsersFromServer(filterText, items, rid, cb);\n        }\n\n        if (!filterRegex || filterRegex.test('all')) {\n          items.push({\n            _id: 'all',\n            username: 'all',\n            system: true,\n            name: t('Notify_all_in_this_room'),\n            sort: 4\n          });\n        }\n\n        if (!filterRegex || filterRegex.test('here')) {\n          items.push({\n            _id: 'here',\n            username: 'here',\n            system: true,\n            name: t('Notify_active_in_this_room'),\n            sort: 4\n          });\n        }\n\n        return items;\n      },\n      getValue: function (_id) {\n        return _id;\n      }\n    };\n  },\n  popupChannelConfig: function () {\n    var _this3 = this;\n\n    return {\n      title: t('Channels'),\n      collection: Subscriptions,\n      trigger: '#',\n      suffix: ' ',\n      textFilterDelay: 500,\n      template: 'messagePopupChannel',\n      rid: this.rid,\n      getInput: this.getInput,\n      getFilter: function (collection, filter, cb) {\n        var rid = _this3.rid;\n        var exp = new RegExp(filter, 'i');\n        var records = collection.find({\n          name: exp,\n          t: {\n            $in: ['c', 'p']\n          }\n        }, {\n          reactive: 1,\n          limit: 5,\n          sort: {\n            ls: -1\n          }\n        }).fetch();\n\n        if (records.length < 5 && filter && filter.trim() !== '') {\n          fetchRoomsFromServer(filter, records, rid, cb);\n        }\n\n        return records;\n      },\n      getValue: function (_id, collection, records) {\n        var record = _.findWhere(records, {\n          _id: _id\n        });\n\n        return record && record.name;\n      }\n    };\n  },\n  popupSlashCommandsConfig: function () {\n    var _this4 = this;\n\n    return {\n      title: t('Commands'),\n      collection: slashCommands.commands,\n      trigger: '/',\n      suffix: ' ',\n      triggerAnywhere: false,\n      template: 'messagePopupSlashCommand',\n      rid: this.rid,\n      getInput: this.getInput,\n      getFilter: function (collection, filter) {\n        var rid = _this4.rid;\n        return Object.keys(collection).map(function (command) {\n          var item = collection[command];\n          return {\n            _id: command,\n            params: item.params ? TAPi18n.__(item.params) : '',\n            description: TAPi18n.__(item.description),\n            permission: item.permission\n          };\n        }).filter(function (command) {\n          var isMatch = command._id.indexOf(filter) > -1;\n\n          if (!isMatch) {\n            return false;\n          }\n\n          if (!command.permission) {\n            return true;\n          }\n\n          return hasAtLeastOnePermission(command.permission, rid);\n        }).sort(function (a, b) {\n          return a._id > b._id;\n        }).slice(0, 11);\n      }\n    };\n  },\n  popupEmojiConfig: function () {\n    return {\n      title: t('Emoji'),\n      collection: emoji.list,\n      template: 'messagePopupEmoji',\n      trigger: ':',\n      prefix: '',\n      suffix: ' ',\n      rid: this.rid,\n      getInput: this.getInput,\n      getFilter: getEmojis,\n      getValue: function (emojiText) {\n        addEmojiToRecents(emojiText);\n        return emojiText;\n      }\n    };\n  },\n  popupReactionEmojiConfig: function () {\n    return {\n      title: t('Emoji'),\n      collection: emoji.list,\n      template: 'messagePopupEmoji',\n      trigger: '\\\\+:',\n      prefix: '+',\n      suffix: ' ',\n      rid: this.rid,\n      getInput: this.getInput,\n      getFilter: getEmojis,\n      getValue: function (emojiText) {\n        addEmojiToRecents(emojiText);\n        return emojiText;\n      }\n    };\n  }\n});","map":{"version":3,"sources":["app/ui-message/client/popup/messagePopupConfig.js"],"names":["_objectSpread","module","link","default","v","_regeneratorRuntime","_","Blaze","Meteor","Mongo","Tracker","Session","Template","TAPi18n","escapeRegExp","Messages","Subscriptions","settings","hasAllPermission","hasAtLeastOnePermission","EmojiPicker","emoji","callWithErrorHandling","t","getUserPreference","slashCommands","customMessagePopups","reloadUsersFromRoomMessages","rid","template","user","userId","users","findOne","fields","username","usersFromRoomMessages","remove","uniqueMessageUsersControl","find","$ne","$exists","sort","ts","fetch","filter","u","notMapped","forEach","name","upsert","_id","status","nonreactive","get","fetchUsersFromServer","throttle","filterText","records","cb","usernames","map","mentions","length","nickname","avatarETag","outside","push","sortA","sortB","fetchRoomsFromServer","rooms","slice","room","emojiSort","recents","a","b","idA","idB","includes","indexOf","exactFinalTone","RegExp","colorBlind","seeColor","getEmojis","collection","key","packages","emojione","asciiList","regExp","getRecent","item","Object","keys","data","test","substring","addEmojiToRecents","pickerEl","document","querySelector","view","getView","_withTemplateInstanceFunc","templateInstance","addRecent","replace","messagePopupConfig","onCreated","Collection","autorun","helpers","getCustomConfig","instance","configGetter","popupUserConfig","suggestionsCount","title","getInput","textFilterDelay","trigger","suffix","getFilter","trim","filterRegex","items","$or","limit","suggestion","system","getValue","popupChannelConfig","exp","$in","reactive","ls","record","findWhere","popupSlashCommandsConfig","commands","triggerAnywhere","command","params","__","description","permission","isMatch","popupEmojiConfig","list","prefix","emojiText","popupReactionEmojiConfig"],"mappings":"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;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;;AACA,YAAIkF,KAAK,CAACjE,MAAN,GAAewD,gBAAf,IAAmC9D,UAAU,KAAK,EAAtD,EAA0D;AACzDF,UAAAA,oBAAoB,CAACE,UAAD,EAAauE,KAAb,EAAoBpG,GAApB,EAAyB+B,EAAzB,CAApB;AACA;;AAED,YAAI,CAACoE,WAAD,IAAgBA,WAAW,CAAC7B,IAAZ,CAAiB,KAAjB,CAApB,EAA6C;AAC5C8B,UAAAA,KAAK,CAAC7D,IAAN,CAAW;AACVhB,YAAAA,GAAG,EAAE,KADK;AAEVhB,YAAAA,QAAQ,EAAE,KAFA;AAGViG,YAAAA,MAAM,EAAE,IAHE;AAIVnF,YAAAA,IAAI,EAAE1B,CAAC,CAAC,yBAAD,CAJG;AAKVmB,YAAAA,IAAI,EAAE;AALI,WAAX;AAOA;;AAED,YAAI,CAACqF,WAAD,IAAgBA,WAAW,CAAC7B,IAAZ,CAAiB,MAAjB,CAApB,EAA8C;AAC7C8B,UAAAA,KAAK,CAAC7D,IAAN,CAAW;AACVhB,YAAAA,GAAG,EAAE,MADK;AAEVhB,YAAAA,QAAQ,EAAE,MAFA;AAGViG,YAAAA,MAAM,EAAE,IAHE;AAIVnF,YAAAA,IAAI,EAAE1B,CAAC,CAAC,4BAAD,CAJG;AAKVmB,YAAAA,IAAI,EAAE;AALI,WAAX;AAOA;;AAED,eAAOsF,KAAP;AACA,OA/JK;AAgKN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","sourcesContent":["import _ from 'underscore';\nimport { Blaze } from 'meteor/blaze';\nimport { Meteor } from 'meteor/meteor';\nimport { Mongo } from 'meteor/mongo';\nimport { Tracker } from 'meteor/tracker';\nimport { Session } from 'meteor/session';\nimport { Template } from 'meteor/templating';\nimport { TAPi18n } from 'meteor/rocketchat:tap-i18n';\nimport { escapeRegExp } from '@rocket.chat/string-helpers';\n\nimport { Messages, Subscriptions } from '../../../models/client';\nimport { settings } from '../../../settings/client';\nimport { hasAllPermission, hasAtLeastOnePermission } from '../../../authorization/client';\nimport { EmojiPicker, emoji } from '../../../emoji';\nimport { callWithErrorHandling } from '../../../../client/lib/utils/callWithErrorHandling';\nimport { t, getUserPreference, slashCommands } from '../../../utils/client';\nimport { customMessagePopups } from './customMessagePopups';\nimport './messagePopupConfig.html';\nimport './messagePopupSlashCommand.html';\nimport './messagePopupUser.html';\n\nconst reloadUsersFromRoomMessages = (rid, template) => {\n\tconst user = Meteor.userId() && Meteor.users.findOne(Meteor.userId(), { fields: { username: 1 } });\n\tif (!rid || !user) {\n\t\treturn;\n\t}\n\n\ttemplate.usersFromRoomMessages.remove({});\n\n\tconst uniqueMessageUsersControl = {};\n\n\tMessages.find(\n\t\t{\n\t\t\trid,\n\t\t\t'u.username': { $ne: user.username },\n\t\t\t't': { $exists: false },\n\t\t},\n\t\t{\n\t\t\tfields: {\n\t\t\t\t'u.username': 1,\n\t\t\t\t'u.name': 1,\n\t\t\t\t'ts': 1,\n\t\t\t},\n\t\t\tsort: { ts: -1 },\n\t\t},\n\t)\n\t\t.fetch()\n\t\t.filter(({ u: { username } }) => {\n\t\t\tconst notMapped = !uniqueMessageUsersControl[username];\n\t\t\tuniqueMessageUsersControl[username] = true;\n\t\t\treturn notMapped;\n\t\t})\n\t\t.forEach(({ u: { username, name }, ts }) =>\n\t\t\ttemplate.usersFromRoomMessages.upsert(username, {\n\t\t\t\t_id: username,\n\t\t\t\tusername,\n\t\t\t\tname,\n\t\t\t\tstatus: Tracker.nonreactive(() => Session.get(`user_${username}_status`) || 'offline'),\n\t\t\t\tts,\n\t\t\t}),\n\t\t);\n};\n\nconst fetchUsersFromServer = _.throttle(async (filterText, records, rid, cb) => {\n\tconst usernames = records.map(({ username }) => username);\n\n\tconst { users } = await callWithErrorHandling('spotlight', filterText, usernames, { users: true, mentions: true }, rid);\n\n\tif (!users || users.length <= 0) {\n\t\treturn;\n\t}\n\n\tusers\n\t\t// .slice(0, 5)\n\t\t.forEach(({ username, nickname, name, status, avatarETag, outside }) => {\n\t\t\t// if (records.length < 5) {\n\t\t\trecords.push({\n\t\t\t\t_id: username,\n\t\t\t\tusername,\n\t\t\t\tnickname,\n\t\t\t\tname,\n\t\t\t\tstatus,\n\t\t\t\tavatarETag,\n\t\t\t\toutside,\n\t\t\t\tsort: 3,\n\t\t\t});\n\t\t\t// }\n\t\t});\n\n\trecords.sort(({ sort: sortA }, { sort: sortB }) => sortA - sortB);\n\n\tcb && cb(records);\n}, 1000);\n\nconst fetchRoomsFromServer = _.throttle(async (filterText, records, rid, cb) => {\n\tif (!hasAllPermission('view-outside-room')) {\n\t\tcb && cb([]);\n\t\treturn;\n\t}\n\n\tconst { rooms } = await callWithErrorHandling('spotlight', filterText, null, { rooms: true, mentions: true }, rid);\n\n\tif (!rooms || rooms.length <= 0) {\n\t\treturn;\n\t}\n\n\trooms.slice(0, 5).forEach((room) => {\n\t\tif (records.length < 5) {\n\t\t\trecords.push(room);\n\t\t}\n\t});\n\n\tcb && cb(records);\n}, 1000);\n\nconst emojiSort = (recents) => (a, b) => {\n\tlet idA = a._id;\n\tlet idB = a._id;\n\n\tif (recents.includes(a._id)) {\n\t\tidA = recents.indexOf(a._id) + idA;\n\t}\n\tif (recents.includes(b._id)) {\n\t\tidB = recents.indexOf(b._id) + idB;\n\t}\n\n\tif (idA < idB) {\n\t\treturn -1;\n\t}\n\n\tif (idA > idB) {\n\t\treturn 1;\n\t}\n\n\treturn 0;\n};\nconst exactFinalTone = new RegExp('^tone[1-5]:*$');\nconst colorBlind = new RegExp('tone[1-5]:*$');\nconst seeColor = new RegExp('_t(?:o|$)(?:n|$)(?:e|$)(?:[1-5]|$)(?::|$)$');\nconst getEmojis = (collection, filter) => {\n\tconst key = `:${filter}`;\n\n\tif (!getUserPreference(Meteor.userId(), 'useEmojis')) {\n\t\treturn [];\n\t}\n\n\tif (!emoji.packages.emojione || emoji.packages.emojione.asciiList[key]) {\n\t\treturn [];\n\t}\n\n\tconst regExp = new RegExp(escapeRegExp(filter), 'i');\n\tconst recents = EmojiPicker.getRecent().map((item) => `:${item}:`);\n\n\treturn Object.keys(collection)\n\t\t.map((_id) => {\n\t\t\tconst data = collection[key];\n\t\t\treturn { _id, data };\n\t\t})\n\t\t.filter(\n\t\t\t({ _id }) => regExp.test(_id) && (exactFinalTone.test(_id.substring(key.length)) || seeColor.test(key) || !colorBlind.test(_id)),\n\t\t)\n\t\t.sort(emojiSort(recents))\n\t\t.slice(0, 10);\n};\n\nconst addEmojiToRecents = (emoji) => {\n\tconst pickerEl = document.querySelector('.emoji-picker');\n\tif (!pickerEl) {\n\t\treturn;\n\t}\n\n\tconst view = Blaze.getView(pickerEl);\n\tif (!view) {\n\t\treturn;\n\t}\n\n\tTemplate._withTemplateInstanceFunc(view.templateInstance, () => {\n\t\tEmojiPicker.addRecent(emoji.replace(/:/g, ''));\n\t});\n};\n\nTemplate.messagePopupConfig.onCreated(function () {\n\tthis.usersFromRoomMessages = new Mongo.Collection(null);\n\n\tthis.autorun(() => {\n\t\tconst { rid } = this.data;\n\t\treloadUsersFromRoomMessages(rid, this);\n\t});\n});\n\nTemplate.messagePopupConfig.helpers({\n\tcustomMessagePopups() {\n\t\treturn customMessagePopups.get();\n\t},\n\n\tgetCustomConfig() {\n\t\tconst template = Template.instance();\n\t\treturn this.configGetter(template);\n\t},\n\n\tpopupUserConfig() {\n\t\tconst template = Template.instance();\n\t\tconst suggestionsCount = settings.get('Number_of_users_autocomplete_suggestions');\n\n\t\treturn {\n\t\t\ttitle: t('People'),\n\t\t\tcollection: template.usersFromRoomMessages,\n\t\t\ttemplate: 'messagePopupUser',\n\t\t\trid: this.rid,\n\t\t\tgetInput: this.getInput,\n\t\t\ttextFilterDelay: 500,\n\t\t\ttrigger: '@',\n\t\t\tsuffix: ' ',\n\t\t\tgetFilter: (collection, filter = '', cb) => {\n\t\t\t\tconst { rid } = this;\n\t\t\t\tconst filterText = filter.trim();\n\t\t\t\tconst filterRegex = filterText !== '' && new RegExp(`${escapeRegExp(filterText)}`, 'i');\n\n\t\t\t\tconst items = template.usersFromRoomMessages\n\t\t\t\t\t.find(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tts: { $exists: true },\n\t\t\t\t\t\t\t...(filterText && {\n\t\t\t\t\t\t\t\t$or: [{ username: filterRegex }, { name: filterRegex }],\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlimit: filterText ? 2 : suggestionsCount,\n\t\t\t\t\t\t\tsort: { ts: -1 },\n\t\t\t\t\t\t},\n\t\t\t\t\t)\n\t\t\t\t\t.fetch()\n\t\t\t\t\t.map((u) => {\n\t\t\t\t\t\tu.suggestion = true;\n\t\t\t\t\t\treturn u;\n\t\t\t\t\t});\n\n\t\t\t\t// // If needed, add to list the online users\n\t\t\t\t// if (items.length < 5 && filterRegex) {\n\t\t\t\t// \tconst usernamesAlreadyFetched = items.map(({ username }) => username);\n\t\t\t\t// \tif (!hasAllPermission('view-outside-room')) {\n\t\t\t\t// \t\tconst usernamesFromDMs = Subscriptions\n\t\t\t\t// \t\t\t.find(\n\t\t\t\t// \t\t\t\t{\n\t\t\t\t// \t\t\t\t\tt: 'd',\n\t\t\t\t// \t\t\t\t\t$and: [\n\t\t\t\t// \t\t\t\t\t\t{\n\t\t\t\t// \t\t\t\t\t\t\t...filterRegex && {\n\t\t\t\t// \t\t\t\t\t\t\t\t$or: [\n\t\t\t\t// \t\t\t\t\t\t\t\t\t{ name: filterRegex },\n\t\t\t\t// \t\t\t\t\t\t\t\t\t{ fname: filterRegex },\n\t\t\t\t// \t\t\t\t\t\t\t\t],\n\t\t\t\t// \t\t\t\t\t\t\t},\n\t\t\t\t// \t\t\t\t\t\t},\n\t\t\t\t// \t\t\t\t\t\t{\n\t\t\t\t// \t\t\t\t\t\t\tname: { $nin: usernamesAlreadyFetched },\n\t\t\t\t// \t\t\t\t\t\t},\n\t\t\t\t// \t\t\t\t\t],\n\t\t\t\t// \t\t\t\t},\n\t\t\t\t// \t\t\t\t{\n\t\t\t\t// \t\t\t\t\tfields: { name: 1 },\n\t\t\t\t// \t\t\t\t},\n\t\t\t\t// \t\t\t)\n\t\t\t\t// \t\t\t.map(({ name }) => name);\n\t\t\t\t// \t\tconst newItems = Users\n\t\t\t\t// \t\t\t.find(\n\t\t\t\t// \t\t\t\t{\n\t\t\t\t// \t\t\t\t\tusername: {\n\t\t\t\t// \t\t\t\t\t\t$in: usernamesFromDMs,\n\t\t\t\t// \t\t\t\t\t},\n\t\t\t\t// \t\t\t\t},\n\t\t\t\t// \t\t\t\t{\n\t\t\t\t// \t\t\t\t\tfields: {\n\t\t\t\t// \t\t\t\t\t\tusername: 1,\n\t\t\t\t// \t\t\t\t\t\tnickname: 1,\n\t\t\t\t// \t\t\t\t\t\tname: 1,\n\t\t\t\t// \t\t\t\t\t\tstatus: 1,\n\t\t\t\t// \t\t\t\t\t},\n\t\t\t\t// \t\t\t\t\tlimit: 5 - usernamesAlreadyFetched.length,\n\t\t\t\t// \t\t\t\t},\n\t\t\t\t// \t\t\t)\n\t\t\t\t// \t\t\t.fetch()\n\t\t\t\t// \t\t\t.map(({ username, name, status, nickname }) => ({\n\t\t\t\t// \t\t\t\t_id: username,\n\t\t\t\t// \t\t\t\tusername,\n\t\t\t\t// \t\t\t\tnickname,\n\t\t\t\t// \t\t\t\tname,\n\t\t\t\t// \t\t\t\tstatus,\n\t\t\t\t// \t\t\t\tsort: 1,\n\t\t\t\t// \t\t\t}));\n\n\t\t\t\t// \t\titems.push(...newItems);\n\t\t\t\t// \t} else {\n\t\t\t\t// \t\tconst user = Meteor.users.findOne(Meteor.userId(), { fields: { username: 1 } });\n\t\t\t\t// \t\tconst newItems = Meteor.users.find({\n\t\t\t\t// \t\t\t$and: [\n\t\t\t\t// \t\t\t\t{\n\t\t\t\t// \t\t\t\t\t...filterRegex && {\n\t\t\t\t// \t\t\t\t\t\t$or: [\n\t\t\t\t// \t\t\t\t\t\t\t{ username: filterRegex },\n\t\t\t\t// \t\t\t\t\t\t\t{ name: filterRegex },\n\t\t\t\t// \t\t\t\t\t\t],\n\t\t\t\t// \t\t\t\t\t},\n\t\t\t\t// \t\t\t\t},\n\t\t\t\t// \t\t\t\t{\n\t\t\t\t// \t\t\t\t\tusername: {\n\t\t\t\t// \t\t\t\t\t\t$nin: [\n\t\t\t\t// \t\t\t\t\t\t\tuser && user.username,\n\t\t\t\t// \t\t\t\t\t\t\t...usernamesAlreadyFetched,\n\t\t\t\t// \t\t\t\t\t\t],\n\t\t\t\t// \t\t\t\t\t},\n\t\t\t\t// \t\t\t\t},\n\t\t\t\t// \t\t\t],\n\t\t\t\t// \t\t},\n\t\t\t\t// \t\t{\n\t\t\t\t// \t\t\tfields: {\n\t\t\t\t// \t\t\t\tusername: 1,\n\t\t\t\t// \t\t\t\tnickname: 1,\n\t\t\t\t// \t\t\t\tname: 1,\n\t\t\t\t// \t\t\t\tstatus: 1,\n\t\t\t\t// \t\t\t},\n\t\t\t\t// \t\t\tlimit: 5 - usernamesAlreadyFetched.length,\n\t\t\t\t// \t\t})\n\t\t\t\t// \t\t\t.fetch()\n\t\t\t\t// \t\t\t.map(({ username, name, status, nickname }) => ({\n\t\t\t\t// \t\t\t\t_id: username,\n\t\t\t\t// \t\t\t\tusername,\n\t\t\t\t// \t\t\t\tnickname,\n\t\t\t\t// \t\t\t\tname,\n\t\t\t\t// \t\t\t\tstatus,\n\t\t\t\t// \t\t\t\tsort: 1,\n\t\t\t\t// \t\t\t}));\n\n\t\t\t\t// \t\titems.push(...newItems);\n\t\t\t\t// \t}\n\t\t\t\t// }\n\n\t\t\t\t// Get users from Server\n\t\t\t\tif (items.length < suggestionsCount && filterText !== '') {\n\t\t\t\t\tfetchUsersFromServer(filterText, items, rid, cb);\n\t\t\t\t}\n\n\t\t\t\tif (!filterRegex || filterRegex.test('all')) {\n\t\t\t\t\titems.push({\n\t\t\t\t\t\t_id: 'all',\n\t\t\t\t\t\tusername: 'all',\n\t\t\t\t\t\tsystem: true,\n\t\t\t\t\t\tname: t('Notify_all_in_this_room'),\n\t\t\t\t\t\tsort: 4,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tif (!filterRegex || filterRegex.test('here')) {\n\t\t\t\t\titems.push({\n\t\t\t\t\t\t_id: 'here',\n\t\t\t\t\t\tusername: 'here',\n\t\t\t\t\t\tsystem: true,\n\t\t\t\t\t\tname: t('Notify_active_in_this_room'),\n\t\t\t\t\t\tsort: 4,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\treturn items;\n\t\t\t},\n\t\t\tgetValue: (_id) => _id,\n\t\t};\n\t},\n\tpopupChannelConfig() {\n\t\treturn {\n\t\t\ttitle: t('Channels'),\n\t\t\tcollection: Subscriptions,\n\t\t\ttrigger: '#',\n\t\t\tsuffix: ' ',\n\t\t\ttextFilterDelay: 500,\n\t\t\ttemplate: 'messagePopupChannel',\n\t\t\trid: this.rid,\n\t\t\tgetInput: this.getInput,\n\t\t\tgetFilter: (collection, filter, cb) => {\n\t\t\t\tconst { rid } = this;\n\t\t\t\tconst exp = new RegExp(filter, 'i');\n\t\t\t\tconst records = collection\n\t\t\t\t\t.find(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tname: exp,\n\t\t\t\t\t\t\tt: {\n\t\t\t\t\t\t\t\t$in: ['c', 'p'],\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treactive: 1,\n\t\t\t\t\t\t\tlimit: 5,\n\t\t\t\t\t\t\tsort: {\n\t\t\t\t\t\t\t\tls: -1,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t)\n\t\t\t\t\t.fetch();\n\n\t\t\t\tif (records.length < 5 && filter && filter.trim() !== '') {\n\t\t\t\t\tfetchRoomsFromServer(filter, records, rid, cb);\n\t\t\t\t}\n\t\t\t\treturn records;\n\t\t\t},\n\t\t\tgetValue: (_id, collection, records) => {\n\t\t\t\tconst record = _.findWhere(records, {\n\t\t\t\t\t_id,\n\t\t\t\t});\n\t\t\t\treturn record && record.name;\n\t\t\t},\n\t\t};\n\t},\n\tpopupSlashCommandsConfig() {\n\t\treturn {\n\t\t\ttitle: t('Commands'),\n\t\t\tcollection: slashCommands.commands,\n\t\t\ttrigger: '/',\n\t\t\tsuffix: ' ',\n\t\t\ttriggerAnywhere: false,\n\t\t\ttemplate: 'messagePopupSlashCommand',\n\t\t\trid: this.rid,\n\t\t\tgetInput: this.getInput,\n\t\t\tgetFilter: (collection, filter) => {\n\t\t\t\tconst { rid } = this;\n\t\t\t\treturn Object.keys(collection)\n\t\t\t\t\t.map((command) => {\n\t\t\t\t\t\tconst item = collection[command];\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t_id: command,\n\t\t\t\t\t\t\tparams: item.params ? TAPi18n.__(item.params) : '',\n\t\t\t\t\t\t\tdescription: TAPi18n.__(item.description),\n\t\t\t\t\t\t\tpermission: item.permission,\n\t\t\t\t\t\t};\n\t\t\t\t\t})\n\t\t\t\t\t.filter((command) => {\n\t\t\t\t\t\tconst isMatch = command._id.indexOf(filter) > -1;\n\n\t\t\t\t\t\tif (!isMatch) {\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (!command.permission) {\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn hasAtLeastOnePermission(command.permission, rid);\n\t\t\t\t\t})\n\t\t\t\t\t.sort((a, b) => a._id > b._id)\n\t\t\t\t\t.slice(0, 11);\n\t\t\t},\n\t\t};\n\t},\n\tpopupEmojiConfig() {\n\t\treturn {\n\t\t\ttitle: t('Emoji'),\n\t\t\tcollection: emoji.list,\n\t\t\ttemplate: 'messagePopupEmoji',\n\t\t\ttrigger: ':',\n\t\t\tprefix: '',\n\t\t\tsuffix: ' ',\n\t\t\trid: this.rid,\n\t\t\tgetInput: this.getInput,\n\t\t\tgetFilter: getEmojis,\n\t\t\tgetValue: (emojiText) => {\n\t\t\t\taddEmojiToRecents(emojiText);\n\t\t\t\treturn emojiText;\n\t\t\t},\n\t\t};\n\t},\n\tpopupReactionEmojiConfig() {\n\t\treturn {\n\t\t\ttitle: t('Emoji'),\n\t\t\tcollection: emoji.list,\n\t\t\ttemplate: 'messagePopupEmoji',\n\t\t\ttrigger: '\\\\+:',\n\t\t\tprefix: '+',\n\t\t\tsuffix: ' ',\n\t\t\trid: this.rid,\n\t\t\tgetInput: this.getInput,\n\t\t\tgetFilter: getEmojis,\n\t\t\tgetValue: (emojiText) => {\n\t\t\t\taddEmojiToRecents(emojiText);\n\t\t\t\treturn emojiText;\n\t\t\t},\n\t\t};\n\t},\n});\n"]},"sourceType":"module","hash":"fea7718595063c4f9ebebc5fcb5ab5d5007829ee"}
