{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui-message/client/ActionManager.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"app/ui-message/client/ActionManager.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui-message/client/ActionManager.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui-message/client/ActionManager.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/ui-message/client/ActionManager.js"}},"code":"const _excluded = [\"triggerId\"],\n      _excluded2 = [\"type\", \"actionId\", \"appId\", \"rid\", \"mid\", \"viewId\", \"container\"],\n      _excluded3 = [\"type\"],\n      _excluded4 = [\"viewId\"],\n      _excluded5 = [\"view\"],\n      _excluded6 = [\"type\"];\n\nlet _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default(v) {\n    _objectSpread = v;\n  }\n\n}, 0);\n\nlet _objectWithoutProperties;\n\nmodule.link(\"@babel/runtime/helpers/objectWithoutProperties\", {\n  default(v) {\n    _objectWithoutProperties = v;\n  }\n\n}, 1);\nmodule.export({\n  on: () => on,\n  off: () => off,\n  generateTriggerId: () => generateTriggerId,\n  triggerAction: () => triggerAction,\n  triggerBlockAction: () => triggerBlockAction,\n  triggerActionButtonAction: () => triggerActionButtonAction,\n  triggerSubmitView: () => triggerSubmitView,\n  triggerCancel: () => triggerCancel,\n  getUserInteractionPayloadByViewId: () => getUserInteractionPayloadByViewId\n});\nlet UIKitIncomingInteractionType;\nmodule.link(\"@rocket.chat/apps-engine/definition/uikit\", {\n  UIKitIncomingInteractionType(v) {\n    UIKitIncomingInteractionType = v;\n  }\n\n}, 0);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 1);\nlet FlowRouter;\nmodule.link(\"meteor/kadira:flow-router\", {\n  FlowRouter(v) {\n    FlowRouter = v;\n  }\n\n}, 2);\nlet Random;\nmodule.link(\"meteor/random\", {\n  Random(v) {\n    Random = v;\n  }\n\n}, 3);\nlet Emitter;\nmodule.link(\"@rocket.chat/emitter\", {\n  Emitter(v) {\n    Emitter = v;\n  }\n\n}, 4);\nlet Notifications;\nmodule.link(\"../../notifications/client/lib/Notifications\", {\n  default(v) {\n    Notifications = v;\n  }\n\n}, 5);\nlet CachedCollectionManager;\nmodule.link(\"../../ui-cached-collection\", {\n  CachedCollectionManager(v) {\n    CachedCollectionManager = v;\n  }\n\n}, 6);\nlet modal;\nmodule.link(\"../../ui-utils/client/lib/modal\", {\n  modal(v) {\n    modal = v;\n  }\n\n}, 7);\nlet APIClient;\nmodule.link(\"../../utils\", {\n  APIClient(v) {\n    APIClient = v;\n  }\n\n}, 8);\nlet UIKitInteractionTypes;\nmodule.link(\"../../../definition/UIKit\", {\n  UIKitInteractionTypes(v) {\n    UIKitInteractionTypes = v;\n  }\n\n}, 9);\nlet banners;\nmodule.link(\"../../../client/lib/banners\", {\n  \"*\"(v) {\n    banners = v;\n  }\n\n}, 10);\nlet dispatchToastMessage;\nmodule.link(\"../../../client/lib/toast\", {\n  dispatchToastMessage(v) {\n    dispatchToastMessage = v;\n  }\n\n}, 11);\nlet t;\nmodule.link(\"../../utils/client\", {\n  t(v) {\n    t = v;\n  }\n\n}, 12);\nconst events = new Emitter();\n\nconst on = function () {\n  events.on(...arguments);\n};\n\nconst off = function () {\n  events.off(...arguments);\n};\n\nconst TRIGGER_TIMEOUT = 5000;\nconst TRIGGER_TIMEOUT_ERROR = 'TRIGGER_TIMEOUT_ERROR';\nconst triggersId = new Map();\nconst instances = new Map();\n\nconst invalidateTriggerId = id => {\n  const appId = triggersId.get(id);\n  triggersId.delete(id);\n  return appId;\n};\n\nconst generateTriggerId = appId => {\n  const triggerId = Random.id();\n  triggersId.set(triggerId, appId);\n  setTimeout(invalidateTriggerId, TRIGGER_TIMEOUT, triggerId);\n  return triggerId;\n};\n\nconst handlePayloadUserInteraction = (type, _ref) => {\n  let {\n    /* appId,*/\n    triggerId\n  } = _ref,\n      data = _objectWithoutProperties(_ref, _excluded);\n\n  if (!triggersId.has(triggerId)) {\n    return;\n  }\n\n  const appId = invalidateTriggerId(triggerId);\n\n  if (!appId) {\n    return;\n  }\n\n  const {\n    view\n  } = data;\n  let {\n    viewId\n  } = data;\n\n  if (view && view.id) {\n    viewId = view.id;\n  }\n\n  if (!viewId) {\n    return;\n  }\n\n  if ([UIKitInteractionTypes.ERRORS].includes(type)) {\n    events.emit(viewId, _objectSpread({\n      type,\n      triggerId,\n      viewId,\n      appId\n    }, data));\n    return UIKitInteractionTypes.ERRORS;\n  }\n\n  if ([UIKitInteractionTypes.BANNER_UPDATE, UIKitInteractionTypes.MODAL_UPDATE, UIKitInteractionTypes.CONTEXTUAL_BAR_UPDATE].includes(type)) {\n    events.emit(viewId, _objectSpread({\n      type,\n      triggerId,\n      viewId,\n      appId\n    }, data));\n    return type;\n  }\n\n  if ([UIKitInteractionTypes.MODAL_OPEN].includes(type)) {\n    const instance = modal.push({\n      template: 'ModalBlock',\n      modifier: 'uikit',\n      closeOnEscape: false,\n      data: _objectSpread({\n        triggerId,\n        viewId,\n        appId\n      }, data)\n    });\n    instances.set(viewId, {\n      close() {\n        instance.close();\n        instances.delete(viewId);\n      }\n\n    });\n    return UIKitInteractionTypes.MODAL_OPEN;\n  }\n\n  if ([UIKitInteractionTypes.CONTEXTUAL_BAR_OPEN].includes(type)) {\n    instances.set(viewId, {\n      payload: _objectSpread({\n        type,\n        triggerId,\n        appId,\n        viewId\n      }, data),\n\n      close() {\n        instances.delete(viewId);\n      }\n\n    });\n    FlowRouter.setParams({\n      tab: 'app',\n      context: viewId\n    });\n    return UIKitInteractionTypes.CONTEXTUAL_BAR_OPEN;\n  }\n\n  if ([UIKitInteractionTypes.BANNER_OPEN].includes(type)) {\n    banners.open(data);\n    instances.set(viewId, {\n      close() {\n        banners.closeById(viewId);\n      }\n\n    });\n    return UIKitInteractionTypes.BANNER_OPEN;\n  }\n\n  if ([UIKitIncomingInteractionType.BANNER_CLOSE].includes(type)) {\n    const instance = instances.get(viewId);\n\n    if (instance) {\n      instance.close();\n    }\n\n    return UIKitIncomingInteractionType.BANNER_CLOSE;\n  }\n\n  if ([UIKitIncomingInteractionType.CONTEXTUAL_BAR_CLOSE].includes(type)) {\n    const instance = instances.get(viewId);\n\n    if (instance) {\n      instance.close();\n    }\n\n    return UIKitIncomingInteractionType.CONTEXTUAL_BAR_CLOSE;\n  }\n\n  return UIKitInteractionTypes.MODAL_ClOSE;\n};\n\nconst triggerAction = async _ref2 => {\n  let {\n    type,\n    actionId,\n    appId,\n    rid,\n    mid,\n    viewId,\n    container\n  } = _ref2,\n      rest = _objectWithoutProperties(_ref2, _excluded2);\n\n  return new Promise(async (resolve, reject) => {\n    const triggerId = generateTriggerId(appId);\n    const payload = rest.payload || rest;\n    setTimeout(reject, TRIGGER_TIMEOUT, [TRIGGER_TIMEOUT_ERROR, {\n      triggerId,\n      appId\n    }]);\n\n    const _await$APIClient$post = await APIClient.post(\"apps/ui.interaction/\".concat(appId), {\n      type,\n      actionId,\n      payload,\n      container,\n      mid,\n      rid,\n      triggerId,\n      viewId\n    }),\n          {\n      type: interactionType\n    } = _await$APIClient$post,\n          data = _objectWithoutProperties(_await$APIClient$post, _excluded3);\n\n    return resolve(handlePayloadUserInteraction(interactionType, data));\n  });\n};\n\nconst triggerBlockAction = options => triggerAction(_objectSpread({\n  type: UIKitIncomingInteractionType.BLOCK\n}, options));\n\nconst triggerActionButtonAction = options => triggerAction(_objectSpread({\n  type: UIKitIncomingInteractionType.ACTION_BUTTON\n}, options)).catch(async reason => {\n  if (Array.isArray(reason) && reason[0] === TRIGGER_TIMEOUT_ERROR) {\n    dispatchToastMessage({\n      type: 'error',\n      message: t('UIKit_Interaction_Timeout')\n    });\n  }\n});\n\nconst triggerSubmitView = async _ref3 => {\n  let {\n    viewId\n  } = _ref3,\n      options = _objectWithoutProperties(_ref3, _excluded4);\n\n  const close = () => {\n    const instance = instances.get(viewId);\n\n    if (instance) {\n      instance.close();\n    }\n  };\n\n  try {\n    const result = await triggerAction(_objectSpread({\n      type: UIKitIncomingInteractionType.VIEW_SUBMIT,\n      viewId\n    }, options));\n\n    if (!result || UIKitInteractionTypes.MODAL_CLOSE === result) {\n      close();\n    }\n  } catch (_unused) {\n    close();\n  }\n};\n\nconst triggerCancel = async _ref4 => {\n  let {\n    view\n  } = _ref4,\n      options = _objectWithoutProperties(_ref4, _excluded5);\n\n  const instance = instances.get(view.id);\n\n  try {\n    await triggerAction(_objectSpread({\n      type: UIKitIncomingInteractionType.VIEW_CLOSED,\n      view\n    }, options));\n  } finally {\n    if (instance) {\n      instance.close();\n    }\n  }\n};\n\nconst getUserInteractionPayloadByViewId = viewId => {\n  if (!viewId) {\n    throw new Error('No viewId provided when checking for `user interaction payload`');\n  }\n\n  const instance = instances.get(viewId);\n\n  if (!instance) {\n    return {};\n  }\n\n  return instance.payload;\n};\n\nMeteor.startup(() => CachedCollectionManager.onLogin(() => Notifications.onUser('uiInteraction', _ref5 => {\n  let {\n    type\n  } = _ref5,\n      data = _objectWithoutProperties(_ref5, _excluded6);\n\n  handlePayloadUserInteraction(type, data);\n})));","map":{"version":3,"sources":["app/ui-message/client/ActionManager.js"],"names":["_objectSpread","module","link","default","v","_objectWithoutProperties","export","on","off","generateTriggerId","triggerAction","triggerBlockAction","triggerActionButtonAction","triggerSubmitView","triggerCancel","getUserInteractionPayloadByViewId","UIKitIncomingInteractionType","Meteor","FlowRouter","Random","Emitter","Notifications","CachedCollectionManager","modal","APIClient","UIKitInteractionTypes","banners","dispatchToastMessage","t","events","TRIGGER_TIMEOUT","TRIGGER_TIMEOUT_ERROR","triggersId","Map","instances","invalidateTriggerId","id","appId","get","delete","triggerId","set","setTimeout","handlePayloadUserInteraction","type","data","has","view","viewId","ERRORS","includes","emit","BANNER_UPDATE","MODAL_UPDATE","CONTEXTUAL_BAR_UPDATE","MODAL_OPEN","instance","push","template","modifier","closeOnEscape","close","CONTEXTUAL_BAR_OPEN","payload","setParams","tab","context","BANNER_OPEN","open","closeById","BANNER_CLOSE","CONTEXTUAL_BAR_CLOSE","MODAL_ClOSE","actionId","rid","mid","container","rest","Promise","resolve","reject","post","interactionType","options","BLOCK","ACTION_BUTTON","catch","reason","Array","isArray","message","result","VIEW_SUBMIT","MODAL_CLOSE","VIEW_CLOSED","Error","startup","onLogin","onUser"],"mappings":"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","sourcesContent":["import { UIKitIncomingInteractionType } from '@rocket.chat/apps-engine/definition/uikit';\nimport { Meteor } from 'meteor/meteor';\nimport { FlowRouter } from 'meteor/kadira:flow-router';\nimport { Random } from 'meteor/random';\nimport { Emitter } from '@rocket.chat/emitter';\n\nimport Notifications from '../../notifications/client/lib/Notifications';\nimport { CachedCollectionManager } from '../../ui-cached-collection';\nimport { modal } from '../../ui-utils/client/lib/modal';\nimport { APIClient } from '../../utils';\nimport { UIKitInteractionTypes } from '../../../definition/UIKit';\nimport * as banners from '../../../client/lib/banners';\nimport { dispatchToastMessage } from '../../../client/lib/toast';\nimport { t } from '../../utils/client';\n\nconst events = new Emitter();\n\nexport const on = (...args) => {\n\tevents.on(...args);\n};\n\nexport const off = (...args) => {\n\tevents.off(...args);\n};\n\nconst TRIGGER_TIMEOUT = 5000;\n\nconst TRIGGER_TIMEOUT_ERROR = 'TRIGGER_TIMEOUT_ERROR';\n\nconst triggersId = new Map();\n\nconst instances = new Map();\n\nconst invalidateTriggerId = (id) => {\n\tconst appId = triggersId.get(id);\n\ttriggersId.delete(id);\n\treturn appId;\n};\n\nexport const generateTriggerId = (appId) => {\n\tconst triggerId = Random.id();\n\ttriggersId.set(triggerId, appId);\n\tsetTimeout(invalidateTriggerId, TRIGGER_TIMEOUT, triggerId);\n\treturn triggerId;\n};\n\nconst handlePayloadUserInteraction = (type, { /* appId,*/ triggerId, ...data }) => {\n\tif (!triggersId.has(triggerId)) {\n\t\treturn;\n\t}\n\tconst appId = invalidateTriggerId(triggerId);\n\tif (!appId) {\n\t\treturn;\n\t}\n\n\tconst { view } = data;\n\tlet { viewId } = data;\n\n\tif (view && view.id) {\n\t\tviewId = view.id;\n\t}\n\n\tif (!viewId) {\n\t\treturn;\n\t}\n\n\tif ([UIKitInteractionTypes.ERRORS].includes(type)) {\n\t\tevents.emit(viewId, {\n\t\t\ttype,\n\t\t\ttriggerId,\n\t\t\tviewId,\n\t\t\tappId,\n\t\t\t...data,\n\t\t});\n\t\treturn UIKitInteractionTypes.ERRORS;\n\t}\n\n\tif (\n\t\t[UIKitInteractionTypes.BANNER_UPDATE, UIKitInteractionTypes.MODAL_UPDATE, UIKitInteractionTypes.CONTEXTUAL_BAR_UPDATE].includes(type)\n\t) {\n\t\tevents.emit(viewId, {\n\t\t\ttype,\n\t\t\ttriggerId,\n\t\t\tviewId,\n\t\t\tappId,\n\t\t\t...data,\n\t\t});\n\t\treturn type;\n\t}\n\n\tif ([UIKitInteractionTypes.MODAL_OPEN].includes(type)) {\n\t\tconst instance = modal.push({\n\t\t\ttemplate: 'ModalBlock',\n\t\t\tmodifier: 'uikit',\n\t\t\tcloseOnEscape: false,\n\t\t\tdata: {\n\t\t\t\ttriggerId,\n\t\t\t\tviewId,\n\t\t\t\tappId,\n\t\t\t\t...data,\n\t\t\t},\n\t\t});\n\n\t\tinstances.set(viewId, {\n\t\t\tclose() {\n\t\t\t\tinstance.close();\n\t\t\t\tinstances.delete(viewId);\n\t\t\t},\n\t\t});\n\n\t\treturn UIKitInteractionTypes.MODAL_OPEN;\n\t}\n\n\tif ([UIKitInteractionTypes.CONTEXTUAL_BAR_OPEN].includes(type)) {\n\t\tinstances.set(viewId, {\n\t\t\tpayload: {\n\t\t\t\ttype,\n\t\t\t\ttriggerId,\n\t\t\t\tappId,\n\t\t\t\tviewId,\n\t\t\t\t...data,\n\t\t\t},\n\t\t\tclose() {\n\t\t\t\tinstances.delete(viewId);\n\t\t\t},\n\t\t});\n\n\t\tFlowRouter.setParams({ tab: 'app', context: viewId });\n\n\t\treturn UIKitInteractionTypes.CONTEXTUAL_BAR_OPEN;\n\t}\n\n\tif ([UIKitInteractionTypes.BANNER_OPEN].includes(type)) {\n\t\tbanners.open(data);\n\t\tinstances.set(viewId, {\n\t\t\tclose() {\n\t\t\t\tbanners.closeById(viewId);\n\t\t\t},\n\t\t});\n\t\treturn UIKitInteractionTypes.BANNER_OPEN;\n\t}\n\n\tif ([UIKitIncomingInteractionType.BANNER_CLOSE].includes(type)) {\n\t\tconst instance = instances.get(viewId);\n\n\t\tif (instance) {\n\t\t\tinstance.close();\n\t\t}\n\t\treturn UIKitIncomingInteractionType.BANNER_CLOSE;\n\t}\n\n\tif ([UIKitIncomingInteractionType.CONTEXTUAL_BAR_CLOSE].includes(type)) {\n\t\tconst instance = instances.get(viewId);\n\n\t\tif (instance) {\n\t\t\tinstance.close();\n\t\t}\n\t\treturn UIKitIncomingInteractionType.CONTEXTUAL_BAR_CLOSE;\n\t}\n\n\treturn UIKitInteractionTypes.MODAL_ClOSE;\n};\n\nexport const triggerAction = async ({ type, actionId, appId, rid, mid, viewId, container, ...rest }) =>\n\tnew Promise(async (resolve, reject) => {\n\t\tconst triggerId = generateTriggerId(appId);\n\n\t\tconst payload = rest.payload || rest;\n\n\t\tsetTimeout(reject, TRIGGER_TIMEOUT, [TRIGGER_TIMEOUT_ERROR, { triggerId, appId }]);\n\n\t\tconst { type: interactionType, ...data } = await APIClient.post(`apps/ui.interaction/${appId}`, {\n\t\t\ttype,\n\t\t\tactionId,\n\t\t\tpayload,\n\t\t\tcontainer,\n\t\t\tmid,\n\t\t\trid,\n\t\t\ttriggerId,\n\t\t\tviewId,\n\t\t});\n\n\t\treturn resolve(handlePayloadUserInteraction(interactionType, data));\n\t});\n\nexport const triggerBlockAction = (options) => triggerAction({ type: UIKitIncomingInteractionType.BLOCK, ...options });\n\nexport const triggerActionButtonAction = (options) =>\n\ttriggerAction({ type: UIKitIncomingInteractionType.ACTION_BUTTON, ...options }).catch(async (reason) => {\n\t\tif (Array.isArray(reason) && reason[0] === TRIGGER_TIMEOUT_ERROR) {\n\t\t\tdispatchToastMessage({\n\t\t\t\ttype: 'error',\n\t\t\t\tmessage: t('UIKit_Interaction_Timeout'),\n\t\t\t});\n\t\t}\n\t});\n\nexport const triggerSubmitView = async ({ viewId, ...options }) => {\n\tconst close = () => {\n\t\tconst instance = instances.get(viewId);\n\n\t\tif (instance) {\n\t\t\tinstance.close();\n\t\t}\n\t};\n\n\ttry {\n\t\tconst result = await triggerAction({\n\t\t\ttype: UIKitIncomingInteractionType.VIEW_SUBMIT,\n\t\t\tviewId,\n\t\t\t...options,\n\t\t});\n\t\tif (!result || UIKitInteractionTypes.MODAL_CLOSE === result) {\n\t\t\tclose();\n\t\t}\n\t} catch {\n\t\tclose();\n\t}\n};\n\nexport const triggerCancel = async ({ view, ...options }) => {\n\tconst instance = instances.get(view.id);\n\ttry {\n\t\tawait triggerAction({ type: UIKitIncomingInteractionType.VIEW_CLOSED, view, ...options });\n\t} finally {\n\t\tif (instance) {\n\t\t\tinstance.close();\n\t\t}\n\t}\n};\n\nexport const getUserInteractionPayloadByViewId = (viewId) => {\n\tif (!viewId) {\n\t\tthrow new Error('No viewId provided when checking for `user interaction payload`');\n\t}\n\n\tconst instance = instances.get(viewId);\n\n\tif (!instance) {\n\t\treturn {};\n\t}\n\n\treturn instance.payload;\n};\n\nMeteor.startup(() =>\n\tCachedCollectionManager.onLogin(() =>\n\t\tNotifications.onUser('uiInteraction', ({ type, ...data }) => {\n\t\t\thandlePayloadUserInteraction(type, data);\n\t\t}),\n\t),\n);\n"]},"sourceType":"module","hash":"ddc264658b85da10cd3d7207c7c28c67d1f23e88"}
