{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/views/account/security/TwoFactorTOTP.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"client/views/account/security/TwoFactorTOTP.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/views/account/security/TwoFactorTOTP.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/views/account/security/TwoFactorTOTP.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/views/account/security/TwoFactorTOTP.js"}},"code":"let _extends;\n\nmodule.link(\"@babel/runtime/helpers/extends\", {\n  default(v) {\n    _extends = v;\n  }\n\n}, 0);\nlet Box, Button, TextInput, Margins;\nmodule.link(\"@rocket.chat/fuselage\", {\n  Box(v) {\n    Box = v;\n  },\n\n  Button(v) {\n    Button = v;\n  },\n\n  TextInput(v) {\n    TextInput = v;\n  },\n\n  Margins(v) {\n    Margins = v;\n  }\n\n}, 0);\nlet useSafely;\nmodule.link(\"@rocket.chat/fuselage-hooks\", {\n  useSafely(v) {\n    useSafely = v;\n  }\n\n}, 1);\nlet React, useState, useCallback, useEffect;\nmodule.link(\"react\", {\n  default(v) {\n    React = v;\n  },\n\n  useState(v) {\n    useState = v;\n  },\n\n  useCallback(v) {\n    useCallback = v;\n  },\n\n  useEffect(v) {\n    useEffect = v;\n  }\n\n}, 2);\nlet qrcode;\nmodule.link(\"yaqrcode\", {\n  default(v) {\n    qrcode = v;\n  }\n\n}, 3);\nlet TextCopy;\nmodule.link(\"../../../components/TextCopy\", {\n  default(v) {\n    TextCopy = v;\n  }\n\n}, 4);\nlet TwoFactorTotpModal;\nmodule.link(\"../../../components/TwoFactorModal/TwoFactorTotpModal\", {\n  default(v) {\n    TwoFactorTotpModal = v;\n  }\n\n}, 5);\nlet useSetModal;\nmodule.link(\"../../../contexts/ModalContext\", {\n  useSetModal(v) {\n    useSetModal = v;\n  }\n\n}, 6);\nlet useMethod;\nmodule.link(\"../../../contexts/ServerContext\", {\n  useMethod(v) {\n    useMethod = v;\n  }\n\n}, 7);\nlet useToastMessageDispatch;\nmodule.link(\"../../../contexts/ToastMessagesContext\", {\n  useToastMessageDispatch(v) {\n    useToastMessageDispatch = v;\n  }\n\n}, 8);\nlet useTranslation;\nmodule.link(\"../../../contexts/TranslationContext\", {\n  useTranslation(v) {\n    useTranslation = v;\n  }\n\n}, 9);\nlet useUser;\nmodule.link(\"../../../contexts/UserContext\", {\n  useUser(v) {\n    useUser = v;\n  }\n\n}, 10);\nlet useForm;\nmodule.link(\"../../../hooks/useForm\", {\n  useForm(v) {\n    useForm = v;\n  }\n\n}, 11);\nlet BackupCodesModal;\nmodule.link(\"./BackupCodesModal\", {\n  default(v) {\n    BackupCodesModal = v;\n  }\n\n}, 12);\n\nconst TwoFactorTOTP = props => {\n  const t = useTranslation();\n  const dispatchToastMessage = useToastMessageDispatch();\n  const user = useUser();\n  const setModal = useSetModal();\n  const enableTotpFn = useMethod('2fa:enable');\n  const disableTotpFn = useMethod('2fa:disable');\n  const verifyCodeFn = useMethod('2fa:validateTempToken');\n  const checkCodesRemainingFn = useMethod('2fa:checkCodesRemaining');\n  const regenerateCodesFn = useMethod('2fa:regenerateCodes');\n  const [registeringTotp, setRegisteringTotp] = useSafely(useState(false));\n  const [qrCode, setQrCode] = useSafely(useState());\n  const [totpSecret, setTotpSecret] = useSafely(useState());\n  const [codesRemaining, setCodesRemaining] = useSafely(useState());\n  const {\n    values,\n    handlers\n  } = useForm({\n    authCode: ''\n  });\n  const {\n    authCode\n  } = values;\n  const {\n    handleAuthCode\n  } = handlers;\n  const totpEnabled = user && user.services && user.services.totp && user.services.totp.enabled;\n  const closeModal = useCallback(() => setModal(null), [setModal]);\n  useEffect(() => {\n    const updateCodesRemaining = async () => {\n      if (!totpEnabled) {\n        return false;\n      }\n\n      const result = await checkCodesRemainingFn();\n      setCodesRemaining(result.remaining);\n    };\n\n    updateCodesRemaining();\n  }, [checkCodesRemainingFn, setCodesRemaining, totpEnabled]);\n  const handleEnableTotp = useCallback(async () => {\n    try {\n      const result = await enableTotpFn();\n      setTotpSecret(result.secret);\n      setQrCode(qrcode(result.url, {\n        size: 200\n      }));\n      setRegisteringTotp(true);\n    } catch (error) {\n      dispatchToastMessage({\n        type: 'error',\n        message: error\n      });\n    }\n  }, [dispatchToastMessage, enableTotpFn, setQrCode, setRegisteringTotp, setTotpSecret]);\n  const handleDisableTotp = useCallback(async () => {\n    const onDisable = async authCode => {\n      try {\n        const result = await disableTotpFn(authCode);\n\n        if (!result) {\n          return dispatchToastMessage({\n            type: 'error',\n            message: t('Invalid_two_factor_code')\n          });\n        }\n\n        dispatchToastMessage({\n          type: 'success',\n          message: t('Two-factor_authentication_disabled')\n        });\n      } catch (error) {\n        dispatchToastMessage({\n          type: 'error',\n          message: error\n        });\n      }\n\n      closeModal();\n    };\n\n    setModal( /*#__PURE__*/React.createElement(TwoFactorTotpModal, {\n      onConfirm: onDisable,\n      onClose: closeModal\n    }));\n  }, [closeModal, disableTotpFn, dispatchToastMessage, setModal, t]);\n  const handleVerifyCode = useCallback(async () => {\n    try {\n      const result = await verifyCodeFn(authCode);\n\n      if (!result) {\n        return dispatchToastMessage({\n          type: 'error',\n          message: t('Invalid_two_factor_code')\n        });\n      }\n\n      setModal( /*#__PURE__*/React.createElement(BackupCodesModal, {\n        codes: result.codes,\n        onClose: closeModal\n      }));\n    } catch (error) {\n      dispatchToastMessage({\n        type: 'error',\n        message: error\n      });\n    }\n  }, [authCode, closeModal, dispatchToastMessage, setModal, t, verifyCodeFn]);\n  const handleRegenerateCodes = useCallback(() => {\n    const onRegenerate = async authCode => {\n      try {\n        const result = await regenerateCodesFn(authCode);\n\n        if (!result) {\n          return dispatchToastMessage({\n            type: 'error',\n            message: t('Invalid_two_factor_code')\n          });\n        }\n\n        setModal( /*#__PURE__*/React.createElement(BackupCodesModal, {\n          codes: result.codes,\n          onClose: closeModal\n        }));\n      } catch (error) {\n        dispatchToastMessage({\n          type: 'error',\n          message: error\n        });\n      }\n    };\n\n    setModal( /*#__PURE__*/React.createElement(TwoFactorTotpModal, {\n      onConfirm: onRegenerate,\n      onClose: closeModal\n    }));\n  }, [closeModal, dispatchToastMessage, regenerateCodesFn, setModal, t]);\n  return /*#__PURE__*/React.createElement(Box, _extends({\n    display: \"flex\",\n    flexDirection: \"column\",\n    alignItems: \"flex-start\"\n  }, props), /*#__PURE__*/React.createElement(Margins, {\n    blockEnd: \"x8\"\n  }, /*#__PURE__*/React.createElement(Box, {\n    fontScale: \"h4\"\n  }, t('Two-factor_authentication')), !totpEnabled && !registeringTotp && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(Box, null, t('Two-factor_authentication_is_currently_disabled')), /*#__PURE__*/React.createElement(Button, {\n    primary: true,\n    onClick: handleEnableTotp\n  }, t('Enable_two-factor_authentication'))), !totpEnabled && registeringTotp && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(Box, null, t('Scan_QR_code')), /*#__PURE__*/React.createElement(Box, null, t('Scan_QR_code_alternative_s')), /*#__PURE__*/React.createElement(TextCopy, {\n    text: totpSecret\n  }), /*#__PURE__*/React.createElement(Box, {\n    is: \"img\",\n    size: \"x200\",\n    src: qrCode,\n    \"aria-hidden\": \"true\"\n  }), /*#__PURE__*/React.createElement(Box, {\n    display: \"flex\",\n    flexDirection: \"row\",\n    w: \"full\"\n  }, /*#__PURE__*/React.createElement(TextInput, {\n    placeholder: t('Enter_authentication_code'),\n    value: authCode,\n    onChange: handleAuthCode\n  }), /*#__PURE__*/React.createElement(Button, {\n    primary: true,\n    onClick: handleVerifyCode\n  }, t('Verify')))), totpEnabled && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(Button, {\n    primary: true,\n    danger: true,\n    onClick: handleDisableTotp\n  }, t('Disable_two-factor_authentication')), /*#__PURE__*/React.createElement(Box, {\n    fontScale: \"p2m\",\n    mbs: \"x8\"\n  }, t('Backup_codes')), /*#__PURE__*/React.createElement(Box, null, t('You_have_n_codes_remaining', {\n    number: codesRemaining\n  })), /*#__PURE__*/React.createElement(Button, {\n    onClick: handleRegenerateCodes\n  }, t('Regenerate_codes')))));\n};\n\nmodule.exportDefault(TwoFactorTOTP);","map":{"version":3,"sources":["client/views/account/security/TwoFactorTOTP.js"],"names":["_extends","module","link","default","v","Box","Button","TextInput","Margins","useSafely","React","useState","useCallback","useEffect","qrcode","TextCopy","TwoFactorTotpModal","useSetModal","useMethod","useToastMessageDispatch","useTranslation","useUser","useForm","BackupCodesModal","TwoFactorTOTP","props","t","dispatchToastMessage","user","setModal","enableTotpFn","disableTotpFn","verifyCodeFn","checkCodesRemainingFn","regenerateCodesFn","registeringTotp","setRegisteringTotp","qrCode","setQrCode","totpSecret","setTotpSecret","codesRemaining","setCodesRemaining","values","handlers","authCode","handleAuthCode","totpEnabled","services","totp","enabled","closeModal","updateCodesRemaining","result","remaining","handleEnableTotp","secret","url","size","error","type","message","handleDisableTotp","onDisable","handleVerifyCode","codes","handleRegenerateCodes","onRegenerate","number","exportDefault"],"mappings":"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","sourcesContent":["import { Box, Button, TextInput, Margins } from '@rocket.chat/fuselage';\nimport { useSafely } from '@rocket.chat/fuselage-hooks';\nimport React, { useState, useCallback, useEffect } from 'react';\nimport qrcode from 'yaqrcode';\n\nimport TextCopy from '../../../components/TextCopy';\nimport TwoFactorTotpModal from '../../../components/TwoFactorModal/TwoFactorTotpModal';\nimport { useSetModal } from '../../../contexts/ModalContext';\nimport { useMethod } from '../../../contexts/ServerContext';\nimport { useToastMessageDispatch } from '../../../contexts/ToastMessagesContext';\nimport { useTranslation } from '../../../contexts/TranslationContext';\nimport { useUser } from '../../../contexts/UserContext';\nimport { useForm } from '../../../hooks/useForm';\nimport BackupCodesModal from './BackupCodesModal';\n\nconst TwoFactorTOTP = (props) => {\n\tconst t = useTranslation();\n\tconst dispatchToastMessage = useToastMessageDispatch();\n\tconst user = useUser();\n\tconst setModal = useSetModal();\n\n\tconst enableTotpFn = useMethod('2fa:enable');\n\tconst disableTotpFn = useMethod('2fa:disable');\n\tconst verifyCodeFn = useMethod('2fa:validateTempToken');\n\tconst checkCodesRemainingFn = useMethod('2fa:checkCodesRemaining');\n\tconst regenerateCodesFn = useMethod('2fa:regenerateCodes');\n\n\tconst [registeringTotp, setRegisteringTotp] = useSafely(useState(false));\n\tconst [qrCode, setQrCode] = useSafely(useState());\n\tconst [totpSecret, setTotpSecret] = useSafely(useState());\n\tconst [codesRemaining, setCodesRemaining] = useSafely(useState());\n\n\tconst { values, handlers } = useForm({ authCode: '' });\n\n\tconst { authCode } = values;\n\tconst { handleAuthCode } = handlers;\n\n\tconst totpEnabled = user && user.services && user.services.totp && user.services.totp.enabled;\n\n\tconst closeModal = useCallback(() => setModal(null), [setModal]);\n\n\tuseEffect(() => {\n\t\tconst updateCodesRemaining = async () => {\n\t\t\tif (!totpEnabled) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tconst result = await checkCodesRemainingFn();\n\t\t\tsetCodesRemaining(result.remaining);\n\t\t};\n\t\tupdateCodesRemaining();\n\t}, [checkCodesRemainingFn, setCodesRemaining, totpEnabled]);\n\n\tconst handleEnableTotp = useCallback(async () => {\n\t\ttry {\n\t\t\tconst result = await enableTotpFn();\n\n\t\t\tsetTotpSecret(result.secret);\n\t\t\tsetQrCode(qrcode(result.url, { size: 200 }));\n\n\t\t\tsetRegisteringTotp(true);\n\t\t} catch (error) {\n\t\t\tdispatchToastMessage({ type: 'error', message: error });\n\t\t}\n\t}, [dispatchToastMessage, enableTotpFn, setQrCode, setRegisteringTotp, setTotpSecret]);\n\n\tconst handleDisableTotp = useCallback(async () => {\n\t\tconst onDisable = async (authCode) => {\n\t\t\ttry {\n\t\t\t\tconst result = await disableTotpFn(authCode);\n\n\t\t\t\tif (!result) {\n\t\t\t\t\treturn dispatchToastMessage({ type: 'error', message: t('Invalid_two_factor_code') });\n\t\t\t\t}\n\n\t\t\t\tdispatchToastMessage({ type: 'success', message: t('Two-factor_authentication_disabled') });\n\t\t\t} catch (error) {\n\t\t\t\tdispatchToastMessage({ type: 'error', message: error });\n\t\t\t}\n\t\t\tcloseModal();\n\t\t};\n\n\t\tsetModal(<TwoFactorTotpModal onConfirm={onDisable} onClose={closeModal} />);\n\t}, [closeModal, disableTotpFn, dispatchToastMessage, setModal, t]);\n\n\tconst handleVerifyCode = useCallback(async () => {\n\t\ttry {\n\t\t\tconst result = await verifyCodeFn(authCode);\n\n\t\t\tif (!result) {\n\t\t\t\treturn dispatchToastMessage({ type: 'error', message: t('Invalid_two_factor_code') });\n\t\t\t}\n\t\t\tsetModal(<BackupCodesModal codes={result.codes} onClose={closeModal} />);\n\t\t} catch (error) {\n\t\t\tdispatchToastMessage({ type: 'error', message: error });\n\t\t}\n\t}, [authCode, closeModal, dispatchToastMessage, setModal, t, verifyCodeFn]);\n\n\tconst handleRegenerateCodes = useCallback(() => {\n\t\tconst onRegenerate = async (authCode) => {\n\t\t\ttry {\n\t\t\t\tconst result = await regenerateCodesFn(authCode);\n\n\t\t\t\tif (!result) {\n\t\t\t\t\treturn dispatchToastMessage({ type: 'error', message: t('Invalid_two_factor_code') });\n\t\t\t\t}\n\t\t\t\tsetModal(<BackupCodesModal codes={result.codes} onClose={closeModal} />);\n\t\t\t} catch (error) {\n\t\t\t\tdispatchToastMessage({ type: 'error', message: error });\n\t\t\t}\n\t\t};\n\n\t\tsetModal(<TwoFactorTotpModal onConfirm={onRegenerate} onClose={closeModal} />);\n\t}, [closeModal, dispatchToastMessage, regenerateCodesFn, setModal, t]);\n\n\treturn (\n\t\t<Box display='flex' flexDirection='column' alignItems='flex-start' {...props}>\n\t\t\t<Margins blockEnd='x8'>\n\t\t\t\t<Box fontScale='h4'>{t('Two-factor_authentication')}</Box>\n\t\t\t\t{!totpEnabled && !registeringTotp && (\n\t\t\t\t\t<>\n\t\t\t\t\t\t<Box>{t('Two-factor_authentication_is_currently_disabled')}</Box>\n\t\t\t\t\t\t<Button primary onClick={handleEnableTotp}>\n\t\t\t\t\t\t\t{t('Enable_two-factor_authentication')}\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t</>\n\t\t\t\t)}\n\t\t\t\t{!totpEnabled && registeringTotp && (\n\t\t\t\t\t<>\n\t\t\t\t\t\t<Box>{t('Scan_QR_code')}</Box>\n\t\t\t\t\t\t<Box>{t('Scan_QR_code_alternative_s')}</Box>\n\t\t\t\t\t\t<TextCopy text={totpSecret} />\n\t\t\t\t\t\t<Box is='img' size='x200' src={qrCode} aria-hidden='true' />\n\t\t\t\t\t\t<Box display='flex' flexDirection='row' w='full'>\n\t\t\t\t\t\t\t<TextInput placeholder={t('Enter_authentication_code')} value={authCode} onChange={handleAuthCode} />\n\t\t\t\t\t\t\t<Button primary onClick={handleVerifyCode}>\n\t\t\t\t\t\t\t\t{t('Verify')}\n\t\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t</Box>\n\t\t\t\t\t</>\n\t\t\t\t)}\n\t\t\t\t{totpEnabled && (\n\t\t\t\t\t<>\n\t\t\t\t\t\t<Button primary danger onClick={handleDisableTotp}>\n\t\t\t\t\t\t\t{t('Disable_two-factor_authentication')}\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t<Box fontScale='p2m' mbs='x8'>\n\t\t\t\t\t\t\t{t('Backup_codes')}\n\t\t\t\t\t\t</Box>\n\t\t\t\t\t\t<Box>{t('You_have_n_codes_remaining', { number: codesRemaining })}</Box>\n\t\t\t\t\t\t<Button onClick={handleRegenerateCodes}>{t('Regenerate_codes')}</Button>\n\t\t\t\t\t</>\n\t\t\t\t)}\n\t\t\t</Margins>\n\t\t</Box>\n\t);\n};\n\nexport default TwoFactorTOTP;\n"]},"sourceType":"module","hash":"8c716073b2e40afaa2f23167b6c11a3eab5fadc3"}
