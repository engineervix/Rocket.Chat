{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui-utils/client/lib/RoomManager.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"app/ui-utils/client/lib/RoomManager.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui-utils/client/lib/RoomManager.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui-utils/client/lib/RoomManager.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/ui-utils/client/lib/RoomManager.js"}},"code":"module.export({\n  RoomManager: () => RoomManager\n});\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet ReactiveVar;\nmodule.link(\"meteor/reactive-var\", {\n  ReactiveVar(v) {\n    ReactiveVar = v;\n  }\n\n}, 1);\nlet Session;\nmodule.link(\"meteor/session\", {\n  Session(v) {\n    Session = v;\n  }\n\n}, 2);\nlet Tracker;\nmodule.link(\"meteor/tracker\", {\n  Tracker(v) {\n    Tracker = v;\n  }\n\n}, 3);\nlet Blaze;\nmodule.link(\"meteor/blaze\", {\n  Blaze(v) {\n    Blaze = v;\n  }\n\n}, 4);\nlet FlowRouter;\nmodule.link(\"meteor/kadira:flow-router\", {\n  FlowRouter(v) {\n    FlowRouter = v;\n  }\n\n}, 5);\n\nlet _;\n\nmodule.link(\"underscore\", {\n  default(v) {\n    _ = v;\n  }\n\n}, 6);\nlet fireGlobalEvent;\nmodule.link(\"../../../../client/lib/utils/fireGlobalEvent\", {\n  fireGlobalEvent(v) {\n    fireGlobalEvent = v;\n  }\n\n}, 7);\nlet upsertMessage, RoomHistoryManager;\nmodule.link(\"./RoomHistoryManager\", {\n  upsertMessage(v) {\n    upsertMessage = v;\n  },\n\n  RoomHistoryManager(v) {\n    RoomHistoryManager = v;\n  }\n\n}, 8);\nlet mainReady;\nmodule.link(\"./mainReady\", {\n  mainReady(v) {\n    mainReady = v;\n  }\n\n}, 9);\nlet callbacks;\nmodule.link(\"../../../../lib/callbacks\", {\n  callbacks(v) {\n    callbacks = v;\n  }\n\n}, 10);\nlet Notifications;\nmodule.link(\"../../../notifications\", {\n  Notifications(v) {\n    Notifications = v;\n  }\n\n}, 11);\nlet CachedChatRoom, ChatMessage, ChatSubscription, CachedChatSubscription, ChatRoom;\nmodule.link(\"../../../models\", {\n  CachedChatRoom(v) {\n    CachedChatRoom = v;\n  },\n\n  ChatMessage(v) {\n    ChatMessage = v;\n  },\n\n  ChatSubscription(v) {\n    ChatSubscription = v;\n  },\n\n  CachedChatSubscription(v) {\n    CachedChatSubscription = v;\n  },\n\n  ChatRoom(v) {\n    ChatRoom = v;\n  }\n\n}, 12);\nlet CachedCollectionManager;\nmodule.link(\"../../../ui-cached-collection\", {\n  CachedCollectionManager(v) {\n    CachedCollectionManager = v;\n  }\n\n}, 13);\nlet getConfig;\nmodule.link(\"../../../../client/lib/utils/getConfig\", {\n  getConfig(v) {\n    getConfig = v;\n  }\n\n}, 14);\nlet ROOM_DATA_STREAM;\nmodule.link(\"../../../utils/stream/constants\", {\n  ROOM_DATA_STREAM(v) {\n    ROOM_DATA_STREAM = v;\n  }\n\n}, 15);\nlet callWithErrorHandling;\nmodule.link(\"../../../../client/lib/utils/callWithErrorHandling\", {\n  callWithErrorHandling(v) {\n    callWithErrorHandling = v;\n  }\n\n}, 16);\nlet NewRoomManager;\nmodule.link(\"../../../../client/lib/RoomManager\", {\n  RoomManager(v) {\n    NewRoomManager = v;\n  }\n\n}, 17);\nlet roomCoordinator;\nmodule.link(\"../../../../client/lib/rooms/roomCoordinator\", {\n  roomCoordinator(v) {\n    roomCoordinator = v;\n  }\n\n}, 18);\nconst maxRoomsOpen = parseInt(getConfig('maxRoomsOpen')) || 5;\n\nconst onDeleteMessageStream = msg => {\n  ChatMessage.remove({\n    _id: msg._id\n  }); // remove thread refenrece from deleted message\n\n  ChatMessage.update({\n    tmid: msg._id\n  }, {\n    $unset: {\n      tmid: 1\n    }\n  }, {\n    multi: true\n  });\n};\n\nconst onDeleteMessageBulkStream = _ref => {\n  let {\n    rid,\n    ts,\n    excludePinned,\n    ignoreDiscussion,\n    users\n  } = _ref;\n  const query = {\n    rid,\n    ts\n  };\n\n  if (excludePinned) {\n    query.pinned = {\n      $ne: true\n    };\n  }\n\n  if (ignoreDiscussion) {\n    query.drid = {\n      $exists: false\n    };\n  }\n\n  if (users && users.length) {\n    query['u.username'] = {\n      $in: users\n    };\n  }\n\n  ChatMessage.remove(query);\n};\n\nconst RoomManager = new function () {\n  const openedRooms = {};\n  const msgStream = new Meteor.Streamer('room-messages');\n  const roomStream = new Meteor.Streamer(ROOM_DATA_STREAM);\n  const onlineUsers = new ReactiveVar({});\n  const Dep = new Tracker.Dependency();\n\n  const handleTrackSettingsChange = msg => {\n    const openedRoom = Tracker.nonreactive(() => Session.get('openedRoom'));\n\n    if (openedRoom !== msg.rid) {\n      return;\n    }\n\n    Tracker.nonreactive(() => {\n      if (msg.t === 'room_changed_privacy') {\n        const type = FlowRouter.current().route.name === 'channel' ? 'c' : 'p';\n        RoomManager.close(type + FlowRouter.getParam('name'));\n        const subscription = ChatSubscription.findOne({\n          rid: msg.rid\n        });\n        const route = subscription.t === 'c' ? 'channel' : 'group';\n        FlowRouter.go(route, {\n          name: subscription.name\n        }, FlowRouter.current().queryParams);\n      }\n\n      if (msg.t === 'r') {\n        const room = ChatRoom.findOne(msg.rid);\n\n        if (room.name !== FlowRouter.getParam('name')) {\n          RoomManager.close(room.t + FlowRouter.getParam('name'));\n          roomCoordinator.openRouteLink(room.t, room, FlowRouter.current().queryParams);\n        }\n      }\n    });\n  };\n\n  const Cls = class {\n    static initClass() {\n      this.prototype.openedRooms = openedRooms;\n      this.prototype.onlineUsers = onlineUsers;\n      this.prototype.roomStream = roomStream;\n      this.prototype.computation = Tracker.autorun(() => {\n        const ready = CachedChatRoom.ready.get() && mainReady.get();\n\n        if (ready !== true) {\n          return;\n        }\n\n        Tracker.nonreactive(() => Object.entries(openedRooms).forEach(_ref2 => {\n          var _roomCoordinator$getR;\n\n          let [typeName, record] = _ref2;\n\n          if (record.active !== true || record.ready === true) {\n            return;\n          }\n\n          const type = typeName.substr(0, 1);\n          const name = typeName.substr(1);\n          const room = (_roomCoordinator$getR = roomCoordinator.getRoomDirectives(type)) === null || _roomCoordinator$getR === void 0 ? void 0 : _roomCoordinator$getR.findRoom(name);\n          RoomHistoryManager.getMoreIfIsEmpty(record.rid);\n\n          if (room != null) {\n            if (record.streamActive !== true) {\n              record.streamActive = true;\n              msgStream.on(record.rid, async msg => {\n                // Should not send message to room if room has not loaded all the current messages\n                if (RoomHistoryManager.hasMoreNext(record.rid) !== false) {\n                  return;\n                } // Do not load command messages into channel\n\n\n                if (msg.t !== 'command') {\n                  const subscription = ChatSubscription.findOne({\n                    rid: record.rid\n                  }, {\n                    reactive: false\n                  });\n                  const isNew = !ChatMessage.findOne({\n                    _id: msg._id,\n                    temp: {\n                      $ne: true\n                    }\n                  });\n                  upsertMessage({\n                    msg,\n                    subscription\n                  });\n                  msg.room = {\n                    type,\n                    name\n                  };\n\n                  if (isNew) {\n                    callbacks.run('streamNewMessage', msg);\n                  }\n                }\n\n                msg.name = room.name;\n                Tracker.afterFlush(() => RoomManager.updateMentionsMarksOfRoom(typeName));\n                handleTrackSettingsChange(msg);\n                callbacks.run('streamMessage', msg);\n                return fireGlobalEvent('new-message', msg);\n              });\n              Notifications.onRoom(record.rid, 'deleteMessage', onDeleteMessageStream); // eslint-disable-line no-use-before-define\n\n              Notifications.onRoom(record.rid, 'deleteMessageBulk', onDeleteMessageBulkStream); // eslint-disable-line no-use-before-define\n            }\n          }\n\n          record.ready = true;\n        }));\n        Dep.changed();\n      });\n    }\n\n    getOpenedRoomByRid(rid) {\n      return Object.keys(openedRooms).map(typeName => openedRooms[typeName]).find(openedRoom => openedRoom.rid === rid);\n    }\n\n    close(typeName) {\n      if (openedRooms[typeName]) {\n        if (openedRooms[typeName].rid != null) {\n          msgStream.removeAllListeners(openedRooms[typeName].rid);\n          Notifications.unRoom(openedRooms[typeName].rid, 'deleteMessage', onDeleteMessageStream); // eslint-disable-line no-use-before-define\n\n          Notifications.unRoom(openedRooms[typeName].rid, 'deleteMessageBulk', onDeleteMessageBulkStream); // eslint-disable-line no-use-before-define\n        }\n\n        openedRooms[typeName].ready = false;\n        openedRooms[typeName].active = false;\n\n        if (openedRooms[typeName].template != null) {\n          try {\n            Blaze.remove(openedRooms[typeName].template);\n          } catch (e) {\n            console.error('Error removing template from DOM', e);\n          }\n        }\n\n        delete openedRooms[typeName].dom;\n        delete openedRooms[typeName].template;\n        const {\n          rid\n        } = openedRooms[typeName];\n        delete openedRooms[typeName];\n\n        if (rid != null) {\n          NewRoomManager.close(rid);\n          return RoomHistoryManager.clear(rid);\n        }\n      }\n    }\n\n    closeOlderRooms() {\n      if (Object.keys(openedRooms).length <= maxRoomsOpen) {\n        return;\n      }\n\n      const roomsToClose = _.sortBy(_.values(openedRooms), 'lastSeen').reverse().slice(maxRoomsOpen);\n\n      return Array.from(roomsToClose).map(roomToClose => this.close(roomToClose.typeName));\n    }\n\n    closeAllRooms() {\n      Object.keys(openedRooms).forEach(key => {\n        const openedRoom = openedRooms[key];\n        this.close(openedRoom.typeName);\n      });\n      Session.set('openedRoom');\n    }\n\n    open(_ref3) {\n      let {\n        typeName,\n        rid\n      } = _ref3;\n\n      if (openedRooms[typeName] == null) {\n        openedRooms[typeName] = {\n          typeName,\n          rid,\n          active: false,\n          ready: false,\n          unreadSince: new ReactiveVar(undefined)\n        };\n      }\n\n      openedRooms[typeName].lastSeen = new Date();\n\n      if (openedRooms[typeName].ready) {\n        this.closeOlderRooms();\n      }\n\n      if (CachedChatSubscription.ready.get() === true) {\n        if (openedRooms[typeName].active !== true) {\n          openedRooms[typeName].active = true;\n\n          if (this.computation) {\n            this.computation.invalidate();\n          }\n        }\n      }\n\n      return {\n        ready() {\n          Dep.depend();\n          return openedRooms[typeName].ready;\n        }\n\n      };\n    }\n\n    existsDomOfRoom(typeName) {\n      const room = openedRooms[typeName];\n      return (room != null ? room.dom : undefined) != null;\n    }\n\n    updateUserStatus(user, status, utcOffset) {\n      const onlineUsersValue = onlineUsers.curValue;\n\n      if (status === 'offline') {\n        delete onlineUsersValue[user.username];\n      } else {\n        onlineUsersValue[user.username] = {\n          _id: user._id,\n          status,\n          utcOffset\n        };\n      }\n\n      return onlineUsers.set(onlineUsersValue);\n    }\n\n    updateMentionsMarksOfRoom() {// const [ticksBar] = dom.getElementsByClassName('ticks-bar');\n      // const [messagesBox] = dom.getElementsByClassName('messages-box');\n      // const scrollTop = $('> .wrapper', messagesBox).scrollTop() - 50;\n      // const totalHeight = $(' > .wrapper > ul', messagesBox).height() + 40;\n      // if (!ticksBar) {\n      // \treturn;\n      // }\n      // // TODO: thread quotes should NOT have mention links at all\n      // const mentionsSelector = '.message .body .mention-link--me, .message .body .mention-link--group';\n      // ticksBar.innerHTML = Array.from(messagesBox?.querySelectorAll(mentionsSelector) || [])\n      // \t.map((mentionLink) => {\n      // \t\tconst topOffset = $(mentionLink).offset().top + scrollTop;\n      // \t\tconst percent = (100 / totalHeight) * topOffset;\n      // \t\tconst className = [\n      // \t\t\t'tick',\n      // \t\t\tmentionLink.classList.contains('mention-link--me') && 'tick--me',\n      // \t\t\tmentionLink.classList.contains('mention-link--group') && 'tick--group',\n      // \t\t].filter(Boolean).join(' ');\n      // \t\treturn `<div class=\"${ className }\" style=\"top: ${ percent }%;\"></div>`;\n      // \t})\n      // \t.join('');\n    }\n\n  };\n  Cls.initClass();\n  return new Cls();\n}();\n\nconst loadMissedMessages = async function (rid) {\n  const lastMessage = ChatMessage.findOne({\n    rid,\n    _hidden: {\n      $ne: true\n    },\n    temp: {\n      $exists: false\n    }\n  }, {\n    sort: {\n      ts: -1\n    },\n    limit: 1\n  });\n\n  if (lastMessage == null) {\n    return;\n  }\n\n  try {\n    const result = await callWithErrorHandling('loadMissedMessages', rid, lastMessage.ts);\n\n    if (result) {\n      const subscription = ChatSubscription.findOne({\n        rid\n      });\n      return Promise.all(Array.from(result).map(msg => upsertMessage({\n        msg,\n        subscription\n      })));\n    }\n\n    return [];\n  } catch (error) {\n    return [];\n  }\n};\n\nlet connectionWasOnline = true;\nTracker.autorun(function () {\n  const {\n    connected\n  } = Meteor.connection.status();\n\n  if (connected === true && connectionWasOnline === false && RoomManager.openedRooms != null) {\n    Object.keys(RoomManager.openedRooms).forEach(key => {\n      const value = RoomManager.openedRooms[key];\n\n      if (value.rid != null) {\n        loadMissedMessages(value.rid);\n      }\n    });\n  }\n\n  connectionWasOnline = connected;\n});\nMeteor.startup(() => {\n  // Reload rooms after login\n  let currentUsername = undefined;\n  Tracker.autorun(() => {\n    const user = Meteor.user();\n\n    if (currentUsername === undefined && (user != null ? user.username : undefined) != null) {\n      currentUsername = user.username;\n      RoomManager.closeAllRooms(); // Reload only if the current route is a channel route\n\n      const roomType = roomCoordinator.getRouteNameIdentifier(FlowRouter.current().route.name);\n\n      if (roomType) {\n        FlowRouter.reload();\n      }\n    }\n  });\n  ChatMessage.find().observe({\n    removed(record) {\n      if (RoomManager.getOpenedRoomByRid(record.rid) != null) {\n        const recordBefore = ChatMessage.findOne({\n          ts: {\n            $lt: record.ts\n          }\n        }, {\n          sort: {\n            ts: -1\n          }\n        });\n\n        if (recordBefore != null) {\n          ChatMessage.update({\n            _id: recordBefore._id\n          }, {\n            $set: {\n              tick: new Date()\n            }\n          });\n        }\n\n        const recordAfter = ChatMessage.findOne({\n          ts: {\n            $gt: record.ts\n          }\n        }, {\n          sort: {\n            ts: 1\n          }\n        });\n\n        if (recordAfter != null) {\n          return ChatMessage.update({\n            _id: recordAfter._id\n          }, {\n            $set: {\n              tick: new Date()\n            }\n          });\n        }\n      }\n    }\n\n  });\n});\nTracker.autorun(function () {\n  if (Meteor.userId()) {\n    return Notifications.onUser('message', function (msg) {\n      msg.u = msg.u || {\n        username: 'rocket.cat'\n      };\n      msg.private = true;\n      return ChatMessage.upsert({\n        _id: msg._id\n      }, msg);\n    });\n  }\n});\ncallbacks.add('afterLogoutCleanUp', () => RoomManager.closeAllRooms(), callbacks.priority.MEDIUM, 'roommanager-after-logout-cleanup');\nCachedCollectionManager.onLogin(() => {\n  Notifications.onUser('subscriptions-changed', (action, sub) => {\n    const ignored = sub && sub.ignored ? {\n      $nin: sub.ignored\n    } : {\n      $exists: true\n    };\n    ChatMessage.update({\n      rid: sub.rid,\n      ignored\n    }, {\n      $unset: {\n        ignored: true\n      }\n    }, {\n      multi: true\n    });\n\n    if (sub && sub.ignored) {\n      ChatMessage.update({\n        'rid': sub.rid,\n        't': {\n          $ne: 'command'\n        },\n        'u._id': {\n          $in: sub.ignored\n        }\n      }, {\n        $set: {\n          ignored: true\n        }\n      }, {\n        multi: true\n      });\n    }\n  });\n});","map":{"version":3,"sources":["app/ui-utils/client/lib/RoomManager.js"],"names":["module","export","RoomManager","Meteor","link","v","ReactiveVar","Session","Tracker","Blaze","FlowRouter","_","default","fireGlobalEvent","upsertMessage","RoomHistoryManager","mainReady","callbacks","Notifications","CachedChatRoom","ChatMessage","ChatSubscription","CachedChatSubscription","ChatRoom","CachedCollectionManager","getConfig","ROOM_DATA_STREAM","callWithErrorHandling","NewRoomManager","roomCoordinator","maxRoomsOpen","parseInt","onDeleteMessageStream","msg","remove","_id","update","tmid","$unset","multi","onDeleteMessageBulkStream","rid","ts","excludePinned","ignoreDiscussion","users","query","pinned","$ne","drid","$exists","length","$in","openedRooms","msgStream","Streamer","roomStream","onlineUsers","Dep","Dependency","handleTrackSettingsChange","openedRoom","nonreactive","get","t","type","current","route","name","close","getParam","subscription","findOne","go","queryParams","room","openRouteLink","Cls","initClass","prototype","computation","autorun","ready","Object","entries","forEach","typeName","record","active","substr","getRoomDirectives","findRoom","getMoreIfIsEmpty","streamActive","on","hasMoreNext","reactive","isNew","temp","run","afterFlush","updateMentionsMarksOfRoom","onRoom","changed","getOpenedRoomByRid","keys","map","find","removeAllListeners","unRoom","template","e","console","error","dom","clear","closeOlderRooms","roomsToClose","sortBy","values","reverse","slice","Array","from","roomToClose","closeAllRooms","key","set","open","unreadSince","undefined","lastSeen","Date","invalidate","depend","existsDomOfRoom","updateUserStatus","user","status","utcOffset","onlineUsersValue","curValue","username","loadMissedMessages","lastMessage","_hidden","sort","limit","result","Promise","all","connectionWasOnline","connected","connection","value","startup","currentUsername","roomType","getRouteNameIdentifier","reload","observe","removed","recordBefore","$lt","$set","tick","recordAfter","$gt","userId","onUser","u","private","upsert","add","priority","MEDIUM","onLogin","action","sub","ignored","$nin"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { ReactiveVar } from 'meteor/reactive-var';\nimport { Session } from 'meteor/session';\nimport { Tracker } from 'meteor/tracker';\nimport { Blaze } from 'meteor/blaze';\nimport { FlowRouter } from 'meteor/kadira:flow-router';\nimport _ from 'underscore';\n\nimport { fireGlobalEvent } from '../../../../client/lib/utils/fireGlobalEvent';\nimport { upsertMessage, RoomHistoryManager } from './RoomHistoryManager';\nimport { mainReady } from './mainReady';\nimport { callbacks } from '../../../../lib/callbacks';\nimport { Notifications } from '../../../notifications';\nimport { CachedChatRoom, ChatMessage, ChatSubscription, CachedChatSubscription, ChatRoom } from '../../../models';\nimport { CachedCollectionManager } from '../../../ui-cached-collection';\nimport { getConfig } from '../../../../client/lib/utils/getConfig';\nimport { ROOM_DATA_STREAM } from '../../../utils/stream/constants';\nimport { callWithErrorHandling } from '../../../../client/lib/utils/callWithErrorHandling';\nimport { RoomManager as NewRoomManager } from '../../../../client/lib/RoomManager';\nimport { roomCoordinator } from '../../../../client/lib/rooms/roomCoordinator';\n\nconst maxRoomsOpen = parseInt(getConfig('maxRoomsOpen')) || 5;\n\nconst onDeleteMessageStream = (msg) => {\n\tChatMessage.remove({ _id: msg._id });\n\n\t// remove thread refenrece from deleted message\n\tChatMessage.update({ tmid: msg._id }, { $unset: { tmid: 1 } }, { multi: true });\n};\nconst onDeleteMessageBulkStream = ({ rid, ts, excludePinned, ignoreDiscussion, users }) => {\n\tconst query = { rid, ts };\n\tif (excludePinned) {\n\t\tquery.pinned = { $ne: true };\n\t}\n\tif (ignoreDiscussion) {\n\t\tquery.drid = { $exists: false };\n\t}\n\tif (users && users.length) {\n\t\tquery['u.username'] = { $in: users };\n\t}\n\tChatMessage.remove(query);\n};\n\nexport const RoomManager = new (function () {\n\tconst openedRooms = {};\n\tconst msgStream = new Meteor.Streamer('room-messages');\n\tconst roomStream = new Meteor.Streamer(ROOM_DATA_STREAM);\n\tconst onlineUsers = new ReactiveVar({});\n\tconst Dep = new Tracker.Dependency();\n\n\tconst handleTrackSettingsChange = (msg) => {\n\t\tconst openedRoom = Tracker.nonreactive(() => Session.get('openedRoom'));\n\t\tif (openedRoom !== msg.rid) {\n\t\t\treturn;\n\t\t}\n\n\t\tTracker.nonreactive(() => {\n\t\t\tif (msg.t === 'room_changed_privacy') {\n\t\t\t\tconst type = FlowRouter.current().route.name === 'channel' ? 'c' : 'p';\n\t\t\t\tRoomManager.close(type + FlowRouter.getParam('name'));\n\n\t\t\t\tconst subscription = ChatSubscription.findOne({ rid: msg.rid });\n\t\t\t\tconst route = subscription.t === 'c' ? 'channel' : 'group';\n\t\t\t\tFlowRouter.go(route, { name: subscription.name }, FlowRouter.current().queryParams);\n\t\t\t}\n\n\t\t\tif (msg.t === 'r') {\n\t\t\t\tconst room = ChatRoom.findOne(msg.rid);\n\t\t\t\tif (room.name !== FlowRouter.getParam('name')) {\n\t\t\t\t\tRoomManager.close(room.t + FlowRouter.getParam('name'));\n\t\t\t\t\troomCoordinator.openRouteLink(room.t, room, FlowRouter.current().queryParams);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t};\n\n\tconst Cls = class {\n\t\tstatic initClass() {\n\t\t\tthis.prototype.openedRooms = openedRooms;\n\t\t\tthis.prototype.onlineUsers = onlineUsers;\n\t\t\tthis.prototype.roomStream = roomStream;\n\t\t\tthis.prototype.computation = Tracker.autorun(() => {\n\t\t\t\tconst ready = CachedChatRoom.ready.get() && mainReady.get();\n\t\t\t\tif (ready !== true) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tTracker.nonreactive(() =>\n\t\t\t\t\tObject.entries(openedRooms).forEach(([typeName, record]) => {\n\t\t\t\t\t\tif (record.active !== true || record.ready === true) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst type = typeName.substr(0, 1);\n\t\t\t\t\t\tconst name = typeName.substr(1);\n\n\t\t\t\t\t\tconst room = roomCoordinator.getRoomDirectives(type)?.findRoom(name);\n\n\t\t\t\t\t\tRoomHistoryManager.getMoreIfIsEmpty(record.rid);\n\n\t\t\t\t\t\tif (room != null) {\n\t\t\t\t\t\t\tif (record.streamActive !== true) {\n\t\t\t\t\t\t\t\trecord.streamActive = true;\n\t\t\t\t\t\t\t\tmsgStream.on(record.rid, async (msg) => {\n\t\t\t\t\t\t\t\t\t// Should not send message to room if room has not loaded all the current messages\n\t\t\t\t\t\t\t\t\tif (RoomHistoryManager.hasMoreNext(record.rid) !== false) {\n\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t// Do not load command messages into channel\n\t\t\t\t\t\t\t\t\tif (msg.t !== 'command') {\n\t\t\t\t\t\t\t\t\t\tconst subscription = ChatSubscription.findOne({ rid: record.rid }, { reactive: false });\n\t\t\t\t\t\t\t\t\t\tconst isNew = !ChatMessage.findOne({ _id: msg._id, temp: { $ne: true } });\n\t\t\t\t\t\t\t\t\t\tupsertMessage({ msg, subscription });\n\n\t\t\t\t\t\t\t\t\t\tmsg.room = {\n\t\t\t\t\t\t\t\t\t\t\ttype,\n\t\t\t\t\t\t\t\t\t\t\tname,\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\tif (isNew) {\n\t\t\t\t\t\t\t\t\t\t\tcallbacks.run('streamNewMessage', msg);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\tmsg.name = room.name;\n\t\t\t\t\t\t\t\t\tTracker.afterFlush(() => RoomManager.updateMentionsMarksOfRoom(typeName));\n\n\t\t\t\t\t\t\t\t\thandleTrackSettingsChange(msg);\n\n\t\t\t\t\t\t\t\t\tcallbacks.run('streamMessage', msg);\n\n\t\t\t\t\t\t\t\t\treturn fireGlobalEvent('new-message', msg);\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\tNotifications.onRoom(record.rid, 'deleteMessage', onDeleteMessageStream); // eslint-disable-line no-use-before-define\n\t\t\t\t\t\t\t\tNotifications.onRoom(record.rid, 'deleteMessageBulk', onDeleteMessageBulkStream); // eslint-disable-line no-use-before-define\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\trecord.ready = true;\n\t\t\t\t\t}),\n\t\t\t\t);\n\t\t\t\tDep.changed();\n\t\t\t});\n\t\t}\n\n\t\tgetOpenedRoomByRid(rid) {\n\t\t\treturn Object.keys(openedRooms)\n\t\t\t\t.map((typeName) => openedRooms[typeName])\n\t\t\t\t.find((openedRoom) => openedRoom.rid === rid);\n\t\t}\n\n\t\tclose(typeName) {\n\t\t\tif (openedRooms[typeName]) {\n\t\t\t\tif (openedRooms[typeName].rid != null) {\n\t\t\t\t\tmsgStream.removeAllListeners(openedRooms[typeName].rid);\n\t\t\t\t\tNotifications.unRoom(openedRooms[typeName].rid, 'deleteMessage', onDeleteMessageStream); // eslint-disable-line no-use-before-define\n\t\t\t\t\tNotifications.unRoom(openedRooms[typeName].rid, 'deleteMessageBulk', onDeleteMessageBulkStream); // eslint-disable-line no-use-before-define\n\t\t\t\t}\n\n\t\t\t\topenedRooms[typeName].ready = false;\n\t\t\t\topenedRooms[typeName].active = false;\n\t\t\t\tif (openedRooms[typeName].template != null) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tBlaze.remove(openedRooms[typeName].template);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tconsole.error('Error removing template from DOM', e);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tdelete openedRooms[typeName].dom;\n\t\t\t\tdelete openedRooms[typeName].template;\n\n\t\t\t\tconst { rid } = openedRooms[typeName];\n\t\t\t\tdelete openedRooms[typeName];\n\n\t\t\t\tif (rid != null) {\n\t\t\t\t\tNewRoomManager.close(rid);\n\t\t\t\t\treturn RoomHistoryManager.clear(rid);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tcloseOlderRooms() {\n\t\t\tif (Object.keys(openedRooms).length <= maxRoomsOpen) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst roomsToClose = _.sortBy(_.values(openedRooms), 'lastSeen').reverse().slice(maxRoomsOpen);\n\t\t\treturn Array.from(roomsToClose).map((roomToClose) => this.close(roomToClose.typeName));\n\t\t}\n\n\t\tcloseAllRooms() {\n\t\t\tObject.keys(openedRooms).forEach((key) => {\n\t\t\t\tconst openedRoom = openedRooms[key];\n\t\t\t\tthis.close(openedRoom.typeName);\n\t\t\t});\n\t\t\tSession.set('openedRoom');\n\t\t}\n\n\t\topen({ typeName, rid }) {\n\t\t\tif (openedRooms[typeName] == null) {\n\t\t\t\topenedRooms[typeName] = {\n\t\t\t\t\ttypeName,\n\t\t\t\t\trid,\n\t\t\t\t\tactive: false,\n\t\t\t\t\tready: false,\n\t\t\t\t\tunreadSince: new ReactiveVar(undefined),\n\t\t\t\t};\n\t\t\t}\n\n\t\t\topenedRooms[typeName].lastSeen = new Date();\n\n\t\t\tif (openedRooms[typeName].ready) {\n\t\t\t\tthis.closeOlderRooms();\n\t\t\t}\n\n\t\t\tif (CachedChatSubscription.ready.get() === true) {\n\t\t\t\tif (openedRooms[typeName].active !== true) {\n\t\t\t\t\topenedRooms[typeName].active = true;\n\t\t\t\t\tif (this.computation) {\n\t\t\t\t\t\tthis.computation.invalidate();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tready() {\n\t\t\t\t\tDep.depend();\n\t\t\t\t\treturn openedRooms[typeName].ready;\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\texistsDomOfRoom(typeName) {\n\t\t\tconst room = openedRooms[typeName];\n\t\t\treturn (room != null ? room.dom : undefined) != null;\n\t\t}\n\n\t\tupdateUserStatus(user, status, utcOffset) {\n\t\t\tconst onlineUsersValue = onlineUsers.curValue;\n\n\t\t\tif (status === 'offline') {\n\t\t\t\tdelete onlineUsersValue[user.username];\n\t\t\t} else {\n\t\t\t\tonlineUsersValue[user.username] = {\n\t\t\t\t\t_id: user._id,\n\t\t\t\t\tstatus,\n\t\t\t\t\tutcOffset,\n\t\t\t\t};\n\t\t\t}\n\n\t\t\treturn onlineUsers.set(onlineUsersValue);\n\t\t}\n\n\t\tupdateMentionsMarksOfRoom(/* typeName */) {\n\t\t\t// const [ticksBar] = dom.getElementsByClassName('ticks-bar');\n\t\t\t// const [messagesBox] = dom.getElementsByClassName('messages-box');\n\t\t\t// const scrollTop = $('> .wrapper', messagesBox).scrollTop() - 50;\n\t\t\t// const totalHeight = $(' > .wrapper > ul', messagesBox).height() + 40;\n\t\t\t// if (!ticksBar) {\n\t\t\t// \treturn;\n\t\t\t// }\n\t\t\t// // TODO: thread quotes should NOT have mention links at all\n\t\t\t// const mentionsSelector = '.message .body .mention-link--me, .message .body .mention-link--group';\n\t\t\t// ticksBar.innerHTML = Array.from(messagesBox?.querySelectorAll(mentionsSelector) || [])\n\t\t\t// \t.map((mentionLink) => {\n\t\t\t// \t\tconst topOffset = $(mentionLink).offset().top + scrollTop;\n\t\t\t// \t\tconst percent = (100 / totalHeight) * topOffset;\n\t\t\t// \t\tconst className = [\n\t\t\t// \t\t\t'tick',\n\t\t\t// \t\t\tmentionLink.classList.contains('mention-link--me') && 'tick--me',\n\t\t\t// \t\t\tmentionLink.classList.contains('mention-link--group') && 'tick--group',\n\t\t\t// \t\t].filter(Boolean).join(' ');\n\t\t\t// \t\treturn `<div class=\"${ className }\" style=\"top: ${ percent }%;\"></div>`;\n\t\t\t// \t})\n\t\t\t// \t.join('');\n\t\t}\n\t};\n\tCls.initClass();\n\treturn new Cls();\n})();\n\nconst loadMissedMessages = async function (rid) {\n\tconst lastMessage = ChatMessage.findOne({ rid, _hidden: { $ne: true }, temp: { $exists: false } }, { sort: { ts: -1 }, limit: 1 });\n\n\tif (lastMessage == null) {\n\t\treturn;\n\t}\n\n\ttry {\n\t\tconst result = await callWithErrorHandling('loadMissedMessages', rid, lastMessage.ts);\n\t\tif (result) {\n\t\t\tconst subscription = ChatSubscription.findOne({ rid });\n\t\t\treturn Promise.all(Array.from(result).map((msg) => upsertMessage({ msg, subscription })));\n\t\t}\n\t\treturn [];\n\t} catch (error) {\n\t\treturn [];\n\t}\n};\n\nlet connectionWasOnline = true;\nTracker.autorun(function () {\n\tconst { connected } = Meteor.connection.status();\n\n\tif (connected === true && connectionWasOnline === false && RoomManager.openedRooms != null) {\n\t\tObject.keys(RoomManager.openedRooms).forEach((key) => {\n\t\t\tconst value = RoomManager.openedRooms[key];\n\t\t\tif (value.rid != null) {\n\t\t\t\tloadMissedMessages(value.rid);\n\t\t\t}\n\t\t});\n\t}\n\tconnectionWasOnline = connected;\n});\n\nMeteor.startup(() => {\n\t// Reload rooms after login\n\tlet currentUsername = undefined;\n\tTracker.autorun(() => {\n\t\tconst user = Meteor.user();\n\t\tif (currentUsername === undefined && (user != null ? user.username : undefined) != null) {\n\t\t\tcurrentUsername = user.username;\n\t\t\tRoomManager.closeAllRooms();\n\t\t\t// Reload only if the current route is a channel route\n\t\t\tconst roomType = roomCoordinator.getRouteNameIdentifier(FlowRouter.current().route.name);\n\t\t\tif (roomType) {\n\t\t\t\tFlowRouter.reload();\n\t\t\t}\n\t\t}\n\t});\n\n\tChatMessage.find().observe({\n\t\tremoved(record) {\n\t\t\tif (RoomManager.getOpenedRoomByRid(record.rid) != null) {\n\t\t\t\tconst recordBefore = ChatMessage.findOne({ ts: { $lt: record.ts } }, { sort: { ts: -1 } });\n\t\t\t\tif (recordBefore != null) {\n\t\t\t\t\tChatMessage.update({ _id: recordBefore._id }, { $set: { tick: new Date() } });\n\t\t\t\t}\n\n\t\t\t\tconst recordAfter = ChatMessage.findOne({ ts: { $gt: record.ts } }, { sort: { ts: 1 } });\n\t\t\t\tif (recordAfter != null) {\n\t\t\t\t\treturn ChatMessage.update({ _id: recordAfter._id }, { $set: { tick: new Date() } });\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t});\n});\n\nTracker.autorun(function () {\n\tif (Meteor.userId()) {\n\t\treturn Notifications.onUser('message', function (msg) {\n\t\t\tmsg.u = msg.u || { username: 'rocket.cat' };\n\t\t\tmsg.private = true;\n\n\t\t\treturn ChatMessage.upsert({ _id: msg._id }, msg);\n\t\t});\n\t}\n});\n\ncallbacks.add('afterLogoutCleanUp', () => RoomManager.closeAllRooms(), callbacks.priority.MEDIUM, 'roommanager-after-logout-cleanup');\n\nCachedCollectionManager.onLogin(() => {\n\tNotifications.onUser('subscriptions-changed', (action, sub) => {\n\t\tconst ignored = sub && sub.ignored ? { $nin: sub.ignored } : { $exists: true };\n\n\t\tChatMessage.update({ rid: sub.rid, ignored }, { $unset: { ignored: true } }, { multi: true });\n\t\tif (sub && sub.ignored) {\n\t\t\tChatMessage.update(\n\t\t\t\t{ 'rid': sub.rid, 't': { $ne: 'command' }, 'u._id': { $in: sub.ignored } },\n\t\t\t\t{ $set: { ignored: true } },\n\t\t\t\t{ multi: true },\n\t\t\t);\n\t\t}\n\t});\n});\n"]},"sourceType":"module","hash":"ffc2c3529641613d5631b16619a4e187d7886cec"}
