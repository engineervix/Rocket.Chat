{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/packages/rocketchat:streamer/client/client.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"packages/rocketchat:streamer/client/client.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/packages/rocketchat:streamer/client/client.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/packages/rocketchat:streamer/client/client.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/rocketchat:streamer/client/client.js"}},"code":"/* globals DDPCommon, EV */\n\n/* eslint-disable new-cap */\nconst NonEmptyString = Match.Where(function (x) {\n  check(x, String);\n  return x.length > 0;\n});\n\nclass StreamerCentral extends EV {\n  constructor() {\n    super();\n    this.instances = {};\n    this.ddpConnections = {}; // since each Streamer instance can provide its own ddp connection, store them by streamer name\n  }\n\n  setupDdpConnection(name, ddpConnection) {\n    // make sure we only setup event listeners for each ddp connection once\n    if (ddpConnection.hasMeteorStreamerEventListeners) {\n      return;\n    }\n\n    ddpConnection._stream.on('message', raw_msg => {\n      const msg = DDPCommon.parseDDP(raw_msg);\n\n      if (msg && msg.msg === 'changed' && msg.collection && msg.fields && msg.fields.eventName && msg.fields.args) {\n        msg.fields.args.unshift(msg.fields.eventName);\n        msg.fields.args.unshift(msg.collection);\n        this.emit.apply(this, msg.fields.args);\n      }\n    }); // store ddp connection\n\n\n    this.storeDdpConnection(name, ddpConnection);\n  }\n\n  storeDdpConnection(name, ddpConnection) {\n    // mark the connection as setup for Streamer, and store it\n    ddpConnection.hasMeteorStreamerEventListeners = true;\n    this.ddpConnections[name] = ddpConnection;\n  }\n\n}\n\nMeteor.StreamerCentral = new StreamerCentral();\nMeteor.Streamer = class Streamer extends EV {\n  constructor(name) {\n    var _this;\n\n    let {\n      useCollection = false,\n      ddpConnection = Meteor.connection\n    } = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n\n    if (Meteor.StreamerCentral.instances[name]) {\n      console.warn('Streamer instance already exists:', name);\n      return Meteor.StreamerCentral.instances[name];\n    }\n\n    Meteor.StreamerCentral.setupDdpConnection(name, ddpConnection);\n    super();\n    _this = this;\n    this.ddpConnection = ddpConnection || Meteor.connection;\n    Meteor.StreamerCentral.instances[name] = this;\n    this.name = name;\n    this.useCollection = useCollection;\n    this.subscriptions = {};\n    Meteor.StreamerCentral.on(this.subscriptionName, function (eventName) {\n      if (_this.subscriptions[eventName]) {\n        for (var _len = arguments.length, args = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {\n          args[_key - 1] = arguments[_key];\n        }\n\n        _this.subscriptions[eventName].lastMessage = args;\n        EV.prototype.emit.call(_this, eventName, ...args);\n      }\n    });\n\n    this.ddpConnection._stream.on('reset', () => {\n      EV.prototype.emit.call(this, '__reconnect__');\n    });\n  }\n\n  get name() {\n    return this._name;\n  }\n\n  set name(name) {\n    check(name, String);\n    this._name = name;\n  }\n\n  get subscriptionName() {\n    return \"stream-\".concat(this.name);\n  }\n\n  get useCollection() {\n    return this._useCollection;\n  }\n\n  set useCollection(useCollection) {\n    check(useCollection, Boolean);\n    this._useCollection = useCollection;\n  }\n\n  stop(eventName) {\n    return this.subscriptions[eventName] && this.subscriptions[eventName].subscription && this.subscriptions[eventName].subscription.stop();\n  }\n\n  stopAll() {\n    Object.keys(this.subscriptions).forEach(eventName => this.removeAllListeners(eventName));\n  }\n\n  unsubscribe(eventName) {\n    delete this.subscriptions[eventName];\n    EV.prototype.removeAllListeners.call(this, eventName);\n  }\n\n  subscribe(eventName, args) {\n    return new Promise((resolve, reject) => {\n      if (this.subscriptions[eventName]) {\n        return resolve();\n      }\n\n      const subscription = Tracker.nonreactive(() => this.ddpConnection.subscribe(this.subscriptionName, eventName, {\n        useCollection: this.useCollection,\n        args\n      }, {\n        onStop: () => reject(this.unsubscribe(eventName)),\n        onReady: resolve\n      }));\n      this.subscriptions[eventName] = {\n        subscription\n      };\n    });\n  }\n\n  onReconnect(fn) {\n    if (typeof fn === 'function') {\n      EV.prototype.on.call(this, '__reconnect__', fn);\n    }\n  }\n\n  getLastMessageFromEvent(eventName) {\n    const subscription = this.subscriptions[eventName];\n\n    if (subscription && subscription.lastMessage) {\n      return subscription.lastMessage;\n    }\n  }\n\n  removeAllListeners(eventName) {\n    EV.prototype.removeAllListeners.call(this, eventName);\n    return this.stop(eventName);\n  }\n\n  removeListener(eventName) {\n    if (this.listenerCount(eventName) === 1) {\n      this.stop(eventName);\n    }\n\n    for (var _len2 = arguments.length, args = new Array(_len2 > 1 ? _len2 - 1 : 0), _key2 = 1; _key2 < _len2; _key2++) {\n      args[_key2 - 1] = arguments[_key2];\n    }\n\n    EV.prototype.removeListener.call(this, eventName, ...args);\n  }\n\n  on(eventName) {\n    check(eventName, NonEmptyString);\n\n    for (var _len3 = arguments.length, args = new Array(_len3 > 1 ? _len3 - 1 : 0), _key3 = 1; _key3 < _len3; _key3++) {\n      args[_key3 - 1] = arguments[_key3];\n    }\n\n    const callback = args.pop();\n    check(callback, Function);\n    EV.prototype.on.call(this, eventName, callback);\n    return this.subscribe(eventName, args);\n  }\n\n  once(eventName) {\n    var _this2 = this;\n\n    check(eventName, NonEmptyString);\n\n    for (var _len4 = arguments.length, args = new Array(_len4 > 1 ? _len4 - 1 : 0), _key4 = 1; _key4 < _len4; _key4++) {\n      args[_key4 - 1] = arguments[_key4];\n    }\n\n    const callback = args.pop();\n    check(callback, Function);\n    EV.prototype.once.call(this, eventName, function () {\n      callback(...arguments);\n\n      if (_this2.listenerCount(eventName) === 0) {\n        return _this2.stop(eventName);\n      }\n    });\n    return this.subscribe(eventName, args);\n  }\n\n  emit() {\n    for (var _len5 = arguments.length, args = new Array(_len5), _key5 = 0; _key5 < _len5; _key5++) {\n      args[_key5] = arguments[_key5];\n    }\n\n    this.ddpConnection.call(this.subscriptionName, ...args);\n  }\n\n};","map":{"version":3,"sources":["packages/rocketchat:streamer/client/client.js"],"names":["NonEmptyString","Match","Where","x","check","String","length","StreamerCentral","EV","constructor","instances","ddpConnections","setupDdpConnection","name","ddpConnection","hasMeteorStreamerEventListeners","_stream","on","raw_msg","msg","DDPCommon","parseDDP","collection","fields","eventName","args","unshift","emit","apply","storeDdpConnection","Meteor","Streamer","useCollection","connection","console","warn","subscriptions","subscriptionName","lastMessage","prototype","call","_name","_useCollection","Boolean","stop","subscription","stopAll","Object","keys","forEach","removeAllListeners","unsubscribe","subscribe","Promise","resolve","reject","Tracker","nonreactive","onStop","onReady","onReconnect","fn","getLastMessageFromEvent","removeListener","listenerCount","callback","pop","Function","once"],"mappings":"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","sourcesContent":["/* globals DDPCommon, EV */\n/* eslint-disable new-cap */\nconst NonEmptyString = Match.Where(function (x) {\n\tcheck(x, String);\n\treturn x.length > 0;\n});\n\nclass StreamerCentral extends EV {\n\tconstructor() {\n\t\tsuper();\n\n\t\tthis.instances = {};\n\t\tthis.ddpConnections = {};\t\t// since each Streamer instance can provide its own ddp connection, store them by streamer name\n\t}\n\n\tsetupDdpConnection(name, ddpConnection) {\n\t\t// make sure we only setup event listeners for each ddp connection once\n\t\tif (ddpConnection.hasMeteorStreamerEventListeners) {\n\t\t\treturn;\n\t\t}\n\t\tddpConnection._stream.on('message', (raw_msg) => {\n\t\t\tconst msg = DDPCommon.parseDDP(raw_msg);\n\t\t\tif (msg && msg.msg === 'changed' && msg.collection && msg.fields && msg.fields.eventName && msg.fields.args) {\n\t\t\t\tmsg.fields.args.unshift(msg.fields.eventName);\n\t\t\t\tmsg.fields.args.unshift(msg.collection);\n\t\t\t\tthis.emit.apply(this, msg.fields.args);\n\t\t\t}\n\t\t});\n\t\t// store ddp connection\n\t\tthis.storeDdpConnection(name, ddpConnection);\n\n\t}\n\n\tstoreDdpConnection(name, ddpConnection) {\n\t\t// mark the connection as setup for Streamer, and store it\n\t\tddpConnection.hasMeteorStreamerEventListeners = true;\n\t\tthis.ddpConnections[name] = ddpConnection;\n\t}\n}\n\nMeteor.StreamerCentral = new StreamerCentral;\n\nMeteor.Streamer = class Streamer extends EV {\n\tconstructor(name, { useCollection = false, ddpConnection = Meteor.connection } = {}) {\n\t\tif (Meteor.StreamerCentral.instances[name]) {\n\t\t\tconsole.warn('Streamer instance already exists:', name);\n\t\t\treturn Meteor.StreamerCentral.instances[name];\n\t\t}\n\t\tMeteor.StreamerCentral.setupDdpConnection(name, ddpConnection);\n\n\t\tsuper();\n\n\t\tthis.ddpConnection = ddpConnection || Meteor.connection;\n\n\t\tMeteor.StreamerCentral.instances[name] = this;\n\n\t\tthis.name = name;\n\t\tthis.useCollection = useCollection;\n\t\tthis.subscriptions = {};\n\n\t\tMeteor.StreamerCentral.on(this.subscriptionName, (eventName, ...args) => {\n\t\t\tif (this.subscriptions[eventName]) {\n\t\t\t\tthis.subscriptions[eventName].lastMessage = args;\n\t\t\t\tEV.prototype.emit.call(this, eventName, ...args);\n\t\t\t}\n\t\t});\n\n\t\tthis.ddpConnection._stream.on('reset', () => {\n\t\t\tEV.prototype.emit.call(this, '__reconnect__');\n\t\t});\n\t}\n\n\tget name() {\n\t\treturn this._name;\n\t}\n\n\tset name(name) {\n\t\tcheck(name, String);\n\t\tthis._name = name;\n\t}\n\n\tget subscriptionName() {\n\t\treturn `stream-${this.name}`;\n\t}\n\n\tget useCollection() {\n\t\treturn this._useCollection;\n\t}\n\n\tset useCollection(useCollection) {\n\t\tcheck(useCollection, Boolean);\n\t\tthis._useCollection = useCollection;\n\t}\n\n\tstop(eventName) {\n\t\treturn this.subscriptions[eventName] && this.subscriptions[eventName].subscription && this.subscriptions[eventName].subscription.stop();\n\t}\n\n\tstopAll() {\n\t\tObject.keys(this.subscriptions).forEach(eventName => this.removeAllListeners(eventName));\n\t}\n\n\tunsubscribe(eventName) {\n\t\tdelete this.subscriptions[eventName];\n\t\tEV.prototype.removeAllListeners.call(this, eventName);\n\t}\n\n\tsubscribe(eventName, args) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tif (this.subscriptions[eventName]) {\n\t\t\t\treturn resolve();\n\t\t\t}\n\t\t\tconst subscription = Tracker.nonreactive(() => this.ddpConnection.subscribe(\n\t\t\t\tthis.subscriptionName,\n\t\t\t\teventName,\n\t\t\t\t{ useCollection: this.useCollection, args },\n\t\t\t\t{\n\t\t\t\t\tonStop: () => reject(this.unsubscribe(eventName)),\n\t\t\t\t\tonReady: resolve\n\t\t\t\t}\n\t\t\t));\n\t\t\tthis.subscriptions[eventName] = { subscription };\n\t\t})\n\t}\n\n\tonReconnect(fn) {\n\t\tif (typeof fn === 'function') {\n\t\t\tEV.prototype.on.call(this, '__reconnect__', fn);\n\t\t}\n\t}\n\n\tgetLastMessageFromEvent(eventName) {\n\t\tconst subscription = this.subscriptions[eventName];\n\t\tif (subscription && subscription.lastMessage) {\n\t\t\treturn subscription.lastMessage;\n\t\t}\n\t}\n\n\tremoveAllListeners(eventName) {\n\t\tEV.prototype.removeAllListeners.call(this, eventName);\n\t\treturn this.stop(eventName);\n\t}\n\n\tremoveListener(eventName, ...args) {\n\t\tif (this.listenerCount(eventName) === 1) {\n\t\t\tthis.stop(eventName);\n\t\t}\n\t\tEV.prototype.removeListener.call(this, eventName, ...args);\n\t}\n\n\ton(eventName, ...args) {\n\t\tcheck(eventName, NonEmptyString);\n\n\t\tconst callback = args.pop();\n\t\tcheck(callback, Function);\n\n\t\tEV.prototype.on.call(this, eventName, callback);\n\n\t\treturn this.subscribe(eventName, args);\n\t}\n\n\tonce(eventName, ...args) {\n\t\tcheck(eventName, NonEmptyString);\n\n\t\tconst callback = args.pop();\n\t\tcheck(callback, Function);\n\n\t\tEV.prototype.once.call(this, eventName, (...args) => {\n\t\t\tcallback(...args);\n\t\t\tif (this.listenerCount(eventName) === 0) {\n\t\t\t\treturn this.stop(eventName);\n\t\t\t}\n\t\t});\n\n\t\treturn this.subscribe(eventName, args);\n\t}\n\n\temit(...args) {\n\t\tthis.ddpConnection.call(this.subscriptionName, ...args);\n\t}\n};\n"]},"sourceType":"module","hash":"5f4e4e88b207275e7f49ec7ef3f470635e724ad1"}
