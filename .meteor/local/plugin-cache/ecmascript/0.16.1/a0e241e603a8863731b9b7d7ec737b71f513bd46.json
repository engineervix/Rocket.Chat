{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/livestream/client/views/liveStreamTab.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"app/livestream/client/views/liveStreamTab.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/livestream/client/views/liveStreamTab.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/livestream/client/views/liveStreamTab.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/livestream/client/views/liveStreamTab.js"}},"code":"let _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default(v) {\n    _objectSpread = v;\n  }\n\n}, 0);\nmodule.export({\n  call: () => call,\n  close: () => close\n});\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet ReactiveVar;\nmodule.link(\"meteor/reactive-var\", {\n  ReactiveVar(v) {\n    ReactiveVar = v;\n  }\n\n}, 1);\nlet Blaze;\nmodule.link(\"meteor/blaze\", {\n  Blaze(v) {\n    Blaze = v;\n  }\n\n}, 2);\nlet Session;\nmodule.link(\"meteor/session\", {\n  Session(v) {\n    Session = v;\n  }\n\n}, 3);\nlet Template;\nmodule.link(\"meteor/templating\", {\n  Template(v) {\n    Template = v;\n  }\n\n}, 4);\nlet TAPi18n;\nmodule.link(\"meteor/rocketchat:tap-i18n\", {\n  TAPi18n(v) {\n    TAPi18n = v;\n  }\n\n}, 5);\nlet auth;\nmodule.link(\"../oauth.js\", {\n  auth(v) {\n    auth = v;\n  }\n\n}, 6);\nlet RocketChatAnnouncement;\nmodule.link(\"../../../lib\", {\n  RocketChatAnnouncement(v) {\n    RocketChatAnnouncement = v;\n  }\n\n}, 7);\nlet popout;\nmodule.link(\"../../../ui-utils\", {\n  popout(v) {\n    popout = v;\n  }\n\n}, 8);\nlet t;\nmodule.link(\"../../../utils\", {\n  t(v) {\n    t = v;\n  }\n\n}, 9);\nlet settings;\nmodule.link(\"../../../settings\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 10);\nlet callbacks;\nmodule.link(\"../../../../lib/callbacks\", {\n  callbacks(v) {\n    callbacks = v;\n  }\n\n}, 11);\nlet hasAllPermission;\nmodule.link(\"../../../authorization\", {\n  hasAllPermission(v) {\n    hasAllPermission = v;\n  }\n\n}, 12);\nlet Users, Rooms;\nmodule.link(\"../../../models\", {\n  Users(v) {\n    Users = v;\n  },\n\n  Rooms(v) {\n    Rooms = v;\n  }\n\n}, 13);\nlet handleError;\nmodule.link(\"../../../../client/lib/utils/handleError\", {\n  handleError(v) {\n    handleError = v;\n  }\n\n}, 14);\nlet dispatchToastMessage;\nmodule.link(\"../../../../client/lib/toast\", {\n  dispatchToastMessage(v) {\n    dispatchToastMessage = v;\n  }\n\n}, 15);\n\nconst call = function () {\n  for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n    args[_key] = arguments[_key];\n  }\n\n  return new Promise(function (resolve, reject) {\n    Meteor.call(...args, function (err, result) {\n      if (err) {\n        handleError(err);\n        reject(err);\n      }\n\n      resolve(result);\n    });\n  });\n};\n\nconst close = popup => new Promise(function (resolve) {\n  const checkInterval = setInterval(() => {\n    if (popup.closed) {\n      clearInterval(checkInterval);\n      resolve();\n    }\n  }, 300);\n});\n\nfunction optionsFromUrl(url) {\n  const options = {};\n  const parsedUrl = url.match(/(http:|https:|)\\/\\/(www.)?(youtu(be\\.com|\\.be|be\\.googleapis\\.com))\\/(video\\/|embed\\/|watch\\?v=|v\\/|embed\\?clip=)?([A-Za-z0-9._%-]*)(\\&\\S+)?/);\n  options.url = url;\n\n  if (parsedUrl != null) {\n    options.id = parsedUrl[6];\n\n    if (parsedUrl[3].includes('youtu')) {\n      options.url = \"https://www.youtube.com/embed/\".concat(parsedUrl[6]);\n      options.thumbnail = \"https://img.youtube.com/vi/\".concat(parsedUrl[6], \"/0.jpg\");\n    } // @TODO add support for other urls\n\n  }\n\n  return options;\n}\n\nTemplate.liveStreamTab.helpers({\n  broadcastEnabled() {\n    return !!settings.get('Broadcasting_enabled');\n  },\n\n  streamingSource() {\n    return Template.instance().streamingOptions.get() ? Template.instance().streamingOptions.get().url : '';\n  },\n\n  streamingUnavailableMessage() {\n    return Template.instance().streamingOptions.get() && Template.instance().streamingOptions.get().message && Template.instance().streamingOptions.get().message !== '' ? Template.instance().streamingOptions.get().message : t('Livestream_not_found');\n  },\n\n  thumbnailUrl() {\n    return Template.instance().streamingOptions.get() ? Template.instance().streamingOptions.get().thumbnail : '';\n  },\n\n  hasThumbnail() {\n    return !!Template.instance().streamingOptions.get() && !!Template.instance().streamingOptions.get().thumbnail && Template.instance().streamingOptions.get().thumbnail !== '';\n  },\n\n  hasSource() {\n    return !!Template.instance().streamingOptions.get() && !!Template.instance().streamingOptions.get().url && Template.instance().streamingOptions.get().url !== '';\n  },\n\n  canEdit() {\n    return hasAllPermission('edit-room', this.rid);\n  },\n\n  editing() {\n    return Template.instance().editing.get() || Template.instance().streamingOptions.get() == null || Template.instance().streamingOptions.get() != null && (Template.instance().streamingOptions.get().url == null || Template.instance().streamingOptions.get().url === '');\n  },\n\n  canDock() {\n    const livestreamTabSource = Template.instance().streamingOptions.get().url;\n    let popoutSource = null;\n\n    try {\n      if (popout.context) {\n        popoutSource = Blaze.getData(popout.context).data && Blaze.getData(popout.context).data.streamingSource;\n      }\n\n      if (popoutSource != null && livestreamTabSource === popoutSource) {\n        return true;\n      }\n    } catch (e) {\n      return false;\n    }\n\n    return false;\n  },\n\n  isPopoutOpen() {\n    return Template.instance().popoutOpen.get();\n  },\n\n  isAudioOnly() {\n    return Template.instance().streamingOptions.get() ? Template.instance().streamingOptions.get().isAudioOnly : false;\n  }\n\n});\nTemplate.liveStreamTab.onCreated(function () {\n  this.editing = new ReactiveVar(false);\n  this.streamingOptions = new ReactiveVar();\n  this.popoutOpen = new ReactiveVar(popout.context != null);\n  this.autorun(() => {\n    const room = Rooms.findOne(this.data.rid, {\n      fields: {\n        streamingOptions: 1\n      }\n    });\n    this.streamingOptions.set(room.streamingOptions);\n  });\n});\nTemplate.liveStreamTab.onDestroyed(function () {\n  if (popout.docked) {\n    popout.close();\n  }\n});\nTemplate.liveStreamTab.events({\n  'click .js-cancel'(e, i) {\n    e.preventDefault();\n    i.editing.set(false);\n  },\n\n  'click .js-clear'(e, i) {\n    e.preventDefault();\n    const clearedObject = {};\n    Meteor.call('saveRoomSettings', this.rid, 'streamingOptions', clearedObject, function (err) {\n      if (err) {\n        return handleError(err);\n      }\n\n      i.editing.set(false);\n      i.streamingOptions.set(clearedObject);\n      const roomAnnouncement = new RocketChatAnnouncement().getByRoom(i.data.rid);\n\n      if (roomAnnouncement.getMessage() !== '') {\n        roomAnnouncement.clear();\n      }\n\n      return dispatchToastMessage({\n        type: 'success',\n        message: TAPi18n.__('Livestream_source_changed_succesfully')\n      });\n    });\n  },\n\n  'click .js-save'(e, i) {\n    e.preventDefault();\n\n    const streamingOptions = _objectSpread(_objectSpread({}, optionsFromUrl(i.find('[name=streaming-source]').value)), {}, {\n      isAudioOnly: i.find('[name=streaming-audio-only]').checked,\n      message: i.find('[name=streaming-message]').value,\n      type: 'livestream'\n    });\n\n    Meteor.call('saveRoomSettings', this.rid, 'streamingOptions', streamingOptions, function (err) {\n      if (err) {\n        return handleError(err);\n      }\n\n      i.editing.set(false);\n      i.streamingOptions.set(streamingOptions);\n\n      if (streamingOptions.url !== '') {\n        new RocketChatAnnouncement({\n          room: i.data.rid,\n          message: 'Broadcast is now live. Click here to watch!',\n          callback: 'openBroadcast'\n        }).save();\n      } else {\n        const roomAnnouncement = new RocketChatAnnouncement().getByRoom(i.data.rid);\n\n        if (roomAnnouncement.getMessage() !== '') {\n          roomAnnouncement.clear();\n        }\n      }\n\n      return dispatchToastMessage({\n        type: 'success',\n        message: TAPi18n.__('Livestream_source_changed_succesfully')\n      });\n    });\n  },\n\n  'click .streaming-source-settings'(e, i) {\n    e.preventDefault();\n    i.editing.set(true);\n  },\n\n  'click .js-dock'(e) {\n    e.stopPropagation();\n    popout.docked = true;\n  },\n\n  'click .js-close'(e, i) {\n    e.stopPropagation();\n    let popoutSource = '';\n\n    if (popout.context) {\n      popoutSource = Blaze.getData(popout.context).data && Blaze.getData(popout.context).data.streamingSource;\n    }\n\n    popout.close();\n\n    if (popoutSource !== Template.instance().streamingOptions.get().url) {\n      popout.open({\n        content: 'liveStreamView',\n        data: {\n          streamingSource: i.streamingOptions.get().url,\n          isAudioOnly: i.streamingOptions.get().isAudioOnly,\n          showVideoControls: true,\n          streamingOptions: i.streamingOptions.get()\n        },\n        onCloseCallback: () => i.popoutOpen.set(false)\n      });\n    }\n  },\n\n  'submit .liveStreamTab__form'(e, i) {\n    e.preventDefault();\n    e.stopPropagation();\n\n    const streamingOptions = _objectSpread(_objectSpread({}, optionsFromUrl(i.find('[name=streaming-source]').value)), {}, {\n      isAudioOnly: i.find('[name=streaming-audio-only]').checked,\n      message: i.find('[name=streaming-message]').value,\n      type: 'livestream'\n    });\n\n    Meteor.call('saveRoomSettings', this.rid, 'streamingOptions', streamingOptions, function (err) {\n      if (err) {\n        return handleError(err);\n      }\n\n      i.editing.set(false);\n      i.streamingOptions.set(streamingOptions);\n\n      if (streamingOptions.url !== '') {\n        new RocketChatAnnouncement({\n          room: i.data.rid,\n          message: 'Broadcast is now live. Click here to watch!',\n          callback: 'openBroadcast'\n        }).save();\n      } else {\n        const roomAnnouncement = new RocketChatAnnouncement().getByRoom(i.data.rid);\n\n        if (roomAnnouncement.getMessage() !== '') {\n          roomAnnouncement.clear();\n        }\n      }\n\n      return dispatchToastMessage({\n        type: 'success',\n        message: TAPi18n.__('Livestream_source_changed_succesfully')\n      });\n    });\n  },\n\n  'click .js-popout'(e, i) {\n    e.preventDefault();\n    popout.open({\n      content: 'liveStreamView',\n      data: {\n        streamingSource: i.streamingOptions.get().url,\n        isAudioOnly: i.streamingOptions.get().isAudioOnly,\n        showVideoControls: true,\n        streamingOptions: i.streamingOptions.get()\n      },\n      onCloseCallback: () => i.popoutOpen.set(false)\n    });\n    i.popoutOpen.set(true);\n  },\n\n  async 'click .js-broadcast'(e, i) {\n    e.preventDefault();\n    e.currentTarget.classList.add('loading');\n\n    try {\n      const user = Users.findOne({\n        _id: Meteor.userId()\n      }, {\n        fields: {\n          'settings.livestream': 1\n        }\n      });\n\n      if (!user.settings || !user.settings.livestream) {\n        await auth();\n      }\n\n      const result = await call('livestreamGet', {\n        rid: i.data.rid\n      });\n      popout.open({\n        content: 'broadcastView',\n        data: _objectSpread(_objectSpread({}, result), {}, {\n          showVideoControls: false,\n          showStreamControls: true\n        }),\n        onCloseCallback: () => i.popoutOpen.set(false)\n      });\n    } catch (e) {\n      console.log(e);\n    } finally {\n      e.currentTarget.classList.remove('loading');\n    }\n  }\n\n});\ncallbacks.add('openBroadcast', rid => {\n  const roomData = Session.get(\"roomData\".concat(rid));\n\n  if (!roomData) {\n    return;\n  }\n\n  popout.open({\n    content: 'liveStreamView',\n    data: {\n      streamingSource: roomData.streamingOptions.url,\n      isAudioOnly: roomData.streamingOptions.isAudioOnly,\n      showVideoControls: true,\n      streamingOptions: roomData.streamingOptions\n    }\n  });\n});","map":{"version":3,"sources":["app/livestream/client/views/liveStreamTab.js"],"names":["_objectSpread","module","link","default","v","export","call","close","Meteor","ReactiveVar","Blaze","Session","Template","TAPi18n","auth","RocketChatAnnouncement","popout","t","settings","callbacks","hasAllPermission","Users","Rooms","handleError","dispatchToastMessage","args","Promise","resolve","reject","err","result","popup","checkInterval","setInterval","closed","clearInterval","optionsFromUrl","url","options","parsedUrl","match","id","includes","thumbnail","liveStreamTab","helpers","broadcastEnabled","get","streamingSource","instance","streamingOptions","streamingUnavailableMessage","message","thumbnailUrl","hasThumbnail","hasSource","canEdit","rid","editing","canDock","livestreamTabSource","popoutSource","context","getData","data","e","isPopoutOpen","popoutOpen","isAudioOnly","onCreated","autorun","room","findOne","fields","set","onDestroyed","docked","events","i","preventDefault","clearedObject","roomAnnouncement","getByRoom","getMessage","clear","type","__","find","value","checked","callback","save","stopPropagation","open","content","showVideoControls","onCloseCallback","currentTarget","classList","add","user","_id","userId","livestream","showStreamControls","console","log","remove","roomData"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { ReactiveVar } from 'meteor/reactive-var';\nimport { Blaze } from 'meteor/blaze';\nimport { Session } from 'meteor/session';\nimport { Template } from 'meteor/templating';\nimport { TAPi18n } from 'meteor/rocketchat:tap-i18n';\n\nimport { auth } from '../oauth.js';\nimport { RocketChatAnnouncement } from '../../../lib';\nimport { popout } from '../../../ui-utils';\nimport { t } from '../../../utils';\nimport { settings } from '../../../settings';\nimport { callbacks } from '../../../../lib/callbacks';\nimport { hasAllPermission } from '../../../authorization';\nimport { Users, Rooms } from '../../../models';\nimport { handleError } from '../../../../client/lib/utils/handleError';\nimport { dispatchToastMessage } from '../../../../client/lib/toast';\n\nexport const call = (...args) =>\n\tnew Promise(function (resolve, reject) {\n\t\tMeteor.call(...args, function (err, result) {\n\t\t\tif (err) {\n\t\t\t\thandleError(err);\n\t\t\t\treject(err);\n\t\t\t}\n\t\t\tresolve(result);\n\t\t});\n\t});\n\nexport const close = (popup) =>\n\tnew Promise(function (resolve) {\n\t\tconst checkInterval = setInterval(() => {\n\t\t\tif (popup.closed) {\n\t\t\t\tclearInterval(checkInterval);\n\t\t\t\tresolve();\n\t\t\t}\n\t\t}, 300);\n\t});\n\nfunction optionsFromUrl(url) {\n\tconst options = {};\n\tconst parsedUrl = url.match(\n\t\t/(http:|https:|)\\/\\/(www.)?(youtu(be\\.com|\\.be|be\\.googleapis\\.com))\\/(video\\/|embed\\/|watch\\?v=|v\\/|embed\\?clip=)?([A-Za-z0-9._%-]*)(\\&\\S+)?/,\n\t);\n\toptions.url = url;\n\tif (parsedUrl != null) {\n\t\toptions.id = parsedUrl[6];\n\t\tif (parsedUrl[3].includes('youtu')) {\n\t\t\toptions.url = `https://www.youtube.com/embed/${parsedUrl[6]}`;\n\t\t\toptions.thumbnail = `https://img.youtube.com/vi/${parsedUrl[6]}/0.jpg`;\n\t\t}\n\t\t// @TODO add support for other urls\n\t}\n\treturn options;\n}\n\nTemplate.liveStreamTab.helpers({\n\tbroadcastEnabled() {\n\t\treturn !!settings.get('Broadcasting_enabled');\n\t},\n\tstreamingSource() {\n\t\treturn Template.instance().streamingOptions.get() ? Template.instance().streamingOptions.get().url : '';\n\t},\n\tstreamingUnavailableMessage() {\n\t\treturn Template.instance().streamingOptions.get() &&\n\t\t\tTemplate.instance().streamingOptions.get().message &&\n\t\t\tTemplate.instance().streamingOptions.get().message !== ''\n\t\t\t? Template.instance().streamingOptions.get().message\n\t\t\t: t('Livestream_not_found');\n\t},\n\tthumbnailUrl() {\n\t\treturn Template.instance().streamingOptions.get() ? Template.instance().streamingOptions.get().thumbnail : '';\n\t},\n\thasThumbnail() {\n\t\treturn (\n\t\t\t!!Template.instance().streamingOptions.get() &&\n\t\t\t!!Template.instance().streamingOptions.get().thumbnail &&\n\t\t\tTemplate.instance().streamingOptions.get().thumbnail !== ''\n\t\t);\n\t},\n\thasSource() {\n\t\treturn (\n\t\t\t!!Template.instance().streamingOptions.get() &&\n\t\t\t!!Template.instance().streamingOptions.get().url &&\n\t\t\tTemplate.instance().streamingOptions.get().url !== ''\n\t\t);\n\t},\n\tcanEdit() {\n\t\treturn hasAllPermission('edit-room', this.rid);\n\t},\n\tediting() {\n\t\treturn (\n\t\t\tTemplate.instance().editing.get() ||\n\t\t\tTemplate.instance().streamingOptions.get() == null ||\n\t\t\t(Template.instance().streamingOptions.get() != null &&\n\t\t\t\t(Template.instance().streamingOptions.get().url == null || Template.instance().streamingOptions.get().url === ''))\n\t\t);\n\t},\n\tcanDock() {\n\t\tconst livestreamTabSource = Template.instance().streamingOptions.get().url;\n\t\tlet popoutSource = null;\n\t\ttry {\n\t\t\tif (popout.context) {\n\t\t\t\tpopoutSource = Blaze.getData(popout.context).data && Blaze.getData(popout.context).data.streamingSource;\n\t\t\t}\n\t\t\tif (popoutSource != null && livestreamTabSource === popoutSource) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t} catch (e) {\n\t\t\treturn false;\n\t\t}\n\t\treturn false;\n\t},\n\tisPopoutOpen() {\n\t\treturn Template.instance().popoutOpen.get();\n\t},\n\tisAudioOnly() {\n\t\treturn Template.instance().streamingOptions.get() ? Template.instance().streamingOptions.get().isAudioOnly : false;\n\t},\n});\n\nTemplate.liveStreamTab.onCreated(function () {\n\tthis.editing = new ReactiveVar(false);\n\tthis.streamingOptions = new ReactiveVar();\n\tthis.popoutOpen = new ReactiveVar(popout.context != null);\n\n\tthis.autorun(() => {\n\t\tconst room = Rooms.findOne(this.data.rid, { fields: { streamingOptions: 1 } });\n\t\tthis.streamingOptions.set(room.streamingOptions);\n\t});\n});\n\nTemplate.liveStreamTab.onDestroyed(function () {\n\tif (popout.docked) {\n\t\tpopout.close();\n\t}\n});\n\nTemplate.liveStreamTab.events({\n\t'click .js-cancel'(e, i) {\n\t\te.preventDefault();\n\t\ti.editing.set(false);\n\t},\n\t'click .js-clear'(e, i) {\n\t\te.preventDefault();\n\n\t\tconst clearedObject = {};\n\n\t\tMeteor.call('saveRoomSettings', this.rid, 'streamingOptions', clearedObject, function (err) {\n\t\t\tif (err) {\n\t\t\t\treturn handleError(err);\n\t\t\t}\n\t\t\ti.editing.set(false);\n\t\t\ti.streamingOptions.set(clearedObject);\n\t\t\tconst roomAnnouncement = new RocketChatAnnouncement().getByRoom(i.data.rid);\n\t\t\tif (roomAnnouncement.getMessage() !== '') {\n\t\t\t\troomAnnouncement.clear();\n\t\t\t}\n\t\t\treturn dispatchToastMessage({\n\t\t\t\ttype: 'success',\n\t\t\t\tmessage: TAPi18n.__('Livestream_source_changed_succesfully'),\n\t\t\t});\n\t\t});\n\t},\n\t'click .js-save'(e, i) {\n\t\te.preventDefault();\n\n\t\tconst streamingOptions = {\n\t\t\t...optionsFromUrl(i.find('[name=streaming-source]').value),\n\t\t\tisAudioOnly: i.find('[name=streaming-audio-only]').checked,\n\t\t\tmessage: i.find('[name=streaming-message]').value,\n\t\t\ttype: 'livestream',\n\t\t};\n\n\t\tMeteor.call('saveRoomSettings', this.rid, 'streamingOptions', streamingOptions, function (err) {\n\t\t\tif (err) {\n\t\t\t\treturn handleError(err);\n\t\t\t}\n\t\t\ti.editing.set(false);\n\t\t\ti.streamingOptions.set(streamingOptions);\n\t\t\tif (streamingOptions.url !== '') {\n\t\t\t\tnew RocketChatAnnouncement({\n\t\t\t\t\troom: i.data.rid,\n\t\t\t\t\tmessage: 'Broadcast is now live. Click here to watch!',\n\t\t\t\t\tcallback: 'openBroadcast',\n\t\t\t\t}).save();\n\t\t\t} else {\n\t\t\t\tconst roomAnnouncement = new RocketChatAnnouncement().getByRoom(i.data.rid);\n\t\t\t\tif (roomAnnouncement.getMessage() !== '') {\n\t\t\t\t\troomAnnouncement.clear();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn dispatchToastMessage({\n\t\t\t\ttype: 'success',\n\t\t\t\tmessage: TAPi18n.__('Livestream_source_changed_succesfully'),\n\t\t\t});\n\t\t});\n\t},\n\t'click .streaming-source-settings'(e, i) {\n\t\te.preventDefault();\n\t\ti.editing.set(true);\n\t},\n\t'click .js-dock'(e) {\n\t\te.stopPropagation();\n\t\tpopout.docked = true;\n\t},\n\t'click .js-close'(e, i) {\n\t\te.stopPropagation();\n\t\tlet popoutSource = '';\n\t\tif (popout.context) {\n\t\t\tpopoutSource = Blaze.getData(popout.context).data && Blaze.getData(popout.context).data.streamingSource;\n\t\t}\n\t\tpopout.close();\n\t\tif (popoutSource !== Template.instance().streamingOptions.get().url) {\n\t\t\tpopout.open({\n\t\t\t\tcontent: 'liveStreamView',\n\t\t\t\tdata: {\n\t\t\t\t\tstreamingSource: i.streamingOptions.get().url,\n\t\t\t\t\tisAudioOnly: i.streamingOptions.get().isAudioOnly,\n\t\t\t\t\tshowVideoControls: true,\n\t\t\t\t\tstreamingOptions: i.streamingOptions.get(),\n\t\t\t\t},\n\t\t\t\tonCloseCallback: () => i.popoutOpen.set(false),\n\t\t\t});\n\t\t}\n\t},\n\t'submit .liveStreamTab__form'(e, i) {\n\t\te.preventDefault();\n\t\te.stopPropagation();\n\n\t\tconst streamingOptions = {\n\t\t\t...optionsFromUrl(i.find('[name=streaming-source]').value),\n\t\t\tisAudioOnly: i.find('[name=streaming-audio-only]').checked,\n\t\t\tmessage: i.find('[name=streaming-message]').value,\n\t\t\ttype: 'livestream',\n\t\t};\n\n\t\tMeteor.call('saveRoomSettings', this.rid, 'streamingOptions', streamingOptions, function (err) {\n\t\t\tif (err) {\n\t\t\t\treturn handleError(err);\n\t\t\t}\n\t\t\ti.editing.set(false);\n\t\t\ti.streamingOptions.set(streamingOptions);\n\t\t\tif (streamingOptions.url !== '') {\n\t\t\t\tnew RocketChatAnnouncement({\n\t\t\t\t\troom: i.data.rid,\n\t\t\t\t\tmessage: 'Broadcast is now live. Click here to watch!',\n\t\t\t\t\tcallback: 'openBroadcast',\n\t\t\t\t}).save();\n\t\t\t} else {\n\t\t\t\tconst roomAnnouncement = new RocketChatAnnouncement().getByRoom(i.data.rid);\n\t\t\t\tif (roomAnnouncement.getMessage() !== '') {\n\t\t\t\t\troomAnnouncement.clear();\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn dispatchToastMessage({\n\t\t\t\ttype: 'success',\n\t\t\t\tmessage: TAPi18n.__('Livestream_source_changed_succesfully'),\n\t\t\t});\n\t\t});\n\t},\n\t'click .js-popout'(e, i) {\n\t\te.preventDefault();\n\t\tpopout.open({\n\t\t\tcontent: 'liveStreamView',\n\t\t\tdata: {\n\t\t\t\tstreamingSource: i.streamingOptions.get().url,\n\t\t\t\tisAudioOnly: i.streamingOptions.get().isAudioOnly,\n\t\t\t\tshowVideoControls: true,\n\t\t\t\tstreamingOptions: i.streamingOptions.get(),\n\t\t\t},\n\t\t\tonCloseCallback: () => i.popoutOpen.set(false),\n\t\t});\n\t\ti.popoutOpen.set(true);\n\t},\n\tasync 'click .js-broadcast'(e, i) {\n\t\te.preventDefault();\n\t\te.currentTarget.classList.add('loading');\n\t\ttry {\n\t\t\tconst user = Users.findOne({ _id: Meteor.userId() }, { fields: { 'settings.livestream': 1 } });\n\t\t\tif (!user.settings || !user.settings.livestream) {\n\t\t\t\tawait auth();\n\t\t\t}\n\t\t\tconst result = await call('livestreamGet', { rid: i.data.rid });\n\t\t\tpopout.open({\n\t\t\t\tcontent: 'broadcastView',\n\t\t\t\tdata: {\n\t\t\t\t\t...result,\n\t\t\t\t\tshowVideoControls: false,\n\t\t\t\t\tshowStreamControls: true,\n\t\t\t\t},\n\t\t\t\tonCloseCallback: () => i.popoutOpen.set(false),\n\t\t\t});\n\t\t} catch (e) {\n\t\t\tconsole.log(e);\n\t\t} finally {\n\t\t\te.currentTarget.classList.remove('loading');\n\t\t}\n\t},\n});\n\ncallbacks.add('openBroadcast', (rid) => {\n\tconst roomData = Session.get(`roomData${rid}`);\n\tif (!roomData) {\n\t\treturn;\n\t}\n\tpopout.open({\n\t\tcontent: 'liveStreamView',\n\t\tdata: {\n\t\t\tstreamingSource: roomData.streamingOptions.url,\n\t\t\tisAudioOnly: roomData.streamingOptions.isAudioOnly,\n\t\t\tshowVideoControls: true,\n\t\t\tstreamingOptions: roomData.streamingOptions,\n\t\t},\n\t});\n});\n"]},"sourceType":"module","hash":"a0e241e603a8863731b9b7d7ec737b71f513bd46"}
