{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/file-upload/lib/FileUploadBase.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"app/file-upload/lib/FileUploadBase.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/file-upload/lib/FileUploadBase.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/file-upload/lib/FileUploadBase.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/file-upload/lib/FileUploadBase.js"}},"code":"module.export({\n  FileUploadBase: () => FileUploadBase\n});\nlet path;\nmodule.link(\"path\", {\n  default(v) {\n    path = v;\n  }\n\n}, 0);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 1);\nlet Random;\nmodule.link(\"meteor/random\", {\n  Random(v) {\n    Random = v;\n  }\n\n}, 2);\nlet UploadFS;\nmodule.link(\"meteor/jalik:ufs\", {\n  UploadFS(v) {\n    UploadFS = v;\n  }\n\n}, 3);\n\nlet _;\n\nmodule.link(\"underscore\", {\n  default(v) {\n    _ = v;\n  }\n\n}, 4);\nlet canAccessRoom, hasPermission;\nmodule.link(\"../../authorization\", {\n  canAccessRoom(v) {\n    canAccessRoom = v;\n  },\n\n  hasPermission(v) {\n    hasPermission = v;\n  }\n\n}, 5);\nlet settings;\nmodule.link(\"../../settings\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 6);\n\n// set ufs temp dir to $TMPDIR/ufs instead of /tmp/ufs if the variable is set\nif ('TMPDIR' in process.env) {\n  UploadFS.config.tmpDir = path.join(process.env.TMPDIR, 'ufs');\n}\n\nUploadFS.config.defaultStorePermissions = new UploadFS.StorePermissions({\n  insert(userId, doc) {\n    if (userId) {\n      return true;\n    } // allow inserts from slackbridge (message_id = slack-timestamp-milli)\n\n\n    if (doc && doc.message_id && doc.message_id.indexOf('slack-') === 0) {\n      return true;\n    } // allow inserts to the UserDataFiles store\n\n\n    if (doc && doc.store && doc.store.split(':').pop() === 'UserDataFiles') {\n      return true;\n    }\n\n    if (canAccessRoom(null, null, doc)) {\n      return true;\n    }\n\n    return false;\n  },\n\n  update(userId, doc) {\n    return hasPermission(Meteor.userId(), 'delete-message', doc.rid) || settings.get('Message_AllowDeleting') && userId === doc.userId;\n  },\n\n  remove(userId, doc) {\n    return hasPermission(Meteor.userId(), 'delete-message', doc.rid) || settings.get('Message_AllowDeleting') && userId === doc.userId;\n  }\n\n});\n\nclass FileUploadBase {\n  constructor(store, meta, file) {\n    this.id = Random.id();\n    this.meta = meta;\n    this.file = file;\n    this.store = store;\n  }\n\n  getProgress() {}\n\n  getFileName() {\n    return this.meta.name;\n  }\n\n  start(callback) {\n    this.handler = new UploadFS.Uploader({\n      store: this.store,\n      data: this.file,\n      file: this.meta,\n      onError: err => callback(err),\n      onComplete: fileData => {\n        const file = _.pick(fileData, '_id', 'type', 'size', 'name', 'identify', 'description');\n\n        file.url = fileData.url.replace(Meteor.absoluteUrl(), '/');\n        return callback(null, file, this.store.options.name);\n      }\n    });\n\n    this.handler.onProgress = (file, progress) => {\n      this.onProgress(progress);\n    };\n\n    return this.handler.start();\n  }\n\n  onProgress() {}\n\n  stop() {\n    return this.handler.stop();\n  }\n\n}","map":{"version":3,"sources":["app/file-upload/lib/FileUploadBase.js"],"names":["module","export","FileUploadBase","path","link","default","v","Meteor","Random","UploadFS","_","canAccessRoom","hasPermission","settings","process","env","config","tmpDir","join","TMPDIR","defaultStorePermissions","StorePermissions","insert","userId","doc","message_id","indexOf","store","split","pop","update","rid","get","remove","constructor","meta","file","id","getProgress","getFileName","name","start","callback","handler","Uploader","data","onError","err","onComplete","fileData","pick","url","replace","absoluteUrl","options","onProgress","progress","stop"],"mappings":"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","sourcesContent":["import path from 'path';\n\nimport { Meteor } from 'meteor/meteor';\nimport { Random } from 'meteor/random';\nimport { UploadFS } from 'meteor/jalik:ufs';\nimport _ from 'underscore';\n\nimport { canAccessRoom, hasPermission } from '../../authorization';\nimport { settings } from '../../settings';\n\n// set ufs temp dir to $TMPDIR/ufs instead of /tmp/ufs if the variable is set\nif ('TMPDIR' in process.env) {\n\tUploadFS.config.tmpDir = path.join(process.env.TMPDIR, 'ufs');\n}\n\nUploadFS.config.defaultStorePermissions = new UploadFS.StorePermissions({\n\tinsert(userId, doc) {\n\t\tif (userId) {\n\t\t\treturn true;\n\t\t}\n\n\t\t// allow inserts from slackbridge (message_id = slack-timestamp-milli)\n\t\tif (doc && doc.message_id && doc.message_id.indexOf('slack-') === 0) {\n\t\t\treturn true;\n\t\t}\n\n\t\t// allow inserts to the UserDataFiles store\n\t\tif (doc && doc.store && doc.store.split(':').pop() === 'UserDataFiles') {\n\t\t\treturn true;\n\t\t}\n\n\t\tif (canAccessRoom(null, null, doc)) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t},\n\tupdate(userId, doc) {\n\t\treturn hasPermission(Meteor.userId(), 'delete-message', doc.rid) || (settings.get('Message_AllowDeleting') && userId === doc.userId);\n\t},\n\tremove(userId, doc) {\n\t\treturn hasPermission(Meteor.userId(), 'delete-message', doc.rid) || (settings.get('Message_AllowDeleting') && userId === doc.userId);\n\t},\n});\n\nexport class FileUploadBase {\n\tconstructor(store, meta, file) {\n\t\tthis.id = Random.id();\n\t\tthis.meta = meta;\n\t\tthis.file = file;\n\t\tthis.store = store;\n\t}\n\n\tgetProgress() {}\n\n\tgetFileName() {\n\t\treturn this.meta.name;\n\t}\n\n\tstart(callback) {\n\t\tthis.handler = new UploadFS.Uploader({\n\t\t\tstore: this.store,\n\t\t\tdata: this.file,\n\t\t\tfile: this.meta,\n\t\t\tonError: (err) => callback(err),\n\t\t\tonComplete: (fileData) => {\n\t\t\t\tconst file = _.pick(fileData, '_id', 'type', 'size', 'name', 'identify', 'description');\n\n\t\t\t\tfile.url = fileData.url.replace(Meteor.absoluteUrl(), '/');\n\t\t\t\treturn callback(null, file, this.store.options.name);\n\t\t\t},\n\t\t});\n\n\t\tthis.handler.onProgress = (file, progress) => {\n\t\t\tthis.onProgress(progress);\n\t\t};\n\n\t\treturn this.handler.start();\n\t}\n\n\tonProgress() {}\n\n\tstop() {\n\t\treturn this.handler.stop();\n\t}\n}\n"]},"sourceType":"module","hash":"b6f870b20ea31ede2ec5abddea55e6ab259a4290"}
