{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui-message/client/messageBox/messageBoxAudioMessage.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"app/ui-message/client/messageBox/messageBoxAudioMessage.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui-message/client/messageBox/messageBoxAudioMessage.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui-message/client/messageBox/messageBoxAudioMessage.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/ui-message/client/messageBox/messageBoxAudioMessage.js"}},"code":"let ReactiveVar;\nmodule.link(\"meteor/reactive-var\", {\n  ReactiveVar(v) {\n    ReactiveVar = v;\n  }\n\n}, 0);\nlet Template;\nmodule.link(\"meteor/templating\", {\n  Template(v) {\n    Template = v;\n  }\n\n}, 1);\nlet settings;\nmodule.link(\"../../../settings\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 2);\nlet AudioRecorder, fileUpload, USER_ACTIVITIES, UserAction;\nmodule.link(\"../../../ui\", {\n  AudioRecorder(v) {\n    AudioRecorder = v;\n  },\n\n  fileUpload(v) {\n    fileUpload = v;\n  },\n\n  USER_ACTIVITIES(v) {\n    USER_ACTIVITIES = v;\n  },\n\n  UserAction(v) {\n    UserAction = v;\n  }\n\n}, 3);\nlet t;\nmodule.link(\"../../../utils\", {\n  t(v) {\n    t = v;\n  }\n\n}, 4);\nmodule.link(\"./messageBoxAudioMessage.html\");\n\nconst startRecording = async (rid, tmid) => {\n  try {\n    await AudioRecorder.start();\n    UserAction.performContinuously(rid, USER_ACTIVITIES.USER_RECORDING, {\n      tmid\n    });\n  } catch (error) {\n    throw error;\n  }\n};\n\nconst stopRecording = async (rid, tmid) => {\n  const result = await new Promise(resolve => AudioRecorder.stop(resolve));\n  UserAction.stop(rid, USER_ACTIVITIES.USER_RECORDING, {\n    tmid\n  });\n  return result;\n};\n\nconst recordingInterval = new ReactiveVar(null);\nconst recordingRoomId = new ReactiveVar(null);\n\nconst clearIntervalVariables = () => {\n  if (recordingInterval.get()) {\n    clearInterval(recordingInterval.get());\n    recordingInterval.set(null);\n    recordingRoomId.set(null);\n  }\n};\n\nconst cancelRecording = async (instance, rid, tmid) => {\n  clearIntervalVariables();\n  instance.time.set('00:00');\n  const blob = await stopRecording(rid, tmid);\n  instance.state.set(null);\n  return blob;\n};\n\nTemplate.messageBoxAudioMessage.onCreated(async function () {\n  this.state = new ReactiveVar(null);\n  this.time = new ReactiveVar('00:00');\n  this.isMicrophoneDenied = new ReactiveVar(false);\n\n  if (navigator.permissions) {\n    try {\n      const permissionStatus = await navigator.permissions.query({\n        name: 'microphone'\n      });\n      this.isMicrophoneDenied.set(permissionStatus.state === 'denied');\n\n      permissionStatus.onchange = () => {\n        this.isMicrophoneDenied.set(permissionStatus.state === 'denied');\n      };\n\n      return;\n    } catch (error) {\n      console.warn(error);\n    }\n  }\n\n  if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {\n    this.isMicrophoneDenied.set(true);\n    return;\n  }\n\n  try {\n    if (!(await navigator.mediaDevices.enumerateDevices()).some(_ref => {\n      let {\n        kind\n      } = _ref;\n      return kind === 'audioinput';\n    })) {\n      this.isMicrophoneDenied.set(true);\n      return;\n    }\n  } catch (error) {\n    console.warn(error);\n  }\n});\nTemplate.messageBoxAudioMessage.onDestroyed(async function () {\n  if (this.state.get() === 'recording') {\n    const {\n      rid,\n      tmid\n    } = this.data;\n    await cancelRecording(this, rid, tmid);\n  }\n});\nTemplate.messageBoxAudioMessage.helpers({\n  isAllowed() {\n    return AudioRecorder.isSupported() && !Template.instance().isMicrophoneDenied.get() && settings.get('FileUpload_Enabled') && settings.get('Message_AudioRecorderEnabled') && (!settings.get('FileUpload_MediaTypeBlackList') || !settings.get('FileUpload_MediaTypeBlackList').match(/audio\\/mp3|audio\\/\\*/i)) && (!settings.get('FileUpload_MediaTypeWhiteList') || settings.get('FileUpload_MediaTypeWhiteList').match(/audio\\/mp3|audio\\/\\*/i));\n  },\n\n  stateClass() {\n    if (recordingRoomId.get() && recordingRoomId.get() !== Template.currentData().rid) {\n      return 'rc-message-box__audio-message--busy';\n    }\n\n    const state = Template.instance().state.get();\n    return state && \"rc-message-box__audio-message--\".concat(state);\n  },\n\n  time() {\n    return Template.instance().time.get();\n  }\n\n});\nTemplate.messageBoxAudioMessage.events({\n  async 'click .js-audio-message-record'(event, instance) {\n    event.preventDefault();\n\n    if (recordingRoomId.get() && recordingRoomId.get() !== this.rid) {\n      return;\n    }\n\n    instance.state.set('recording');\n\n    try {\n      await startRecording(this.rid, this.tmid);\n      const startTime = new Date();\n      recordingInterval.set(setInterval(() => {\n        const now = new Date();\n        const distance = (now.getTime() - startTime.getTime()) / 1000;\n        const minutes = Math.floor(distance / 60);\n        const seconds = Math.floor(distance % 60);\n        instance.time.set(\"\".concat(String(minutes).padStart(2, '0'), \":\").concat(String(seconds).padStart(2, '0')));\n      }, 1000));\n      recordingRoomId.set(this.rid);\n    } catch (error) {\n      console.log(error);\n      instance.isMicrophoneDenied.set(true);\n      instance.state.set(null);\n    }\n  },\n\n  async 'click .js-audio-message-cancel'(event, instance) {\n    event.preventDefault();\n    await cancelRecording(instance, this.rid, this.tmid);\n  },\n\n  async 'click .js-audio-message-done'(event, instance) {\n    event.preventDefault();\n    instance.state.set('loading');\n    const {\n      rid,\n      tmid\n    } = this;\n    const blob = await cancelRecording(instance, rid, tmid);\n    await fileUpload([{\n      file: blob,\n      type: 'video',\n      name: \"\".concat(t('Audio record'), \".mp3\")\n    }], {\n      input: blob\n    }, {\n      rid,\n      tmid\n    });\n  }\n\n});","map":{"version":3,"sources":["app/ui-message/client/messageBox/messageBoxAudioMessage.js"],"names":["ReactiveVar","module","link","v","Template","settings","AudioRecorder","fileUpload","USER_ACTIVITIES","UserAction","t","startRecording","rid","tmid","start","performContinuously","USER_RECORDING","error","stopRecording","result","Promise","resolve","stop","recordingInterval","recordingRoomId","clearIntervalVariables","get","clearInterval","set","cancelRecording","instance","time","blob","state","messageBoxAudioMessage","onCreated","isMicrophoneDenied","navigator","permissions","permissionStatus","query","name","onchange","console","warn","mediaDevices","enumerateDevices","some","kind","onDestroyed","data","helpers","isAllowed","isSupported","match","stateClass","currentData","events","event","preventDefault","startTime","Date","setInterval","now","distance","getTime","minutes","Math","floor","seconds","String","padStart","log","file","type","input"],"mappings":"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","sourcesContent":["import { ReactiveVar } from 'meteor/reactive-var';\nimport { Template } from 'meteor/templating';\n\nimport { settings } from '../../../settings';\nimport { AudioRecorder, fileUpload, USER_ACTIVITIES, UserAction } from '../../../ui';\nimport { t } from '../../../utils';\nimport './messageBoxAudioMessage.html';\n\nconst startRecording = async (rid, tmid) => {\n\ttry {\n\t\tawait AudioRecorder.start();\n\t\tUserAction.performContinuously(rid, USER_ACTIVITIES.USER_RECORDING, { tmid });\n\t} catch (error) {\n\t\tthrow error;\n\t}\n};\n\nconst stopRecording = async (rid, tmid) => {\n\tconst result = await new Promise((resolve) => AudioRecorder.stop(resolve));\n\tUserAction.stop(rid, USER_ACTIVITIES.USER_RECORDING, { tmid });\n\treturn result;\n};\n\nconst recordingInterval = new ReactiveVar(null);\nconst recordingRoomId = new ReactiveVar(null);\n\nconst clearIntervalVariables = () => {\n\tif (recordingInterval.get()) {\n\t\tclearInterval(recordingInterval.get());\n\t\trecordingInterval.set(null);\n\t\trecordingRoomId.set(null);\n\t}\n};\n\nconst cancelRecording = async (instance, rid, tmid) => {\n\tclearIntervalVariables();\n\n\tinstance.time.set('00:00');\n\n\tconst blob = await stopRecording(rid, tmid);\n\n\tinstance.state.set(null);\n\n\treturn blob;\n};\n\nTemplate.messageBoxAudioMessage.onCreated(async function () {\n\tthis.state = new ReactiveVar(null);\n\tthis.time = new ReactiveVar('00:00');\n\tthis.isMicrophoneDenied = new ReactiveVar(false);\n\n\tif (navigator.permissions) {\n\t\ttry {\n\t\t\tconst permissionStatus = await navigator.permissions.query({ name: 'microphone' });\n\t\t\tthis.isMicrophoneDenied.set(permissionStatus.state === 'denied');\n\t\t\tpermissionStatus.onchange = () => {\n\t\t\t\tthis.isMicrophoneDenied.set(permissionStatus.state === 'denied');\n\t\t\t};\n\t\t\treturn;\n\t\t} catch (error) {\n\t\t\tconsole.warn(error);\n\t\t}\n\t}\n\n\tif (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {\n\t\tthis.isMicrophoneDenied.set(true);\n\t\treturn;\n\t}\n\n\ttry {\n\t\tif (!(await navigator.mediaDevices.enumerateDevices()).some(({ kind }) => kind === 'audioinput')) {\n\t\t\tthis.isMicrophoneDenied.set(true);\n\t\t\treturn;\n\t\t}\n\t} catch (error) {\n\t\tconsole.warn(error);\n\t}\n});\n\nTemplate.messageBoxAudioMessage.onDestroyed(async function () {\n\tif (this.state.get() === 'recording') {\n\t\tconst { rid, tmid } = this.data;\n\t\tawait cancelRecording(this, rid, tmid);\n\t}\n});\n\nTemplate.messageBoxAudioMessage.helpers({\n\tisAllowed() {\n\t\treturn (\n\t\t\tAudioRecorder.isSupported() &&\n\t\t\t!Template.instance().isMicrophoneDenied.get() &&\n\t\t\tsettings.get('FileUpload_Enabled') &&\n\t\t\tsettings.get('Message_AudioRecorderEnabled') &&\n\t\t\t(!settings.get('FileUpload_MediaTypeBlackList') || !settings.get('FileUpload_MediaTypeBlackList').match(/audio\\/mp3|audio\\/\\*/i)) &&\n\t\t\t(!settings.get('FileUpload_MediaTypeWhiteList') || settings.get('FileUpload_MediaTypeWhiteList').match(/audio\\/mp3|audio\\/\\*/i))\n\t\t);\n\t},\n\n\tstateClass() {\n\t\tif (recordingRoomId.get() && recordingRoomId.get() !== Template.currentData().rid) {\n\t\t\treturn 'rc-message-box__audio-message--busy';\n\t\t}\n\n\t\tconst state = Template.instance().state.get();\n\t\treturn state && `rc-message-box__audio-message--${state}`;\n\t},\n\n\ttime() {\n\t\treturn Template.instance().time.get();\n\t},\n});\n\nTemplate.messageBoxAudioMessage.events({\n\tasync 'click .js-audio-message-record'(event, instance) {\n\t\tevent.preventDefault();\n\n\t\tif (recordingRoomId.get() && recordingRoomId.get() !== this.rid) {\n\t\t\treturn;\n\t\t}\n\n\t\tinstance.state.set('recording');\n\n\t\ttry {\n\t\t\tawait startRecording(this.rid, this.tmid);\n\t\t\tconst startTime = new Date();\n\t\t\trecordingInterval.set(\n\t\t\t\tsetInterval(() => {\n\t\t\t\t\tconst now = new Date();\n\t\t\t\t\tconst distance = (now.getTime() - startTime.getTime()) / 1000;\n\t\t\t\t\tconst minutes = Math.floor(distance / 60);\n\t\t\t\t\tconst seconds = Math.floor(distance % 60);\n\t\t\t\t\tinstance.time.set(`${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`);\n\t\t\t\t}, 1000),\n\t\t\t);\n\t\t\trecordingRoomId.set(this.rid);\n\t\t} catch (error) {\n\t\t\tconsole.log(error);\n\t\t\tinstance.isMicrophoneDenied.set(true);\n\t\t\tinstance.state.set(null);\n\t\t}\n\t},\n\n\tasync 'click .js-audio-message-cancel'(event, instance) {\n\t\tevent.preventDefault();\n\n\t\tawait cancelRecording(instance, this.rid, this.tmid);\n\t},\n\n\tasync 'click .js-audio-message-done'(event, instance) {\n\t\tevent.preventDefault();\n\n\t\tinstance.state.set('loading');\n\n\t\tconst { rid, tmid } = this;\n\t\tconst blob = await cancelRecording(instance, rid, tmid);\n\n\t\tawait fileUpload([{ file: blob, type: 'video', name: `${t('Audio record')}.mp3` }], { input: blob }, { rid, tmid });\n\t},\n});\n"]},"sourceType":"module","hash":"15b504fbb3e0b8b226df11d80816ea7dfea52bcb"}
