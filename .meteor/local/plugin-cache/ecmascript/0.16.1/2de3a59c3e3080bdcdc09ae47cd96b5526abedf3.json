{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/livechat/client/views/app/tabbar/contactChatHistory.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"app/livechat/client/views/app/tabbar/contactChatHistory.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/livechat/client/views/app/tabbar/contactChatHistory.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{}},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/livechat/client/views/app/tabbar/contactChatHistory.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/livechat/client/views/app/tabbar/contactChatHistory.js"}},"code":"var _regeneratorRuntime;\n\nmodule.link(\"@babel/runtime/regenerator\", {\n  default: function (v) {\n    _regeneratorRuntime = v;\n  }\n}, 0);\n\nvar _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default: function (v) {\n    _objectSpread = v;\n  }\n}, 1);\nvar Tracker;\nmodule.link(\"meteor/tracker\", {\n  Tracker: function (v) {\n    Tracker = v;\n  }\n}, 0);\nvar Template;\nmodule.link(\"meteor/templating\", {\n  Template: function (v) {\n    Template = v;\n  }\n}, 1);\nvar moment;\nmodule.link(\"moment\", {\n  \"default\": function (v) {\n    moment = v;\n  }\n}, 2);\nvar ReactiveVar;\nmodule.link(\"meteor/reactive-var\", {\n  ReactiveVar: function (v) {\n    ReactiveVar = v;\n  }\n}, 3);\nmodule.link(\"./contactChatHistory.html\");\nmodule.link(\"./contactChatHistoryItem.html\");\n\nvar _;\n\nmodule.link(\"underscore\", {\n  \"default\": function (v) {\n    _ = v;\n  }\n}, 4);\nvar t, APIClient;\nmodule.link(\"../../../../../utils/client\", {\n  t: function (v) {\n    t = v;\n  },\n  APIClient: function (v) {\n    APIClient = v;\n  }\n}, 5);\nvar HISTORY_LIMIT = 50;\nTemplate.contactChatHistory.helpers({\n  isReady: function () {\n    return Template.instance().isReady.get();\n  },\n  hasChatHistory: function () {\n    return Template.instance().history.get().length > 0;\n  },\n  history: function () {\n    return Template.instance().history.get();\n  },\n  isLoading: function () {\n    return Template.instance().isLoading.get();\n  },\n  isSearching: function () {\n    return Template.instance().searchTerm.get().length > 0;\n  },\n  showChatHistoryMessages: function () {\n    return Template.instance().showChatHistoryMessages.get();\n  },\n  chatHistoryMessagesContext: function () {\n    return _objectSpread({\n      tabBar: Template.instance().tabBar,\n      clear: Template.instance().returnChatHistoryList\n    }, Template.instance().chatHistoryMessagesContext.get());\n  },\n  canSearch: function () {\n    return Template.instance().canSearch.get();\n  }\n});\nTemplate.contactChatHistory.onCreated(function () {\n  function _callee3() {\n    var _this = this;\n\n    var currentData;\n    return _regeneratorRuntime.async(function () {\n      function _callee3$(_context3) {\n        while (1) {\n          switch (_context3.prev = _context3.next) {\n            case 0:\n              currentData = Template.currentData();\n              this.offset = new ReactiveVar(0);\n              this.visitorId = new ReactiveVar();\n              this.history = new ReactiveVar([]);\n              this.searchTerm = new ReactiveVar('');\n              this.hasMore = new ReactiveVar(true);\n              this.isLoading = new ReactiveVar(true);\n              this.chatHistoryMessagesContext = new ReactiveVar();\n              this.showChatHistoryMessages = new ReactiveVar(false);\n              this.limit = new ReactiveVar(HISTORY_LIMIT);\n              this.isReady = new ReactiveVar(false);\n              this.canSearch = new ReactiveVar(false);\n              this.tabBar = currentData.tabBar;\n\n              this.returnChatHistoryList = function () {\n                _this.showChatHistoryMessages.set(false);\n\n                _this.chatHistoryMessagesContext.set();\n              };\n\n              this.autorun(function () {\n                function _callee() {\n                  var limit, offset, searchTerm, baseUrl, _await$APIClient$v1$g, history, total;\n\n                  return _regeneratorRuntime.async(function () {\n                    function _callee$(_context) {\n                      while (1) {\n                        switch (_context.prev = _context.next) {\n                          case 0:\n                            if (!(!_this.visitorId.get() || !currentData || !currentData.rid)) {\n                              _context.next = 2;\n                              break;\n                            }\n\n                            return _context.abrupt(\"return\");\n\n                          case 2:\n                            limit = _this.limit.get();\n                            offset = _this.offset.get();\n                            searchTerm = _this.searchTerm.get();\n                            baseUrl = \"livechat/visitors.searchChats/room/\" + currentData.rid + \"/visitor/\" + _this.visitorId.get() + \"?count=\" + limit + \"&offset=\" + offset + \"&closedChatsOnly=true&servedChatsOnly=true\";\n\n                            if (searchTerm) {\n                              baseUrl += \"&searchText=\" + searchTerm;\n                            }\n\n                            _this.isLoading.set(true);\n\n                            _context.next = 10;\n                            return _regeneratorRuntime.awrap(APIClient.v1.get(baseUrl));\n\n                          case 10:\n                            _await$APIClient$v1$g = _context.sent;\n                            history = _await$APIClient$v1$g.history;\n                            total = _await$APIClient$v1$g.total;\n\n                            _this.history.set(offset === 0 ? history : _this.history.get().concat(history));\n\n                            _this.hasMore.set(total > _this.history.get().length);\n\n                            _this.isLoading.set(false);\n\n                          case 16:\n                          case \"end\":\n                            return _context.stop();\n                        }\n                      }\n                    }\n\n                    return _callee$;\n                  }(), null, null, null, Promise);\n                }\n\n                return _callee;\n              }());\n              this.autorun(function () {\n                function _callee2() {\n                  var _await$APIClient$v1$g2, room;\n\n                  return _regeneratorRuntime.async(function () {\n                    function _callee2$(_context2) {\n                      while (1) {\n                        switch (_context2.prev = _context2.next) {\n                          case 0:\n                            _context2.next = 2;\n                            return _regeneratorRuntime.awrap(APIClient.v1.get(\"rooms.info?roomId=\" + currentData.rid));\n\n                          case 2:\n                            _await$APIClient$v1$g2 = _context2.sent;\n                            room = _await$APIClient$v1$g2.room;\n\n                            if (room !== null && room !== void 0 && room.v) {\n                              _this.visitorId.set(room.v._id);\n                            }\n\n                          case 5:\n                          case \"end\":\n                            return _context2.stop();\n                        }\n                      }\n                    }\n\n                    return _callee2$;\n                  }(), null, null, null, Promise);\n                }\n\n                return _callee2;\n              }());\n\n            case 16:\n            case \"end\":\n              return _context3.stop();\n          }\n        }\n      }\n\n      return _callee3$;\n    }(), null, this, null, Promise);\n  }\n\n  return _callee3;\n}());\nTemplate.contactChatHistory.onRendered(function () {\n  var _this2 = this;\n\n  Tracker.autorun(function (computation) {\n    if (_this2.isLoading.get()) {\n      return;\n    }\n\n    var history = _this2.history.get();\n\n    _this2.canSearch.set(history && history.length > 0);\n\n    _this2.isReady.set(true);\n\n    computation.stop();\n  });\n});\nTemplate.contactChatHistory.events({\n  'scroll .js-list': _.throttle(function (e, instance) {\n    if (e.target.scrollTop >= e.target.scrollHeight - e.target.clientHeight - 10 && instance.hasMore.get()) {\n      instance.offset.set(instance.offset.get() + instance.limit.get());\n    }\n  }, 200),\n  'click .chat-history-item': function (event, instance) {\n    event.preventDefault();\n    event.stopPropagation();\n    var rid = this._id,\n        _this$v = this.v;\n    _this$v = _this$v === void 0 ? {} : _this$v;\n    var name = _this$v.name,\n        username = _this$v.username,\n        closedAt = this.closedAt;\n    var closedAtLabel = t('Closed_At');\n    var closedDay = moment(closedAt).format('MMM D YYYY');\n    instance.chatHistoryMessagesContext.set({\n      label: (name || username) + \", \" + closedAtLabel + \" \" + closedDay,\n      rid: rid\n    });\n    instance.showChatHistoryMessages.set(true);\n  },\n  'keyup #chat-search': _.debounce(function (e, instance) {\n    if (e.keyCode === 13) {\n      return e.preventDefault();\n    }\n\n    var value = e.target.value;\n\n    if (e.keyCode === 40 || e.keyCode === 38) {\n      return e.preventDefault();\n    }\n\n    instance.offset.set(0);\n    instance.searchTerm.set(value);\n  }, 300)\n});","map":{"version":3,"sources":["app/livechat/client/views/app/tabbar/contactChatHistory.js"],"names":["_regeneratorRuntime","module","link","default","v","_objectSpread","Tracker","Template","moment","ReactiveVar","_","t","APIClient","HISTORY_LIMIT","contactChatHistory","helpers","isReady","instance","get","hasChatHistory","history","length","isLoading","isSearching","searchTerm","showChatHistoryMessages","chatHistoryMessagesContext","tabBar","clear","returnChatHistoryList","canSearch","onCreated","currentData","offset","visitorId","hasMore","limit","set","autorun","rid","baseUrl","v1","total","concat","room","_id","onRendered","computation","stop","events","throttle","e","target","scrollTop","scrollHeight","clientHeight","event","preventDefault","stopPropagation","name","username","closedAt","closedAtLabel","closedDay","format","label","debounce","keyCode","value"],"mappings":"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","sourcesContent":["import { Tracker } from 'meteor/tracker';\nimport { Template } from 'meteor/templating';\nimport moment from 'moment';\nimport { ReactiveVar } from 'meteor/reactive-var';\nimport './contactChatHistory.html';\nimport './contactChatHistoryItem.html';\nimport _ from 'underscore';\n\nimport { t, APIClient } from '../../../../../utils/client';\n\nconst HISTORY_LIMIT = 50;\n\nTemplate.contactChatHistory.helpers({\n\tisReady() {\n\t\treturn Template.instance().isReady.get();\n\t},\n\thasChatHistory() {\n\t\treturn Template.instance().history.get().length > 0;\n\t},\n\thistory() {\n\t\treturn Template.instance().history.get();\n\t},\n\tisLoading() {\n\t\treturn Template.instance().isLoading.get();\n\t},\n\tisSearching() {\n\t\treturn Template.instance().searchTerm.get().length > 0;\n\t},\n\tshowChatHistoryMessages() {\n\t\treturn Template.instance().showChatHistoryMessages.get();\n\t},\n\tchatHistoryMessagesContext() {\n\t\treturn {\n\t\t\ttabBar: Template.instance().tabBar,\n\t\t\tclear: Template.instance().returnChatHistoryList,\n\t\t\t...Template.instance().chatHistoryMessagesContext.get(),\n\t\t};\n\t},\n\tcanSearch() {\n\t\treturn Template.instance().canSearch.get();\n\t},\n});\n\nTemplate.contactChatHistory.onCreated(async function () {\n\tconst currentData = Template.currentData();\n\tthis.offset = new ReactiveVar(0);\n\tthis.visitorId = new ReactiveVar();\n\tthis.history = new ReactiveVar([]);\n\tthis.searchTerm = new ReactiveVar('');\n\tthis.hasMore = new ReactiveVar(true);\n\tthis.isLoading = new ReactiveVar(true);\n\tthis.chatHistoryMessagesContext = new ReactiveVar();\n\tthis.showChatHistoryMessages = new ReactiveVar(false);\n\tthis.limit = new ReactiveVar(HISTORY_LIMIT);\n\tthis.isReady = new ReactiveVar(false);\n\tthis.canSearch = new ReactiveVar(false);\n\tthis.tabBar = currentData.tabBar;\n\n\tthis.returnChatHistoryList = () => {\n\t\tthis.showChatHistoryMessages.set(false);\n\t\tthis.chatHistoryMessagesContext.set();\n\t};\n\n\tthis.autorun(async () => {\n\t\tif (!this.visitorId.get() || !currentData || !currentData.rid) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst limit = this.limit.get();\n\t\tconst offset = this.offset.get();\n\t\tconst searchTerm = this.searchTerm.get();\n\n\t\tlet baseUrl = `livechat/visitors.searchChats/room/${\n\t\t\tcurrentData.rid\n\t\t}/visitor/${this.visitorId.get()}?count=${limit}&offset=${offset}&closedChatsOnly=true&servedChatsOnly=true`;\n\t\tif (searchTerm) {\n\t\t\tbaseUrl += `&searchText=${searchTerm}`;\n\t\t}\n\n\t\tthis.isLoading.set(true);\n\t\tconst { history, total } = await APIClient.v1.get(baseUrl);\n\t\tthis.history.set(offset === 0 ? history : this.history.get().concat(history));\n\t\tthis.hasMore.set(total > this.history.get().length);\n\t\tthis.isLoading.set(false);\n\t});\n\n\tthis.autorun(async () => {\n\t\tconst { room } = await APIClient.v1.get(`rooms.info?roomId=${currentData.rid}`);\n\t\tif (room?.v) {\n\t\t\tthis.visitorId.set(room.v._id);\n\t\t}\n\t});\n});\n\nTemplate.contactChatHistory.onRendered(function () {\n\tTracker.autorun((computation) => {\n\t\tif (this.isLoading.get()) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst history = this.history.get();\n\t\tthis.canSearch.set(history && history.length > 0);\n\t\tthis.isReady.set(true);\n\n\t\tcomputation.stop();\n\t});\n});\n\nTemplate.contactChatHistory.events({\n\t'scroll .js-list': _.throttle(function (e, instance) {\n\t\tif (e.target.scrollTop >= e.target.scrollHeight - e.target.clientHeight - 10 && instance.hasMore.get()) {\n\t\t\tinstance.offset.set(instance.offset.get() + instance.limit.get());\n\t\t}\n\t}, 200),\n\t'click .chat-history-item'(event, instance) {\n\t\tevent.preventDefault();\n\t\tevent.stopPropagation();\n\n\t\tconst { _id: rid, v: { name, username } = {}, closedAt } = this;\n\n\t\tconst closedAtLabel = t('Closed_At');\n\t\tconst closedDay = moment(closedAt).format('MMM D YYYY');\n\n\t\tinstance.chatHistoryMessagesContext.set({\n\t\t\tlabel: `${name || username}, ${closedAtLabel} ${closedDay}`,\n\t\t\trid,\n\t\t});\n\n\t\tinstance.showChatHistoryMessages.set(true);\n\t},\n\t'keyup #chat-search': _.debounce(function (e, instance) {\n\t\tif (e.keyCode === 13) {\n\t\t\treturn e.preventDefault();\n\t\t}\n\n\t\tconst { value } = e.target;\n\n\t\tif (e.keyCode === 40 || e.keyCode === 38) {\n\t\t\treturn e.preventDefault();\n\t\t}\n\n\t\tinstance.offset.set(0);\n\t\tinstance.searchTerm.set(value);\n\t}, 300),\n});\n"]},"sourceType":"module","hash":"2de3a59c3e3080bdcdc09ae47cd96b5526abedf3"}
