{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui-message/client/messageBox/messageBox.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"app/ui-message/client/messageBox/messageBox.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui-message/client/messageBox/messageBox.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui-message/client/messageBox/messageBox.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/ui-message/client/messageBox/messageBox.js"}},"code":"let Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet ReactiveVar;\nmodule.link(\"meteor/reactive-var\", {\n  ReactiveVar(v) {\n    ReactiveVar = v;\n  }\n\n}, 1);\nlet ReactiveDict;\nmodule.link(\"meteor/reactive-dict\", {\n  ReactiveDict(v) {\n    ReactiveDict = v;\n  }\n\n}, 2);\nlet Session;\nmodule.link(\"meteor/session\", {\n  Session(v) {\n    Session = v;\n  }\n\n}, 3);\nlet Template;\nmodule.link(\"meteor/templating\", {\n  Template(v) {\n    Template = v;\n  }\n\n}, 4);\nlet Tracker;\nmodule.link(\"meteor/tracker\", {\n  Tracker(v) {\n    Tracker = v;\n  }\n\n}, 5);\nlet moment;\nmodule.link(\"moment\", {\n  default(v) {\n    moment = v;\n  }\n\n}, 6);\nlet setupAutogrow;\nmodule.link(\"./messageBoxAutogrow\", {\n  setupAutogrow(v) {\n    setupAutogrow = v;\n  }\n\n}, 7);\nlet formattingButtons, applyFormatting;\nmodule.link(\"./messageBoxFormatting\", {\n  formattingButtons(v) {\n    formattingButtons = v;\n  },\n\n  applyFormatting(v) {\n    applyFormatting = v;\n  }\n\n}, 8);\nlet EmojiPicker;\nmodule.link(\"../../../emoji\", {\n  EmojiPicker(v) {\n    EmojiPicker = v;\n  }\n\n}, 9);\nlet Users;\nmodule.link(\"../../../models\", {\n  Users(v) {\n    Users = v;\n  }\n\n}, 10);\nlet settings;\nmodule.link(\"../../../settings\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 11);\nlet fileUpload, KonchatNotification;\nmodule.link(\"../../../ui\", {\n  fileUpload(v) {\n    fileUpload = v;\n  },\n\n  KonchatNotification(v) {\n    KonchatNotification = v;\n  }\n\n}, 12);\nlet messageBox, popover;\nmodule.link(\"../../../ui-utils\", {\n  messageBox(v) {\n    messageBox = v;\n  },\n\n  popover(v) {\n    popover = v;\n  }\n\n}, 13);\nlet t, getUserPreference;\nmodule.link(\"../../../utils/client\", {\n  t(v) {\n    t = v;\n  },\n\n  getUserPreference(v) {\n    getUserPreference = v;\n  }\n\n}, 14);\nmodule.link(\"./messageBoxActions\");\nmodule.link(\"./messageBoxReplyPreview\");\nmodule.link(\"./userActionIndicator.ts\");\nmodule.link(\"./messageBoxAudioMessage\");\nmodule.link(\"./messageBoxNotSubscribed\");\nmodule.link(\"./messageBox.html\");\nmodule.link(\"./messageBoxReadOnly\");\nlet getImageExtensionFromMime;\nmodule.link(\"../../../../lib/getImageExtensionFromMime\", {\n  getImageExtensionFromMime(v) {\n    getImageExtensionFromMime = v;\n  }\n\n}, 15);\nlet keyCodes;\nmodule.link(\"../../../../client/lib/utils/keyCodes\", {\n  keyCodes(v) {\n    keyCodes = v;\n  }\n\n}, 16);\nlet isRTL;\nmodule.link(\"../../../../client/lib/utils/isRTL\", {\n  isRTL(v) {\n    isRTL = v;\n  }\n\n}, 17);\nlet call;\nmodule.link(\"../../../../client/lib/utils/call\", {\n  call(v) {\n    call = v;\n  }\n\n}, 18);\nlet roomCoordinator;\nmodule.link(\"../../../../client/lib/rooms/roomCoordinator\", {\n  roomCoordinator(v) {\n    roomCoordinator = v;\n  }\n\n}, 19);\nTemplate.messageBox.onCreated(function () {\n  this.state = new ReactiveDict();\n  this.popupConfig = new ReactiveVar(null);\n  this.replyMessageData = new ReactiveVar();\n  this.isMicrophoneDenied = new ReactiveVar(true);\n  this.isSendIconVisible = new ReactiveVar(false);\n\n  this.set = value => {\n    const {\n      input\n    } = this;\n\n    if (!input) {\n      return;\n    }\n\n    input.value = value;\n    $(input).trigger('change').trigger('input');\n  };\n\n  this.insertNewLine = () => {\n    const {\n      input,\n      autogrow\n    } = this;\n\n    if (!input) {\n      return;\n    }\n\n    if (document.selection) {\n      input.focus();\n      const sel = document.selection.createRange();\n      sel.text = '\\n';\n    } else if (input.selectionStart || input.selectionStart === 0) {\n      const newPosition = input.selectionStart + 1;\n      const before = input.value.substring(0, input.selectionStart);\n      const after = input.value.substring(input.selectionEnd, input.value.length);\n      input.value = \"\".concat(before, \"\\n\").concat(after);\n      input.selectionStart = newPosition;\n      input.selectionEnd = newPosition;\n    } else {\n      input.value += '\\n';\n    }\n\n    $(input).trigger('change').trigger('input');\n    input.blur();\n    input.focus();\n    autogrow.update();\n  };\n\n  this.send = event => {\n    const {\n      input\n    } = this;\n\n    if (!input) {\n      return;\n    }\n\n    const {\n      autogrow,\n      data: {\n        rid,\n        tmid,\n        onSend,\n        tshow\n      }\n    } = this;\n    const {\n      value\n    } = input;\n    this.set('');\n\n    if (!onSend) {\n      return;\n    }\n\n    onSend.call(this.data, event, {\n      rid,\n      tmid,\n      value,\n      tshow\n    }, () => {\n      autogrow.update();\n      input.focus();\n    });\n  };\n});\nTemplate.messageBox.onRendered(function () {\n  let inputSetup = false;\n  this.autorun(() => {\n    const {\n      rid,\n      subscription\n    } = Template.currentData();\n    const room = Session.get(\"roomData\".concat(rid));\n\n    if (!inputSetup) {\n      const $input = $(this.find('.js-input-message'));\n      this.source = $input[0];\n\n      if (this.source) {\n        inputSetup = true;\n      }\n\n      $input.on('dataChange', () => {\n        const messages = $input.data('reply') || [];\n        this.replyMessageData.set(messages);\n      });\n    }\n\n    if (!room) {\n      return this.state.set({\n        room: false,\n        isBlockedOrBlocker: false,\n        mustJoinWithCode: false\n      });\n    }\n\n    const isBlocked = room && room.t === 'd' && subscription && subscription.blocked;\n    const isBlocker = room && room.t === 'd' && subscription && subscription.blocker;\n    const isBlockedOrBlocker = isBlocked || isBlocker;\n    const mustJoinWithCode = !subscription && room.joinCodeRequired;\n    return this.state.set({\n      room: false,\n      isBlockedOrBlocker,\n      mustJoinWithCode\n    });\n  });\n  this.autorun(() => {\n    const {\n      rid,\n      tmid,\n      onInputChanged,\n      onResize\n    } = Template.currentData();\n    Tracker.afterFlush(() => {\n      const input = this.find('.js-input-message');\n\n      if (this.input === input) {\n        return;\n      }\n\n      this.input = input;\n      onInputChanged && onInputChanged(input);\n\n      if (input && rid) {\n        this.popupConfig.set({\n          rid,\n          tmid,\n          getInput: () => input\n        });\n      } else {\n        this.popupConfig.set(null);\n      }\n\n      if (this.autogrow) {\n        this.autogrow.destroy();\n        this.autogrow = null;\n      }\n\n      if (!input) {\n        return;\n      }\n\n      const shadow = this.find('.js-input-message-shadow');\n      this.autogrow = setupAutogrow(input, shadow, onResize);\n    });\n  });\n});\nTemplate.messageBox.onDestroyed(function () {\n  if (!this.autogrow) {\n    return;\n  }\n\n  this.autogrow.destroy();\n});\nTemplate.messageBox.helpers({\n  isAnonymousOrMustJoinWithCode() {\n    const instance = Template.instance();\n    const {\n      rid\n    } = Template.currentData();\n\n    if (!rid) {\n      return false;\n    }\n\n    const isAnonymous = !Meteor.userId();\n    return isAnonymous || instance.state.get('mustJoinWithCode');\n  },\n\n  isWritable() {\n    const {\n      rid,\n      subscription\n    } = Template.currentData();\n\n    if (!rid) {\n      return true;\n    }\n\n    const isBlockedOrBlocker = Template.instance().state.get('isBlockedOrBlocker');\n\n    if (isBlockedOrBlocker) {\n      return false;\n    }\n\n    if (subscription !== null && subscription !== void 0 && subscription.onHold) {\n      return false;\n    }\n\n    const isReadOnly = roomCoordinator.readOnly(rid, Users.findOne({\n      _id: Meteor.userId()\n    }, {\n      fields: {\n        username: 1\n      }\n    }));\n    const isArchived = roomCoordinator.archived(rid) || subscription && subscription.t === 'd' && subscription.archived;\n    return !isReadOnly && !isArchived;\n  },\n\n  popupConfig() {\n    return Template.instance().popupConfig.get();\n  },\n\n  input() {\n    return Template.instance().input;\n  },\n\n  replyMessageData() {\n    return Template.instance().replyMessageData.get();\n  },\n\n  isEmojiEnabled() {\n    return getUserPreference(Meteor.userId(), 'useEmojis');\n  },\n\n  maxMessageLength() {\n    return settings.get('Message_AllowConvertLongMessagesToAttachment') ? null : settings.get('Message_MaxAllowedSize');\n  },\n\n  isSendIconVisible() {\n    return Template.instance().isSendIconVisible.get();\n  },\n\n  canSend() {\n    const {\n      rid\n    } = Template.currentData();\n\n    if (!rid) {\n      return true;\n    }\n\n    return roomCoordinator.verifyCanSendMessage(rid);\n  },\n\n  actions() {\n    const actionGroups = messageBox.actions.get();\n    return Object.values(actionGroups).reduce((actions, actionGroup) => [...actions, ...actionGroup], []);\n  },\n\n  formattingButtons() {\n    return formattingButtons.filter(_ref => {\n      let {\n        condition\n      } = _ref;\n      return !condition || condition();\n    });\n  },\n\n  isBlockedOrBlocker() {\n    return Template.instance().state.get('isBlockedOrBlocker');\n  },\n\n  onHold() {\n    const {\n      rid,\n      subscription\n    } = Template.currentData();\n    return rid && !!(subscription !== null && subscription !== void 0 && subscription.onHold);\n  },\n\n  isSubscribed() {\n    const {\n      subscription\n    } = Template.currentData();\n    return !!subscription;\n  }\n\n});\n\nconst handleFormattingShortcut = (event, instance) => {\n  const isMacOS = navigator.platform.indexOf('Mac') !== -1;\n  const isCmdOrCtrlPressed = isMacOS && event.metaKey || !isMacOS && event.ctrlKey;\n\n  if (!isCmdOrCtrlPressed) {\n    return false;\n  }\n\n  const key = event.key.toLowerCase();\n  const {\n    pattern\n  } = formattingButtons.filter(_ref2 => {\n    let {\n      condition\n    } = _ref2;\n    return !condition || condition();\n  }).find(_ref3 => {\n    let {\n      command\n    } = _ref3;\n    return command === key;\n  }) || {};\n\n  if (!pattern) {\n    return false;\n  }\n\n  const {\n    input\n  } = instance;\n  applyFormatting(pattern, input);\n  return true;\n};\n\nlet sendOnEnter;\nlet sendOnEnterActive;\nTracker.autorun(() => {\n  sendOnEnter = getUserPreference(Meteor.userId(), 'sendOnEnter');\n  sendOnEnterActive = sendOnEnter == null || sendOnEnter === 'normal' || sendOnEnter === 'desktop' && Meteor.Device.isDesktop();\n});\n\nconst handleSubmit = (event, instance) => {\n  const {\n    which: keyCode\n  } = event;\n  const isSubmitKey = keyCode === keyCodes.CARRIAGE_RETURN || keyCode === keyCodes.NEW_LINE;\n\n  if (!isSubmitKey) {\n    return false;\n  }\n\n  const withModifier = event.shiftKey || event.ctrlKey || event.altKey || event.metaKey;\n  const isSending = sendOnEnterActive && !withModifier || !sendOnEnterActive && withModifier;\n\n  if (isSending) {\n    instance.send(event);\n    return true;\n  }\n\n  instance.insertNewLine();\n  return true;\n};\n\nTemplate.messageBox.events({\n  async 'click .js-join'(event) {\n    event.stopPropagation();\n    event.preventDefault();\n    const joinCodeInput = Template.instance().find('[name=joinCode]');\n    const joinCode = joinCodeInput && joinCodeInput.value;\n    await call('joinRoom', this.rid, joinCode);\n  },\n\n  'click .js-emoji-picker'(event, instance) {\n    event.stopPropagation();\n    event.preventDefault();\n\n    if (!getUserPreference(Meteor.userId(), 'useEmojis')) {\n      return;\n    }\n\n    if (EmojiPicker.isOpened()) {\n      EmojiPicker.close();\n      return;\n    }\n\n    EmojiPicker.open(instance.source, emoji => {\n      const emojiValue = \":\".concat(emoji, \": \");\n      const {\n        input\n      } = instance;\n      const caretPos = input.selectionStart;\n      const textAreaTxt = input.value;\n      input.focus();\n\n      if (!document.execCommand || !document.execCommand('insertText', false, emojiValue)) {\n        instance.set(textAreaTxt.substring(0, caretPos) + emojiValue + textAreaTxt.substring(caretPos));\n        input.focus();\n      }\n\n      input.selectionStart = caretPos + emojiValue.length;\n      input.selectionEnd = caretPos + emojiValue.length;\n    });\n  },\n\n  'focus .js-input-message'() {\n    KonchatNotification.removeRoomNotification(this.rid);\n  },\n\n  'keydown .js-input-message'(event, instance) {\n    const isEventHandled = handleFormattingShortcut(event, instance) || handleSubmit(event, instance);\n\n    if (isEventHandled) {\n      event.preventDefault();\n      event.stopPropagation();\n      return;\n    }\n\n    const {\n      rid,\n      tmid,\n      onKeyDown\n    } = this;\n    onKeyDown && onKeyDown.call(this, event, {\n      rid,\n      tmid\n    });\n  },\n\n  'keyup .js-input-message'(event) {\n    const {\n      rid,\n      tmid,\n      onKeyUp\n    } = this;\n    onKeyUp && onKeyUp.call(this, event, {\n      rid,\n      tmid\n    });\n  },\n\n  'paste .js-input-message'(event, instance) {\n    const {\n      rid,\n      tmid\n    } = this;\n    const {\n      input,\n      autogrow\n    } = instance;\n    setTimeout(() => autogrow && autogrow.update(), 50);\n\n    if (!event.originalEvent.clipboardData) {\n      return;\n    }\n\n    const items = [...event.originalEvent.clipboardData.items];\n\n    if (items.some(_ref4 => {\n      let {\n        kind,\n        type\n      } = _ref4;\n      return kind === 'string' && type === 'text/plain';\n    })) {\n      return;\n    }\n\n    const files = items.filter(item => item.kind === 'file' && item.type.indexOf('image/') !== -1).map(item => {\n      const fileItem = item.getAsFile();\n      const imageExtension = getImageExtensionFromMime(fileItem.type);\n      const extension = imageExtension ? \".\".concat(imageExtension) : '';\n      return {\n        file: fileItem,\n        name: \"Clipboard - \".concat(moment().format(settings.get('Message_TimeAndDateFormat'))).concat(extension)\n      };\n    }).filter(_ref5 => {\n      let {\n        file\n      } = _ref5;\n      return file !== null;\n    });\n\n    if (files.length) {\n      event.preventDefault();\n      fileUpload(files, input, {\n        rid,\n        tmid\n      });\n    }\n  },\n\n  'input .js-input-message'(event, instance) {\n    const {\n      input\n    } = instance;\n\n    if (!input) {\n      return;\n    }\n\n    instance.isSendIconVisible.set(!!input.value);\n\n    if (input.value.length > 0) {\n      input.dir = isRTL(input.value) ? 'rtl' : 'ltr';\n    }\n\n    const {\n      rid,\n      tmid,\n      onValueChanged\n    } = this;\n    onValueChanged && onValueChanged.call(this, event, {\n      rid,\n      tmid\n    });\n  },\n\n  'propertychange .js-input-message'(event, instance) {\n    if (event.originalEvent.propertyName !== 'value') {\n      return;\n    }\n\n    const {\n      input\n    } = instance;\n\n    if (!input) {\n      return;\n    }\n\n    instance.sendIconDisabled.set(!!input.value);\n\n    if (input.value.length > 0) {\n      input.dir = isRTL(input.value) ? 'rtl' : 'ltr';\n    }\n\n    const {\n      rid,\n      tmid,\n      onValueChanged\n    } = this;\n    onValueChanged && onValueChanged.call(this, event, {\n      rid,\n      tmid\n    });\n  },\n\n  async 'click .js-send'(event, instance) {\n    instance.send(event);\n  },\n\n  'click .js-action-menu'(event, instance) {\n    const groups = messageBox.actions.get();\n    const config = {\n      popoverClass: 'message-box',\n      columns: [{\n        groups: Object.keys(groups).map(group => {\n          const items = [];\n          groups[group].forEach(item => {\n            items.push({\n              icon: item.icon,\n              name: t(item.label),\n              type: 'messagebox-action',\n              id: item.id\n            });\n          });\n          return {\n            title: t(group),\n            items\n          };\n        })\n      }],\n      offsetVertical: 10,\n      direction: 'top-inverted',\n      currentTarget: event.currentTarget.firstElementChild.firstElementChild,\n      data: {\n        rid: this.rid,\n        tmid: this.tmid,\n        prid: this.subscription.prid,\n        messageBox: instance.firstNode\n      },\n      activeElement: event.currentTarget\n    };\n    popover.open(config);\n  },\n\n  'click .js-message-actions .js-message-action'(event, instance) {\n    const {\n      id\n    } = event.currentTarget.dataset;\n    const actions = messageBox.actions.getById(id);\n    actions.filter(_ref6 => {\n      let {\n        action\n      } = _ref6;\n      return !!action;\n    }).forEach(_ref7 => {\n      let {\n        action\n      } = _ref7;\n      action.call(null, {\n        rid: this.rid,\n        tmid: this.tmid,\n        messageBox: instance.firstNode,\n        prid: this.subscription.prid,\n        event\n      });\n    });\n  },\n\n  'click .js-format'(event, instance) {\n    event.preventDefault();\n    event.stopPropagation();\n    const {\n      id\n    } = event.currentTarget.dataset;\n    const {\n      pattern\n    } = formattingButtons.filter(_ref8 => {\n      let {\n        condition\n      } = _ref8;\n      return !condition || condition();\n    }).find(_ref9 => {\n      let {\n        label\n      } = _ref9;\n      return label === id;\n    }) || {};\n\n    if (!pattern) {\n      return;\n    }\n\n    applyFormatting(pattern, instance.input);\n  }\n\n});","map":{"version":3,"sources":["app/ui-message/client/messageBox/messageBox.js"],"names":["Meteor","module","link","v","ReactiveVar","ReactiveDict","Session","Template","Tracker","moment","default","setupAutogrow","formattingButtons","applyFormatting","EmojiPicker","Users","settings","fileUpload","KonchatNotification","messageBox","popover","t","getUserPreference","getImageExtensionFromMime","keyCodes","isRTL","call","roomCoordinator","onCreated","state","popupConfig","replyMessageData","isMicrophoneDenied","isSendIconVisible","set","value","input","$","trigger","insertNewLine","autogrow","document","selection","focus","sel","createRange","text","selectionStart","newPosition","before","substring","after","selectionEnd","length","blur","update","send","event","data","rid","tmid","onSend","tshow","onRendered","inputSetup","autorun","subscription","currentData","room","get","$input","find","source","on","messages","isBlockedOrBlocker","mustJoinWithCode","isBlocked","blocked","isBlocker","blocker","joinCodeRequired","onInputChanged","onResize","afterFlush","getInput","destroy","shadow","onDestroyed","helpers","isAnonymousOrMustJoinWithCode","instance","isAnonymous","userId","isWritable","onHold","isReadOnly","readOnly","findOne","_id","fields","username","isArchived","archived","isEmojiEnabled","maxMessageLength","canSend","verifyCanSendMessage","actions","actionGroups","Object","values","reduce","actionGroup","filter","condition","isSubscribed","handleFormattingShortcut","isMacOS","navigator","platform","indexOf","isCmdOrCtrlPressed","metaKey","ctrlKey","key","toLowerCase","pattern","command","sendOnEnter","sendOnEnterActive","Device","isDesktop","handleSubmit","which","keyCode","isSubmitKey","CARRIAGE_RETURN","NEW_LINE","withModifier","shiftKey","altKey","isSending","events","stopPropagation","preventDefault","joinCodeInput","joinCode","isOpened","close","open","emoji","emojiValue","caretPos","textAreaTxt","execCommand","removeRoomNotification","isEventHandled","onKeyDown","onKeyUp","setTimeout","originalEvent","clipboardData","items","some","kind","type","files","item","map","fileItem","getAsFile","imageExtension","extension","file","name","format","dir","onValueChanged","propertyName","sendIconDisabled","groups","config","popoverClass","columns","keys","group","forEach","push","icon","label","id","title","offsetVertical","direction","currentTarget","firstElementChild","prid","firstNode","activeElement","dataset","getById","action"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { ReactiveVar } from 'meteor/reactive-var';\nimport { ReactiveDict } from 'meteor/reactive-dict';\nimport { Session } from 'meteor/session';\nimport { Template } from 'meteor/templating';\nimport { Tracker } from 'meteor/tracker';\nimport moment from 'moment';\n\nimport { setupAutogrow } from './messageBoxAutogrow';\nimport { formattingButtons, applyFormatting } from './messageBoxFormatting';\nimport { EmojiPicker } from '../../../emoji';\nimport { Users } from '../../../models';\nimport { settings } from '../../../settings';\nimport { fileUpload, KonchatNotification } from '../../../ui';\nimport { messageBox, popover } from '../../../ui-utils';\nimport { t, getUserPreference } from '../../../utils/client';\nimport './messageBoxActions';\nimport './messageBoxReplyPreview';\nimport './userActionIndicator.ts';\nimport './messageBoxAudioMessage';\nimport './messageBoxNotSubscribed';\nimport './messageBox.html';\nimport './messageBoxReadOnly';\nimport { getImageExtensionFromMime } from '../../../../lib/getImageExtensionFromMime';\nimport { keyCodes } from '../../../../client/lib/utils/keyCodes';\nimport { isRTL } from '../../../../client/lib/utils/isRTL';\nimport { call } from '../../../../client/lib/utils/call';\nimport { roomCoordinator } from '../../../../client/lib/rooms/roomCoordinator';\n\nTemplate.messageBox.onCreated(function () {\n\tthis.state = new ReactiveDict();\n\tthis.popupConfig = new ReactiveVar(null);\n\tthis.replyMessageData = new ReactiveVar();\n\tthis.isMicrophoneDenied = new ReactiveVar(true);\n\tthis.isSendIconVisible = new ReactiveVar(false);\n\n\tthis.set = (value) => {\n\t\tconst { input } = this;\n\t\tif (!input) {\n\t\t\treturn;\n\t\t}\n\n\t\tinput.value = value;\n\t\t$(input).trigger('change').trigger('input');\n\t};\n\n\tthis.insertNewLine = () => {\n\t\tconst { input, autogrow } = this;\n\t\tif (!input) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (document.selection) {\n\t\t\tinput.focus();\n\t\t\tconst sel = document.selection.createRange();\n\t\t\tsel.text = '\\n';\n\t\t} else if (input.selectionStart || input.selectionStart === 0) {\n\t\t\tconst newPosition = input.selectionStart + 1;\n\t\t\tconst before = input.value.substring(0, input.selectionStart);\n\t\t\tconst after = input.value.substring(input.selectionEnd, input.value.length);\n\t\t\tinput.value = `${before}\\n${after}`;\n\t\t\tinput.selectionStart = newPosition;\n\t\t\tinput.selectionEnd = newPosition;\n\t\t} else {\n\t\t\tinput.value += '\\n';\n\t\t}\n\t\t$(input).trigger('change').trigger('input');\n\n\t\tinput.blur();\n\t\tinput.focus();\n\t\tautogrow.update();\n\t};\n\n\tthis.send = (event) => {\n\t\tconst { input } = this;\n\n\t\tif (!input) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst {\n\t\t\tautogrow,\n\t\t\tdata: { rid, tmid, onSend, tshow },\n\t\t} = this;\n\t\tconst { value } = input;\n\t\tthis.set('');\n\n\t\tif (!onSend) {\n\t\t\treturn;\n\t\t}\n\n\t\tonSend.call(this.data, event, { rid, tmid, value, tshow }, () => {\n\t\t\tautogrow.update();\n\t\t\tinput.focus();\n\t\t});\n\t};\n});\n\nTemplate.messageBox.onRendered(function () {\n\tlet inputSetup = false;\n\n\tthis.autorun(() => {\n\t\tconst { rid, subscription } = Template.currentData();\n\t\tconst room = Session.get(`roomData${rid}`);\n\n\t\tif (!inputSetup) {\n\t\t\tconst $input = $(this.find('.js-input-message'));\n\t\t\tthis.source = $input[0];\n\t\t\tif (this.source) {\n\t\t\t\tinputSetup = true;\n\t\t\t}\n\t\t\t$input.on('dataChange', () => {\n\t\t\t\tconst messages = $input.data('reply') || [];\n\t\t\t\tthis.replyMessageData.set(messages);\n\t\t\t});\n\t\t}\n\n\t\tif (!room) {\n\t\t\treturn this.state.set({\n\t\t\t\troom: false,\n\t\t\t\tisBlockedOrBlocker: false,\n\t\t\t\tmustJoinWithCode: false,\n\t\t\t});\n\t\t}\n\n\t\tconst isBlocked = room && room.t === 'd' && subscription && subscription.blocked;\n\t\tconst isBlocker = room && room.t === 'd' && subscription && subscription.blocker;\n\t\tconst isBlockedOrBlocker = isBlocked || isBlocker;\n\n\t\tconst mustJoinWithCode = !subscription && room.joinCodeRequired;\n\n\t\treturn this.state.set({\n\t\t\troom: false,\n\t\t\tisBlockedOrBlocker,\n\t\t\tmustJoinWithCode,\n\t\t});\n\t});\n\n\tthis.autorun(() => {\n\t\tconst { rid, tmid, onInputChanged, onResize } = Template.currentData();\n\n\t\tTracker.afterFlush(() => {\n\t\t\tconst input = this.find('.js-input-message');\n\n\t\t\tif (this.input === input) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.input = input;\n\t\t\tonInputChanged && onInputChanged(input);\n\n\t\t\tif (input && rid) {\n\t\t\t\tthis.popupConfig.set({\n\t\t\t\t\trid,\n\t\t\t\t\ttmid,\n\t\t\t\t\tgetInput: () => input,\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tthis.popupConfig.set(null);\n\t\t\t}\n\n\t\t\tif (this.autogrow) {\n\t\t\t\tthis.autogrow.destroy();\n\t\t\t\tthis.autogrow = null;\n\t\t\t}\n\n\t\t\tif (!input) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst shadow = this.find('.js-input-message-shadow');\n\t\t\tthis.autogrow = setupAutogrow(input, shadow, onResize);\n\t\t});\n\t});\n});\n\nTemplate.messageBox.onDestroyed(function () {\n\tif (!this.autogrow) {\n\t\treturn;\n\t}\n\n\tthis.autogrow.destroy();\n});\n\nTemplate.messageBox.helpers({\n\tisAnonymousOrMustJoinWithCode() {\n\t\tconst instance = Template.instance();\n\t\tconst { rid } = Template.currentData();\n\t\tif (!rid) {\n\t\t\treturn false;\n\t\t}\n\t\tconst isAnonymous = !Meteor.userId();\n\t\treturn isAnonymous || instance.state.get('mustJoinWithCode');\n\t},\n\tisWritable() {\n\t\tconst { rid, subscription } = Template.currentData();\n\t\tif (!rid) {\n\t\t\treturn true;\n\t\t}\n\n\t\tconst isBlockedOrBlocker = Template.instance().state.get('isBlockedOrBlocker');\n\n\t\tif (isBlockedOrBlocker) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (subscription?.onHold) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst isReadOnly = roomCoordinator.readOnly(rid, Users.findOne({ _id: Meteor.userId() }, { fields: { username: 1 } }));\n\t\tconst isArchived = roomCoordinator.archived(rid) || (subscription && subscription.t === 'd' && subscription.archived);\n\n\t\treturn !isReadOnly && !isArchived;\n\t},\n\tpopupConfig() {\n\t\treturn Template.instance().popupConfig.get();\n\t},\n\tinput() {\n\t\treturn Template.instance().input;\n\t},\n\treplyMessageData() {\n\t\treturn Template.instance().replyMessageData.get();\n\t},\n\tisEmojiEnabled() {\n\t\treturn getUserPreference(Meteor.userId(), 'useEmojis');\n\t},\n\tmaxMessageLength() {\n\t\treturn settings.get('Message_AllowConvertLongMessagesToAttachment') ? null : settings.get('Message_MaxAllowedSize');\n\t},\n\tisSendIconVisible() {\n\t\treturn Template.instance().isSendIconVisible.get();\n\t},\n\tcanSend() {\n\t\tconst { rid } = Template.currentData();\n\t\tif (!rid) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn roomCoordinator.verifyCanSendMessage(rid);\n\t},\n\tactions() {\n\t\tconst actionGroups = messageBox.actions.get();\n\t\treturn Object.values(actionGroups).reduce((actions, actionGroup) => [...actions, ...actionGroup], []);\n\t},\n\tformattingButtons() {\n\t\treturn formattingButtons.filter(({ condition }) => !condition || condition());\n\t},\n\tisBlockedOrBlocker() {\n\t\treturn Template.instance().state.get('isBlockedOrBlocker');\n\t},\n\tonHold() {\n\t\tconst { rid, subscription } = Template.currentData();\n\t\treturn rid && !!subscription?.onHold;\n\t},\n\tisSubscribed() {\n\t\tconst { subscription } = Template.currentData();\n\t\treturn !!subscription;\n\t},\n});\n\nconst handleFormattingShortcut = (event, instance) => {\n\tconst isMacOS = navigator.platform.indexOf('Mac') !== -1;\n\tconst isCmdOrCtrlPressed = (isMacOS && event.metaKey) || (!isMacOS && event.ctrlKey);\n\n\tif (!isCmdOrCtrlPressed) {\n\t\treturn false;\n\t}\n\n\tconst key = event.key.toLowerCase();\n\n\tconst { pattern } = formattingButtons.filter(({ condition }) => !condition || condition()).find(({ command }) => command === key) || {};\n\n\tif (!pattern) {\n\t\treturn false;\n\t}\n\n\tconst { input } = instance;\n\tapplyFormatting(pattern, input);\n\treturn true;\n};\n\nlet sendOnEnter;\nlet sendOnEnterActive;\n\nTracker.autorun(() => {\n\tsendOnEnter = getUserPreference(Meteor.userId(), 'sendOnEnter');\n\tsendOnEnterActive = sendOnEnter == null || sendOnEnter === 'normal' || (sendOnEnter === 'desktop' && Meteor.Device.isDesktop());\n});\n\nconst handleSubmit = (event, instance) => {\n\tconst { which: keyCode } = event;\n\n\tconst isSubmitKey = keyCode === keyCodes.CARRIAGE_RETURN || keyCode === keyCodes.NEW_LINE;\n\n\tif (!isSubmitKey) {\n\t\treturn false;\n\t}\n\n\tconst withModifier = event.shiftKey || event.ctrlKey || event.altKey || event.metaKey;\n\tconst isSending = (sendOnEnterActive && !withModifier) || (!sendOnEnterActive && withModifier);\n\n\tif (isSending) {\n\t\tinstance.send(event);\n\t\treturn true;\n\t}\n\n\tinstance.insertNewLine();\n\treturn true;\n};\n\nTemplate.messageBox.events({\n\tasync 'click .js-join'(event) {\n\t\tevent.stopPropagation();\n\t\tevent.preventDefault();\n\n\t\tconst joinCodeInput = Template.instance().find('[name=joinCode]');\n\t\tconst joinCode = joinCodeInput && joinCodeInput.value;\n\n\t\tawait call('joinRoom', this.rid, joinCode);\n\t},\n\t'click .js-emoji-picker'(event, instance) {\n\t\tevent.stopPropagation();\n\t\tevent.preventDefault();\n\n\t\tif (!getUserPreference(Meteor.userId(), 'useEmojis')) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (EmojiPicker.isOpened()) {\n\t\t\tEmojiPicker.close();\n\t\t\treturn;\n\t\t}\n\n\t\tEmojiPicker.open(instance.source, (emoji) => {\n\t\t\tconst emojiValue = `:${emoji}: `;\n\n\t\t\tconst { input } = instance;\n\n\t\t\tconst caretPos = input.selectionStart;\n\t\t\tconst textAreaTxt = input.value;\n\n\t\t\tinput.focus();\n\t\t\tif (!document.execCommand || !document.execCommand('insertText', false, emojiValue)) {\n\t\t\t\tinstance.set(textAreaTxt.substring(0, caretPos) + emojiValue + textAreaTxt.substring(caretPos));\n\t\t\t\tinput.focus();\n\t\t\t}\n\n\t\t\tinput.selectionStart = caretPos + emojiValue.length;\n\t\t\tinput.selectionEnd = caretPos + emojiValue.length;\n\t\t});\n\t},\n\t'focus .js-input-message'() {\n\t\tKonchatNotification.removeRoomNotification(this.rid);\n\t},\n\t'keydown .js-input-message'(event, instance) {\n\t\tconst isEventHandled = handleFormattingShortcut(event, instance) || handleSubmit(event, instance);\n\n\t\tif (isEventHandled) {\n\t\t\tevent.preventDefault();\n\t\t\tevent.stopPropagation();\n\t\t\treturn;\n\t\t}\n\n\t\tconst { rid, tmid, onKeyDown } = this;\n\t\tonKeyDown && onKeyDown.call(this, event, { rid, tmid });\n\t},\n\t'keyup .js-input-message'(event) {\n\t\tconst { rid, tmid, onKeyUp } = this;\n\t\tonKeyUp && onKeyUp.call(this, event, { rid, tmid });\n\t},\n\t'paste .js-input-message'(event, instance) {\n\t\tconst { rid, tmid } = this;\n\t\tconst { input, autogrow } = instance;\n\n\t\tsetTimeout(() => autogrow && autogrow.update(), 50);\n\n\t\tif (!event.originalEvent.clipboardData) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst items = [...event.originalEvent.clipboardData.items];\n\n\t\tif (items.some(({ kind, type }) => kind === 'string' && type === 'text/plain')) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst files = items\n\t\t\t.filter((item) => item.kind === 'file' && item.type.indexOf('image/') !== -1)\n\t\t\t.map((item) => {\n\t\t\t\tconst fileItem = item.getAsFile();\n\n\t\t\t\tconst imageExtension = getImageExtensionFromMime(fileItem.type);\n\n\t\t\t\tconst extension = imageExtension ? `.${imageExtension}` : '';\n\n\t\t\t\treturn {\n\t\t\t\t\tfile: fileItem,\n\t\t\t\t\tname: `Clipboard - ${moment().format(settings.get('Message_TimeAndDateFormat'))}${extension}`,\n\t\t\t\t};\n\t\t\t})\n\t\t\t.filter(({ file }) => file !== null);\n\n\t\tif (files.length) {\n\t\t\tevent.preventDefault();\n\t\t\tfileUpload(files, input, { rid, tmid });\n\t\t}\n\t},\n\t'input .js-input-message'(event, instance) {\n\t\tconst { input } = instance;\n\t\tif (!input) {\n\t\t\treturn;\n\t\t}\n\n\t\tinstance.isSendIconVisible.set(!!input.value);\n\n\t\tif (input.value.length > 0) {\n\t\t\tinput.dir = isRTL(input.value) ? 'rtl' : 'ltr';\n\t\t}\n\n\t\tconst { rid, tmid, onValueChanged } = this;\n\t\tonValueChanged && onValueChanged.call(this, event, { rid, tmid });\n\t},\n\t'propertychange .js-input-message'(event, instance) {\n\t\tif (event.originalEvent.propertyName !== 'value') {\n\t\t\treturn;\n\t\t}\n\n\t\tconst { input } = instance;\n\t\tif (!input) {\n\t\t\treturn;\n\t\t}\n\n\t\tinstance.sendIconDisabled.set(!!input.value);\n\n\t\tif (input.value.length > 0) {\n\t\t\tinput.dir = isRTL(input.value) ? 'rtl' : 'ltr';\n\t\t}\n\n\t\tconst { rid, tmid, onValueChanged } = this;\n\t\tonValueChanged && onValueChanged.call(this, event, { rid, tmid });\n\t},\n\tasync 'click .js-send'(event, instance) {\n\t\tinstance.send(event);\n\t},\n\t'click .js-action-menu'(event, instance) {\n\t\tconst groups = messageBox.actions.get();\n\t\tconst config = {\n\t\t\tpopoverClass: 'message-box',\n\t\t\tcolumns: [\n\t\t\t\t{\n\t\t\t\t\tgroups: Object.keys(groups).map((group) => {\n\t\t\t\t\t\tconst items = [];\n\t\t\t\t\t\tgroups[group].forEach((item) => {\n\t\t\t\t\t\t\titems.push({\n\t\t\t\t\t\t\t\ticon: item.icon,\n\t\t\t\t\t\t\t\tname: t(item.label),\n\t\t\t\t\t\t\t\ttype: 'messagebox-action',\n\t\t\t\t\t\t\t\tid: item.id,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\ttitle: t(group),\n\t\t\t\t\t\t\titems,\n\t\t\t\t\t\t};\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t\toffsetVertical: 10,\n\t\t\tdirection: 'top-inverted',\n\t\t\tcurrentTarget: event.currentTarget.firstElementChild.firstElementChild,\n\t\t\tdata: {\n\t\t\t\trid: this.rid,\n\t\t\t\ttmid: this.tmid,\n\t\t\t\tprid: this.subscription.prid,\n\t\t\t\tmessageBox: instance.firstNode,\n\t\t\t},\n\t\t\tactiveElement: event.currentTarget,\n\t\t};\n\n\t\tpopover.open(config);\n\t},\n\t'click .js-message-actions .js-message-action'(event, instance) {\n\t\tconst { id } = event.currentTarget.dataset;\n\t\tconst actions = messageBox.actions.getById(id);\n\t\tactions\n\t\t\t.filter(({ action }) => !!action)\n\t\t\t.forEach(({ action }) => {\n\t\t\t\taction.call(null, {\n\t\t\t\t\trid: this.rid,\n\t\t\t\t\ttmid: this.tmid,\n\t\t\t\t\tmessageBox: instance.firstNode,\n\t\t\t\t\tprid: this.subscription.prid,\n\t\t\t\t\tevent,\n\t\t\t\t});\n\t\t\t});\n\t},\n\t'click .js-format'(event, instance) {\n\t\tevent.preventDefault();\n\t\tevent.stopPropagation();\n\n\t\tconst { id } = event.currentTarget.dataset;\n\t\tconst { pattern } = formattingButtons.filter(({ condition }) => !condition || condition()).find(({ label }) => label === id) || {};\n\n\t\tif (!pattern) {\n\t\t\treturn;\n\t\t}\n\n\t\tapplyFormatting(pattern, instance.input);\n\t},\n});\n"]},"sourceType":"module","hash":"8102ee410c5a1ae37fd963fb0703c9261b7a946a"}
