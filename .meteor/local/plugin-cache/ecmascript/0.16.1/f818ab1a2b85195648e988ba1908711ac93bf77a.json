{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui/client/lib/fileUpload.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"app/ui/client/lib/fileUpload.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui/client/lib/fileUpload.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui/client/lib/fileUpload.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/ui/client/lib/fileUpload.js"}},"code":"module.export({\n  uploadFileWithMessage: () => uploadFileWithMessage,\n  fileUpload: () => fileUpload\n});\nlet Tracker;\nmodule.link(\"meteor/tracker\", {\n  Tracker(v) {\n    Tracker = v;\n  }\n\n}, 0);\nlet Session;\nmodule.link(\"meteor/session\", {\n  Session(v) {\n    Session = v;\n  }\n\n}, 1);\nlet Random;\nmodule.link(\"meteor/random\", {\n  Random(v) {\n    Random = v;\n  }\n\n}, 2);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 3);\nlet settings;\nmodule.link(\"../../../settings/client\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 4);\nlet UserAction, USER_ACTIVITIES;\nmodule.link(\"../index\", {\n  UserAction(v) {\n    UserAction = v;\n  },\n\n  USER_ACTIVITIES(v) {\n    USER_ACTIVITIES = v;\n  }\n\n}, 5);\nlet fileUploadIsValidContentType, APIClient;\nmodule.link(\"../../../utils\", {\n  fileUploadIsValidContentType(v) {\n    fileUploadIsValidContentType = v;\n  },\n\n  APIClient(v) {\n    APIClient = v;\n  }\n\n}, 6);\nlet imperativeModal;\nmodule.link(\"../../../../client/lib/imperativeModal\", {\n  imperativeModal(v) {\n    imperativeModal = v;\n  }\n\n}, 7);\nlet FileUploadModal;\nmodule.link(\"../../../../client/views/room/modals/FileUploadModal\", {\n  default(v) {\n    FileUploadModal = v;\n  }\n\n}, 8);\nlet prependReplies;\nmodule.link(\"../../../../client/lib/utils/prependReplies\", {\n  prependReplies(v) {\n    prependReplies = v;\n  }\n\n}, 9);\nlet chatMessages;\nmodule.link(\"../views/app/room\", {\n  chatMessages(v) {\n    chatMessages = v;\n  }\n\n}, 10);\n\nconst uploadFileWithMessage = async (rid, tmid, _ref) => {\n  let {\n    description,\n    fileName,\n    msg,\n    file\n  } = _ref;\n  const data = new FormData();\n  description && data.append('description', description);\n  msg && data.append('msg', msg);\n  tmid && data.append('tmid', tmid);\n  data.append('file', file.file, fileName);\n  const uploads = Session.get('uploading') || [];\n  const upload = {\n    id: Random.id(),\n    name: fileName,\n    percentage: 0\n  };\n  uploads.push(upload);\n  Session.set('uploading', uploads);\n  const {\n    xhr,\n    promise\n  } = APIClient.upload(\"v1/rooms.upload/\".concat(rid), {}, data, {\n    progress(progress) {\n      const uploads = Session.get('uploading') || [];\n\n      if (progress === 100) {\n        return;\n      }\n\n      uploads.filter(u => u.id === upload.id).forEach(u => {\n        u.percentage = Math.round(progress) || 0;\n      });\n      Session.set('uploading', uploads);\n    },\n\n    error(error) {\n      const uploads = Session.get('uploading') || [];\n      uploads.filter(u => u.id === upload.id).forEach(u => {\n        u.error = error.message;\n        u.percentage = 0;\n      });\n      Session.set('uploading', uploads);\n    }\n\n  });\n\n  if (Session.get('uploading').length) {\n    UserAction.performContinuously(rid, USER_ACTIVITIES.USER_UPLOADING, {\n      tmid\n    });\n  }\n\n  Tracker.autorun(computation => {\n    const isCanceling = Session.get(\"uploading-cancel-\".concat(upload.id));\n\n    if (!isCanceling) {\n      return;\n    }\n\n    computation.stop();\n    Session.delete(\"uploading-cancel-\".concat(upload.id));\n    xhr.abort();\n    const uploads = Session.get('uploading') || {};\n    Session.set('uploading', uploads.filter(u => u.id !== upload.id));\n  });\n\n  try {\n    await promise;\n    const uploads = Session.get('uploading') || [];\n    const remainingUploads = Session.set('uploading', uploads.filter(u => u.id !== upload.id));\n\n    if (!Session.get('uploading').length) {\n      UserAction.stop(rid, USER_ACTIVITIES.USER_UPLOADING, {\n        tmid\n      });\n    }\n\n    return remainingUploads;\n  } catch (error) {\n    const uploads = Session.get('uploading') || [];\n    uploads.filter(u => u.id === upload.id).forEach(u => {\n      u.error = error.xhr && error.xhr.responseJSON && error.xhr.responseJSON.error || error.message;\n      u.percentage = 0;\n    });\n\n    if (!uploads.length) {\n      UserAction.stop(rid, USER_ACTIVITIES.USER_UPLOADING, {\n        tmid\n      });\n    }\n\n    Session.set('uploading', uploads);\n  }\n};\n\nconst fileUpload = async (files, input, _ref2) => {\n  let {\n    rid,\n    tmid\n  } = _ref2;\n  const threadsEnabled = settings.get('Threads_enabled');\n  files = [].concat(files);\n  const replies = $(input).data('reply') || [];\n  const mention = $(input).data('mention-user') || false;\n  let msg = '';\n\n  if (!mention || !threadsEnabled) {\n    msg = await prependReplies('', replies, mention);\n  }\n\n  if (mention && threadsEnabled && replies.length) {\n    tmid = replies[0]._id;\n  }\n\n  const key = ['messagebox', rid, tmid].filter(Boolean).join('_');\n  const messageBoxText = Meteor._localStorage.getItem(key) || '';\n\n  const uploadNextFile = () => {\n    const file = files.pop();\n\n    if (!file) {\n      return;\n    }\n\n    imperativeModal.open({\n      component: FileUploadModal,\n      props: {\n        file: file.file,\n        fileName: file.name,\n        fileDescription: messageBoxText,\n        onClose: () => {\n          imperativeModal.close();\n          uploadNextFile();\n        },\n        onSubmit: (fileName, description) => {\n          uploadFileWithMessage(rid, tmid, {\n            description,\n            fileName,\n            msg: msg || undefined,\n            file\n          });\n          const localStorageKey = ['messagebox', rid, tmid].filter(Boolean).join('_');\n          const chatMessageKey = [rid, tmid].filter(Boolean).join('-');\n          const {\n            input\n          } = chatMessages[chatMessageKey];\n          input.value = null;\n          $(input).trigger('input');\n\n          Meteor._localStorage.removeItem(localStorageKey);\n\n          imperativeModal.close();\n          uploadNextFile();\n        },\n        invalidContentType: file.file.type && !fileUploadIsValidContentType(file.file.type)\n      }\n    });\n  };\n\n  uploadNextFile();\n};","map":{"version":3,"sources":["app/ui/client/lib/fileUpload.js"],"names":["module","export","uploadFileWithMessage","fileUpload","Tracker","link","v","Session","Random","Meteor","settings","UserAction","USER_ACTIVITIES","fileUploadIsValidContentType","APIClient","imperativeModal","FileUploadModal","default","prependReplies","chatMessages","rid","tmid","description","fileName","msg","file","data","FormData","append","uploads","get","upload","id","name","percentage","push","set","xhr","promise","progress","filter","u","forEach","Math","round","error","message","length","performContinuously","USER_UPLOADING","autorun","computation","isCanceling","stop","delete","abort","remainingUploads","responseJSON","files","input","threadsEnabled","concat","replies","$","mention","_id","key","Boolean","join","messageBoxText","_localStorage","getItem","uploadNextFile","pop","open","component","props","fileDescription","onClose","close","onSubmit","undefined","localStorageKey","chatMessageKey","value","trigger","removeItem","invalidContentType","type"],"mappings":"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","sourcesContent":["import { Tracker } from 'meteor/tracker';\nimport { Session } from 'meteor/session';\nimport { Random } from 'meteor/random';\nimport { Meteor } from 'meteor/meteor';\n\nimport { settings } from '../../../settings/client';\nimport { UserAction, USER_ACTIVITIES } from '../index';\nimport { fileUploadIsValidContentType, APIClient } from '../../../utils';\nimport { imperativeModal } from '../../../../client/lib/imperativeModal';\nimport FileUploadModal from '../../../../client/views/room/modals/FileUploadModal';\nimport { prependReplies } from '../../../../client/lib/utils/prependReplies';\nimport { chatMessages } from '../views/app/room';\n\nexport const uploadFileWithMessage = async (rid, tmid, { description, fileName, msg, file }) => {\n\tconst data = new FormData();\n\tdescription && data.append('description', description);\n\tmsg && data.append('msg', msg);\n\ttmid && data.append('tmid', tmid);\n\tdata.append('file', file.file, fileName);\n\n\tconst uploads = Session.get('uploading') || [];\n\n\tconst upload = {\n\t\tid: Random.id(),\n\t\tname: fileName,\n\t\tpercentage: 0,\n\t};\n\n\tuploads.push(upload);\n\tSession.set('uploading', uploads);\n\n\tconst { xhr, promise } = APIClient.upload(`v1/rooms.upload/${rid}`, {}, data, {\n\t\tprogress(progress) {\n\t\t\tconst uploads = Session.get('uploading') || [];\n\n\t\t\tif (progress === 100) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tuploads\n\t\t\t\t.filter((u) => u.id === upload.id)\n\t\t\t\t.forEach((u) => {\n\t\t\t\t\tu.percentage = Math.round(progress) || 0;\n\t\t\t\t});\n\t\t\tSession.set('uploading', uploads);\n\t\t},\n\t\terror(error) {\n\t\t\tconst uploads = Session.get('uploading') || [];\n\t\t\tuploads\n\t\t\t\t.filter((u) => u.id === upload.id)\n\t\t\t\t.forEach((u) => {\n\t\t\t\t\tu.error = error.message;\n\t\t\t\t\tu.percentage = 0;\n\t\t\t\t});\n\t\t\tSession.set('uploading', uploads);\n\t\t},\n\t});\n\tif (Session.get('uploading').length) {\n\t\tUserAction.performContinuously(rid, USER_ACTIVITIES.USER_UPLOADING, { tmid });\n\t}\n\n\tTracker.autorun((computation) => {\n\t\tconst isCanceling = Session.get(`uploading-cancel-${upload.id}`);\n\t\tif (!isCanceling) {\n\t\t\treturn;\n\t\t}\n\t\tcomputation.stop();\n\t\tSession.delete(`uploading-cancel-${upload.id}`);\n\n\t\txhr.abort();\n\n\t\tconst uploads = Session.get('uploading') || {};\n\t\tSession.set(\n\t\t\t'uploading',\n\t\t\tuploads.filter((u) => u.id !== upload.id),\n\t\t);\n\t});\n\n\ttry {\n\t\tawait promise;\n\t\tconst uploads = Session.get('uploading') || [];\n\t\tconst remainingUploads = Session.set(\n\t\t\t'uploading',\n\t\t\tuploads.filter((u) => u.id !== upload.id),\n\t\t);\n\n\t\tif (!Session.get('uploading').length) {\n\t\t\tUserAction.stop(rid, USER_ACTIVITIES.USER_UPLOADING, { tmid });\n\t\t}\n\t\treturn remainingUploads;\n\t} catch (error) {\n\t\tconst uploads = Session.get('uploading') || [];\n\t\tuploads\n\t\t\t.filter((u) => u.id === upload.id)\n\t\t\t.forEach((u) => {\n\t\t\t\tu.error = (error.xhr && error.xhr.responseJSON && error.xhr.responseJSON.error) || error.message;\n\t\t\t\tu.percentage = 0;\n\t\t\t});\n\t\tif (!uploads.length) {\n\t\t\tUserAction.stop(rid, USER_ACTIVITIES.USER_UPLOADING, { tmid });\n\t\t}\n\t\tSession.set('uploading', uploads);\n\t}\n};\n\nexport const fileUpload = async (files, input, { rid, tmid }) => {\n\tconst threadsEnabled = settings.get('Threads_enabled');\n\n\tfiles = [].concat(files);\n\n\tconst replies = $(input).data('reply') || [];\n\tconst mention = $(input).data('mention-user') || false;\n\n\tlet msg = '';\n\n\tif (!mention || !threadsEnabled) {\n\t\tmsg = await prependReplies('', replies, mention);\n\t}\n\n\tif (mention && threadsEnabled && replies.length) {\n\t\ttmid = replies[0]._id;\n\t}\n\n\tconst key = ['messagebox', rid, tmid].filter(Boolean).join('_');\n\tconst messageBoxText = Meteor._localStorage.getItem(key) || '';\n\n\tconst uploadNextFile = () => {\n\t\tconst file = files.pop();\n\t\tif (!file) {\n\t\t\treturn;\n\t\t}\n\n\t\timperativeModal.open({\n\t\t\tcomponent: FileUploadModal,\n\t\t\tprops: {\n\t\t\t\tfile: file.file,\n\t\t\t\tfileName: file.name,\n\t\t\t\tfileDescription: messageBoxText,\n\t\t\t\tonClose: () => {\n\t\t\t\t\timperativeModal.close();\n\t\t\t\t\tuploadNextFile();\n\t\t\t\t},\n\t\t\t\tonSubmit: (fileName, description) => {\n\t\t\t\t\tuploadFileWithMessage(rid, tmid, {\n\t\t\t\t\t\tdescription,\n\t\t\t\t\t\tfileName,\n\t\t\t\t\t\tmsg: msg || undefined,\n\t\t\t\t\t\tfile,\n\t\t\t\t\t});\n\t\t\t\t\tconst localStorageKey = ['messagebox', rid, tmid].filter(Boolean).join('_');\n\t\t\t\t\tconst chatMessageKey = [rid, tmid].filter(Boolean).join('-');\n\t\t\t\t\tconst { input } = chatMessages[chatMessageKey];\n\t\t\t\t\tinput.value = null;\n\t\t\t\t\t$(input).trigger('input');\n\t\t\t\t\tMeteor._localStorage.removeItem(localStorageKey);\n\t\t\t\t\timperativeModal.close();\n\t\t\t\t\tuploadNextFile();\n\t\t\t\t},\n\t\t\t\tinvalidContentType: file.file.type && !fileUploadIsValidContentType(file.file.type),\n\t\t\t},\n\t\t});\n\t};\n\n\tuploadNextFile();\n};\n"]},"sourceType":"module","hash":"f818ab1a2b85195648e988ba1908711ac93bf77a"}
