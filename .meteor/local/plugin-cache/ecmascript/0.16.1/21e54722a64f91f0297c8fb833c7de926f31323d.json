{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/imports/client/map-age-cleaner/dist/index.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"imports/client/map-age-cleaner/dist/index.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/imports/client/map-age-cleaner/dist/index.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{}},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/imports/client/map-age-cleaner/dist/index.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"imports/client/map-age-cleaner/dist/index.js"}},"code":"\"use strict\";\n\n!function (module1) {\n  var _createForOfIteratorHelperLoose;\n\n  module1.link(\"@babel/runtime/helpers/createForOfIteratorHelperLoose\", {\n    default: function (v) {\n      _createForOfIteratorHelperLoose = v;\n    }\n  }, 0);\n\n  var _regeneratorRuntime;\n\n  module1.link(\"@babel/runtime/regenerator\", {\n    default: function (v) {\n      _regeneratorRuntime = v;\n    }\n  }, 1);\n\n  var __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n    return new (P || (P = Promise))(function (resolve, reject) {\n      function fulfilled(value) {\n        try {\n          step(generator.next(value));\n        } catch (e) {\n          reject(e);\n        }\n      }\n\n      function rejected(value) {\n        try {\n          step(generator[\"throw\"](value));\n        } catch (e) {\n          reject(e);\n        }\n      }\n\n      function step(result) {\n        result.done ? resolve(result.value) : new P(function (resolve) {\n          resolve(result.value);\n        }).then(fulfilled, rejected);\n      }\n\n      step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n  };\n\n  var __importDefault = this && this.__importDefault || function (mod) {\n    return mod && mod.__esModule ? mod : {\n      \"default\": mod\n    };\n  };\n\n  Object.defineProperty(exports, \"__esModule\", {\n    value: true\n  });\n\n  var p_defer_1 = __importDefault(require(\"p-defer\"));\n\n  function mapAgeCleaner(map) {\n    var _this = this;\n\n    var property = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 'maxAge';\n    var processingKey;\n    var processingTimer;\n    var processingDeferred;\n\n    var cleanup = function () {\n      return __awaiter(_this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function () {\n        function _callee2() {\n          var _this2 = this;\n\n          var setupTimer, _iterator, _step, entry;\n\n          return _regeneratorRuntime.wrap(function () {\n            function _callee2$(_context2) {\n              while (1) {\n                switch (_context2.prev = _context2.next) {\n                  case 0:\n                    if (!(processingKey !== undefined)) {\n                      _context2.next = 2;\n                      break;\n                    }\n\n                    return _context2.abrupt(\"return\");\n\n                  case 2:\n                    setupTimer = function (item) {\n                      return __awaiter(_this2, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function () {\n                        function _callee() {\n                          var delay;\n                          return _regeneratorRuntime.wrap(function () {\n                            function _callee$(_context) {\n                              while (1) {\n                                switch (_context.prev = _context.next) {\n                                  case 0:\n                                    processingDeferred = p_defer_1.default();\n                                    delay = item[1][property] - Date.now();\n\n                                    if (!(delay <= 0)) {\n                                      _context.next = 6;\n                                      break;\n                                    }\n\n                                    // Remove the item immediately if the delay is equal to or below 0\n                                    map.delete(item[0]);\n                                    processingDeferred.resolve();\n                                    return _context.abrupt(\"return\");\n\n                                  case 6:\n                                    // Keep track of the current processed key\n                                    processingKey = item[0];\n                                    processingTimer = setTimeout(function () {\n                                      // Remove the item when the timeout fires\n                                      map.delete(item[0]);\n\n                                      if (processingDeferred) {\n                                        processingDeferred.resolve();\n                                      }\n                                    }, delay); // tslint:disable-next-line:strict-type-predicates\n\n                                    if (typeof processingTimer.unref === 'function') {\n                                      // Don't hold up the process from exiting\n                                      processingTimer.unref();\n                                    }\n\n                                    return _context.abrupt(\"return\", processingDeferred.promise);\n\n                                  case 10:\n                                  case \"end\":\n                                    return _context.stop();\n                                }\n                              }\n                            }\n\n                            return _callee$;\n                          }(), _callee);\n                        }\n\n                        return _callee;\n                      }()));\n                    };\n\n                    _context2.prev = 3;\n                    _iterator = _createForOfIteratorHelperLoose(map);\n\n                  case 5:\n                    if ((_step = _iterator()).done) {\n                      _context2.next = 11;\n                      break;\n                    }\n\n                    entry = _step.value;\n                    _context2.next = 9;\n                    return setupTimer(entry);\n\n                  case 9:\n                    _context2.next = 5;\n                    break;\n\n                  case 11:\n                    _context2.next = 15;\n                    break;\n\n                  case 13:\n                    _context2.prev = 13;\n                    _context2.t0 = _context2[\"catch\"](3);\n\n                  case 15:\n                    processingKey = undefined;\n\n                  case 16:\n                  case \"end\":\n                    return _context2.stop();\n                }\n              }\n            }\n\n            return _callee2$;\n          }(), _callee2, null, [[3, 13]]);\n        }\n\n        return _callee2;\n      }()));\n    };\n\n    var reset = function () {\n      processingKey = undefined;\n\n      if (processingTimer !== undefined) {\n        clearTimeout(processingTimer);\n        processingTimer = undefined;\n      }\n\n      if (processingDeferred !== undefined) {\n        // tslint:disable-line:early-exit\n        processingDeferred.reject(undefined);\n        processingDeferred = undefined;\n      }\n    };\n\n    var originalSet = map.set.bind(map);\n\n    map.set = function (key, value) {\n      if (map.has(key)) {\n        // If the key already exist, remove it so we can add it back at the end of the map.\n        map.delete(key);\n      } // Call the original `map.set`\n\n\n      var result = originalSet(key, value); // If we are already processing a key and the key added is the current processed key, stop processing it\n\n      if (processingKey && processingKey === key) {\n        reset();\n      } // Always run the cleanup method in case it wasn't started yet\n\n\n      cleanup(); // tslint:disable-line:no-floating-promises\n\n      return result;\n    };\n\n    cleanup(); // tslint:disable-line:no-floating-promises\n\n    return map;\n  }\n\n  exports.default = mapAgeCleaner; // Add support for CJS\n\n  module.exports = mapAgeCleaner;\n  module.exports.default = mapAgeCleaner;\n}.call(this, module);","map":{"version":3,"sources":["imports/client/map-age-cleaner/dist/index.js"],"names":["_createForOfIteratorHelperLoose","module1","link","default","v","_regeneratorRuntime","__awaiter","thisArg","_arguments","P","generator","Promise","resolve","reject","fulfilled","value","step","next","e","rejected","result","done","then","apply","__importDefault","mod","__esModule","Object","defineProperty","exports","p_defer_1","require","mapAgeCleaner","map","property","processingKey","processingTimer","processingDeferred","cleanup","undefined","setupTimer","item","delay","Date","now","delete","setTimeout","unref","promise","entry","reset","clearTimeout","originalSet","set","bind","key","has","module"],"mappings":"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","sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst p_defer_1 = __importDefault(require(\"p-defer\"));\nfunction mapAgeCleaner(map, property = 'maxAge') {\n    let processingKey;\n    let processingTimer;\n    let processingDeferred;\n    const cleanup = () => __awaiter(this, void 0, void 0, function* () {\n        if (processingKey !== undefined) {\n            // If we are already processing an item, we can safely exit\n            return;\n        }\n        const setupTimer = (item) => __awaiter(this, void 0, void 0, function* () {\n            processingDeferred = p_defer_1.default();\n            const delay = item[1][property] - Date.now();\n            if (delay <= 0) {\n                // Remove the item immediately if the delay is equal to or below 0\n                map.delete(item[0]);\n                processingDeferred.resolve();\n                return;\n            }\n            // Keep track of the current processed key\n            processingKey = item[0];\n            processingTimer = setTimeout(() => {\n                // Remove the item when the timeout fires\n                map.delete(item[0]);\n                if (processingDeferred) {\n                    processingDeferred.resolve();\n                }\n            }, delay);\n            // tslint:disable-next-line:strict-type-predicates\n            if (typeof processingTimer.unref === 'function') {\n                // Don't hold up the process from exiting\n                processingTimer.unref();\n            }\n            return processingDeferred.promise;\n        });\n        try {\n            for (const entry of map) {\n                yield setupTimer(entry);\n            }\n        }\n        catch (_a) {\n            // Do nothing if an error occurs, this means the timer was cleaned up and we should stop processing\n        }\n        processingKey = undefined;\n    });\n    const reset = () => {\n        processingKey = undefined;\n        if (processingTimer !== undefined) {\n            clearTimeout(processingTimer);\n            processingTimer = undefined;\n        }\n        if (processingDeferred !== undefined) { // tslint:disable-line:early-exit\n            processingDeferred.reject(undefined);\n            processingDeferred = undefined;\n        }\n    };\n    const originalSet = map.set.bind(map);\n    map.set = (key, value) => {\n        if (map.has(key)) {\n            // If the key already exist, remove it so we can add it back at the end of the map.\n            map.delete(key);\n        }\n        // Call the original `map.set`\n        const result = originalSet(key, value);\n        // If we are already processing a key and the key added is the current processed key, stop processing it\n        if (processingKey && processingKey === key) {\n            reset();\n        }\n        // Always run the cleanup method in case it wasn't started yet\n        cleanup(); // tslint:disable-line:no-floating-promises\n        return result;\n    };\n    cleanup(); // tslint:disable-line:no-floating-promises\n    return map;\n}\nexports.default = mapAgeCleaner;\n// Add support for CJS\nmodule.exports = mapAgeCleaner;\nmodule.exports.default = mapAgeCleaner;\n"]},"sourceType":"module","hash":"21e54722a64f91f0297c8fb833c7de926f31323d"}
