{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/livechat/client/views/app/tabbar/visitorForward.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"app/livechat/client/views/app/tabbar/visitorForward.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/livechat/client/views/app/tabbar/visitorForward.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{}},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/livechat/client/views/app/tabbar/visitorForward.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/livechat/client/views/app/tabbar/visitorForward.js"}},"code":"var _regeneratorRuntime;\n\nmodule.link(\"@babel/runtime/regenerator\", {\n  default: function (v) {\n    _regeneratorRuntime = v;\n  }\n}, 0);\n\nvar _slicedToArray;\n\nmodule.link(\"@babel/runtime/helpers/slicedToArray\", {\n  default: function (v) {\n    _slicedToArray = v;\n  }\n}, 1);\n\nvar _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default: function (v) {\n    _objectSpread = v;\n  }\n}, 2);\nvar Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 0);\nvar ReactiveVar;\nmodule.link(\"meteor/reactive-var\", {\n  ReactiveVar: function (v) {\n    ReactiveVar = v;\n  }\n}, 1);\nvar FlowRouter;\nmodule.link(\"meteor/kadira:flow-router\", {\n  FlowRouter: function (v) {\n    FlowRouter = v;\n  }\n}, 2);\nvar Template;\nmodule.link(\"meteor/templating\", {\n  Template: function (v) {\n    Template = v;\n  }\n}, 3);\nvar ChatRoom;\nmodule.link(\"../../../../../models\", {\n  ChatRoom: function (v) {\n    ChatRoom = v;\n  }\n}, 4);\nvar t;\nmodule.link(\"../../../../../utils\", {\n  t: function (v) {\n    t = v;\n  }\n}, 5);\nmodule.link(\"./visitorForward.html\");\nvar APIClient;\nmodule.link(\"../../../../../utils/client\", {\n  APIClient: function (v) {\n    APIClient = v;\n  }\n}, 6);\nvar dispatchToastMessage;\nmodule.link(\"../../../../../../client/lib/toast\", {\n  dispatchToastMessage: function (v) {\n    dispatchToastMessage = v;\n  }\n}, 7);\nTemplate.visitorForward.helpers({\n  visitor: function () {\n    return Template.instance().visitor.get();\n  },\n  agentName: function () {\n    return this.name || this.username;\n  },\n  onSelectAgents: function () {\n    return Template.instance().onSelectAgents;\n  },\n  agentModifier: function () {\n    return function (filter) {\n      var text = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : '';\n      var f = filter.get();\n      return \"@\" + (f.length === 0 ? text : text.replace(new RegExp(filter.get()), function (part) {\n        return \"<strong>\" + part + \"</strong>\";\n      }));\n    };\n  },\n  agentConditions: function () {\n    var room = Template.instance().room.get();\n\n    var _ref = room || {},\n        _ref$servedBy = _ref.servedBy;\n\n    _ref$servedBy = _ref$servedBy === void 0 ? {} : _ref$servedBy;\n    var agentId = _ref$servedBy._id;\n\n    var _id = agentId && {\n      $ne: agentId\n    };\n\n    return {\n      _id: _id,\n      status: {\n        $ne: 'offline'\n      },\n      statusLivechat: 'available'\n    };\n  },\n  selectedAgents: function () {\n    return Template.instance().selectedAgents.get();\n  },\n  onClickTagAgent: function () {\n    return Template.instance().onClickTagAgent;\n  },\n  departmentModifier: function () {\n    return function (filter) {\n      var text = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : '';\n      var f = filter.get();\n      return \"\" + (f.length === 0 ? text : text.replace(new RegExp(filter.get(), 'i'), function (part) {\n        return \"<strong>\" + part + \"</strong>\";\n      }));\n    };\n  },\n  onClickTagDepartment: function () {\n    return Template.instance().onClickTagDepartment;\n  },\n  selectedDepartments: function () {\n    return Template.instance().selectedDepartments.get();\n  },\n  onSelectDepartments: function () {\n    return Template.instance().onSelectDepartments;\n  },\n  departmentConditions: function () {\n    var departmentForwardRestrictions = Template.instance().departmentForwardRestrictions.get();\n    return _objectSpread({\n      enabled: true,\n      numAgents: {\n        $gt: 0\n      }\n    }, departmentForwardRestrictions);\n  }\n});\nTemplate.visitorForward.onCreated(function () {\n  function _callee() {\n    var _this = this;\n\n    var _await$APIClient$v1$g, departments;\n\n    return _regeneratorRuntime.async(function () {\n      function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              this.visitor = new ReactiveVar();\n              this.room = new ReactiveVar();\n              this.departments = new ReactiveVar([]);\n              this.selectedAgents = new ReactiveVar([]);\n              this.selectedDepartments = new ReactiveVar([]);\n              this.departmentForwardRestrictions = new ReactiveVar({});\n\n              this.onSelectDepartments = function (_ref2) {\n                var department = _ref2.item;\n                department.text = department.name;\n\n                _this.selectedDepartments.set([department]);\n\n                _this.selectedAgents.set([]);\n              };\n\n              this.onClickTagDepartment = function () {\n                _this.selectedDepartments.set([]);\n              };\n\n              this.onSelectAgents = function (_ref3) {\n                var agent = _ref3.item;\n\n                _this.selectedAgents.set([agent]);\n\n                _this.selectedDepartments.set([]);\n              };\n\n              this.onClickTagAgent = function (_ref4) {\n                var username = _ref4.username;\n\n                _this.selectedAgents.set(_this.selectedAgents.get().filter(function (user) {\n                  return user.username !== username;\n                }));\n              };\n\n              this.autorun(function () {\n                _this.visitor.set(Meteor.users.findOne({\n                  _id: Template.currentData().visitorId\n                }));\n              });\n              this.autorun(function () {\n                _this.room.set(ChatRoom.findOne({\n                  _id: Template.currentData().roomId\n                }));\n\n                var _this$room$get = _this.room.get(),\n                    departmentId = _this$room$get.departmentId;\n\n                if (departmentId) {\n                  Meteor.call('livechat:getDepartmentForwardRestrictions', departmentId, function (err, result) {\n                    _this.departmentForwardRestrictions.set(result);\n                  });\n                }\n              });\n              _context.next = 14;\n              return _regeneratorRuntime.awrap(APIClient.v1.get('livechat/department?enabled=true'));\n\n            case 14:\n              _await$APIClient$v1$g = _context.sent;\n              departments = _await$APIClient$v1$g.departments;\n              this.departments.set(departments);\n\n            case 17:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }\n\n      return _callee$;\n    }(), null, this, null, Promise);\n  }\n\n  return _callee;\n}());\nTemplate.visitorForward.events({\n  'submit form': function (event, instance) {\n    var _this2 = this;\n\n    event.preventDefault();\n    var transferData = {\n      roomId: instance.room.get()._id,\n      comment: event.target.comment.value,\n      clientAction: true\n    };\n\n    var _instance$selectedAge = instance.selectedAgents.get(),\n        _instance$selectedAge2 = _slicedToArray(_instance$selectedAge, 1),\n        user = _instance$selectedAge2[0];\n\n    if (user) {\n      transferData.userId = user._id;\n    } else if (instance.selectedDepartments.get()) {\n      var _instance$selectedDep = instance.selectedDepartments.get(),\n          _instance$selectedDep2 = _slicedToArray(_instance$selectedDep, 1),\n          department = _instance$selectedDep2[0];\n\n      transferData.departmentId = department && department._id;\n    }\n\n    if (!transferData.userId && !transferData.departmentId) {\n      return;\n    }\n\n    Meteor.call('livechat:transfer', transferData, function (error, result) {\n      if (error) {\n        dispatchToastMessage({\n          type: 'error',\n          message: t(error.error)\n        });\n      } else if (result) {\n        _this2.save();\n\n        dispatchToastMessage({\n          type: 'success',\n          message: t('Transferred')\n        });\n        FlowRouter.go('/');\n      } else {\n        dispatchToastMessage({\n          type: 'warning',\n          message: t('No_available_agents_to_transfer')\n        });\n      }\n    });\n  },\n  'click .cancel': function (event) {\n    event.preventDefault();\n    this.cancel();\n  }\n});","map":{"version":3,"sources":["app/livechat/client/views/app/tabbar/visitorForward.js"],"names":["_regeneratorRuntime","module","link","default","v","_slicedToArray","_objectSpread","Meteor","ReactiveVar","FlowRouter","Template","ChatRoom","t","APIClient","dispatchToastMessage","visitorForward","helpers","visitor","instance","get","agentName","name","username","onSelectAgents","agentModifier","filter","text","f","length","replace","RegExp","part","agentConditions","room","servedBy","agentId","_id","$ne","status","statusLivechat","selectedAgents","onClickTagAgent","departmentModifier","onClickTagDepartment","selectedDepartments","onSelectDepartments","departmentConditions","departmentForwardRestrictions","enabled","numAgents","$gt","onCreated","departments","department","item","set","agent","user","autorun","users","findOne","currentData","visitorId","roomId","departmentId","call","err","result","v1","events","event","preventDefault","transferData","comment","target","value","clientAction","userId","error","type","message","save","go","cancel"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { ReactiveVar } from 'meteor/reactive-var';\nimport { FlowRouter } from 'meteor/kadira:flow-router';\nimport { Template } from 'meteor/templating';\n\nimport { ChatRoom } from '../../../../../models';\nimport { t } from '../../../../../utils';\nimport './visitorForward.html';\nimport { APIClient } from '../../../../../utils/client';\nimport { dispatchToastMessage } from '../../../../../../client/lib/toast';\n\nTemplate.visitorForward.helpers({\n\tvisitor() {\n\t\treturn Template.instance().visitor.get();\n\t},\n\tagentName() {\n\t\treturn this.name || this.username;\n\t},\n\tonSelectAgents() {\n\t\treturn Template.instance().onSelectAgents;\n\t},\n\tagentModifier() {\n\t\treturn (filter, text = '') => {\n\t\t\tconst f = filter.get();\n\t\t\treturn `@${f.length === 0 ? text : text.replace(new RegExp(filter.get()), (part) => `<strong>${part}</strong>`)}`;\n\t\t};\n\t},\n\tagentConditions() {\n\t\tconst room = Template.instance().room.get();\n\t\tconst { servedBy: { _id: agentId } = {} } = room || {};\n\t\tconst _id = agentId && { $ne: agentId };\n\t\treturn { _id, status: { $ne: 'offline' }, statusLivechat: 'available' };\n\t},\n\tselectedAgents() {\n\t\treturn Template.instance().selectedAgents.get();\n\t},\n\tonClickTagAgent() {\n\t\treturn Template.instance().onClickTagAgent;\n\t},\n\tdepartmentModifier() {\n\t\treturn (filter, text = '') => {\n\t\t\tconst f = filter.get();\n\t\t\treturn `${f.length === 0 ? text : text.replace(new RegExp(filter.get(), 'i'), (part) => `<strong>${part}</strong>`)}`;\n\t\t};\n\t},\n\tonClickTagDepartment() {\n\t\treturn Template.instance().onClickTagDepartment;\n\t},\n\tselectedDepartments() {\n\t\treturn Template.instance().selectedDepartments.get();\n\t},\n\tonSelectDepartments() {\n\t\treturn Template.instance().onSelectDepartments;\n\t},\n\tdepartmentConditions() {\n\t\tconst departmentForwardRestrictions = Template.instance().departmentForwardRestrictions.get();\n\t\treturn { enabled: true, numAgents: { $gt: 0 }, ...departmentForwardRestrictions };\n\t},\n});\n\nTemplate.visitorForward.onCreated(async function () {\n\tthis.visitor = new ReactiveVar();\n\tthis.room = new ReactiveVar();\n\tthis.departments = new ReactiveVar([]);\n\tthis.selectedAgents = new ReactiveVar([]);\n\tthis.selectedDepartments = new ReactiveVar([]);\n\tthis.departmentForwardRestrictions = new ReactiveVar({});\n\n\tthis.onSelectDepartments = ({ item: department }) => {\n\t\tdepartment.text = department.name;\n\t\tthis.selectedDepartments.set([department]);\n\t\tthis.selectedAgents.set([]);\n\t};\n\n\tthis.onClickTagDepartment = () => {\n\t\tthis.selectedDepartments.set([]);\n\t};\n\n\tthis.onSelectAgents = ({ item: agent }) => {\n\t\tthis.selectedAgents.set([agent]);\n\t\tthis.selectedDepartments.set([]);\n\t};\n\n\tthis.onClickTagAgent = ({ username }) => {\n\t\tthis.selectedAgents.set(this.selectedAgents.get().filter((user) => user.username !== username));\n\t};\n\n\tthis.autorun(() => {\n\t\tthis.visitor.set(Meteor.users.findOne({ _id: Template.currentData().visitorId }));\n\t});\n\n\tthis.autorun(() => {\n\t\tthis.room.set(ChatRoom.findOne({ _id: Template.currentData().roomId }));\n\t\tconst { departmentId } = this.room.get();\n\t\tif (departmentId) {\n\t\t\tMeteor.call('livechat:getDepartmentForwardRestrictions', departmentId, (err, result) => {\n\t\t\t\tthis.departmentForwardRestrictions.set(result);\n\t\t\t});\n\t\t}\n\t});\n\n\tconst { departments } = await APIClient.v1.get('livechat/department?enabled=true');\n\tthis.departments.set(departments);\n});\n\nTemplate.visitorForward.events({\n\t'submit form'(event, instance) {\n\t\tevent.preventDefault();\n\n\t\tconst transferData = {\n\t\t\troomId: instance.room.get()._id,\n\t\t\tcomment: event.target.comment.value,\n\t\t\tclientAction: true,\n\t\t};\n\n\t\tconst [user] = instance.selectedAgents.get();\n\t\tif (user) {\n\t\t\ttransferData.userId = user._id;\n\t\t} else if (instance.selectedDepartments.get()) {\n\t\t\tconst [department] = instance.selectedDepartments.get();\n\t\t\ttransferData.departmentId = department && department._id;\n\t\t}\n\n\t\tif (!transferData.userId && !transferData.departmentId) {\n\t\t\treturn;\n\t\t}\n\n\t\tMeteor.call('livechat:transfer', transferData, (error, result) => {\n\t\t\tif (error) {\n\t\t\t\tdispatchToastMessage({\n\t\t\t\t\ttype: 'error',\n\t\t\t\t\tmessage: t(error.error),\n\t\t\t\t});\n\t\t\t} else if (result) {\n\t\t\t\tthis.save();\n\t\t\t\tdispatchToastMessage({\n\t\t\t\t\ttype: 'success',\n\t\t\t\t\tmessage: t('Transferred'),\n\t\t\t\t});\n\t\t\t\tFlowRouter.go('/');\n\t\t\t} else {\n\t\t\t\tdispatchToastMessage({\n\t\t\t\t\ttype: 'warning',\n\t\t\t\t\tmessage: t('No_available_agents_to_transfer'),\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t},\n\n\t'click .cancel'(event) {\n\t\tevent.preventDefault();\n\n\t\tthis.cancel();\n\t},\n});\n"]},"sourceType":"module","hash":"ecbb9295837fa605078a0c3966d5afce114bdff2"}
