{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/views/admin/import/ImportProgressPage.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"client/views/admin/import/ImportProgressPage.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/views/admin/import/ImportProgressPage.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{}},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/views/admin/import/ImportProgressPage.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/views/admin/import/ImportProgressPage.js"}},"code":"var _regeneratorRuntime;\n\nmodule.link(\"@babel/runtime/regenerator\", {\n  default: function (v) {\n    _regeneratorRuntime = v;\n  }\n}, 0);\n\nvar _slicedToArray;\n\nmodule.link(\"@babel/runtime/helpers/slicedToArray\", {\n  default: function (v) {\n    _slicedToArray = v;\n  }\n}, 1);\nvar Box, Margins, Throbber;\nmodule.link(\"@rocket.chat/fuselage\", {\n  Box: function (v) {\n    Box = v;\n  },\n  Margins: function (v) {\n    Margins = v;\n  },\n  Throbber: function (v) {\n    Throbber = v;\n  }\n}, 0);\nvar useSafely;\nmodule.link(\"@rocket.chat/fuselage-hooks\", {\n  useSafely: function (v) {\n    useSafely = v;\n  }\n}, 1);\nvar Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 2);\nvar React, useEffect, useState, useMemo;\nmodule.link(\"react\", {\n  \"default\": function (v) {\n    React = v;\n  },\n  useEffect: function (v) {\n    useEffect = v;\n  },\n  useState: function (v) {\n    useState = v;\n  },\n  useMemo: function (v) {\n    useMemo = v;\n  }\n}, 3);\nvar s;\nmodule.link(\"underscore.string\", {\n  \"default\": function (v) {\n    s = v;\n  }\n}, 4);\nvar ProgressStep, ImportingStartedStates;\nmodule.link(\"../../../../app/importer/lib/ImporterProgressStep\", {\n  ProgressStep: function (v) {\n    ProgressStep = v;\n  },\n  ImportingStartedStates: function (v) {\n    ImportingStartedStates = v;\n  }\n}, 5);\nvar Page;\nmodule.link(\"../../../components/Page\", {\n  \"default\": function (v) {\n    Page = v;\n  }\n}, 6);\nvar useRoute;\nmodule.link(\"../../../contexts/RouterContext\", {\n  useRoute: function (v) {\n    useRoute = v;\n  }\n}, 7);\nvar useEndpoint;\nmodule.link(\"../../../contexts/ServerContext\", {\n  useEndpoint: function (v) {\n    useEndpoint = v;\n  }\n}, 8);\nvar useToastMessageDispatch;\nmodule.link(\"../../../contexts/ToastMessagesContext\", {\n  useToastMessageDispatch: function (v) {\n    useToastMessageDispatch = v;\n  }\n}, 9);\nvar useTranslation;\nmodule.link(\"../../../contexts/TranslationContext\", {\n  useTranslation: function (v) {\n    useTranslation = v;\n  }\n}, 10);\nvar useErrorHandler;\nmodule.link(\"./useErrorHandler\", {\n  useErrorHandler: function (v) {\n    useErrorHandler = v;\n  }\n}, 11);\n\nfunction ImportProgressPage() {\n  var t = useTranslation();\n  var dispatchToastMessage = useToastMessageDispatch();\n  var handleError = useErrorHandler();\n\n  var _useSafely = useSafely(useState(null)),\n      _useSafely2 = _slicedToArray(_useSafely, 2),\n      importerKey = _useSafely2[0],\n      setImporterKey = _useSafely2[1];\n\n  var _useSafely3 = useSafely(useState('Loading...')),\n      _useSafely4 = _slicedToArray(_useSafely3, 2),\n      step = _useSafely4[0],\n      setStep = _useSafely4[1];\n\n  var _useSafely5 = useSafely(useState(0)),\n      _useSafely6 = _slicedToArray(_useSafely5, 2),\n      completed = _useSafely6[0],\n      setCompleted = _useSafely6[1];\n\n  var _useSafely7 = useSafely(useState(0)),\n      _useSafely8 = _slicedToArray(_useSafely7, 2),\n      total = _useSafely8[0],\n      setTotal = _useSafely8[1];\n\n  var getCurrentImportOperation = useEndpoint('GET', 'getCurrentImportOperation');\n  var getImportProgress = useEndpoint('GET', 'getImportProgress');\n  var importHistoryRoute = useRoute('admin-import');\n  var prepareImportRoute = useRoute('admin-import-prepare');\n  useEffect(function () {\n    var loadCurrentOperation = function () {\n      function _callee() {\n        var _await$getCurrentImpo, operation;\n\n        return _regeneratorRuntime.async(function () {\n          function _callee$(_context) {\n            while (1) {\n              switch (_context.prev = _context.next) {\n                case 0:\n                  _context.prev = 0;\n                  _context.next = 3;\n                  return _regeneratorRuntime.awrap(getCurrentImportOperation());\n\n                case 3:\n                  _await$getCurrentImpo = _context.sent;\n                  operation = _await$getCurrentImpo.operation;\n\n                  if (operation.valid) {\n                    _context.next = 8;\n                    break;\n                  }\n\n                  importHistoryRoute.push();\n                  return _context.abrupt(\"return\");\n\n                case 8:\n                  if (ImportingStartedStates.includes(operation.status)) {\n                    _context.next = 11;\n                    break;\n                  }\n\n                  prepareImportRoute.push();\n                  return _context.abrupt(\"return\");\n\n                case 11:\n                  setImporterKey(operation.importerKey);\n                  setCompleted(operation.count.completed);\n                  setTotal(operation.count.total);\n                  _context.next = 20;\n                  break;\n\n                case 16:\n                  _context.prev = 16;\n                  _context.t0 = _context[\"catch\"](0);\n                  handleError(_context.t0, t('Failed_To_Load_Import_Data'));\n                  importHistoryRoute.push();\n\n                case 20:\n                case \"end\":\n                  return _context.stop();\n              }\n            }\n          }\n\n          return _callee$;\n        }(), null, null, [[0, 16]], Promise);\n      }\n\n      return _callee;\n    }();\n\n    loadCurrentOperation();\n  }, [getCurrentImportOperation, handleError, importHistoryRoute, prepareImportRoute, setCompleted, setImporterKey, setTotal, t]);\n  useEffect(function () {\n    if (!importerKey) {\n      return;\n    }\n\n    var handleProgressUpdated = function (_ref) {\n      var key = _ref.key,\n          step = _ref.step,\n          _ref$count = _ref.count;\n      _ref$count = _ref$count === void 0 ? {} : _ref$count;\n      var _ref$count$completed = _ref$count.completed,\n          completed = _ref$count$completed === void 0 ? 0 : _ref$count$completed,\n          _ref$count$total = _ref$count.total,\n          total = _ref$count$total === void 0 ? 0 : _ref$count$total;\n\n      if (key.toLowerCase() !== importerKey) {\n        return;\n      }\n\n      switch (step) {\n        case ProgressStep.DONE:\n          dispatchToastMessage({\n            type: 'success',\n            message: t(step[0].toUpperCase() + step.slice(1))\n          });\n          importHistoryRoute.push();\n          return;\n\n        case ProgressStep.ERROR:\n        case ProgressStep.CANCELLED:\n          handleError(t(step[0].toUpperCase() + step.slice(1)));\n          importHistoryRoute.push();\n          return;\n\n        default:\n          setStep(step);\n          setCompleted(completed);\n          setTotal(total);\n          break;\n      }\n    };\n\n    var streamer = new Meteor.Streamer('importers');\n\n    var loadImportProgress = function () {\n      function _callee2() {\n        var progress;\n        return _regeneratorRuntime.async(function () {\n          function _callee2$(_context2) {\n            while (1) {\n              switch (_context2.prev = _context2.next) {\n                case 0:\n                  _context2.prev = 0;\n                  _context2.next = 3;\n                  return _regeneratorRuntime.awrap(getImportProgress());\n\n                case 3:\n                  progress = _context2.sent;\n\n                  if (progress) {\n                    _context2.next = 8;\n                    break;\n                  }\n\n                  dispatchToastMessage({\n                    type: 'warning',\n                    message: t('Importer_not_in_progress')\n                  });\n                  prepareImportRoute.push();\n                  return _context2.abrupt(\"return\");\n\n                case 8:\n                  streamer.on('progress', handleProgressUpdated);\n                  handleProgressUpdated(progress);\n                  _context2.next = 16;\n                  break;\n\n                case 12:\n                  _context2.prev = 12;\n                  _context2.t0 = _context2[\"catch\"](0);\n                  handleError(_context2.t0, t('Failed_To_Load_Import_Data'));\n                  importHistoryRoute.push();\n\n                case 16:\n                case \"end\":\n                  return _context2.stop();\n              }\n            }\n          }\n\n          return _callee2$;\n        }(), null, null, [[0, 12]], Promise);\n      }\n\n      return _callee2;\n    }();\n\n    loadImportProgress();\n    return function () {\n      streamer.removeListener('progress', handleProgressUpdated);\n    };\n  }, [dispatchToastMessage, getImportProgress, handleError, importHistoryRoute, importerKey, prepareImportRoute, setCompleted, setStep, setTotal, t]);\n  var progressRate = useMemo(function () {\n    if (total === 0) {\n      return null;\n    }\n\n    return completed / total * 100;\n  }, [completed, total]);\n  return /*#__PURE__*/React.createElement(Page, null, /*#__PURE__*/React.createElement(Page.Header, {\n    title: t('Importing_Data')\n  }), /*#__PURE__*/React.createElement(Page.ScrollableContentWithShadow, null, /*#__PURE__*/React.createElement(Box, {\n    marginInline: \"auto\",\n    marginBlock: \"neg-x24\",\n    width: \"full\",\n    maxWidth: \"x580\"\n  }, /*#__PURE__*/React.createElement(Margins, {\n    block: \"x24\"\n  }, /*#__PURE__*/React.createElement(Box, {\n    is: \"p\",\n    fontScale: \"p2\"\n  }, t(step[0].toUpperCase() + step.slice(1))), progressRate ? /*#__PURE__*/React.createElement(Box, {\n    display: \"flex\",\n    justifyContent: \"center\"\n  }, /*#__PURE__*/React.createElement(Box, {\n    is: \"progress\",\n    value: completed,\n    max: total,\n    marginInlineEnd: \"x24\"\n  }), /*#__PURE__*/React.createElement(Box, {\n    is: \"span\",\n    fontScale: \"p2\"\n  }, completed, \"/\", total, \" (\", s.numberFormat(progressRate, 0), \"%)\")) : /*#__PURE__*/React.createElement(Throbber, {\n    justifyContent: \"center\"\n  })))));\n}\n\nmodule.exportDefault(ImportProgressPage);","map":{"version":3,"sources":["client/views/admin/import/ImportProgressPage.js"],"names":["_regeneratorRuntime","module","link","default","v","_slicedToArray","Box","Margins","Throbber","useSafely","Meteor","React","useEffect","useState","useMemo","s","ProgressStep","ImportingStartedStates","Page","useRoute","useEndpoint","useToastMessageDispatch","useTranslation","useErrorHandler","ImportProgressPage","t","dispatchToastMessage","handleError","importerKey","setImporterKey","step","setStep","completed","setCompleted","total","setTotal","getCurrentImportOperation","getImportProgress","importHistoryRoute","prepareImportRoute","loadCurrentOperation","operation","valid","push","includes","status","count","handleProgressUpdated","key","toLowerCase","DONE","type","message","toUpperCase","slice","ERROR","CANCELLED","streamer","Streamer","loadImportProgress","progress","on","removeListener","progressRate","numberFormat","exportDefault"],"mappings":"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","sourcesContent":["import { Box, Margins, Throbber } from '@rocket.chat/fuselage';\nimport { useSafely } from '@rocket.chat/fuselage-hooks';\nimport { Meteor } from 'meteor/meteor';\nimport React, { useEffect, useState, useMemo } from 'react';\nimport s from 'underscore.string';\n\nimport { ProgressStep, ImportingStartedStates } from '../../../../app/importer/lib/ImporterProgressStep';\nimport Page from '../../../components/Page';\nimport { useRoute } from '../../../contexts/RouterContext';\nimport { useEndpoint } from '../../../contexts/ServerContext';\nimport { useToastMessageDispatch } from '../../../contexts/ToastMessagesContext';\nimport { useTranslation } from '../../../contexts/TranslationContext';\nimport { useErrorHandler } from './useErrorHandler';\n\nfunction ImportProgressPage() {\n\tconst t = useTranslation();\n\tconst dispatchToastMessage = useToastMessageDispatch();\n\tconst handleError = useErrorHandler();\n\n\tconst [importerKey, setImporterKey] = useSafely(useState(null));\n\tconst [step, setStep] = useSafely(useState('Loading...'));\n\tconst [completed, setCompleted] = useSafely(useState(0));\n\tconst [total, setTotal] = useSafely(useState(0));\n\n\tconst getCurrentImportOperation = useEndpoint('GET', 'getCurrentImportOperation');\n\tconst getImportProgress = useEndpoint('GET', 'getImportProgress');\n\n\tconst importHistoryRoute = useRoute('admin-import');\n\tconst prepareImportRoute = useRoute('admin-import-prepare');\n\n\tuseEffect(() => {\n\t\tconst loadCurrentOperation = async () => {\n\t\t\ttry {\n\t\t\t\tconst { operation } = await getCurrentImportOperation();\n\n\t\t\t\tif (!operation.valid) {\n\t\t\t\t\timportHistoryRoute.push();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (!ImportingStartedStates.includes(operation.status)) {\n\t\t\t\t\tprepareImportRoute.push();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tsetImporterKey(operation.importerKey);\n\t\t\t\tsetCompleted(operation.count.completed);\n\t\t\t\tsetTotal(operation.count.total);\n\t\t\t} catch (error) {\n\t\t\t\thandleError(error, t('Failed_To_Load_Import_Data'));\n\t\t\t\timportHistoryRoute.push();\n\t\t\t}\n\t\t};\n\n\t\tloadCurrentOperation();\n\t}, [getCurrentImportOperation, handleError, importHistoryRoute, prepareImportRoute, setCompleted, setImporterKey, setTotal, t]);\n\n\tuseEffect(() => {\n\t\tif (!importerKey) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst handleProgressUpdated = ({ key, step, count: { completed = 0, total = 0 } = {} }) => {\n\t\t\tif (key.toLowerCase() !== importerKey) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tswitch (step) {\n\t\t\t\tcase ProgressStep.DONE:\n\t\t\t\t\tdispatchToastMessage({\n\t\t\t\t\t\ttype: 'success',\n\t\t\t\t\t\tmessage: t(step[0].toUpperCase() + step.slice(1)),\n\t\t\t\t\t});\n\t\t\t\t\timportHistoryRoute.push();\n\t\t\t\t\treturn;\n\n\t\t\t\tcase ProgressStep.ERROR:\n\t\t\t\tcase ProgressStep.CANCELLED:\n\t\t\t\t\thandleError(t(step[0].toUpperCase() + step.slice(1)));\n\t\t\t\t\timportHistoryRoute.push();\n\t\t\t\t\treturn;\n\n\t\t\t\tdefault:\n\t\t\t\t\tsetStep(step);\n\t\t\t\t\tsetCompleted(completed);\n\t\t\t\t\tsetTotal(total);\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t};\n\n\t\tconst streamer = new Meteor.Streamer('importers');\n\n\t\tconst loadImportProgress = async () => {\n\t\t\ttry {\n\t\t\t\tconst progress = await getImportProgress();\n\n\t\t\t\tif (!progress) {\n\t\t\t\t\tdispatchToastMessage({ type: 'warning', message: t('Importer_not_in_progress') });\n\t\t\t\t\tprepareImportRoute.push();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tstreamer.on('progress', handleProgressUpdated);\n\t\t\t\thandleProgressUpdated(progress);\n\t\t\t} catch (error) {\n\t\t\t\thandleError(error, t('Failed_To_Load_Import_Data'));\n\t\t\t\timportHistoryRoute.push();\n\t\t\t}\n\t\t};\n\n\t\tloadImportProgress();\n\n\t\treturn () => {\n\t\t\tstreamer.removeListener('progress', handleProgressUpdated);\n\t\t};\n\t}, [\n\t\tdispatchToastMessage,\n\t\tgetImportProgress,\n\t\thandleError,\n\t\timportHistoryRoute,\n\t\timporterKey,\n\t\tprepareImportRoute,\n\t\tsetCompleted,\n\t\tsetStep,\n\t\tsetTotal,\n\t\tt,\n\t]);\n\n\tconst progressRate = useMemo(() => {\n\t\tif (total === 0) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn (completed / total) * 100;\n\t}, [completed, total]);\n\n\treturn (\n\t\t<Page>\n\t\t\t<Page.Header title={t('Importing_Data')} />\n\n\t\t\t<Page.ScrollableContentWithShadow>\n\t\t\t\t<Box marginInline='auto' marginBlock='neg-x24' width='full' maxWidth='x580'>\n\t\t\t\t\t<Margins block='x24'>\n\t\t\t\t\t\t<Box is='p' fontScale='p2'>\n\t\t\t\t\t\t\t{t(step[0].toUpperCase() + step.slice(1))}\n\t\t\t\t\t\t</Box>\n\t\t\t\t\t\t{progressRate ? (\n\t\t\t\t\t\t\t<Box display='flex' justifyContent='center'>\n\t\t\t\t\t\t\t\t<Box is='progress' value={completed} max={total} marginInlineEnd='x24' />\n\t\t\t\t\t\t\t\t<Box is='span' fontScale='p2'>\n\t\t\t\t\t\t\t\t\t{completed}/{total} ({s.numberFormat(progressRate, 0)}%)\n\t\t\t\t\t\t\t\t</Box>\n\t\t\t\t\t\t\t</Box>\n\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t<Throbber justifyContent='center' />\n\t\t\t\t\t\t)}\n\t\t\t\t\t</Margins>\n\t\t\t\t</Box>\n\t\t\t</Page.ScrollableContentWithShadow>\n\t\t</Page>\n\t);\n}\n\nexport default ImportProgressPage;\n"]},"sourceType":"module","hash":"8c23c42a60db127ba8a35623fce537cbb52b78f5"}
