{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/packages/jalik:ufs/ufs-filter.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"packages/jalik:ufs/ufs-filter.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/packages/jalik:ufs/ufs-filter.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/packages/jalik:ufs/ufs-filter.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/jalik:ufs/ufs-filter.js"}},"code":"module.export({\n  Filter: () => Filter\n});\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\n\nlet _;\n\nmodule.link(\"meteor/underscore\", {\n  _(v) {\n    _ = v;\n  }\n\n}, 1);\n\nclass Filter {\n  constructor(options) {\n    const self = this; // Default options\n\n    options = _.extend({\n      contentTypes: null,\n      extensions: null,\n      minSize: 1,\n      maxSize: 0,\n      invalidFileError: () => new Meteor.Error('invalid-file', 'File is not valid'),\n      fileTooSmallError: (fileSize, minFileSize) => new Meteor.Error('file-too-small', \"File size (size = \".concat(fileSize, \") is too small (min = \").concat(minFileSize, \")\")),\n      fileTooLargeError: (fileSize, maxFileSize) => new Meteor.Error('file-too-large', \"File size (size = \".concat(fileSize, \") is too large (max = \").concat(maxFileSize, \")\")),\n      invalidFileExtension: (fileExtension, allowedExtensions) => new Meteor.Error('invalid-file-extension', \"File extension \\\"\".concat(fileExtension, \"\\\" is not accepted (\").concat(allowedExtensions, \")\")),\n      invalidFileType: (fileType, allowedContentTypes) => new Meteor.Error('invalid-file-type', \"File type \\\"\".concat(fileType, \"\\\" is not accepted (\").concat(allowedContentTypes, \")\")),\n      onCheck: this.onCheck\n    }, options); // Check options\n\n    if (options.contentTypes && !(options.contentTypes instanceof Array)) {\n      throw new TypeError('Filter: contentTypes is not an Array');\n    }\n\n    if (options.extensions && !(options.extensions instanceof Array)) {\n      throw new TypeError('Filter: extensions is not an Array');\n    }\n\n    if (typeof options.minSize !== 'number') {\n      throw new TypeError('Filter: minSize is not a number');\n    }\n\n    if (typeof options.maxSize !== 'number') {\n      throw new TypeError('Filter: maxSize is not a number');\n    }\n\n    if (options.onCheck && typeof options.onCheck !== 'function') {\n      throw new TypeError('Filter: onCheck is not a function');\n    } // Public attributes\n\n\n    self.options = options;\n    ['onCheck'].forEach(method => {\n      if (typeof options[method] === 'function') {\n        self[method] = options[method];\n      }\n    });\n  }\n  /**\n   * Checks the file\n   * @param file\n   */\n\n\n  check(file) {\n    let error = null;\n\n    if (typeof file !== 'object' || !file) {\n      error = this.options.invalidFileError();\n    } // Check size\n\n\n    const fileSize = file.size;\n    const minSize = this.getMinSize();\n\n    if (fileSize <= 0 || fileSize < minSize) {\n      error = this.options.fileTooSmallError(fileSize, minSize);\n    }\n\n    const maxSize = this.getMaxSize();\n\n    if (maxSize > 0 && fileSize > maxSize) {\n      error = this.options.fileTooLargeError(fileSize, maxSize);\n    } // Check extension\n\n\n    const allowedExtensions = this.getExtensions();\n    const fileExtension = file.extension;\n\n    if (allowedExtensions && !allowedExtensions.includes(fileExtension)) {\n      error = this.options.invalidFileExtension(fileExtension, allowedExtensions);\n    } // Check content type\n\n\n    const allowedContentTypes = this.getContentTypes();\n    const fileTypes = file.type;\n\n    if (allowedContentTypes && !this.isContentTypeInList(fileTypes, allowedContentTypes)) {\n      error = this.options.invalidFileType(fileTypes, allowedContentTypes);\n    } // Apply custom check\n\n\n    if (typeof this.onCheck === 'function' && !this.onCheck(file)) {\n      error = new Meteor.Error('invalid-file', 'File does not match filter');\n    }\n\n    if (error) {\n      throw error;\n    }\n  }\n  /**\n   * Returns the allowed content types\n   * @return {Array}\n   */\n\n\n  getContentTypes() {\n    return this.options.contentTypes;\n  }\n  /**\n   * Returns the allowed extensions\n   * @return {Array}\n   */\n\n\n  getExtensions() {\n    return this.options.extensions;\n  }\n  /**\n   * Returns the maximum file size\n   * @return {Number}\n   */\n\n\n  getMaxSize() {\n    return this.options.maxSize;\n  }\n  /**\n   * Returns the minimum file size\n   * @return {Number}\n   */\n\n\n  getMinSize() {\n    return this.options.minSize;\n  }\n  /**\n   * Checks if content type is in the given list\n   * @param type\n   * @param list\n   * @return {boolean}\n   */\n\n\n  isContentTypeInList(type, list) {\n    if (typeof type === 'string' && list instanceof Array) {\n      if (list.includes(type)) {\n        return true;\n      }\n\n      const wildCardGlob = '/*';\n      const wildcards = list.filter(item => item.indexOf(wildCardGlob) > 0);\n\n      if (wildcards.includes(type.replace(/(\\/.*)$/, wildCardGlob))) {\n        return true;\n      }\n    }\n\n    return false;\n  }\n  /**\n   * Checks if the file matches filter\n   * @param file\n   * @return {boolean}\n   */\n\n\n  isValid(file) {\n    let result = true;\n\n    try {\n      this.check(file);\n    } catch (err) {\n      result = false;\n    }\n\n    return result;\n  }\n  /**\n   * Executes custom checks\n   * @param file\n   * @return {boolean}\n   */\n  // eslint-disable-next-line no-unused-vars\n\n\n  onCheck(file) {\n    return true;\n  }\n\n}","map":{"version":3,"sources":["packages/jalik:ufs/ufs-filter.js"],"names":["module","export","Filter","Meteor","link","v","_","constructor","options","self","extend","contentTypes","extensions","minSize","maxSize","invalidFileError","Error","fileTooSmallError","fileSize","minFileSize","fileTooLargeError","maxFileSize","invalidFileExtension","fileExtension","allowedExtensions","invalidFileType","fileType","allowedContentTypes","onCheck","Array","TypeError","forEach","method","check","file","error","size","getMinSize","getMaxSize","getExtensions","extension","includes","getContentTypes","fileTypes","type","isContentTypeInList","list","wildCardGlob","wildcards","filter","item","indexOf","replace","isValid","result","err"],"mappings":"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","sourcesContent":["/*\n * The MIT License (MIT)\n *\n * Copyright (c) 2017 Karl STEIN\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy\n * of this software and associated documentation files (the \"Software\"), to deal\n * in the Software without restriction, including without limitation the rights\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n * copies of the Software, and to permit persons to whom the Software is\n * furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all\n * copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n * SOFTWARE.\n *\n */\nimport { Meteor } from 'meteor/meteor';\nimport { _ } from 'meteor/underscore';\n\n/**\n * File filter\n */\nexport class Filter {\n\tconstructor(options) {\n\t\tconst self = this;\n\n\t\t// Default options\n\t\toptions = _.extend(\n\t\t\t{\n\t\t\t\tcontentTypes: null,\n\t\t\t\textensions: null,\n\t\t\t\tminSize: 1,\n\t\t\t\tmaxSize: 0,\n\t\t\t\tinvalidFileError: () => new Meteor.Error('invalid-file', 'File is not valid'),\n\t\t\t\tfileTooSmallError: (fileSize, minFileSize) =>\n\t\t\t\t\tnew Meteor.Error('file-too-small', `File size (size = ${fileSize}) is too small (min = ${minFileSize})`),\n\t\t\t\tfileTooLargeError: (fileSize, maxFileSize) =>\n\t\t\t\t\tnew Meteor.Error('file-too-large', `File size (size = ${fileSize}) is too large (max = ${maxFileSize})`),\n\t\t\t\tinvalidFileExtension: (fileExtension, allowedExtensions) =>\n\t\t\t\t\tnew Meteor.Error('invalid-file-extension', `File extension \"${fileExtension}\" is not accepted (${allowedExtensions})`),\n\t\t\t\tinvalidFileType: (fileType, allowedContentTypes) =>\n\t\t\t\t\tnew Meteor.Error('invalid-file-type', `File type \"${fileType}\" is not accepted (${allowedContentTypes})`),\n\t\t\t\tonCheck: this.onCheck,\n\t\t\t},\n\t\t\toptions,\n\t\t);\n\n\t\t// Check options\n\t\tif (options.contentTypes && !(options.contentTypes instanceof Array)) {\n\t\t\tthrow new TypeError('Filter: contentTypes is not an Array');\n\t\t}\n\t\tif (options.extensions && !(options.extensions instanceof Array)) {\n\t\t\tthrow new TypeError('Filter: extensions is not an Array');\n\t\t}\n\t\tif (typeof options.minSize !== 'number') {\n\t\t\tthrow new TypeError('Filter: minSize is not a number');\n\t\t}\n\t\tif (typeof options.maxSize !== 'number') {\n\t\t\tthrow new TypeError('Filter: maxSize is not a number');\n\t\t}\n\t\tif (options.onCheck && typeof options.onCheck !== 'function') {\n\t\t\tthrow new TypeError('Filter: onCheck is not a function');\n\t\t}\n\n\t\t// Public attributes\n\t\tself.options = options;\n\t\t['onCheck'].forEach((method) => {\n\t\t\tif (typeof options[method] === 'function') {\n\t\t\t\tself[method] = options[method];\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * Checks the file\n\t * @param file\n\t */\n\tcheck(file) {\n\t\tlet error = null;\n\t\tif (typeof file !== 'object' || !file) {\n\t\t\terror = this.options.invalidFileError();\n\t\t}\n\t\t// Check size\n\t\tconst fileSize = file.size;\n\t\tconst minSize = this.getMinSize();\n\t\tif (fileSize <= 0 || fileSize < minSize) {\n\t\t\terror = this.options.fileTooSmallError(fileSize, minSize);\n\t\t}\n\t\tconst maxSize = this.getMaxSize();\n\t\tif (maxSize > 0 && fileSize > maxSize) {\n\t\t\terror = this.options.fileTooLargeError(fileSize, maxSize);\n\t\t}\n\t\t// Check extension\n\t\tconst allowedExtensions = this.getExtensions();\n\t\tconst fileExtension = file.extension;\n\t\tif (allowedExtensions && !allowedExtensions.includes(fileExtension)) {\n\t\t\terror = this.options.invalidFileExtension(fileExtension, allowedExtensions);\n\t\t}\n\t\t// Check content type\n\t\tconst allowedContentTypes = this.getContentTypes();\n\t\tconst fileTypes = file.type;\n\t\tif (allowedContentTypes && !this.isContentTypeInList(fileTypes, allowedContentTypes)) {\n\t\t\terror = this.options.invalidFileType(fileTypes, allowedContentTypes);\n\t\t}\n\t\t// Apply custom check\n\t\tif (typeof this.onCheck === 'function' && !this.onCheck(file)) {\n\t\t\terror = new Meteor.Error('invalid-file', 'File does not match filter');\n\t\t}\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\t/**\n\t * Returns the allowed content types\n\t * @return {Array}\n\t */\n\tgetContentTypes() {\n\t\treturn this.options.contentTypes;\n\t}\n\n\t/**\n\t * Returns the allowed extensions\n\t * @return {Array}\n\t */\n\tgetExtensions() {\n\t\treturn this.options.extensions;\n\t}\n\n\t/**\n\t * Returns the maximum file size\n\t * @return {Number}\n\t */\n\tgetMaxSize() {\n\t\treturn this.options.maxSize;\n\t}\n\n\t/**\n\t * Returns the minimum file size\n\t * @return {Number}\n\t */\n\tgetMinSize() {\n\t\treturn this.options.minSize;\n\t}\n\n\t/**\n\t * Checks if content type is in the given list\n\t * @param type\n\t * @param list\n\t * @return {boolean}\n\t */\n\tisContentTypeInList(type, list) {\n\t\tif (typeof type === 'string' && list instanceof Array) {\n\t\t\tif (list.includes(type)) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tconst wildCardGlob = '/*';\n\t\t\tconst wildcards = list.filter((item) => item.indexOf(wildCardGlob) > 0);\n\n\t\t\tif (wildcards.includes(type.replace(/(\\/.*)$/, wildCardGlob))) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\t/**\n\t * Checks if the file matches filter\n\t * @param file\n\t * @return {boolean}\n\t */\n\tisValid(file) {\n\t\tlet result = true;\n\t\ttry {\n\t\t\tthis.check(file);\n\t\t} catch (err) {\n\t\t\tresult = false;\n\t\t}\n\t\treturn result;\n\t}\n\n\t/**\n\t * Executes custom checks\n\t * @param file\n\t * @return {boolean}\n\t */\n\t// eslint-disable-next-line no-unused-vars\n\tonCheck(file) {\n\t\treturn true;\n\t}\n}\n"]},"sourceType":"module","hash":"59a07c7d3dbf9d4f9713acc6b1cfb08483140eb5"}
