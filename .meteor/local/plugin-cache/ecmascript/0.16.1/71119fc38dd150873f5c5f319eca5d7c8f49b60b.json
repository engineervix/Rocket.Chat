{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/packages/mizzao:timesync/client/timesync-client.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"packages/mizzao:timesync/client/timesync-client.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/packages/mizzao:timesync/client/timesync-client.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{}},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/packages/mizzao:timesync/client/timesync-client.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/mizzao:timesync/client/timesync-client.js"}},"code":"module.export({\n  TimeSync: function () {\n    return TimeSync;\n  },\n  SyncInternals: function () {\n    return SyncInternals;\n  }\n});\nvar Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 0);\nvar Tracker;\nmodule.link(\"meteor/tracker\", {\n  Tracker: function (v) {\n    Tracker = v;\n  }\n}, 1);\nvar HTTP;\nmodule.link(\"meteor/http\", {\n  HTTP: function (v) {\n    HTTP = v;\n  }\n}, 2);\n\n//IE8 doesn't have Date.now()\nDate.now = Date.now || function () {\n  return +new Date();\n};\n\nvar TimeSync = {\n  loggingEnabled: true\n};\n\nfunction\n  /* arguments */\nlog() {\n  if (TimeSync.loggingEnabled) {\n    Meteor._debug.apply(this, arguments);\n  }\n}\n\nvar defaultInterval = 1000; // Internal values, exported for testing\n\nvar SyncInternals = {\n  offset: undefined,\n  roundTripTime: undefined,\n  offsetDep: new Tracker.Dependency(),\n  timeTick: {},\n  timeCheck: function (lastTime, currentTime, interval, tolerance) {\n    if (Math.abs(currentTime - lastTime - interval) < tolerance) {\n      // Everything is A-OK\n      return true;\n    } // We're no longer in sync.\n\n\n    return false;\n  }\n};\nSyncInternals.timeTick[defaultInterval] = new Tracker.Dependency();\nvar maxAttempts = 5;\nvar attempts = 0;\n/*\n  This is an approximation of\n  http://en.wikipedia.org/wiki/Network_Time_Protocol\n\n  If this turns out to be more accurate under the connect handlers,\n  we should try taking multiple measurements.\n */\n\nvar syncUrl = \"/_timesync\";\n\nif (__meteor_runtime_config__.ROOT_URL_PATH_PREFIX) {\n  syncUrl = __meteor_runtime_config__.ROOT_URL_PATH_PREFIX + syncUrl;\n}\n\nvar updateOffset = function () {\n  var t0 = Date.now();\n  HTTP.get(syncUrl, function (err, response) {\n    var t3 = Date.now(); // Grab this now\n\n    if (err) {\n      //  We'll still use our last computed offset if is defined\n      log(\"Error syncing to server time: \", err);\n      if (++attempts <= maxAttempts) Meteor.setTimeout(TimeSync.resync, 1000);else log(\"Max number of time sync attempts reached. Giving up.\");\n      return;\n    }\n\n    attempts = 0; // It worked\n\n    var ts = parseInt(response.content);\n    SyncInternals.offset = Math.round((ts - t0 + (ts - t3)) / 2);\n    SyncInternals.roundTripTime = t3 - t0; // - (ts - ts) which is 0\n\n    SyncInternals.offsetDep.changed();\n  });\n}; // Reactive variable for server time that updates every second.\n\n\nTimeSync.serverTime = function (clientTime, interval) {\n  check(interval, Match.Optional(Match.Integer)); // If we don't know the offset, we can't provide the server time.\n\n  if (!TimeSync.isSynced()) return undefined; // If a client time is provided, we don't need to depend on the tick.\n\n  if (!clientTime) getTickDependency(interval || defaultInterval).depend(); // SyncInternals.offsetDep.depend(); implicit as we call isSynced()\n  // Convert Date argument to epoch as necessary\n\n  return (+clientTime || Date.now()) + SyncInternals.offset;\n}; // Reactive variable for the difference between server and client time.\n\n\nTimeSync.serverOffset = function () {\n  SyncInternals.offsetDep.depend();\n  return SyncInternals.offset;\n};\n\nTimeSync.roundTripTime = function () {\n  SyncInternals.offsetDep.depend();\n  return SyncInternals.roundTripTime;\n};\n\nTimeSync.isSynced = function () {\n  SyncInternals.offsetDep.depend();\n  return SyncInternals.offset !== undefined;\n};\n\nvar resyncIntervalId = null;\n\nTimeSync.resync = function () {\n  if (resyncIntervalId !== null) Meteor.clearInterval(resyncIntervalId);\n  updateOffset();\n  resyncIntervalId = Meteor.setInterval(updateOffset, 600000);\n}; // Run this as soon as we load, even before Meteor.startup()\n// Run again whenever we reconnect after losing connection\n\n\nvar wasConnected = false;\nTracker.autorun(function () {\n  var connected = Meteor.status().connected;\n  if (connected && !wasConnected) TimeSync.resync();\n  wasConnected = connected;\n}); // Resync if unexpected change by more than a few seconds. This needs to be\n// somewhat lenient, or a CPU-intensive operation can trigger a re-sync even\n// when the offset is still accurate. In any case, we're not going to be able to\n// catch very small system-initiated NTP adjustments with this, anyway.\n\nvar tickCheckTolerance = 5000;\nvar lastClientTime = Date.now(); // Set up a new interval for any amount of reactivity.\n\nfunction getTickDependency(interval) {\n  if (!SyncInternals.timeTick[interval]) {\n    var dep = new Tracker.Dependency();\n    Meteor.setInterval(function () {\n      dep.changed();\n    }, interval);\n    SyncInternals.timeTick[interval] = dep;\n  }\n\n  return SyncInternals.timeTick[interval];\n} // Set up special interval for the default tick, which also watches for re-sync\n\n\nMeteor.setInterval(function () {\n  var currentClientTime = Date.now();\n\n  if (SyncInternals.timeCheck(lastClientTime, currentClientTime, defaultInterval, tickCheckTolerance)) {\n    // No problem here, just keep ticking along\n    SyncInternals.timeTick[defaultInterval].changed();\n  } else {\n    // resync on major client clock changes\n    // based on http://stackoverflow.com/a/3367542/1656818\n    log(\"Clock discrepancy detected. Attempting re-sync.\"); // Refuse to compute server time.\n\n    SyncInternals.offset = undefined;\n    SyncInternals.offsetDep.changed();\n    TimeSync.resync();\n  }\n\n  lastClientTime = currentClientTime;\n}, defaultInterval);","map":{"version":3,"sources":["packages/mizzao:timesync/client/timesync-client.js"],"names":["module","export","TimeSync","SyncInternals","Meteor","link","v","Tracker","HTTP","Date","now","loggingEnabled","log","_debug","apply","arguments","defaultInterval","offset","undefined","roundTripTime","offsetDep","Dependency","timeTick","timeCheck","lastTime","currentTime","interval","tolerance","Math","abs","maxAttempts","attempts","syncUrl","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","updateOffset","t0","get","err","response","t3","setTimeout","resync","ts","parseInt","content","round","changed","serverTime","clientTime","check","Match","Optional","Integer","isSynced","getTickDependency","depend","serverOffset","resyncIntervalId","clearInterval","setInterval","wasConnected","autorun","connected","status","tickCheckTolerance","lastClientTime","dep","currentClientTime"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { Tracker } from 'meteor/tracker';\nimport { HTTP } from 'meteor/http';\n\n//IE8 doesn't have Date.now()\nDate.now = Date.now || function() { return +new Date; };\n\nexport const TimeSync = {\n  loggingEnabled: true\n};\n\nfunction log(/* arguments */) {\n  if (TimeSync.loggingEnabled) {\n    Meteor._debug.apply(this, arguments);\n  }\n}\n\nvar defaultInterval = 1000;\n\n// Internal values, exported for testing\nexport const SyncInternals = {\n  offset: undefined,\n  roundTripTime: undefined,\n  offsetDep: new Tracker.Dependency(),\n  timeTick: {},\n\n  timeCheck: function (lastTime, currentTime, interval, tolerance) {\n    if (Math.abs(currentTime - lastTime - interval) < tolerance) {\n      // Everything is A-OK\n      return true;\n    }\n    // We're no longer in sync.\n    return false;\n  }\n};\n\nSyncInternals.timeTick[defaultInterval] = new Tracker.Dependency();\n\nvar maxAttempts = 5;\nvar attempts = 0;\n\n/*\n  This is an approximation of\n  http://en.wikipedia.org/wiki/Network_Time_Protocol\n\n  If this turns out to be more accurate under the connect handlers,\n  we should try taking multiple measurements.\n */\n\nvar syncUrl = \"/_timesync\";\nif (__meteor_runtime_config__.ROOT_URL_PATH_PREFIX) {\n\tsyncUrl = __meteor_runtime_config__.ROOT_URL_PATH_PREFIX + syncUrl;\n}\n\nvar updateOffset = function() {\n  var t0 = Date.now();\n\n  HTTP.get(syncUrl, function(err, response) {\n    var t3 = Date.now(); // Grab this now\n    if (err) {\n      //  We'll still use our last computed offset if is defined\n      log(\"Error syncing to server time: \", err);\n      if (++attempts <= maxAttempts)\n        Meteor.setTimeout(TimeSync.resync, 1000);\n      else\n        log(\"Max number of time sync attempts reached. Giving up.\");\n      return;\n    }\n\n    attempts = 0; // It worked\n\n    var ts = parseInt(response.content);\n    SyncInternals.offset = Math.round(((ts - t0) + (ts - t3)) / 2);\n    SyncInternals.roundTripTime = t3 - t0; // - (ts - ts) which is 0\n    SyncInternals.offsetDep.changed();\n  });\n};\n\n// Reactive variable for server time that updates every second.\nTimeSync.serverTime = function(clientTime, interval) {\n  check(interval, Match.Optional(Match.Integer));\n  // If we don't know the offset, we can't provide the server time.\n  if ( !TimeSync.isSynced() ) return undefined;\n  // If a client time is provided, we don't need to depend on the tick.\n  if ( !clientTime ) getTickDependency(interval || defaultInterval).depend();\n\n  // SyncInternals.offsetDep.depend(); implicit as we call isSynced()\n  // Convert Date argument to epoch as necessary\n  return (+clientTime || Date.now()) + SyncInternals.offset;\n};\n\n// Reactive variable for the difference between server and client time.\nTimeSync.serverOffset = function() {\n  SyncInternals.offsetDep.depend();\n  return SyncInternals.offset;\n};\n\nTimeSync.roundTripTime = function() {\n  SyncInternals.offsetDep.depend();\n  return SyncInternals.roundTripTime;\n};\n\nTimeSync.isSynced = function() {\n  SyncInternals.offsetDep.depend();\n  return SyncInternals.offset !== undefined;\n};\n\nvar resyncIntervalId = null;\n\nTimeSync.resync = function() {\n  if (resyncIntervalId !== null) Meteor.clearInterval(resyncIntervalId);\n  updateOffset();\n  resyncIntervalId = Meteor.setInterval(updateOffset, 600000);\n};\n\n// Run this as soon as we load, even before Meteor.startup()\n// Run again whenever we reconnect after losing connection\nvar wasConnected = false;\n\nTracker.autorun(function() {\n  var connected = Meteor.status().connected;\n  if ( connected && !wasConnected ) TimeSync.resync();\n  wasConnected = connected;\n});\n\n// Resync if unexpected change by more than a few seconds. This needs to be\n// somewhat lenient, or a CPU-intensive operation can trigger a re-sync even\n// when the offset is still accurate. In any case, we're not going to be able to\n// catch very small system-initiated NTP adjustments with this, anyway.\nvar tickCheckTolerance = 5000;\n\nvar lastClientTime = Date.now();\n\n// Set up a new interval for any amount of reactivity.\nfunction getTickDependency(interval) {\n\n  if ( !SyncInternals.timeTick[interval] ) {\n    var dep  = new Tracker.Dependency();\n\n    Meteor.setInterval(function() {\n      dep.changed();\n    }, interval);\n\n    SyncInternals.timeTick[interval] = dep;\n  }\n\n  return SyncInternals.timeTick[interval];\n}\n\n// Set up special interval for the default tick, which also watches for re-sync\nMeteor.setInterval(function() {\n  var currentClientTime = Date.now();\n\n  if ( SyncInternals.timeCheck(\n    lastClientTime, currentClientTime, defaultInterval, tickCheckTolerance) ) {\n    // No problem here, just keep ticking along\n    SyncInternals.timeTick[defaultInterval].changed();\n  }\n  else {\n    // resync on major client clock changes\n    // based on http://stackoverflow.com/a/3367542/1656818\n    log(\"Clock discrepancy detected. Attempting re-sync.\");\n    // Refuse to compute server time.\n    SyncInternals.offset = undefined;\n    SyncInternals.offsetDep.changed();\n    TimeSync.resync();\n  }\n\n  lastClientTime = currentClientTime;\n}, defaultInterval);\n\n"]},"sourceType":"module","hash":"71119fc38dd150873f5c5f319eca5d7c8f49b60b"}
