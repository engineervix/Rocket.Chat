{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/views/room/contextualBar/Call/Jitsi/CallJitsiWithData.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"client/views/room/contextualBar/Call/Jitsi/CallJitsiWithData.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/views/room/contextualBar/Call/Jitsi/CallJitsiWithData.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{}},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/views/room/contextualBar/Call/Jitsi/CallJitsiWithData.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/views/room/contextualBar/Call/Jitsi/CallJitsiWithData.js"}},"code":"var _regeneratorRuntime;\n\nmodule.link(\"@babel/runtime/regenerator\", {\n  default: function (v) {\n    _regeneratorRuntime = v;\n  }\n}, 0);\n\nvar _slicedToArray;\n\nmodule.link(\"@babel/runtime/helpers/slicedToArray\", {\n  default: function (v) {\n    _slicedToArray = v;\n  }\n}, 1);\nvar Skeleton;\nmodule.link(\"@rocket.chat/fuselage\", {\n  Skeleton: function (v) {\n    Skeleton = v;\n  }\n}, 0);\nvar useMutableCallback, useSafely;\nmodule.link(\"@rocket.chat/fuselage-hooks\", {\n  useMutableCallback: function (v) {\n    useMutableCallback = v;\n  },\n  useSafely: function (v) {\n    useSafely = v;\n  }\n}, 1);\nvar clear;\nmodule.link(\"@rocket.chat/memo\", {\n  clear: function (v) {\n    clear = v;\n  }\n}, 2);\nvar React, useRef, useEffect, useState, useMemo, useLayoutEffect, memo;\nmodule.link(\"react\", {\n  \"default\": function (v) {\n    React = v;\n  },\n  useRef: function (v) {\n    useRef = v;\n  },\n  useEffect: function (v) {\n    useEffect = v;\n  },\n  useState: function (v) {\n    useState = v;\n  },\n  useMemo: function (v) {\n    useMemo = v;\n  },\n  useLayoutEffect: function (v) {\n    useLayoutEffect = v;\n  },\n  memo: function (v) {\n    memo = v;\n  }\n}, 3);\nvar Subscriptions;\nmodule.link(\"../../../../../../app/models/client\", {\n  Subscriptions: function (v) {\n    Subscriptions = v;\n  }\n}, 4);\nvar HEARTBEAT, TIMEOUT, DEBOUNCE;\nmodule.link(\"../../../../../../app/videobridge/constants\", {\n  HEARTBEAT: function (v) {\n    HEARTBEAT = v;\n  },\n  TIMEOUT: function (v) {\n    TIMEOUT = v;\n  },\n  DEBOUNCE: function (v) {\n    DEBOUNCE = v;\n  }\n}, 5);\nvar useConnectionStatus;\nmodule.link(\"../../../../../contexts/ConnectionStatusContext\", {\n  useConnectionStatus: function (v) {\n    useConnectionStatus = v;\n  }\n}, 6);\nvar useSetModal;\nmodule.link(\"../../../../../contexts/ModalContext\", {\n  useSetModal: function (v) {\n    useSetModal = v;\n  }\n}, 7);\nvar useMethod;\nmodule.link(\"../../../../../contexts/ServerContext\", {\n  useMethod: function (v) {\n    useMethod = v;\n  }\n}, 8);\nvar useSettings;\nmodule.link(\"../../../../../contexts/SettingsContext\", {\n  useSettings: function (v) {\n    useSettings = v;\n  }\n}, 9);\nvar useToastMessageDispatch;\nmodule.link(\"../../../../../contexts/ToastMessagesContext\", {\n  useToastMessageDispatch: function (v) {\n    useToastMessageDispatch = v;\n  }\n}, 10);\nvar useTranslation;\nmodule.link(\"../../../../../contexts/TranslationContext\", {\n  useTranslation: function (v) {\n    useTranslation = v;\n  }\n}, 11);\nvar useUser;\nmodule.link(\"../../../../../contexts/UserContext\", {\n  useUser: function (v) {\n    useUser = v;\n  }\n}, 12);\nvar useRoom;\nmodule.link(\"../../../contexts/RoomContext\", {\n  useRoom: function (v) {\n    useRoom = v;\n  }\n}, 13);\nvar useTabBarClose;\nmodule.link(\"../../../providers/ToolboxProvider\", {\n  useTabBarClose: function (v) {\n    useTabBarClose = v;\n  }\n}, 14);\nvar CallJitsi;\nmodule.link(\"./CallJitsi\", {\n  \"default\": function (v) {\n    CallJitsi = v;\n  }\n}, 15);\nvar CallModal;\nmodule.link(\"./components/CallModal\", {\n  \"default\": function (v) {\n    CallModal = v;\n  }\n}, 16);\nvar JitsiBridge;\nmodule.link(\"./lib/JitsiBridge\", {\n  JitsiBridge: function (v) {\n    JitsiBridge = v;\n  }\n}, 17);\nmodule.link(\"./CallJitsi\", {\n  \"default\": \"CallJitsi\"\n}, 18);\nvar querySettings = {\n  _id: ['Jitsi_Open_New_Window', 'Jitsi_Domain', 'Jitsi_URL_Room_Hash', 'uniqueID', 'Jitsi_URL_Room_Prefix', 'Jitsi_URL_Room_Suffix', 'Jitsi_Chrome_Extension', 'Jitsi_SSL', 'Jitsi_Enabled_TokenAuth']\n};\n\nvar CallJitsiWithData = function (_ref) {\n  var rid = _ref.rid;\n  var user = useUser();\n\n  var _useConnectionStatus = useConnectionStatus(),\n      connected = _useConnectionStatus.connected;\n\n  var _useSafely = useSafely(useState()),\n      _useSafely2 = _slicedToArray(_useSafely, 2),\n      accessToken = _useSafely2[0],\n      setAccessToken = _useSafely2[1];\n\n  var _useState = useState(false),\n      _useState2 = _slicedToArray(_useState, 2),\n      accepted = _useState2[0],\n      setAccepted = _useState2[1];\n\n  var room = useRoom();\n  var setModal = useSetModal();\n  var handleClose = useTabBarClose();\n  var closeModal = useMutableCallback(function () {\n    return setModal(null);\n  });\n  var generateAccessToken = useMethod('jitsi:generateAccessToken');\n  var updateTimeout = useMethod('jitsi:updateTimeout');\n  var joinRoom = useMethod('joinRoom');\n  var dispatchToastMessage = useToastMessageDispatch();\n  var t = useTranslation();\n  var handleCancel = useMutableCallback(function () {\n    closeModal();\n    handleClose();\n  });\n  var ref = useRef();\n\n  var _Object$fromEntries = Object.fromEntries(useSettings(querySettings).map(function (_ref2) {\n    var _id = _ref2._id,\n        value = _ref2.value;\n    return [_id, value];\n  })),\n      openNewWindow = _Object$fromEntries.Jitsi_Open_New_Window,\n      domain = _Object$fromEntries.Jitsi_Domain,\n      ssl = _Object$fromEntries.Jitsi_SSL,\n      desktopSharingChromeExtId = _Object$fromEntries.Jitsi_Chrome_Extension,\n      useHashName = _Object$fromEntries.Jitsi_URL_Room_Hash,\n      uniqueID = _Object$fromEntries.uniqueID,\n      prefix = _Object$fromEntries.Jitsi_URL_Room_Prefix,\n      sufix = _Object$fromEntries.Jitsi_URL_Room_Suffix,\n      isEnabledTokenAuth = _Object$fromEntries.Jitsi_Enabled_TokenAuth;\n\n  useEffect(function () {\n    var ignore = false;\n\n    if (!isEnabledTokenAuth) {\n      setAccessToken();\n      return;\n    }\n\n    (function () {\n      function _callee() {\n        var accessToken;\n        return _regeneratorRuntime.async(function () {\n          function _callee$(_context) {\n            while (1) {\n              switch (_context.prev = _context.next) {\n                case 0:\n                  _context.next = 2;\n                  return _regeneratorRuntime.awrap(generateAccessToken(rid));\n\n                case 2:\n                  accessToken = _context.sent;\n                  !ignore && setAccessToken(accessToken);\n\n                case 4:\n                case \"end\":\n                  return _context.stop();\n              }\n            }\n          }\n\n          return _callee$;\n        }(), null, null, null, Promise);\n      }\n\n      return _callee;\n    })()();\n    return function () {\n      ignore = true;\n    };\n  }, [generateAccessToken, isEnabledTokenAuth, rid, setAccessToken]);\n  useLayoutEffect(function () {\n    if (!connected) {\n      handleClose();\n    }\n  }, [connected, handleClose]);\n  var rname = useHashName ? uniqueID + rid : encodeURIComponent(room.t === 'd' ? room.usernames.join(' x ') : room.name);\n  var jitsi = useMemo(function () {\n    if (isEnabledTokenAuth && !accessToken) {\n      return;\n    }\n\n    var jitsiRoomName = prefix + rname + sufix;\n    return new JitsiBridge({\n      openNewWindow: openNewWindow,\n      ssl: ssl,\n      domain: domain,\n      jitsiRoomName: jitsiRoomName,\n      accessToken: accessToken,\n      desktopSharingChromeExtId: desktopSharingChromeExtId,\n      name: user.name || user.username\n    }, HEARTBEAT);\n  }, [accessToken, desktopSharingChromeExtId, domain, isEnabledTokenAuth, openNewWindow, prefix, rname, ssl, sufix, user.name, user.username]);\n  var testAndHandleTimeout = useMutableCallback(function () {\n    if (jitsi.openNewWindow) {\n      var _jitsi$window;\n\n      if ((_jitsi$window = jitsi.window) !== null && _jitsi$window !== void 0 && _jitsi$window.closed) {\n        return jitsi.dispose();\n      }\n\n      try {\n        return updateTimeout(rid, false);\n      } catch (error) {\n        dispatchToastMessage({\n          type: 'error',\n          message: t(error.reason)\n        });\n        clear();\n        handleClose();\n        return jitsi.dispose();\n      }\n    }\n\n    if (new Date() - new Date(room.jitsiTimeout) > TIMEOUT) {\n      return jitsi.dispose();\n    }\n\n    if (new Date() - new Date(room.jitsiTimeout) + TIMEOUT > DEBOUNCE) {\n      try {\n        return updateTimeout(rid, false);\n      } catch (error) {\n        dispatchToastMessage({\n          type: 'error',\n          message: t(error.reason)\n        });\n        clear();\n        handleClose();\n        return jitsi.dispose();\n      }\n    }\n  });\n  useEffect(function () {\n    if (!accepted || !jitsi) {\n      return;\n    }\n\n    var clear = function () {\n      jitsi.off('HEARTBEAT', testAndHandleTimeout);\n      jitsi.dispose();\n    };\n\n    try {\n      if (jitsi.needsStart) {\n        jitsi.start(ref.current);\n        updateTimeout(rid, true);\n      } else {\n        updateTimeout(rid, false);\n      }\n    } catch (error) {\n      dispatchToastMessage({\n        type: 'error',\n        message: t(error.reason)\n      });\n      clear();\n      handleClose();\n    }\n\n    jitsi.on('HEARTBEAT', testAndHandleTimeout);\n    return function () {\n      if (!jitsi.openNewWindow) clear();\n    };\n  }, [accepted, jitsi, rid, testAndHandleTimeout, updateTimeout, dispatchToastMessage, handleClose, t]);\n  var handleYes = useMutableCallback(function () {\n    if (jitsi) {\n      jitsi.needsStart = true;\n    }\n\n    setAccepted(true);\n    var sub = Subscriptions.findOne({\n      rid: rid,\n      'u._id': user._id\n    });\n\n    if (!sub) {\n      joinRoom(rid);\n    }\n\n    if (openNewWindow) {\n      handleClose();\n    }\n  });\n  useLayoutEffect(function () {\n    if (!accepted) {\n      setModal(function () {\n        return /*#__PURE__*/React.createElement(CallModal, {\n          handleYes: handleYes,\n          handleCancel: handleCancel\n        });\n      });\n      return;\n    }\n\n    closeModal();\n  }, [accepted, closeModal, handleCancel, handleYes, setModal]);\n  return /*#__PURE__*/React.createElement(CallJitsi, {\n    handleClose: handleClose,\n    openNewWindow: openNewWindow,\n    refContent: ref\n  }, !accepted && /*#__PURE__*/React.createElement(Skeleton, null));\n};\n\nmodule.exportDefault( /*#__PURE__*/memo(CallJitsiWithData));","map":{"version":3,"sources":["client/views/room/contextualBar/Call/Jitsi/CallJitsiWithData.js"],"names":["_regeneratorRuntime","module","link","default","v","_slicedToArray","Skeleton","useMutableCallback","useSafely","clear","React","useRef","useEffect","useState","useMemo","useLayoutEffect","memo","Subscriptions","HEARTBEAT","TIMEOUT","DEBOUNCE","useConnectionStatus","useSetModal","useMethod","useSettings","useToastMessageDispatch","useTranslation","useUser","useRoom","useTabBarClose","CallJitsi","CallModal","JitsiBridge","querySettings","_id","CallJitsiWithData","rid","user","connected","accessToken","setAccessToken","accepted","setAccepted","room","setModal","handleClose","closeModal","generateAccessToken","updateTimeout","joinRoom","dispatchToastMessage","t","handleCancel","ref","Object","fromEntries","map","value","openNewWindow","Jitsi_Open_New_Window","domain","Jitsi_Domain","ssl","Jitsi_SSL","desktopSharingChromeExtId","Jitsi_Chrome_Extension","useHashName","Jitsi_URL_Room_Hash","uniqueID","prefix","Jitsi_URL_Room_Prefix","sufix","Jitsi_URL_Room_Suffix","isEnabledTokenAuth","Jitsi_Enabled_TokenAuth","ignore","rname","encodeURIComponent","usernames","join","name","jitsi","jitsiRoomName","username","testAndHandleTimeout","window","closed","dispose","error","type","message","reason","Date","jitsiTimeout","off","needsStart","start","current","on","handleYes","sub","findOne","exportDefault"],"mappings":"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","sourcesContent":["import { Skeleton } from '@rocket.chat/fuselage';\nimport { useMutableCallback, useSafely } from '@rocket.chat/fuselage-hooks';\nimport { clear } from '@rocket.chat/memo';\nimport React, { useRef, useEffect, useState, useMemo, useLayoutEffect, memo } from 'react';\n\nimport { Subscriptions } from '../../../../../../app/models/client';\nimport { HEARTBEAT, TIMEOUT, DEBOUNCE } from '../../../../../../app/videobridge/constants';\nimport { useConnectionStatus } from '../../../../../contexts/ConnectionStatusContext';\nimport { useSetModal } from '../../../../../contexts/ModalContext';\nimport { useMethod } from '../../../../../contexts/ServerContext';\nimport { useSettings } from '../../../../../contexts/SettingsContext';\nimport { useToastMessageDispatch } from '../../../../../contexts/ToastMessagesContext';\nimport { useTranslation } from '../../../../../contexts/TranslationContext';\nimport { useUser } from '../../../../../contexts/UserContext';\nimport { useRoom } from '../../../contexts/RoomContext';\nimport { useTabBarClose } from '../../../providers/ToolboxProvider';\nimport CallJitsi from './CallJitsi';\nimport CallModal from './components/CallModal';\nimport { JitsiBridge } from './lib/JitsiBridge';\n\nexport { default as CallJitsi } from './CallJitsi';\n\nconst querySettings = {\n\t_id: [\n\t\t'Jitsi_Open_New_Window',\n\t\t'Jitsi_Domain',\n\t\t'Jitsi_URL_Room_Hash',\n\t\t'uniqueID',\n\t\t'Jitsi_URL_Room_Prefix',\n\t\t'Jitsi_URL_Room_Suffix',\n\t\t'Jitsi_Chrome_Extension',\n\t\t'Jitsi_SSL',\n\t\t'Jitsi_Enabled_TokenAuth',\n\t],\n};\n\nconst CallJitsiWithData = ({ rid }) => {\n\tconst user = useUser();\n\tconst { connected } = useConnectionStatus();\n\tconst [accessToken, setAccessToken] = useSafely(useState());\n\tconst [accepted, setAccepted] = useState(false);\n\tconst room = useRoom();\n\tconst setModal = useSetModal();\n\tconst handleClose = useTabBarClose();\n\tconst closeModal = useMutableCallback(() => setModal(null));\n\tconst generateAccessToken = useMethod('jitsi:generateAccessToken');\n\tconst updateTimeout = useMethod('jitsi:updateTimeout');\n\tconst joinRoom = useMethod('joinRoom');\n\tconst dispatchToastMessage = useToastMessageDispatch();\n\tconst t = useTranslation();\n\n\tconst handleCancel = useMutableCallback(() => {\n\t\tcloseModal();\n\t\thandleClose();\n\t});\n\n\tconst ref = useRef();\n\n\tconst {\n\t\tJitsi_Open_New_Window: openNewWindow,\n\t\tJitsi_Domain: domain,\n\t\tJitsi_SSL: ssl,\n\t\tJitsi_Chrome_Extension: desktopSharingChromeExtId,\n\t\tJitsi_URL_Room_Hash: useHashName,\n\t\tuniqueID,\n\t\tJitsi_URL_Room_Prefix: prefix,\n\t\tJitsi_URL_Room_Suffix: sufix,\n\t\tJitsi_Enabled_TokenAuth: isEnabledTokenAuth,\n\t} = Object.fromEntries(useSettings(querySettings).map(({ _id, value }) => [_id, value]));\n\n\tuseEffect(() => {\n\t\tlet ignore = false;\n\t\tif (!isEnabledTokenAuth) {\n\t\t\tsetAccessToken();\n\t\t\treturn;\n\t\t}\n\t\t(async () => {\n\t\t\tconst accessToken = await generateAccessToken(rid);\n\t\t\t!ignore && setAccessToken(accessToken);\n\t\t})();\n\t\treturn () => {\n\t\t\tignore = true;\n\t\t};\n\t}, [generateAccessToken, isEnabledTokenAuth, rid, setAccessToken]);\n\n\tuseLayoutEffect(() => {\n\t\tif (!connected) {\n\t\t\thandleClose();\n\t\t}\n\t}, [connected, handleClose]);\n\n\tconst rname = useHashName ? uniqueID + rid : encodeURIComponent(room.t === 'd' ? room.usernames.join(' x ') : room.name);\n\n\tconst jitsi = useMemo(() => {\n\t\tif (isEnabledTokenAuth && !accessToken) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst jitsiRoomName = prefix + rname + sufix;\n\n\t\treturn new JitsiBridge(\n\t\t\t{\n\t\t\t\topenNewWindow,\n\t\t\t\tssl,\n\t\t\t\tdomain,\n\t\t\t\tjitsiRoomName,\n\t\t\t\taccessToken,\n\t\t\t\tdesktopSharingChromeExtId,\n\t\t\t\tname: user.name || user.username,\n\t\t\t},\n\t\t\tHEARTBEAT,\n\t\t);\n\t}, [\n\t\taccessToken,\n\t\tdesktopSharingChromeExtId,\n\t\tdomain,\n\t\tisEnabledTokenAuth,\n\t\topenNewWindow,\n\t\tprefix,\n\t\trname,\n\t\tssl,\n\t\tsufix,\n\t\tuser.name,\n\t\tuser.username,\n\t]);\n\n\tconst testAndHandleTimeout = useMutableCallback(() => {\n\t\tif (jitsi.openNewWindow) {\n\t\t\tif (jitsi.window?.closed) {\n\t\t\t\treturn jitsi.dispose();\n\t\t\t}\n\t\t\ttry {\n\t\t\t\treturn updateTimeout(rid, false);\n\t\t\t} catch (error) {\n\t\t\t\tdispatchToastMessage({ type: 'error', message: t(error.reason) });\n\t\t\t\tclear();\n\t\t\t\thandleClose();\n\t\t\t\treturn jitsi.dispose();\n\t\t\t}\n\t\t}\n\t\tif (new Date() - new Date(room.jitsiTimeout) > TIMEOUT) {\n\t\t\treturn jitsi.dispose();\n\t\t}\n\n\t\tif (new Date() - new Date(room.jitsiTimeout) + TIMEOUT > DEBOUNCE) {\n\t\t\ttry {\n\t\t\t\treturn updateTimeout(rid, false);\n\t\t\t} catch (error) {\n\t\t\t\tdispatchToastMessage({ type: 'error', message: t(error.reason) });\n\t\t\t\tclear();\n\t\t\t\thandleClose();\n\t\t\t\treturn jitsi.dispose();\n\t\t\t}\n\t\t}\n\t});\n\n\tuseEffect(() => {\n\t\tif (!accepted || !jitsi) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst clear = () => {\n\t\t\tjitsi.off('HEARTBEAT', testAndHandleTimeout);\n\t\t\tjitsi.dispose();\n\t\t};\n\n\t\ttry {\n\t\t\tif (jitsi.needsStart) {\n\t\t\t\tjitsi.start(ref.current);\n\t\t\t\tupdateTimeout(rid, true);\n\t\t\t} else {\n\t\t\t\tupdateTimeout(rid, false);\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tdispatchToastMessage({ type: 'error', message: t(error.reason) });\n\t\t\tclear();\n\t\t\thandleClose();\n\t\t}\n\t\tjitsi.on('HEARTBEAT', testAndHandleTimeout);\n\n\t\treturn () => {\n\t\t\tif (!jitsi.openNewWindow) clear();\n\t\t};\n\t}, [accepted, jitsi, rid, testAndHandleTimeout, updateTimeout, dispatchToastMessage, handleClose, t]);\n\n\tconst handleYes = useMutableCallback(() => {\n\t\tif (jitsi) {\n\t\t\tjitsi.needsStart = true;\n\t\t}\n\n\t\tsetAccepted(true);\n\t\tconst sub = Subscriptions.findOne({ rid, 'u._id': user._id });\n\t\tif (!sub) {\n\t\t\tjoinRoom(rid);\n\t\t}\n\n\t\tif (openNewWindow) {\n\t\t\thandleClose();\n\t\t}\n\t});\n\n\tuseLayoutEffect(() => {\n\t\tif (!accepted) {\n\t\t\tsetModal(() => <CallModal handleYes={handleYes} handleCancel={handleCancel} />);\n\t\t\treturn;\n\t\t}\n\t\tcloseModal();\n\t}, [accepted, closeModal, handleCancel, handleYes, setModal]);\n\n\treturn (\n\t\t<CallJitsi handleClose={handleClose} openNewWindow={openNewWindow} refContent={ref}>\n\t\t\t{!accepted && <Skeleton />}\n\t\t</CallJitsi>\n\t);\n};\n\nexport default memo(CallJitsiWithData);\n"]},"sourceType":"module","hash":"59c595d2e45ad1cdb67a0de4467488bca19a96ad"}
