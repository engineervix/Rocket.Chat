{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/threads/client/flextab/thread.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"app/threads/client/flextab/thread.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/threads/client/flextab/thread.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/threads/client/flextab/thread.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/threads/client/flextab/thread.js"}},"code":"const _excluded = [\"context\", \"tab\"],\n      _excluded2 = [\"_id\"],\n      _excluded3 = [\"_id\"];\n\nlet _objectWithoutProperties;\n\nmodule.link(\"@babel/runtime/helpers/objectWithoutProperties\", {\n  default(v) {\n    _objectWithoutProperties = v;\n  }\n\n}, 0);\n\nlet _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default(v) {\n    _objectSpread = v;\n  }\n\n}, 1);\n\nlet _;\n\nmodule.link(\"underscore\", {\n  default(v) {\n    _ = v;\n  }\n\n}, 0);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 1);\nlet Mongo;\nmodule.link(\"meteor/mongo\", {\n  Mongo(v) {\n    Mongo = v;\n  }\n\n}, 2);\nlet Template;\nmodule.link(\"meteor/templating\", {\n  Template(v) {\n    Template = v;\n  }\n\n}, 3);\nlet Session;\nmodule.link(\"meteor/session\", {\n  Session(v) {\n    Session = v;\n  }\n\n}, 4);\nlet ReactiveDict;\nmodule.link(\"meteor/reactive-dict\", {\n  ReactiveDict(v) {\n    ReactiveDict = v;\n  }\n\n}, 5);\nlet Tracker;\nmodule.link(\"meteor/tracker\", {\n  Tracker(v) {\n    Tracker = v;\n  }\n\n}, 6);\nlet FlowRouter;\nmodule.link(\"meteor/kadira:flow-router\", {\n  FlowRouter(v) {\n    FlowRouter = v;\n  }\n\n}, 7);\nlet chatMessages, ChatMessages;\nmodule.link(\"../../../ui\", {\n  chatMessages(v) {\n    chatMessages = v;\n  },\n\n  ChatMessages(v) {\n    ChatMessages = v;\n  }\n\n}, 8);\nlet callWithErrorHandling;\nmodule.link(\"../../../../client/lib/utils/callWithErrorHandling\", {\n  callWithErrorHandling(v) {\n    callWithErrorHandling = v;\n  }\n\n}, 9);\nlet messageContext;\nmodule.link(\"../../../ui-utils/client/lib/messageContext\", {\n  messageContext(v) {\n    messageContext = v;\n  }\n\n}, 10);\nlet upsertMessageBulk;\nmodule.link(\"../../../ui-utils/client/lib/RoomHistoryManager\", {\n  upsertMessageBulk(v) {\n    upsertMessageBulk = v;\n  }\n\n}, 11);\nlet Messages;\nmodule.link(\"../../../models\", {\n  Messages(v) {\n    Messages = v;\n  }\n\n}, 12);\nlet fileUpload;\nmodule.link(\"../../../ui/client/lib/fileUpload\", {\n  fileUpload(v) {\n    fileUpload = v;\n  }\n\n}, 13);\nlet dropzoneEvents, dropzoneHelpers;\nmodule.link(\"../../../ui/client/views/app/room\", {\n  dropzoneEvents(v) {\n    dropzoneEvents = v;\n  },\n\n  dropzoneHelpers(v) {\n    dropzoneHelpers = v;\n  }\n\n}, 14);\nmodule.link(\"./thread.html\");\nlet getUserPreference;\nmodule.link(\"../../../utils\", {\n  getUserPreference(v) {\n    getUserPreference = v;\n  }\n\n}, 15);\nlet settings;\nmodule.link(\"../../../settings/client\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 16);\nlet callbacks;\nmodule.link(\"../../../../lib/callbacks\", {\n  callbacks(v) {\n    callbacks = v;\n  }\n\n}, 17);\nmodule.link(\"./messageBoxFollow\");\nlet getCommonRoomEvents;\nmodule.link(\"../../../ui/client/views/app/lib/getCommonRoomEvents\", {\n  getCommonRoomEvents(v) {\n    getCommonRoomEvents = v;\n  }\n\n}, 18);\nlet keyCodes;\nmodule.link(\"../../../../client/lib/utils/keyCodes\", {\n  keyCodes(v) {\n    keyCodes = v;\n  }\n\n}, 19);\nconst sort = {\n  ts: 1\n};\nTemplate.thread.events(_objectSpread(_objectSpread(_objectSpread({}, dropzoneEvents), getCommonRoomEvents()), {}, {\n  'click .js-close'(e) {\n    e.preventDefault();\n    e.stopPropagation();\n    const {\n      close\n    } = this;\n    return close && close();\n  },\n\n  'scroll .js-scroll-thread': _.throttle((_ref, i) => {\n    let {\n      currentTarget: e\n    } = _ref;\n    i.atBottom = e.scrollTop >= e.scrollHeight - e.clientHeight;\n  }, 150),\n\n  'click .toggle-hidden'(e) {\n    const id = e.currentTarget.dataset.message;\n    document.querySelector(\"#thread-\".concat(id)).classList.toggle('message--ignored');\n  }\n\n}));\nTemplate.thread.helpers(_objectSpread(_objectSpread({}, dropzoneHelpers), {}, {\n  mainMessage() {\n    const {\n      Threads,\n      state\n    } = Template.instance();\n    const tmid = state.get('tmid');\n    return Threads.findOne({\n      _id: tmid\n    });\n  },\n\n  isLoading() {\n    return Template.instance().state.get('loading') !== false;\n  },\n\n  messages() {\n    const {\n      Threads,\n      state\n    } = Template.instance();\n    const tmid = state.get('tmid');\n    return Threads.find({\n      tmid,\n      _id: {\n        $ne: tmid\n      }\n    }, {\n      sort\n    });\n  },\n\n  messageContext() {\n    const result = messageContext.call(this, {\n      rid: this.mainMessage.rid\n    });\n    return _objectSpread(_objectSpread({}, result), {}, {\n      settings: _objectSpread(_objectSpread({}, result.settings), {}, {\n        showReplyButton: false,\n        showreply: false\n      })\n    });\n  },\n\n  messageBoxData() {\n    const instance = Template.instance();\n    const {\n      mainMessage: {\n        rid,\n        _id: tmid\n      },\n      subscription\n    } = Template.currentData();\n    const showFormattingTips = settings.get('Message_ShowFormattingTips');\n    return {\n      showFormattingTips,\n      tshow: instance.state.get('sendToChannel'),\n      subscription,\n      rid,\n      tmid,\n      onSend: function () {\n        instance.sendToBottom();\n        instance.state.set('sendToChannel', false);\n\n        for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n          args[_key] = arguments[_key];\n        }\n\n        return instance.chatMessages && instance.chatMessages.send.apply(instance.chatMessages, args);\n      },\n      onKeyUp: function () {\n        for (var _len2 = arguments.length, args = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {\n          args[_key2] = arguments[_key2];\n        }\n\n        return instance.chatMessages && instance.chatMessages.keyup.apply(instance.chatMessages, args);\n      },\n      onKeyDown: function () {\n        for (var _len3 = arguments.length, args = new Array(_len3), _key3 = 0; _key3 < _len3; _key3++) {\n          args[_key3] = arguments[_key3];\n        }\n\n        const result = instance.chatMessages && instance.chatMessages.keydown.apply(instance.chatMessages, args);\n        const [event] = args;\n        const {\n          which: keyCode\n        } = event;\n\n        if (keyCode === keyCodes.ESCAPE && !result && !event.target.value.trim()) {\n          const _FlowRouter$current = FlowRouter.current(),\n                {\n            route: {\n              name\n            },\n            params: {\n              context,\n              tab\n            }\n          } = _FlowRouter$current,\n                params = _objectWithoutProperties(_FlowRouter$current.params, _excluded);\n\n          FlowRouter.go(name, params);\n        }\n      }\n    };\n  },\n\n  hideUsername() {\n    return getUserPreference(Meteor.userId(), 'hideUsernames') ? 'hide-usernames' : undefined;\n  },\n\n  checkboxData() {\n    const instance = Template.instance();\n    const checked = instance.state.get('sendToChannel');\n    return {\n      id: 'sendAlso',\n      checked,\n      onChange: () => instance.state.set('sendToChannel', !checked)\n    };\n  }\n\n}));\nTemplate.thread.onRendered(function () {\n  const rid = Tracker.nonreactive(() => this.state.get('rid'));\n  const tmid = Tracker.nonreactive(() => this.state.get('tmid'));\n  this.atBottom = true;\n  this.chatMessages = new ChatMessages(this.Threads);\n  this.chatMessages.initializeWrapper(this.find('.js-scroll-thread'));\n  this.chatMessages.initializeInput(this.find('.js-input-message'), {\n    rid,\n    tmid\n  });\n  this.sendToBottom = _.throttle(() => {\n    this.atBottom = true;\n    this.chatMessages.wrapper.scrollTop = this.chatMessages.wrapper.scrollHeight;\n  }, 300);\n\n  this.sendToBottomIfNecessary = () => {\n    this.atBottom && this.sendToBottom();\n  };\n\n  const observer = new ResizeObserver(this.sendToBottomIfNecessary);\n  observer.observe(this.firstNode.querySelector('.js-scroll-thread ul'));\n\n  this.onFile = filesToUpload => {\n    fileUpload(filesToUpload, this.chatMessages.input, {\n      rid: this.state.get('rid'),\n      tmid: this.state.get('tmid')\n    });\n  };\n\n  this.autorun(() => {\n    const rid = this.state.get('rid');\n    const tmid = this.state.get('tmid');\n\n    if (!rid) {\n      return;\n    }\n\n    this.callbackRemove && this.callbackRemove();\n\n    this.callbackRemove = () => callbacks.remove('streamNewMessage', \"thread-\".concat(rid));\n\n    callbacks.add('streamNewMessage', _.debounce(msg => {\n      if (Session.get('openedRoom') !== msg.rid || rid !== msg.rid || msg.editedAt || msg.tmid !== tmid) {\n        return;\n      }\n\n      Meteor.call('readThreads', tmid);\n    }, 1000), callbacks.priority.MEDIUM, \"thread-\".concat(rid));\n  });\n  this.autorun(() => {\n    const tmid = this.state.get('tmid');\n    this.threadsObserve && this.threadsObserve.stop();\n    this.threadsObserve = Messages.find({\n      $or: [{\n        tmid\n      }, {\n        _id: tmid\n      }],\n      _hidden: {\n        $ne: true\n      }\n    }, {\n      fields: {\n        collapsed: 0,\n        threadMsg: 0,\n        repliesCount: 0\n      }\n    }).observe({\n      added: _ref2 => {\n        let {\n          _id\n        } = _ref2,\n            message = _objectWithoutProperties(_ref2, _excluded2);\n\n        this.Threads.upsert({\n          _id\n        }, message);\n      },\n      changed: _ref3 => {\n        let {\n          _id\n        } = _ref3,\n            message = _objectWithoutProperties(_ref3, _excluded3);\n\n        this.Threads.update({\n          _id\n        }, message);\n      },\n      removed: _ref4 => {\n        let {\n          _id\n        } = _ref4;\n        return this.Threads.remove(_id);\n      }\n    });\n    this.loadMore();\n  });\n  this.autorun(() => {\n    const rid = this.state.get('rid');\n    const tmid = this.state.get('tmid');\n    this.chatMessages.initializeInput(this.find('.js-input-message'), {\n      rid,\n      tmid\n    });\n\n    if (rid && tmid) {\n      chatMessages[\"\".concat(rid, \"-\").concat(tmid)] = this.chatMessages;\n    }\n  });\n  this.autorun(() => {\n    FlowRouter.watchPathChange();\n    const jump = FlowRouter.getQueryParam('jump');\n    const {\n      mainMessage\n    } = Template.currentData();\n    this.state.set({\n      tmid: mainMessage._id,\n      rid: mainMessage.rid,\n      jump\n    });\n  });\n  this.autorun(() => {\n    const jump = this.state.get('jump');\n    const loading = this.state.get('loading');\n\n    if (jump && this.lastJump !== jump && loading === false) {\n      this.lastJump = jump;\n      this.find('.js-scroll-thread').style.scrollBehavior = 'smooth';\n      this.state.set('jump', null);\n      Tracker.afterFlush(() => {\n        const message = this.find(\"#thread-\".concat(jump));\n        message.classList.add('highlight');\n\n        const removeClass = () => {\n          message.classList.remove('highlight');\n          message.removeEventListener('animationend', removeClass);\n        };\n\n        message.addEventListener('animationend', removeClass);\n        setTimeout(() => {\n          message.scrollIntoView();\n        }, 300);\n      });\n    }\n  });\n});\nTemplate.thread.onCreated(async function () {\n  this.Threads = new Mongo.Collection(null);\n  this.state = new ReactiveDict({\n    sendToChannel: !this.data.mainMessage.tcount\n  });\n\n  this.loadMore = async () => {\n    const {\n      tmid\n    } = Tracker.nonreactive(() => this.state.all());\n\n    if (!tmid) {\n      return;\n    }\n\n    this.state.set('loading', true);\n    const messages = await callWithErrorHandling('getThreadMessages', {\n      tmid\n    });\n    upsertMessageBulk({\n      msgs: messages\n    }, this.Threads);\n    Tracker.afterFlush(() => {\n      this.state.set('loading', false);\n    });\n  };\n});\nTemplate.thread.onDestroyed(function () {\n  const {\n    Threads,\n    threadsObserve,\n    callbackRemove,\n    state,\n    chatMessages\n  } = this;\n  Threads.remove({});\n  threadsObserve && threadsObserve.stop();\n  callbackRemove && callbackRemove();\n  const tmid = state.get('tmid');\n  const rid = state.get('rid');\n\n  if (rid && tmid) {\n    chatMessages.onDestroyed && chatMessages.onDestroyed(rid, tmid);\n    delete chatMessages[\"\".concat(rid, \"-\").concat(tmid)];\n  }\n});","map":{"version":3,"sources":["app/threads/client/flextab/thread.js"],"names":["_objectWithoutProperties","module","link","default","v","_objectSpread","_","Meteor","Mongo","Template","Session","ReactiveDict","Tracker","FlowRouter","chatMessages","ChatMessages","callWithErrorHandling","messageContext","upsertMessageBulk","Messages","fileUpload","dropzoneEvents","dropzoneHelpers","getUserPreference","settings","callbacks","getCommonRoomEvents","keyCodes","sort","ts","thread","events","e","preventDefault","stopPropagation","close","throttle","i","currentTarget","atBottom","scrollTop","scrollHeight","clientHeight","id","dataset","message","document","querySelector","classList","toggle","helpers","mainMessage","Threads","state","instance","tmid","get","findOne","_id","isLoading","messages","find","$ne","result","call","rid","showReplyButton","showreply","messageBoxData","subscription","currentData","showFormattingTips","tshow","onSend","sendToBottom","set","args","send","apply","onKeyUp","keyup","onKeyDown","keydown","event","which","keyCode","ESCAPE","target","value","trim","current","route","name","params","context","tab","go","hideUsername","userId","undefined","checkboxData","checked","onChange","onRendered","nonreactive","initializeWrapper","initializeInput","wrapper","sendToBottomIfNecessary","observer","ResizeObserver","observe","firstNode","onFile","filesToUpload","input","autorun","callbackRemove","remove","add","debounce","msg","editedAt","priority","MEDIUM","threadsObserve","stop","$or","_hidden","fields","collapsed","threadMsg","repliesCount","added","upsert","changed","update","removed","loadMore","watchPathChange","jump","getQueryParam","loading","lastJump","style","scrollBehavior","afterFlush","removeClass","removeEventListener","addEventListener","setTimeout","scrollIntoView","onCreated","Collection","sendToChannel","data","tcount","all","msgs","onDestroyed"],"mappings":"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","sourcesContent":["import _ from 'underscore';\nimport { Meteor } from 'meteor/meteor';\nimport { Mongo } from 'meteor/mongo';\nimport { Template } from 'meteor/templating';\nimport { Session } from 'meteor/session';\nimport { ReactiveDict } from 'meteor/reactive-dict';\nimport { Tracker } from 'meteor/tracker';\nimport { FlowRouter } from 'meteor/kadira:flow-router';\n\nimport { chatMessages, ChatMessages } from '../../../ui';\nimport { callWithErrorHandling } from '../../../../client/lib/utils/callWithErrorHandling';\nimport { messageContext } from '../../../ui-utils/client/lib/messageContext';\nimport { upsertMessageBulk } from '../../../ui-utils/client/lib/RoomHistoryManager';\nimport { Messages } from '../../../models';\nimport { fileUpload } from '../../../ui/client/lib/fileUpload';\nimport { dropzoneEvents, dropzoneHelpers } from '../../../ui/client/views/app/room';\nimport './thread.html';\nimport { getUserPreference } from '../../../utils';\nimport { settings } from '../../../settings/client';\nimport { callbacks } from '../../../../lib/callbacks';\nimport './messageBoxFollow';\nimport { getCommonRoomEvents } from '../../../ui/client/views/app/lib/getCommonRoomEvents';\nimport { keyCodes } from '../../../../client/lib/utils/keyCodes';\n\nconst sort = { ts: 1 };\n\nTemplate.thread.events({\n\t...dropzoneEvents,\n\t...getCommonRoomEvents(),\n\t'click .js-close'(e) {\n\t\te.preventDefault();\n\t\te.stopPropagation();\n\t\tconst { close } = this;\n\t\treturn close && close();\n\t},\n\t'scroll .js-scroll-thread': _.throttle(({ currentTarget: e }, i) => {\n\t\ti.atBottom = e.scrollTop >= e.scrollHeight - e.clientHeight;\n\t}, 150),\n\t'click .toggle-hidden'(e) {\n\t\tconst id = e.currentTarget.dataset.message;\n\t\tdocument.querySelector(`#thread-${id}`).classList.toggle('message--ignored');\n\t},\n});\n\nTemplate.thread.helpers({\n\t...dropzoneHelpers,\n\tmainMessage() {\n\t\tconst { Threads, state } = Template.instance();\n\t\tconst tmid = state.get('tmid');\n\t\treturn Threads.findOne({ _id: tmid });\n\t},\n\tisLoading() {\n\t\treturn Template.instance().state.get('loading') !== false;\n\t},\n\tmessages() {\n\t\tconst { Threads, state } = Template.instance();\n\t\tconst tmid = state.get('tmid');\n\n\t\treturn Threads.find({ tmid, _id: { $ne: tmid } }, { sort });\n\t},\n\tmessageContext() {\n\t\tconst result = messageContext.call(this, { rid: this.mainMessage.rid });\n\t\treturn {\n\t\t\t...result,\n\t\t\tsettings: {\n\t\t\t\t...result.settings,\n\t\t\t\tshowReplyButton: false,\n\t\t\t\tshowreply: false,\n\t\t\t},\n\t\t};\n\t},\n\tmessageBoxData() {\n\t\tconst instance = Template.instance();\n\t\tconst {\n\t\t\tmainMessage: { rid, _id: tmid },\n\t\t\tsubscription,\n\t\t} = Template.currentData();\n\n\t\tconst showFormattingTips = settings.get('Message_ShowFormattingTips');\n\t\treturn {\n\t\t\tshowFormattingTips,\n\t\t\ttshow: instance.state.get('sendToChannel'),\n\t\t\tsubscription,\n\t\t\trid,\n\t\t\ttmid,\n\t\t\tonSend: (...args) => {\n\t\t\t\tinstance.sendToBottom();\n\t\t\t\tinstance.state.set('sendToChannel', false);\n\t\t\t\treturn instance.chatMessages && instance.chatMessages.send.apply(instance.chatMessages, args);\n\t\t\t},\n\t\t\tonKeyUp: (...args) => instance.chatMessages && instance.chatMessages.keyup.apply(instance.chatMessages, args),\n\t\t\tonKeyDown: (...args) => {\n\t\t\t\tconst result = instance.chatMessages && instance.chatMessages.keydown.apply(instance.chatMessages, args);\n\t\t\t\tconst [event] = args;\n\n\t\t\t\tconst { which: keyCode } = event;\n\n\t\t\t\tif (keyCode === keyCodes.ESCAPE && !result && !event.target.value.trim()) {\n\t\t\t\t\tconst {\n\t\t\t\t\t\troute: { name },\n\t\t\t\t\t\tparams: { context, tab, ...params },\n\t\t\t\t\t} = FlowRouter.current();\n\t\t\t\t\tFlowRouter.go(name, params);\n\t\t\t\t}\n\t\t\t},\n\t\t};\n\t},\n\thideUsername() {\n\t\treturn getUserPreference(Meteor.userId(), 'hideUsernames') ? 'hide-usernames' : undefined;\n\t},\n\tcheckboxData() {\n\t\tconst instance = Template.instance();\n\t\tconst checked = instance.state.get('sendToChannel');\n\t\treturn {\n\t\t\tid: 'sendAlso',\n\t\t\tchecked,\n\t\t\tonChange: () => instance.state.set('sendToChannel', !checked),\n\t\t};\n\t},\n});\n\nTemplate.thread.onRendered(function () {\n\tconst rid = Tracker.nonreactive(() => this.state.get('rid'));\n\tconst tmid = Tracker.nonreactive(() => this.state.get('tmid'));\n\tthis.atBottom = true;\n\n\tthis.chatMessages = new ChatMessages(this.Threads);\n\tthis.chatMessages.initializeWrapper(this.find('.js-scroll-thread'));\n\tthis.chatMessages.initializeInput(this.find('.js-input-message'), { rid, tmid });\n\n\tthis.sendToBottom = _.throttle(() => {\n\t\tthis.atBottom = true;\n\t\tthis.chatMessages.wrapper.scrollTop = this.chatMessages.wrapper.scrollHeight;\n\t}, 300);\n\n\tthis.sendToBottomIfNecessary = () => {\n\t\tthis.atBottom && this.sendToBottom();\n\t};\n\n\tconst observer = new ResizeObserver(this.sendToBottomIfNecessary);\n\tobserver.observe(this.firstNode.querySelector('.js-scroll-thread ul'));\n\n\tthis.onFile = (filesToUpload) => {\n\t\tfileUpload(filesToUpload, this.chatMessages.input, {\n\t\t\trid: this.state.get('rid'),\n\t\t\ttmid: this.state.get('tmid'),\n\t\t});\n\t};\n\n\tthis.autorun(() => {\n\t\tconst rid = this.state.get('rid');\n\t\tconst tmid = this.state.get('tmid');\n\t\tif (!rid) {\n\t\t\treturn;\n\t\t}\n\t\tthis.callbackRemove && this.callbackRemove();\n\n\t\tthis.callbackRemove = () => callbacks.remove('streamNewMessage', `thread-${rid}`);\n\n\t\tcallbacks.add(\n\t\t\t'streamNewMessage',\n\t\t\t_.debounce((msg) => {\n\t\t\t\tif (Session.get('openedRoom') !== msg.rid || rid !== msg.rid || msg.editedAt || msg.tmid !== tmid) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tMeteor.call('readThreads', tmid);\n\t\t\t}, 1000),\n\t\t\tcallbacks.priority.MEDIUM,\n\t\t\t`thread-${rid}`,\n\t\t);\n\t});\n\n\tthis.autorun(() => {\n\t\tconst tmid = this.state.get('tmid');\n\t\tthis.threadsObserve && this.threadsObserve.stop();\n\n\t\tthis.threadsObserve = Messages.find(\n\t\t\t{ $or: [{ tmid }, { _id: tmid }], _hidden: { $ne: true } },\n\t\t\t{\n\t\t\t\tfields: {\n\t\t\t\t\tcollapsed: 0,\n\t\t\t\t\tthreadMsg: 0,\n\t\t\t\t\trepliesCount: 0,\n\t\t\t\t},\n\t\t\t},\n\t\t).observe({\n\t\t\tadded: ({ _id, ...message }) => {\n\t\t\t\tthis.Threads.upsert({ _id }, message);\n\t\t\t},\n\t\t\tchanged: ({ _id, ...message }) => {\n\t\t\t\tthis.Threads.update({ _id }, message);\n\t\t\t},\n\t\t\tremoved: ({ _id }) => this.Threads.remove(_id),\n\t\t});\n\n\t\tthis.loadMore();\n\t});\n\n\tthis.autorun(() => {\n\t\tconst rid = this.state.get('rid');\n\t\tconst tmid = this.state.get('tmid');\n\t\tthis.chatMessages.initializeInput(this.find('.js-input-message'), { rid, tmid });\n\t\tif (rid && tmid) {\n\t\t\tchatMessages[`${rid}-${tmid}`] = this.chatMessages;\n\t\t}\n\t});\n\n\tthis.autorun(() => {\n\t\tFlowRouter.watchPathChange();\n\t\tconst jump = FlowRouter.getQueryParam('jump');\n\t\tconst { mainMessage } = Template.currentData();\n\t\tthis.state.set({\n\t\t\ttmid: mainMessage._id,\n\t\t\trid: mainMessage.rid,\n\t\t\tjump,\n\t\t});\n\t});\n\n\tthis.autorun(() => {\n\t\tconst jump = this.state.get('jump');\n\t\tconst loading = this.state.get('loading');\n\n\t\tif (jump && this.lastJump !== jump && loading === false) {\n\t\t\tthis.lastJump = jump;\n\t\t\tthis.find('.js-scroll-thread').style.scrollBehavior = 'smooth';\n\t\t\tthis.state.set('jump', null);\n\t\t\tTracker.afterFlush(() => {\n\t\t\t\tconst message = this.find(`#thread-${jump}`);\n\t\t\t\tmessage.classList.add('highlight');\n\t\t\t\tconst removeClass = () => {\n\t\t\t\t\tmessage.classList.remove('highlight');\n\t\t\t\t\tmessage.removeEventListener('animationend', removeClass);\n\t\t\t\t};\n\t\t\t\tmessage.addEventListener('animationend', removeClass);\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\tmessage.scrollIntoView();\n\t\t\t\t}, 300);\n\t\t\t});\n\t\t}\n\t});\n});\n\nTemplate.thread.onCreated(async function () {\n\tthis.Threads = new Mongo.Collection(null);\n\n\tthis.state = new ReactiveDict({\n\t\tsendToChannel: !this.data.mainMessage.tcount,\n\t});\n\n\tthis.loadMore = async () => {\n\t\tconst { tmid } = Tracker.nonreactive(() => this.state.all());\n\t\tif (!tmid) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.state.set('loading', true);\n\n\t\tconst messages = await callWithErrorHandling('getThreadMessages', { tmid });\n\n\t\tupsertMessageBulk({ msgs: messages }, this.Threads);\n\n\t\tTracker.afterFlush(() => {\n\t\t\tthis.state.set('loading', false);\n\t\t});\n\t};\n});\n\nTemplate.thread.onDestroyed(function () {\n\tconst { Threads, threadsObserve, callbackRemove, state, chatMessages } = this;\n\tThreads.remove({});\n\tthreadsObserve && threadsObserve.stop();\n\n\tcallbackRemove && callbackRemove();\n\n\tconst tmid = state.get('tmid');\n\tconst rid = state.get('rid');\n\tif (rid && tmid) {\n\t\tchatMessages.onDestroyed && chatMessages.onDestroyed(rid, tmid);\n\t\tdelete chatMessages[`${rid}-${tmid}`];\n\t}\n});\n"]},"sourceType":"module","hash":"e2050d857cb03de61ee54e89e681d1d2e6aa00a3"}
