{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/webrtc/client/WebRTCClass.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"app/webrtc/client/WebRTCClass.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/webrtc/client/WebRTCClass.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{}},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/webrtc/client/WebRTCClass.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/webrtc/client/WebRTCClass.js"}},"code":"var _toConsumableArray;\n\nmodule.link(\"@babel/runtime/helpers/toConsumableArray\", {\n  default: function (v) {\n    _toConsumableArray = v;\n  }\n}, 0);\n\nvar _slicedToArray;\n\nmodule.link(\"@babel/runtime/helpers/slicedToArray\", {\n  default: function (v) {\n    _slicedToArray = v;\n  }\n}, 1);\n\nvar _inheritsLoose;\n\nmodule.link(\"@babel/runtime/helpers/inheritsLoose\", {\n  default: function (v) {\n    _inheritsLoose = v;\n  }\n}, 2);\nmodule.export({\n  WebRTC: function () {\n    return WebRTC;\n  }\n});\nvar Emitter;\nmodule.link(\"@rocket.chat/emitter\", {\n  Emitter: function (v) {\n    Emitter = v;\n  }\n}, 0);\nvar Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 1);\nvar Tracker;\nmodule.link(\"meteor/tracker\", {\n  Tracker: function (v) {\n    Tracker = v;\n  }\n}, 2);\nvar ReactiveVar;\nmodule.link(\"meteor/reactive-var\", {\n  ReactiveVar: function (v) {\n    ReactiveVar = v;\n  }\n}, 3);\nvar TAPi18n;\nmodule.link(\"meteor/rocketchat:tap-i18n\", {\n  TAPi18n: function (v) {\n    TAPi18n = v;\n  }\n}, 4);\nvar ChromeScreenShare;\nmodule.link(\"./screenShare\", {\n  ChromeScreenShare: function (v) {\n    ChromeScreenShare = v;\n  }\n}, 5);\nvar t;\nmodule.link(\"../../utils\", {\n  t: function (v) {\n    t = v;\n  }\n}, 6);\nvar Notifications;\nmodule.link(\"../../notifications\", {\n  Notifications: function (v) {\n    Notifications = v;\n  }\n}, 7);\nvar settings;\nmodule.link(\"../../settings\", {\n  settings: function (v) {\n    settings = v;\n  }\n}, 8);\nvar modal;\nmodule.link(\"../../ui-utils\", {\n  modal: function (v) {\n    modal = v;\n  }\n}, 9);\nvar ChatSubscription;\nmodule.link(\"../../models\", {\n  ChatSubscription: function (v) {\n    ChatSubscription = v;\n  }\n}, 10);\nvar WEB_RTC_EVENTS;\nmodule.link(\"..\", {\n  WEB_RTC_EVENTS: function (v) {\n    WEB_RTC_EVENTS = v;\n  }\n}, 11);\nvar goToRoomById;\nmodule.link(\"../../../client/lib/utils/goToRoomById\", {\n  goToRoomById: function (v) {\n    goToRoomById = v;\n  }\n}, 12);\n\nvar WebRTCTransportClass = /*#__PURE__*/function (_Emitter) {\n  _inheritsLoose(WebRTCTransportClass, _Emitter);\n\n  function WebRTCTransportClass(webrtcInstance) {\n    var _this;\n\n    _this = _Emitter.call(this) || this;\n    _this.debug = false;\n    _this.webrtcInstance = webrtcInstance;\n    Notifications.onRoom(_this.webrtcInstance.room, WEB_RTC_EVENTS.WEB_RTC, function (type, data) {\n      _this.log('WebRTCTransportClass - onRoom', type, data);\n\n      _this.emit(type, data);\n    });\n    return _this;\n  }\n\n  var _proto = WebRTCTransportClass.prototype;\n\n  _proto.log = function () {\n    function log() {\n      if (this.debug === true) {\n        var _console;\n\n        (_console = console).log.apply(_console, arguments);\n      }\n    }\n\n    return log;\n  }();\n\n  _proto.onUserStream = function () {\n    function onUserStream(type, data) {\n      if (data.room !== this.webrtcInstance.room) {\n        return;\n      }\n\n      this.log('WebRTCTransportClass - onUser', type, data);\n      this.emit(type, data);\n    }\n\n    return onUserStream;\n  }();\n\n  _proto.startCall = function () {\n    function startCall(data) {\n      this.log('WebRTCTransportClass - startCall', this.webrtcInstance.room, this.webrtcInstance.selfId);\n      Notifications.notifyUsersOfRoom(this.webrtcInstance.room, WEB_RTC_EVENTS.WEB_RTC, WEB_RTC_EVENTS.CALL, {\n        from: this.webrtcInstance.selfId,\n        room: this.webrtcInstance.room,\n        media: data.media,\n        monitor: data.monitor\n      });\n    }\n\n    return startCall;\n  }();\n\n  _proto.joinCall = function () {\n    function joinCall(data) {\n      this.log('WebRTCTransportClass - joinCall', this.webrtcInstance.room, this.webrtcInstance.selfId);\n\n      if (data.monitor === true) {\n        Notifications.notifyUser(data.to, WEB_RTC_EVENTS.WEB_RTC, WEB_RTC_EVENTS.JOIN, {\n          from: this.webrtcInstance.selfId,\n          room: this.webrtcInstance.room,\n          media: data.media,\n          monitor: data.monitor\n        });\n      } else {\n        Notifications.notifyUsersOfRoom(this.webrtcInstance.room, WEB_RTC_EVENTS.WEB_RTC, WEB_RTC_EVENTS.JOIN, {\n          from: this.webrtcInstance.selfId,\n          room: this.webrtcInstance.room,\n          media: data.media,\n          monitor: data.monitor\n        });\n      }\n    }\n\n    return joinCall;\n  }();\n\n  _proto.sendCandidate = function () {\n    function sendCandidate(data) {\n      data.from = this.webrtcInstance.selfId;\n      data.room = this.webrtcInstance.room;\n      this.log('WebRTCTransportClass - sendCandidate', data);\n      Notifications.notifyUser(data.to, WEB_RTC_EVENTS.WEB_RTC, WEB_RTC_EVENTS.CANDIDATE, data);\n    }\n\n    return sendCandidate;\n  }();\n\n  _proto.sendDescription = function () {\n    function sendDescription(data) {\n      data.from = this.webrtcInstance.selfId;\n      data.room = this.webrtcInstance.room;\n      this.log('WebRTCTransportClass - sendDescription', data);\n      Notifications.notifyUser(data.to, WEB_RTC_EVENTS.WEB_RTC, WEB_RTC_EVENTS.DESCRIPTION, data);\n    }\n\n    return sendDescription;\n  }();\n\n  _proto.sendStatus = function () {\n    function sendStatus(data) {\n      this.log('WebRTCTransportClass - sendStatus', data, this.webrtcInstance.room);\n      data.from = this.webrtcInstance.selfId;\n      Notifications.notifyRoom(this.webrtcInstance.room, WEB_RTC_EVENTS.WEB_RTC, WEB_RTC_EVENTS.STATUS, data);\n    }\n\n    return sendStatus;\n  }();\n\n  _proto.onRemoteCall = function () {\n    function onRemoteCall(fn) {\n      return this.on(WEB_RTC_EVENTS.CALL, fn);\n    }\n\n    return onRemoteCall;\n  }();\n\n  _proto.onRemoteJoin = function () {\n    function onRemoteJoin(fn) {\n      return this.on(WEB_RTC_EVENTS.JOIN, fn);\n    }\n\n    return onRemoteJoin;\n  }();\n\n  _proto.onRemoteCandidate = function () {\n    function onRemoteCandidate(fn) {\n      return this.on(WEB_RTC_EVENTS.CANDIDATE, fn);\n    }\n\n    return onRemoteCandidate;\n  }();\n\n  _proto.onRemoteDescription = function () {\n    function onRemoteDescription(fn) {\n      return this.on(WEB_RTC_EVENTS.DESCRIPTION, fn);\n    }\n\n    return onRemoteDescription;\n  }();\n\n  _proto.onRemoteStatus = function () {\n    function onRemoteStatus(fn) {\n      return this.on(WEB_RTC_EVENTS.STATUS, fn);\n    }\n\n    return onRemoteStatus;\n  }();\n\n  return WebRTCTransportClass;\n}(Emitter);\n\nvar WebRTCClass = /*#__PURE__*/function () {\n  /*\n   \t\t@param seldId {String}\n   \t\t@param room {String}\n    */\n  function WebRTCClass(selfId, room) {\n    var _this2 = this;\n\n    var autoAccept = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n\n    this.resetCallInProgress = function () {\n      _this2.callInProgress.set(false);\n    };\n\n    this.stopPeerConnection = function (id) {\n      var peerConnection = _this2.peerConnections[id];\n\n      if (peerConnection == null) {\n        return;\n      }\n\n      delete _this2.peerConnections[id];\n      peerConnection.close();\n\n      _this2.updateRemoteItems();\n    };\n\n    this.config = {\n      iceServers: []\n    };\n    this.debug = false;\n    this.TransportClass = WebRTCTransportClass;\n    this.selfId = selfId;\n    this.room = room;\n    var servers = settings.get('WebRTC_Servers');\n\n    if (servers && servers.trim() !== '') {\n      servers = servers.replace(/\\s/g, '');\n      servers = servers.split(',');\n      servers.forEach(function (server) {\n        server = server.split('@');\n        var serverConfig = {\n          urls: server.pop()\n        };\n\n        if (server.length === 1) {\n          server = server[0].split(':');\n          serverConfig.username = decodeURIComponent(server[0]);\n          serverConfig.credential = decodeURIComponent(server[1]);\n        }\n\n        _this2.config.iceServers.push(serverConfig);\n      });\n    }\n\n    this.peerConnections = {};\n    this.remoteItems = new ReactiveVar([]);\n    this.remoteItemsById = new ReactiveVar({});\n    this.callInProgress = new ReactiveVar(false);\n    this.audioEnabled = new ReactiveVar(false);\n    this.videoEnabled = new ReactiveVar(false);\n    this.overlayEnabled = new ReactiveVar(false);\n    this.screenShareEnabled = new ReactiveVar(false);\n    this.localUrl = new ReactiveVar();\n    this.active = false;\n    this.remoteMonitoring = false;\n    this.monitor = false;\n    this.autoAccept = autoAccept;\n    this.navigator = undefined;\n    var userAgent = navigator.userAgent.toLocaleLowerCase();\n\n    if (userAgent.indexOf('electron') !== -1) {\n      this.navigator = 'electron';\n    } else if (userAgent.indexOf('chrome') !== -1) {\n      this.navigator = 'chrome';\n    } else if (userAgent.indexOf('firefox') !== -1) {\n      this.navigator = 'firefox';\n    } else if (userAgent.indexOf('safari') !== -1) {\n      this.navigator = 'safari';\n    }\n\n    this.screenShareAvailable = ['chrome', 'firefox', 'electron'].includes(this.navigator);\n    this.media = {\n      video: true,\n      audio: true\n    };\n    this.transport = new this.TransportClass(this);\n    this.transport.onRemoteCall(this.onRemoteCall.bind(this));\n    this.transport.onRemoteJoin(this.onRemoteJoin.bind(this));\n    this.transport.onRemoteCandidate(this.onRemoteCandidate.bind(this));\n    this.transport.onRemoteDescription(this.onRemoteDescription.bind(this));\n    this.transport.onRemoteStatus(this.onRemoteStatus.bind(this));\n    Meteor.setInterval(this.checkPeerConnections.bind(this), 1000); // Meteor.setInterval(this.broadcastStatus.bind(@), 1000);\n  }\n\n  var _proto2 = WebRTCClass.prototype;\n\n  _proto2.onUserStream = function () {\n    function onUserStream() {\n      var _this$transport;\n\n      return (_this$transport = this.transport).onUserStream.apply(_this$transport, arguments);\n    }\n\n    return onUserStream;\n  }();\n\n  _proto2.log = function () {\n    function log() {\n      if (this.debug === true) {\n        for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n          args[_key] = arguments[_key];\n        }\n\n        console.log.apply(console, args);\n      }\n    }\n\n    return log;\n  }();\n\n  _proto2.onError = function () {\n    function onError() {\n      for (var _len2 = arguments.length, args = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {\n        args[_key2] = arguments[_key2];\n      }\n\n      console.error.apply(console, args);\n    }\n\n    return onError;\n  }();\n\n  _proto2.checkPeerConnections = function () {\n    function checkPeerConnections() {\n      var _this3 = this;\n\n      var peerConnections = this.peerConnections;\n      var date = Date.now();\n      Object.entries(peerConnections).some(function (_ref) {\n        var _ref2 = _slicedToArray(_ref, 2),\n            id = _ref2[0],\n            peerConnection = _ref2[1];\n\n        if (!['connected', 'completed'].includes(peerConnection.iceConnectionState) && peerConnection.createdAt + 5000 < date) {\n          _this3.stopPeerConnection(id);\n\n          return true;\n        }\n\n        return false;\n      });\n    }\n\n    return checkPeerConnections;\n  }();\n\n  _proto2.updateRemoteItems = function () {\n    function updateRemoteItems() {\n      var items = [];\n      var itemsById = {};\n      var peerConnections = this.peerConnections;\n      Object.entries(peerConnections).forEach(function (_ref3) {\n        var _ref4 = _slicedToArray(_ref3, 2),\n            id = _ref4[0],\n            peerConnection = _ref4[1];\n\n        peerConnection.getRemoteStreams().forEach(function (remoteStream) {\n          var item = {\n            id: id,\n            url: remoteStream,\n            state: peerConnection.iceConnectionState\n          };\n\n          switch (peerConnection.iceConnectionState) {\n            case 'checking':\n              item.stateText = 'Connecting...';\n              break;\n\n            case 'connected':\n            case 'completed':\n              item.stateText = 'Connected';\n              item.connected = true;\n              break;\n\n            case 'disconnected':\n              item.stateText = 'Disconnected';\n              break;\n\n            case 'failed':\n              item.stateText = 'Failed';\n              break;\n\n            case 'closed':\n              item.stateText = 'Closed';\n          }\n\n          items.push(item);\n          itemsById[id] = item;\n        });\n      });\n      this.remoteItems.set(items);\n      this.remoteItemsById.set(itemsById);\n    }\n\n    return updateRemoteItems;\n  }();\n\n  _proto2.broadcastStatus = function () {\n    function broadcastStatus() {\n      if (this.active !== true || this.monitor === true || this.remoteMonitoring === true) {\n        return;\n      }\n\n      var remoteConnections = [];\n      var peerConnections = this.peerConnections;\n      Object.keys(peerConnections).entries(function (_ref5) {\n        var _ref6 = _slicedToArray(_ref5, 2),\n            id = _ref6[0],\n            media = _ref6[1].remoteMedia;\n\n        remoteConnections.push({\n          id: id,\n          media: media\n        });\n      });\n      this.transport.sendStatus({\n        media: this.media,\n        remoteConnections: remoteConnections\n      });\n    }\n\n    return broadcastStatus;\n  }()\n  /*\n   \t\t@param data {Object}\n   \t\t\tfrom {String}\n   \t\t\tmedia {Object}\n   \t\t\tremoteConnections {Array[Object]}\n   \t\t\t\tid {String}\n   \t\t\t\tmedia {Object}\n    */\n  ;\n\n  _proto2.onRemoteStatus = function () {\n    function onRemoteStatus(data) {\n      var _this4 = this;\n\n      // this.log(onRemoteStatus, arguments);\n      this.callInProgress.set(true);\n      Meteor.clearTimeout(this.callInProgressTimeout);\n      this.callInProgressTimeout = Meteor.setTimeout(this.resetCallInProgress, 2000);\n\n      if (this.active !== true) {\n        return;\n      }\n\n      var remoteConnections = [{\n        id: data.from,\n        media: data.media\n      }].concat(_toConsumableArray(data.remoteConnections));\n      remoteConnections.forEach(function (remoteConnection) {\n        if (remoteConnection.id !== _this4.selfId && _this4.peerConnections[remoteConnection.id] == null) {\n          _this4.log('reconnecting with', remoteConnection.id);\n\n          _this4.onRemoteJoin({\n            from: remoteConnection.id,\n            media: remoteConnection.media\n          });\n        }\n      });\n    }\n\n    return onRemoteStatus;\n  }()\n  /*\n   \t\t@param id {String}\n    */\n  ;\n\n  _proto2.getPeerConnection = function () {\n    function getPeerConnection(id) {\n      var _this5 = this;\n\n      if (this.peerConnections[id] != null) {\n        return this.peerConnections[id];\n      }\n\n      var peerConnection = new RTCPeerConnection(this.config);\n      peerConnection.createdAt = Date.now();\n      peerConnection.remoteMedia = {};\n      this.peerConnections[id] = peerConnection;\n      var eventNames = ['icecandidate', 'addstream', 'removestream', 'iceconnectionstatechange', 'datachannel', 'identityresult', 'idpassertionerror', 'idpvalidationerror', 'negotiationneeded', 'peeridentity', 'signalingstatechange'];\n      eventNames.forEach(function (eventName) {\n        peerConnection.addEventListener(eventName, function (e) {\n          _this5.log(id, e.type, e);\n        });\n      });\n      peerConnection.addEventListener('icecandidate', function (e) {\n        if (e.candidate == null) {\n          return;\n        }\n\n        _this5.transport.sendCandidate({\n          to: id,\n          candidate: {\n            candidate: e.candidate.candidate,\n            sdpMLineIndex: e.candidate.sdpMLineIndex,\n            sdpMid: e.candidate.sdpMid\n          }\n        });\n      });\n      peerConnection.addEventListener('addstream', function () {\n        _this5.updateRemoteItems();\n      });\n      peerConnection.addEventListener('removestream', function () {\n        _this5.updateRemoteItems();\n      });\n      peerConnection.addEventListener('iceconnectionstatechange', function () {\n        if ((peerConnection.iceConnectionState === 'disconnected' || peerConnection.iceConnectionState === 'closed') && peerConnection === _this5.peerConnections[id]) {\n          _this5.stopPeerConnection(id);\n\n          Meteor.setTimeout(function () {\n            if (Object.keys(_this5.peerConnections).length === 0) {\n              _this5.stop();\n            }\n          }, 3000);\n        }\n\n        _this5.updateRemoteItems();\n      });\n      return peerConnection;\n    }\n\n    return getPeerConnection;\n  }();\n\n  _proto2._getUserMedia = function () {\n    function _getUserMedia(media, onSuccess, onError) {\n      var _this6 = this;\n\n      var onSuccessLocal = function (stream) {\n        if (AudioContext && stream.getAudioTracks().length > 0) {\n          var audioContext = new AudioContext();\n          var source = audioContext.createMediaStreamSource(stream);\n          var volume = audioContext.createGain();\n          source.connect(volume);\n          var peer = audioContext.createMediaStreamDestination();\n          volume.connect(peer);\n          volume.gain.value = 0.6;\n          stream.removeTrack(stream.getAudioTracks()[0]);\n          stream.addTrack(peer.stream.getAudioTracks()[0]);\n          stream.volume = volume;\n          _this6.audioContext = audioContext;\n        }\n\n        onSuccess(stream);\n      };\n\n      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {\n        return navigator.mediaDevices.getUserMedia(media).then(onSuccessLocal).catch(onError);\n      }\n\n      navigator.getUserMedia(media, onSuccessLocal, onError);\n    }\n\n    return _getUserMedia;\n  }();\n\n  _proto2.getUserMedia = function () {\n    function getUserMedia(media, onSuccess) {\n      var _this7 = this;\n\n      var onError = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : this.onError;\n\n      if (media.desktop !== true) {\n        this._getUserMedia(media, onSuccess, onError);\n\n        return;\n      }\n\n      if (this.screenShareAvailable !== true) {\n        console.log('Screen share is not avaliable');\n        return;\n      }\n\n      var getScreen = function (audioStream) {\n        var refresh = function () {\n          modal.open({\n            type: 'warning',\n            title: TAPi18n.__('Refresh_your_page_after_install_to_enable_screen_sharing')\n          });\n        };\n\n        var isChromeExtensionInstalled = _this7.navigator === 'chrome' && ChromeScreenShare.installed;\n        var isFirefoxExtensionInstalled = _this7.navigator === 'firefox' && window.rocketchatscreenshare != null;\n\n        if (!isChromeExtensionInstalled && !isFirefoxExtensionInstalled) {\n          modal.open({\n            type: 'warning',\n            title: TAPi18n.__('Screen_Share'),\n            text: TAPi18n.__('You_need_install_an_extension_to_allow_screen_sharing'),\n            html: true,\n            showCancelButton: true,\n            confirmButtonText: TAPi18n.__('Install_Extension'),\n            cancelButtonText: TAPi18n.__('Cancel')\n          }, function (isConfirm) {\n            if (isConfirm) {\n              if (_this7.navigator === 'chrome') {\n                var url = 'https://chrome.google.com/webstore/detail/rocketchat-screen-share/nocfbnnmjnndkbipkabodnheejiegccf';\n\n                try {\n                  chrome.webstore.install(url, refresh, function () {\n                    window.open(url);\n                    refresh();\n                  });\n                } catch (_error) {\n                  console.log(_error);\n                  window.open(url);\n                  refresh();\n                }\n              } else if (_this7.navigator === 'firefox') {\n                window.open('https://addons.mozilla.org/en-GB/firefox/addon/rocketchat-screen-share/');\n                refresh();\n              }\n            }\n          });\n          return onError(false);\n        }\n\n        var getScreenSuccess = function (stream) {\n          if (audioStream != null) {\n            stream.addTrack(audioStream.getAudioTracks()[0]);\n          }\n\n          onSuccess(stream);\n        };\n\n        if (_this7.navigator === 'firefox') {\n          media = {\n            audio: media.audio,\n            video: {\n              mozMediaSource: 'window',\n              mediaSource: 'window'\n            }\n          };\n\n          _this7._getUserMedia(media, getScreenSuccess, onError);\n        } else {\n          ChromeScreenShare.getSourceId(_this7.navigator, function (id) {\n            media = {\n              audio: false,\n              video: {\n                mandatory: {\n                  chromeMediaSource: 'desktop',\n                  chromeMediaSourceId: id,\n                  maxWidth: 1280,\n                  maxHeight: 720\n                }\n              }\n            };\n\n            _this7._getUserMedia(media, getScreenSuccess, onError);\n          });\n        }\n      };\n\n      if (this.navigator === 'firefox' || media.audio == null || media.audio === false) {\n        getScreen();\n      } else {\n        var getAudioSuccess = function (audioStream) {\n          getScreen(audioStream);\n        };\n\n        var getAudioError = function () {\n          getScreen();\n        };\n\n        this._getUserMedia({\n          audio: media.audio\n        }, getAudioSuccess, getAudioError);\n      }\n    }\n\n    return getUserMedia;\n  }()\n  /*\n   \t\t@param callback {Function}\n    */\n  ;\n\n  _proto2.getLocalUserMedia = function () {\n    function getLocalUserMedia(callback) {\n      var _this8 = this;\n\n      for (var _len3 = arguments.length, args = new Array(_len3 > 1 ? _len3 - 1 : 0), _key3 = 1; _key3 < _len3; _key3++) {\n        args[_key3 - 1] = arguments[_key3];\n      }\n\n      this.log('getLocalUserMedia', [callback].concat(args));\n\n      if (this.localStream != null) {\n        return callback(null, this.localStream);\n      }\n\n      var onSuccess = function (stream) {\n        _this8.localStream = stream;\n        !_this8.audioEnabled.get() && _this8.disableAudio();\n        !_this8.videoEnabled.get() && _this8.disableVideo();\n\n        _this8.localUrl.set(stream);\n\n        var peerConnections = _this8.peerConnections;\n        Object.entries(peerConnections).forEach(function (_ref7) {\n          var _ref8 = _slicedToArray(_ref7, 2),\n              peerConnection = _ref8[1];\n\n          return peerConnection.addStream(stream);\n        });\n        document.querySelector('video#localVideo').srcObject = stream;\n        callback(null, _this8.localStream);\n      };\n\n      var onError = function (error) {\n        callback(false);\n\n        _this8.onError(error);\n      };\n\n      this.getUserMedia(this.media, onSuccess, onError);\n    }\n\n    return getLocalUserMedia;\n  }()\n  /*\n   \t\t@param id {String}\n    */\n  ;\n\n  _proto2.stopAllPeerConnections = function () {\n    function stopAllPeerConnections() {\n      var peerConnections = this.peerConnections;\n      Object.keys(peerConnections).forEach(this.stopPeerConnection);\n      window.audioContext && window.audioContext.close();\n    }\n\n    return stopAllPeerConnections;\n  }();\n\n  _proto2.setAudioEnabled = function () {\n    function setAudioEnabled() {\n      var enabled = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;\n\n      if (this.localStream != null) {\n        this.localStream.getAudioTracks().forEach(function (audio) {\n          audio.enabled = enabled;\n        });\n        this.audioEnabled.set(enabled);\n      }\n    }\n\n    return setAudioEnabled;\n  }();\n\n  _proto2.disableAudio = function () {\n    function disableAudio() {\n      this.setAudioEnabled(false);\n    }\n\n    return disableAudio;\n  }();\n\n  _proto2.enableAudio = function () {\n    function enableAudio() {\n      this.setAudioEnabled(true);\n    }\n\n    return enableAudio;\n  }();\n\n  _proto2.toggleAudio = function () {\n    function toggleAudio() {\n      if (this.audioEnabled.get()) {\n        return this.disableAudio();\n      }\n\n      return this.enableAudio();\n    }\n\n    return toggleAudio;\n  }();\n\n  _proto2.setVideoEnabled = function () {\n    function setVideoEnabled() {\n      var enabled = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;\n\n      if (this.localStream != null) {\n        this.localStream.getVideoTracks().forEach(function (video) {\n          video.enabled = enabled;\n        });\n        this.videoEnabled.set(enabled);\n      }\n    }\n\n    return setVideoEnabled;\n  }();\n\n  _proto2.disableScreenShare = function () {\n    function disableScreenShare() {\n      this.setScreenShareEnabled(false);\n    }\n\n    return disableScreenShare;\n  }();\n\n  _proto2.enableScreenShare = function () {\n    function enableScreenShare() {\n      this.setScreenShareEnabled(true);\n    }\n\n    return enableScreenShare;\n  }();\n\n  _proto2.setScreenShareEnabled = function () {\n    function setScreenShareEnabled() {\n      var _this9 = this;\n\n      var enabled = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;\n\n      if (this.localStream != null) {\n        this.media.desktop = enabled;\n        delete this.localStream;\n        this.getLocalUserMedia(function (err) {\n          if (err != null) {\n            return;\n          }\n\n          _this9.screenShareEnabled.set(enabled);\n\n          _this9.stopAllPeerConnections();\n\n          _this9.joinCall();\n        });\n      }\n    }\n\n    return setScreenShareEnabled;\n  }();\n\n  _proto2.disableVideo = function () {\n    function disableVideo() {\n      this.setVideoEnabled(false);\n    }\n\n    return disableVideo;\n  }();\n\n  _proto2.enableVideo = function () {\n    function enableVideo() {\n      this.setVideoEnabled(true);\n    }\n\n    return enableVideo;\n  }();\n\n  _proto2.toggleVideo = function () {\n    function toggleVideo() {\n      if (this.videoEnabled.get()) {\n        return this.disableVideo();\n      }\n\n      return this.enableVideo();\n    }\n\n    return toggleVideo;\n  }();\n\n  _proto2.stop = function () {\n    function stop() {\n      this.active = false;\n      this.monitor = false;\n      this.remoteMonitoring = false;\n\n      if (this.localStream != null && typeof this.localStream !== 'undefined') {\n        this.localStream.getTracks().forEach(function (track) {\n          return track.stop();\n        });\n      }\n\n      this.localUrl.set(undefined);\n      delete this.localStream;\n      this.stopAllPeerConnections();\n    }\n\n    return stop;\n  }()\n  /*\n   \t\t@param media {Object}\n   \t\t\taudio {Boolean}\n   \t\t\tvideo {Boolean}\n    */\n  ;\n\n  _proto2.startCall = function () {\n    function startCall() {\n      var _this10 = this;\n\n      var media = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n\n      for (var _len4 = arguments.length, args = new Array(_len4 > 1 ? _len4 - 1 : 0), _key4 = 1; _key4 < _len4; _key4++) {\n        args[_key4 - 1] = arguments[_key4];\n      }\n\n      this.log('startCall', [media].concat(args));\n      this.media = media;\n      this.getLocalUserMedia(function () {\n        _this10.active = true;\n\n        _this10.transport.startCall({\n          media: _this10.media\n        });\n      });\n    }\n\n    return startCall;\n  }();\n\n  _proto2.startCallAsMonitor = function () {\n    function startCallAsMonitor() {\n      var media = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n\n      for (var _len5 = arguments.length, args = new Array(_len5 > 1 ? _len5 - 1 : 0), _key5 = 1; _key5 < _len5; _key5++) {\n        args[_key5 - 1] = arguments[_key5];\n      }\n\n      this.log('startCallAsMonitor', [media].concat(args));\n      this.media = media;\n      this.active = true;\n      this.monitor = true;\n      this.transport.startCall({\n        media: this.media,\n        monitor: true\n      });\n    }\n\n    return startCallAsMonitor;\n  }()\n  /*\n   \t\t@param data {Object}\n   \t\t\tfrom {String}\n   \t\t\tmonitor {Boolean}\n   \t\t\tmedia {Object}\n   \t\t\t\taudio {Boolean}\n   \t\t\t\tvideo {Boolean}\n    */\n  ;\n\n  _proto2.onRemoteCall = function () {\n    function onRemoteCall(data) {\n      var _this11 = this;\n\n      if (this.autoAccept === true) {\n        Meteor.defer(function () {\n          _this11.joinCall({\n            to: data.from,\n            monitor: data.monitor,\n            media: data.media\n          });\n        });\n        return;\n      }\n\n      var user = Meteor.users.findOne(data.from);\n      var fromUsername = undefined;\n\n      if (user && user.username) {\n        fromUsername = user.username;\n      }\n\n      var subscription = ChatSubscription.findOne({\n        rid: data.room\n      });\n      var icon;\n      var title;\n\n      if (data.monitor === true) {\n        icon = 'eye';\n        title = t('WebRTC_monitor_call_from_%s', fromUsername);\n      } else if (subscription && subscription.t === 'd') {\n        if (data.media && data.media.video) {\n          icon = 'videocam';\n          title = t('WebRTC_direct_video_call_from_%s', fromUsername);\n        } else {\n          icon = 'phone';\n          title = t('WebRTC_direct_audio_call_from_%s', fromUsername);\n        }\n      } else if (data.media && data.media.video) {\n        icon = 'videocam';\n        title = t('WebRTC_group_video_call_from_%s', subscription.name);\n      } else {\n        icon = 'phone';\n        title = t('WebRTC_group_audio_call_from_%s', subscription.name);\n      }\n\n      modal.open({\n        title: \"<i class='icon-\" + icon + \" alert-icon success-color'></i>\" + title,\n        text: t('Do_you_want_to_accept'),\n        html: true,\n        showCancelButton: true,\n        confirmButtonText: t('Yes'),\n        cancelButtonText: t('No')\n      }, function (isConfirm) {\n        if (isConfirm) {\n          goToRoomById(data.room);\n          return _this11.joinCall({\n            to: data.from,\n            monitor: data.monitor,\n            media: data.media\n          });\n        }\n\n        _this11.stop();\n      });\n    }\n\n    return onRemoteCall;\n  }()\n  /*\n   \t\t@param data {Object}\n   \t\t\tto {String}\n   \t\t\tmonitor {Boolean}\n   \t\t\tmedia {Object}\n   \t\t\t\taudio {Boolean}\n   \t\t\t\tvideo {Boolean}\n   \t\t\t\tdesktop {Boolean}\n    */\n  ;\n\n  _proto2.joinCall = function () {\n    function joinCall() {\n      var _this12 = this;\n\n      var data = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n      data.media = this.media;\n\n      for (var _len6 = arguments.length, args = new Array(_len6 > 1 ? _len6 - 1 : 0), _key6 = 1; _key6 < _len6; _key6++) {\n        args[_key6 - 1] = arguments[_key6];\n      }\n\n      this.log('joinCall', [data].concat(args));\n      this.getLocalUserMedia(function () {\n        _this12.remoteMonitoring = data.monitor;\n        _this12.active = true;\n\n        _this12.transport.joinCall(data);\n      });\n    }\n\n    return joinCall;\n  }();\n\n  _proto2.onRemoteJoin = function () {\n    function onRemoteJoin(data) {\n      var _this13 = this;\n\n      if (this.active !== true) {\n        return;\n      }\n\n      for (var _len7 = arguments.length, args = new Array(_len7 > 1 ? _len7 - 1 : 0), _key7 = 1; _key7 < _len7; _key7++) {\n        args[_key7 - 1] = arguments[_key7];\n      }\n\n      this.log('onRemoteJoin', [data].concat(args));\n      var peerConnection = this.getPeerConnection(data.from); // needsRefresh = false\n      // if peerConnection.iceConnectionState isnt 'new'\n      // needsAudio = data.media.audio is true and peerConnection.remoteMedia.audio isnt true\n      // needsVideo = data.media.video is true and peerConnection.remoteMedia.video isnt true\n      // needsRefresh = needsAudio or needsVideo or data.media.desktop isnt peerConnection.remoteMedia.desktop\n      // # if peerConnection.signalingState is \"have-local-offer\" or needsRefresh\n\n      if (peerConnection.signalingState !== 'checking') {\n        this.stopPeerConnection(data.from);\n        peerConnection = this.getPeerConnection(data.from);\n      }\n\n      if (peerConnection.iceConnectionState !== 'new') {\n        return;\n      }\n\n      peerConnection.remoteMedia = data.media;\n\n      if (this.localStream) {\n        peerConnection.addStream(this.localStream);\n      }\n\n      var onOffer = function (offer) {\n        var onLocalDescription = function () {\n          _this13.transport.sendDescription({\n            to: data.from,\n            type: 'offer',\n            ts: peerConnection.createdAt,\n            media: _this13.media,\n            description: {\n              sdp: offer.sdp,\n              type: offer.type\n            }\n          });\n        };\n\n        peerConnection.setLocalDescription(new RTCSessionDescription(offer), onLocalDescription, _this13.onError);\n      };\n\n      if (data.monitor === true) {\n        peerConnection.createOffer(onOffer, this.onError, {\n          mandatory: {\n            OfferToReceiveAudio: data.media.audio,\n            OfferToReceiveVideo: data.media.video\n          }\n        });\n      } else {\n        peerConnection.createOffer(onOffer, this.onError);\n      }\n    }\n\n    return onRemoteJoin;\n  }();\n\n  _proto2.onRemoteOffer = function () {\n    function onRemoteOffer(data) {\n      var _this14 = this;\n\n      if (this.active !== true) {\n        return;\n      }\n\n      for (var _len8 = arguments.length, args = new Array(_len8 > 1 ? _len8 - 1 : 0), _key8 = 1; _key8 < _len8; _key8++) {\n        args[_key8 - 1] = arguments[_key8];\n      }\n\n      this.log('onRemoteOffer', [data].concat(args));\n      var peerConnection = this.getPeerConnection(data.from);\n\n      if (['have-local-offer', 'stable'].includes(peerConnection.signalingState) && peerConnection.createdAt < data.ts) {\n        this.stopPeerConnection(data.from);\n        peerConnection = this.getPeerConnection(data.from);\n      }\n\n      if (peerConnection.iceConnectionState !== 'new') {\n        return;\n      }\n\n      peerConnection.setRemoteDescription(new RTCSessionDescription(data.description));\n\n      try {\n        if (this.localStream) {\n          peerConnection.addStream(this.localStream);\n        }\n      } catch (error) {\n        console.log(error);\n      }\n\n      var onAnswer = function (answer) {\n        var onLocalDescription = function () {\n          _this14.transport.sendDescription({\n            to: data.from,\n            type: 'answer',\n            ts: peerConnection.createdAt,\n            description: {\n              sdp: answer.sdp,\n              type: answer.type\n            }\n          });\n        };\n\n        peerConnection.setLocalDescription(new RTCSessionDescription(answer), onLocalDescription, _this14.onError);\n      };\n\n      peerConnection.createAnswer(onAnswer, this.onError);\n    }\n\n    return onRemoteOffer;\n  }()\n  /*\n   \t\t@param data {Object}\n   \t\t\tto {String}\n   \t\t\tfrom {String}\n   \t\t\tcandidate {RTCIceCandidate JSON encoded}\n    */\n  ;\n\n  _proto2.onRemoteCandidate = function () {\n    function onRemoteCandidate(data) {\n      var _this$remoteItems$get;\n\n      if (this.active !== true) {\n        return;\n      }\n\n      if (data.to !== this.selfId) {\n        return;\n      }\n\n      for (var _len9 = arguments.length, args = new Array(_len9 > 1 ? _len9 - 1 : 0), _key9 = 1; _key9 < _len9; _key9++) {\n        args[_key9 - 1] = arguments[_key9];\n      }\n\n      this.log('onRemoteCandidate', [data].concat(args));\n      var peerConnection = this.getPeerConnection(data.from);\n\n      if (peerConnection.iceConnectionState !== 'closed' && peerConnection.iceConnectionState !== 'failed' && peerConnection.iceConnectionState !== 'disconnected' && peerConnection.iceConnectionState !== 'completed') {\n        peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));\n      }\n\n      document.querySelector('video#remoteVideo').srcObject = (_this$remoteItems$get = this.remoteItems.get()[0]) === null || _this$remoteItems$get === void 0 ? void 0 : _this$remoteItems$get.url;\n    }\n\n    return onRemoteCandidate;\n  }()\n  /*\n   \t\t@param data {Object}\n   \t\t\tto {String}\n   \t\t\tfrom {String}\n   \t\t\ttype {String} [offer, answer]\n   \t\t\tdescription {RTCSessionDescription JSON encoded}\n   \t\t\tts {Integer}\n   \t\t\tmedia {Object}\n   \t\t\t\taudio {Boolean}\n   \t\t\t\tvideo {Boolean}\n   \t\t\t\tdesktop {Boolean}\n    */\n  ;\n\n  _proto2.onRemoteDescription = function () {\n    function onRemoteDescription(data) {\n      if (this.active !== true) {\n        return;\n      }\n\n      if (data.to !== this.selfId) {\n        return;\n      }\n\n      for (var _len10 = arguments.length, args = new Array(_len10 > 1 ? _len10 - 1 : 0), _key10 = 1; _key10 < _len10; _key10++) {\n        args[_key10 - 1] = arguments[_key10];\n      }\n\n      this.log('onRemoteDescription', [data].concat(args));\n      var peerConnection = this.getPeerConnection(data.from);\n\n      if (data.type === 'offer') {\n        peerConnection.remoteMedia = data.media;\n        this.onRemoteOffer({\n          from: data.from,\n          ts: data.ts,\n          description: data.description\n        });\n      } else {\n        peerConnection.setRemoteDescription(new RTCSessionDescription(data.description));\n      }\n    }\n\n    return onRemoteDescription;\n  }();\n\n  return WebRTCClass;\n}();\n\nvar WebRTC = new ( /*#__PURE__*/function () {\n  function _class() {\n    this.instancesByRoomId = {};\n  }\n\n  var _proto3 = _class.prototype;\n\n  _proto3.getInstanceByRoomId = function () {\n    function getInstanceByRoomId(rid) {\n      var visitorId = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : null;\n      var enabled = false;\n\n      if (!visitorId) {\n        var subscription = ChatSubscription.findOne({\n          rid: rid\n        });\n\n        if (!subscription) {\n          return;\n        }\n\n        switch (subscription.t) {\n          case 'd':\n            enabled = settings.get('WebRTC_Enable_Direct');\n            break;\n\n          case 'p':\n            enabled = settings.get('WebRTC_Enable_Private');\n            break;\n\n          case 'c':\n            enabled = settings.get('WebRTC_Enable_Channel');\n            break;\n\n          case 'l':\n            enabled = settings.get('Omnichannel_call_provider') === 'WebRTC';\n        }\n      } else {\n        enabled = settings.get('Omnichannel_call_provider') === 'WebRTC';\n      }\n\n      enabled = enabled && settings.get('WebRTC_Enabled');\n\n      if (enabled === false) {\n        return;\n      }\n\n      if (this.instancesByRoomId[rid] == null) {\n        var uid = Meteor.userId();\n        var autoAccept = false;\n\n        if (visitorId) {\n          uid = visitorId;\n          autoAccept = true;\n        }\n\n        this.instancesByRoomId[rid] = new WebRTCClass(uid, rid, autoAccept);\n      }\n\n      return this.instancesByRoomId[rid];\n    }\n\n    return getInstanceByRoomId;\n  }();\n\n  return _class;\n}())();\nMeteor.startup(function () {\n  Tracker.autorun(function () {\n    if (Meteor.userId()) {\n      Notifications.onUser(WEB_RTC_EVENTS.WEB_RTC, function (type, data) {\n        if (data.room == null) {\n          return;\n        }\n\n        var webrtc = WebRTC.getInstanceByRoomId(data.room);\n        webrtc.onUserStream(type, data);\n      });\n    }\n  });\n});","map":{"version":3,"sources":["app/webrtc/client/WebRTCClass.js"],"names":["_toConsumableArray","module","link","default","v","_slicedToArray","_inheritsLoose","export","WebRTC","Emitter","Meteor","Tracker","ReactiveVar","TAPi18n","ChromeScreenShare","t","Notifications","settings","modal","ChatSubscription","WEB_RTC_EVENTS","goToRoomById","WebRTCTransportClass","webrtcInstance","debug","onRoom","room","WEB_RTC","type","data","log","emit","console","onUserStream","startCall","selfId","notifyUsersOfRoom","CALL","from","media","monitor","joinCall","notifyUser","to","JOIN","sendCandidate","CANDIDATE","sendDescription","DESCRIPTION","sendStatus","notifyRoom","STATUS","onRemoteCall","fn","on","onRemoteJoin","onRemoteCandidate","onRemoteDescription","onRemoteStatus","WebRTCClass","autoAccept","resetCallInProgress","callInProgress","set","stopPeerConnection","id","peerConnection","peerConnections","close","updateRemoteItems","config","iceServers","TransportClass","servers","get","trim","replace","split","forEach","server","serverConfig","urls","pop","length","username","decodeURIComponent","credential","push","remoteItems","remoteItemsById","audioEnabled","videoEnabled","overlayEnabled","screenShareEnabled","localUrl","active","remoteMonitoring","navigator","undefined","userAgent","toLocaleLowerCase","indexOf","screenShareAvailable","includes","video","audio","transport","bind","setInterval","checkPeerConnections","args","apply","onError","error","date","Date","now","Object","entries","some","iceConnectionState","createdAt","items","itemsById","getRemoteStreams","remoteStream","item","url","state","stateText","connected","broadcastStatus","remoteConnections","keys","remoteMedia","clearTimeout","callInProgressTimeout","setTimeout","remoteConnection","getPeerConnection","RTCPeerConnection","eventNames","eventName","addEventListener","e","candidate","sdpMLineIndex","sdpMid","stop","_getUserMedia","onSuccess","onSuccessLocal","stream","AudioContext","getAudioTracks","audioContext","source","createMediaStreamSource","volume","createGain","connect","peer","createMediaStreamDestination","gain","value","removeTrack","addTrack","mediaDevices","getUserMedia","then","catch","desktop","getScreen","audioStream","refresh","open","title","__","isChromeExtensionInstalled","installed","isFirefoxExtensionInstalled","window","rocketchatscreenshare","text","html","showCancelButton","confirmButtonText","cancelButtonText","isConfirm","chrome","webstore","install","_error","getScreenSuccess","mozMediaSource","mediaSource","getSourceId","mandatory","chromeMediaSource","chromeMediaSourceId","maxWidth","maxHeight","getAudioSuccess","getAudioError","getLocalUserMedia","callback","localStream","disableAudio","disableVideo","addStream","document","querySelector","srcObject","stopAllPeerConnections","setAudioEnabled","enabled","enableAudio","toggleAudio","setVideoEnabled","getVideoTracks","disableScreenShare","setScreenShareEnabled","enableScreenShare","err","enableVideo","toggleVideo","getTracks","track","startCallAsMonitor","defer","user","users","findOne","fromUsername","subscription","rid","icon","name","signalingState","onOffer","offer","onLocalDescription","ts","description","sdp","setLocalDescription","RTCSessionDescription","createOffer","OfferToReceiveAudio","OfferToReceiveVideo","onRemoteOffer","setRemoteDescription","onAnswer","answer","createAnswer","addIceCandidate","RTCIceCandidate","instancesByRoomId","getInstanceByRoomId","visitorId","uid","userId","startup","autorun","onUser","webrtc"],"mappings":"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","sourcesContent":["import { Emitter } from '@rocket.chat/emitter';\nimport { Meteor } from 'meteor/meteor';\nimport { Tracker } from 'meteor/tracker';\nimport { ReactiveVar } from 'meteor/reactive-var';\nimport { TAPi18n } from 'meteor/rocketchat:tap-i18n';\n\nimport { ChromeScreenShare } from './screenShare';\nimport { t } from '../../utils';\nimport { Notifications } from '../../notifications';\nimport { settings } from '../../settings';\nimport { modal } from '../../ui-utils';\nimport { ChatSubscription } from '../../models';\nimport { WEB_RTC_EVENTS } from '..';\nimport { goToRoomById } from '../../../client/lib/utils/goToRoomById';\n\nclass WebRTCTransportClass extends Emitter {\n\tconstructor(webrtcInstance) {\n\t\tsuper();\n\t\tthis.debug = false;\n\t\tthis.webrtcInstance = webrtcInstance;\n\t\tNotifications.onRoom(this.webrtcInstance.room, WEB_RTC_EVENTS.WEB_RTC, (type, data) => {\n\t\t\tthis.log('WebRTCTransportClass - onRoom', type, data);\n\t\t\tthis.emit(type, data);\n\t\t});\n\t}\n\n\tlog(...args) {\n\t\tif (this.debug === true) {\n\t\t\tconsole.log(...args);\n\t\t}\n\t}\n\n\tonUserStream(type, data) {\n\t\tif (data.room !== this.webrtcInstance.room) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.log('WebRTCTransportClass - onUser', type, data);\n\t\tthis.emit(type, data);\n\t}\n\n\tstartCall(data) {\n\t\tthis.log('WebRTCTransportClass - startCall', this.webrtcInstance.room, this.webrtcInstance.selfId);\n\t\tNotifications.notifyUsersOfRoom(this.webrtcInstance.room, WEB_RTC_EVENTS.WEB_RTC, WEB_RTC_EVENTS.CALL, {\n\t\t\tfrom: this.webrtcInstance.selfId,\n\t\t\troom: this.webrtcInstance.room,\n\t\t\tmedia: data.media,\n\t\t\tmonitor: data.monitor,\n\t\t});\n\t}\n\n\tjoinCall(data) {\n\t\tthis.log('WebRTCTransportClass - joinCall', this.webrtcInstance.room, this.webrtcInstance.selfId);\n\t\tif (data.monitor === true) {\n\t\t\tNotifications.notifyUser(data.to, WEB_RTC_EVENTS.WEB_RTC, WEB_RTC_EVENTS.JOIN, {\n\t\t\t\tfrom: this.webrtcInstance.selfId,\n\t\t\t\troom: this.webrtcInstance.room,\n\t\t\t\tmedia: data.media,\n\t\t\t\tmonitor: data.monitor,\n\t\t\t});\n\t\t} else {\n\t\t\tNotifications.notifyUsersOfRoom(this.webrtcInstance.room, WEB_RTC_EVENTS.WEB_RTC, WEB_RTC_EVENTS.JOIN, {\n\t\t\t\tfrom: this.webrtcInstance.selfId,\n\t\t\t\troom: this.webrtcInstance.room,\n\t\t\t\tmedia: data.media,\n\t\t\t\tmonitor: data.monitor,\n\t\t\t});\n\t\t}\n\t}\n\n\tsendCandidate(data) {\n\t\tdata.from = this.webrtcInstance.selfId;\n\t\tdata.room = this.webrtcInstance.room;\n\t\tthis.log('WebRTCTransportClass - sendCandidate', data);\n\t\tNotifications.notifyUser(data.to, WEB_RTC_EVENTS.WEB_RTC, WEB_RTC_EVENTS.CANDIDATE, data);\n\t}\n\n\tsendDescription(data) {\n\t\tdata.from = this.webrtcInstance.selfId;\n\t\tdata.room = this.webrtcInstance.room;\n\t\tthis.log('WebRTCTransportClass - sendDescription', data);\n\t\tNotifications.notifyUser(data.to, WEB_RTC_EVENTS.WEB_RTC, WEB_RTC_EVENTS.DESCRIPTION, data);\n\t}\n\n\tsendStatus(data) {\n\t\tthis.log('WebRTCTransportClass - sendStatus', data, this.webrtcInstance.room);\n\t\tdata.from = this.webrtcInstance.selfId;\n\t\tNotifications.notifyRoom(this.webrtcInstance.room, WEB_RTC_EVENTS.WEB_RTC, WEB_RTC_EVENTS.STATUS, data);\n\t}\n\n\tonRemoteCall(fn) {\n\t\treturn this.on(WEB_RTC_EVENTS.CALL, fn);\n\t}\n\n\tonRemoteJoin(fn) {\n\t\treturn this.on(WEB_RTC_EVENTS.JOIN, fn);\n\t}\n\n\tonRemoteCandidate(fn) {\n\t\treturn this.on(WEB_RTC_EVENTS.CANDIDATE, fn);\n\t}\n\n\tonRemoteDescription(fn) {\n\t\treturn this.on(WEB_RTC_EVENTS.DESCRIPTION, fn);\n\t}\n\n\tonRemoteStatus(fn) {\n\t\treturn this.on(WEB_RTC_EVENTS.STATUS, fn);\n\t}\n}\n\nclass WebRTCClass {\n\t/*\n  \t\t@param seldId {String}\n  \t\t@param room {String}\n   */\n\n\tconstructor(selfId, room, autoAccept = false) {\n\t\tthis.config = {\n\t\t\ticeServers: [],\n\t\t};\n\t\tthis.debug = false;\n\t\tthis.TransportClass = WebRTCTransportClass;\n\t\tthis.selfId = selfId;\n\t\tthis.room = room;\n\t\tlet servers = settings.get('WebRTC_Servers');\n\t\tif (servers && servers.trim() !== '') {\n\t\t\tservers = servers.replace(/\\s/g, '');\n\t\t\tservers = servers.split(',');\n\n\t\t\tservers.forEach((server) => {\n\t\t\t\tserver = server.split('@');\n\t\t\t\tconst serverConfig = {\n\t\t\t\t\turls: server.pop(),\n\t\t\t\t};\n\t\t\t\tif (server.length === 1) {\n\t\t\t\t\tserver = server[0].split(':');\n\t\t\t\t\tserverConfig.username = decodeURIComponent(server[0]);\n\t\t\t\t\tserverConfig.credential = decodeURIComponent(server[1]);\n\t\t\t\t}\n\t\t\t\tthis.config.iceServers.push(serverConfig);\n\t\t\t});\n\t\t}\n\t\tthis.peerConnections = {};\n\t\tthis.remoteItems = new ReactiveVar([]);\n\t\tthis.remoteItemsById = new ReactiveVar({});\n\t\tthis.callInProgress = new ReactiveVar(false);\n\t\tthis.audioEnabled = new ReactiveVar(false);\n\t\tthis.videoEnabled = new ReactiveVar(false);\n\t\tthis.overlayEnabled = new ReactiveVar(false);\n\t\tthis.screenShareEnabled = new ReactiveVar(false);\n\t\tthis.localUrl = new ReactiveVar();\n\t\tthis.active = false;\n\t\tthis.remoteMonitoring = false;\n\t\tthis.monitor = false;\n\t\tthis.autoAccept = autoAccept;\n\t\tthis.navigator = undefined;\n\t\tconst userAgent = navigator.userAgent.toLocaleLowerCase();\n\n\t\tif (userAgent.indexOf('electron') !== -1) {\n\t\t\tthis.navigator = 'electron';\n\t\t} else if (userAgent.indexOf('chrome') !== -1) {\n\t\t\tthis.navigator = 'chrome';\n\t\t} else if (userAgent.indexOf('firefox') !== -1) {\n\t\t\tthis.navigator = 'firefox';\n\t\t} else if (userAgent.indexOf('safari') !== -1) {\n\t\t\tthis.navigator = 'safari';\n\t\t}\n\n\t\tthis.screenShareAvailable = ['chrome', 'firefox', 'electron'].includes(this.navigator);\n\t\tthis.media = {\n\t\t\tvideo: true,\n\t\t\taudio: true,\n\t\t};\n\t\tthis.transport = new this.TransportClass(this);\n\t\tthis.transport.onRemoteCall(this.onRemoteCall.bind(this));\n\t\tthis.transport.onRemoteJoin(this.onRemoteJoin.bind(this));\n\t\tthis.transport.onRemoteCandidate(this.onRemoteCandidate.bind(this));\n\t\tthis.transport.onRemoteDescription(this.onRemoteDescription.bind(this));\n\t\tthis.transport.onRemoteStatus(this.onRemoteStatus.bind(this));\n\n\t\tMeteor.setInterval(this.checkPeerConnections.bind(this), 1000);\n\n\t\t// Meteor.setInterval(this.broadcastStatus.bind(@), 1000);\n\t}\n\n\tonUserStream(...args) {\n\t\treturn this.transport.onUserStream(...args);\n\t}\n\n\tlog(...args) {\n\t\tif (this.debug === true) {\n\t\t\tconsole.log.apply(console, args);\n\t\t}\n\t}\n\n\tonError(...args) {\n\t\tconsole.error.apply(console, args);\n\t}\n\n\tcheckPeerConnections() {\n\t\tconst { peerConnections } = this;\n\t\tconst date = Date.now();\n\t\tObject.entries(peerConnections).some(([id, peerConnection]) => {\n\t\t\tif (!['connected', 'completed'].includes(peerConnection.iceConnectionState) && peerConnection.createdAt + 5000 < date) {\n\t\t\t\tthis.stopPeerConnection(id);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\treturn false;\n\t\t});\n\t}\n\n\tupdateRemoteItems() {\n\t\tconst items = [];\n\t\tconst itemsById = {};\n\t\tconst { peerConnections } = this;\n\n\t\tObject.entries(peerConnections).forEach(([id, peerConnection]) => {\n\t\t\tpeerConnection.getRemoteStreams().forEach((remoteStream) => {\n\t\t\t\tconst item = {\n\t\t\t\t\tid,\n\t\t\t\t\turl: remoteStream,\n\t\t\t\t\tstate: peerConnection.iceConnectionState,\n\t\t\t\t};\n\t\t\t\tswitch (peerConnection.iceConnectionState) {\n\t\t\t\t\tcase 'checking':\n\t\t\t\t\t\titem.stateText = 'Connecting...';\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'connected':\n\t\t\t\t\tcase 'completed':\n\t\t\t\t\t\titem.stateText = 'Connected';\n\t\t\t\t\t\titem.connected = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'disconnected':\n\t\t\t\t\t\titem.stateText = 'Disconnected';\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'failed':\n\t\t\t\t\t\titem.stateText = 'Failed';\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'closed':\n\t\t\t\t\t\titem.stateText = 'Closed';\n\t\t\t\t}\n\t\t\t\titems.push(item);\n\t\t\t\titemsById[id] = item;\n\t\t\t});\n\t\t});\n\t\tthis.remoteItems.set(items);\n\t\tthis.remoteItemsById.set(itemsById);\n\t}\n\n\tresetCallInProgress = () => {\n\t\tthis.callInProgress.set(false);\n\t};\n\n\tbroadcastStatus() {\n\t\tif (this.active !== true || this.monitor === true || this.remoteMonitoring === true) {\n\t\t\treturn;\n\t\t}\n\t\tconst remoteConnections = [];\n\t\tconst { peerConnections } = this;\n\t\tObject.keys(peerConnections).entries(([id, { remoteMedia: media }]) => {\n\t\t\tremoteConnections.push({\n\t\t\t\tid,\n\t\t\t\tmedia,\n\t\t\t});\n\t\t});\n\n\t\tthis.transport.sendStatus({\n\t\t\tmedia: this.media,\n\t\t\tremoteConnections,\n\t\t});\n\t}\n\n\t/*\n  \t\t@param data {Object}\n  \t\t\tfrom {String}\n  \t\t\tmedia {Object}\n  \t\t\tremoteConnections {Array[Object]}\n  \t\t\t\tid {String}\n  \t\t\t\tmedia {Object}\n   */\n\n\tonRemoteStatus(data) {\n\t\t// this.log(onRemoteStatus, arguments);\n\t\tthis.callInProgress.set(true);\n\t\tMeteor.clearTimeout(this.callInProgressTimeout);\n\t\tthis.callInProgressTimeout = Meteor.setTimeout(this.resetCallInProgress, 2000);\n\t\tif (this.active !== true) {\n\t\t\treturn;\n\t\t}\n\t\tconst remoteConnections = [\n\t\t\t{\n\t\t\t\tid: data.from,\n\t\t\t\tmedia: data.media,\n\t\t\t},\n\t\t\t...data.remoteConnections,\n\t\t];\n\n\t\tremoteConnections.forEach((remoteConnection) => {\n\t\t\tif (remoteConnection.id !== this.selfId && this.peerConnections[remoteConnection.id] == null) {\n\t\t\t\tthis.log('reconnecting with', remoteConnection.id);\n\t\t\t\tthis.onRemoteJoin({\n\t\t\t\t\tfrom: remoteConnection.id,\n\t\t\t\t\tmedia: remoteConnection.media,\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\n\t/*\n  \t\t@param id {String}\n   */\n\n\tgetPeerConnection(id) {\n\t\tif (this.peerConnections[id] != null) {\n\t\t\treturn this.peerConnections[id];\n\t\t}\n\t\tconst peerConnection = new RTCPeerConnection(this.config);\n\n\t\tpeerConnection.createdAt = Date.now();\n\t\tpeerConnection.remoteMedia = {};\n\t\tthis.peerConnections[id] = peerConnection;\n\t\tconst eventNames = [\n\t\t\t'icecandidate',\n\t\t\t'addstream',\n\t\t\t'removestream',\n\t\t\t'iceconnectionstatechange',\n\t\t\t'datachannel',\n\t\t\t'identityresult',\n\t\t\t'idpassertionerror',\n\t\t\t'idpvalidationerror',\n\t\t\t'negotiationneeded',\n\t\t\t'peeridentity',\n\t\t\t'signalingstatechange',\n\t\t];\n\n\t\teventNames.forEach((eventName) => {\n\t\t\tpeerConnection.addEventListener(eventName, (e) => {\n\t\t\t\tthis.log(id, e.type, e);\n\t\t\t});\n\t\t});\n\n\t\tpeerConnection.addEventListener('icecandidate', (e) => {\n\t\t\tif (e.candidate == null) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.transport.sendCandidate({\n\t\t\t\tto: id,\n\t\t\t\tcandidate: {\n\t\t\t\t\tcandidate: e.candidate.candidate,\n\t\t\t\t\tsdpMLineIndex: e.candidate.sdpMLineIndex,\n\t\t\t\t\tsdpMid: e.candidate.sdpMid,\n\t\t\t\t},\n\t\t\t});\n\t\t});\n\t\tpeerConnection.addEventListener('addstream', () => {\n\t\t\tthis.updateRemoteItems();\n\t\t});\n\t\tpeerConnection.addEventListener('removestream', () => {\n\t\t\tthis.updateRemoteItems();\n\t\t});\n\t\tpeerConnection.addEventListener('iceconnectionstatechange', () => {\n\t\t\tif (\n\t\t\t\t(peerConnection.iceConnectionState === 'disconnected' || peerConnection.iceConnectionState === 'closed') &&\n\t\t\t\tpeerConnection === this.peerConnections[id]\n\t\t\t) {\n\t\t\t\tthis.stopPeerConnection(id);\n\t\t\t\tMeteor.setTimeout(() => {\n\t\t\t\t\tif (Object.keys(this.peerConnections).length === 0) {\n\t\t\t\t\t\tthis.stop();\n\t\t\t\t\t}\n\t\t\t\t}, 3000);\n\t\t\t}\n\t\t\tthis.updateRemoteItems();\n\t\t});\n\t\treturn peerConnection;\n\t}\n\n\t_getUserMedia(media, onSuccess, onError) {\n\t\tconst onSuccessLocal = (stream) => {\n\t\t\tif (AudioContext && stream.getAudioTracks().length > 0) {\n\t\t\t\tconst audioContext = new AudioContext();\n\t\t\t\tconst source = audioContext.createMediaStreamSource(stream);\n\t\t\t\tconst volume = audioContext.createGain();\n\t\t\t\tsource.connect(volume);\n\t\t\t\tconst peer = audioContext.createMediaStreamDestination();\n\t\t\t\tvolume.connect(peer);\n\t\t\t\tvolume.gain.value = 0.6;\n\t\t\t\tstream.removeTrack(stream.getAudioTracks()[0]);\n\t\t\t\tstream.addTrack(peer.stream.getAudioTracks()[0]);\n\t\t\t\tstream.volume = volume;\n\t\t\t\tthis.audioContext = audioContext;\n\t\t\t}\n\t\t\tonSuccess(stream);\n\t\t};\n\t\tif (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {\n\t\t\treturn navigator.mediaDevices.getUserMedia(media).then(onSuccessLocal).catch(onError);\n\t\t}\n\n\t\tnavigator.getUserMedia(media, onSuccessLocal, onError);\n\t}\n\n\tgetUserMedia(media, onSuccess, onError = this.onError) {\n\t\tif (media.desktop !== true) {\n\t\t\tthis._getUserMedia(media, onSuccess, onError);\n\t\t\treturn;\n\t\t}\n\t\tif (this.screenShareAvailable !== true) {\n\t\t\tconsole.log('Screen share is not avaliable');\n\t\t\treturn;\n\t\t}\n\t\tconst getScreen = (audioStream) => {\n\t\t\tconst refresh = function () {\n\t\t\t\tmodal.open({\n\t\t\t\t\ttype: 'warning',\n\t\t\t\t\ttitle: TAPi18n.__('Refresh_your_page_after_install_to_enable_screen_sharing'),\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tconst isChromeExtensionInstalled = this.navigator === 'chrome' && ChromeScreenShare.installed;\n\t\t\tconst isFirefoxExtensionInstalled = this.navigator === 'firefox' && window.rocketchatscreenshare != null;\n\n\t\t\tif (!isChromeExtensionInstalled && !isFirefoxExtensionInstalled) {\n\t\t\t\tmodal.open(\n\t\t\t\t\t{\n\t\t\t\t\t\ttype: 'warning',\n\t\t\t\t\t\ttitle: TAPi18n.__('Screen_Share'),\n\t\t\t\t\t\ttext: TAPi18n.__('You_need_install_an_extension_to_allow_screen_sharing'),\n\t\t\t\t\t\thtml: true,\n\t\t\t\t\t\tshowCancelButton: true,\n\t\t\t\t\t\tconfirmButtonText: TAPi18n.__('Install_Extension'),\n\t\t\t\t\t\tcancelButtonText: TAPi18n.__('Cancel'),\n\t\t\t\t\t},\n\t\t\t\t\t(isConfirm) => {\n\t\t\t\t\t\tif (isConfirm) {\n\t\t\t\t\t\t\tif (this.navigator === 'chrome') {\n\t\t\t\t\t\t\t\tconst url = 'https://chrome.google.com/webstore/detail/rocketchat-screen-share/nocfbnnmjnndkbipkabodnheejiegccf';\n\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\tchrome.webstore.install(url, refresh, function () {\n\t\t\t\t\t\t\t\t\t\twindow.open(url);\n\t\t\t\t\t\t\t\t\t\trefresh();\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t} catch (_error) {\n\t\t\t\t\t\t\t\t\tconsole.log(_error);\n\t\t\t\t\t\t\t\t\twindow.open(url);\n\t\t\t\t\t\t\t\t\trefresh();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t} else if (this.navigator === 'firefox') {\n\t\t\t\t\t\t\t\twindow.open('https://addons.mozilla.org/en-GB/firefox/addon/rocketchat-screen-share/');\n\t\t\t\t\t\t\t\trefresh();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\treturn onError(false);\n\t\t\t}\n\n\t\t\tconst getScreenSuccess = (stream) => {\n\t\t\t\tif (audioStream != null) {\n\t\t\t\t\tstream.addTrack(audioStream.getAudioTracks()[0]);\n\t\t\t\t}\n\t\t\t\tonSuccess(stream);\n\t\t\t};\n\t\t\tif (this.navigator === 'firefox') {\n\t\t\t\tmedia = {\n\t\t\t\t\taudio: media.audio,\n\t\t\t\t\tvideo: {\n\t\t\t\t\t\tmozMediaSource: 'window',\n\t\t\t\t\t\tmediaSource: 'window',\n\t\t\t\t\t},\n\t\t\t\t};\n\t\t\t\tthis._getUserMedia(media, getScreenSuccess, onError);\n\t\t\t} else {\n\t\t\t\tChromeScreenShare.getSourceId(this.navigator, (id) => {\n\t\t\t\t\tmedia = {\n\t\t\t\t\t\taudio: false,\n\t\t\t\t\t\tvideo: {\n\t\t\t\t\t\t\tmandatory: {\n\t\t\t\t\t\t\t\tchromeMediaSource: 'desktop',\n\t\t\t\t\t\t\t\tchromeMediaSourceId: id,\n\t\t\t\t\t\t\t\tmaxWidth: 1280,\n\t\t\t\t\t\t\t\tmaxHeight: 720,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t};\n\t\t\t\t\tthis._getUserMedia(media, getScreenSuccess, onError);\n\t\t\t\t});\n\t\t\t}\n\t\t};\n\t\tif (this.navigator === 'firefox' || media.audio == null || media.audio === false) {\n\t\t\tgetScreen();\n\t\t} else {\n\t\t\tconst getAudioSuccess = (audioStream) => {\n\t\t\t\tgetScreen(audioStream);\n\t\t\t};\n\t\t\tconst getAudioError = () => {\n\t\t\t\tgetScreen();\n\t\t\t};\n\n\t\t\tthis._getUserMedia(\n\t\t\t\t{\n\t\t\t\t\taudio: media.audio,\n\t\t\t\t},\n\t\t\t\tgetAudioSuccess,\n\t\t\t\tgetAudioError,\n\t\t\t);\n\t\t}\n\t}\n\n\t/*\n  \t\t@param callback {Function}\n   */\n\n\tgetLocalUserMedia(callback, ...args) {\n\t\tthis.log('getLocalUserMedia', [callback, ...args]);\n\t\tif (this.localStream != null) {\n\t\t\treturn callback(null, this.localStream);\n\t\t}\n\t\tconst onSuccess = (stream) => {\n\t\t\tthis.localStream = stream;\n\t\t\t!this.audioEnabled.get() && this.disableAudio();\n\t\t\t!this.videoEnabled.get() && this.disableVideo();\n\t\t\tthis.localUrl.set(stream);\n\t\t\tconst { peerConnections } = this;\n\t\t\tObject.entries(peerConnections).forEach(([, peerConnection]) => peerConnection.addStream(stream));\n\t\t\tdocument.querySelector('video#localVideo').srcObject = stream;\n\t\t\tcallback(null, this.localStream);\n\t\t};\n\t\tconst onError = (error) => {\n\t\t\tcallback(false);\n\t\t\tthis.onError(error);\n\t\t};\n\t\tthis.getUserMedia(this.media, onSuccess, onError);\n\t}\n\n\t/*\n  \t\t@param id {String}\n   */\n\n\tstopPeerConnection = (id) => {\n\t\tconst peerConnection = this.peerConnections[id];\n\t\tif (peerConnection == null) {\n\t\t\treturn;\n\t\t}\n\t\tdelete this.peerConnections[id];\n\t\tpeerConnection.close();\n\t\tthis.updateRemoteItems();\n\t};\n\n\tstopAllPeerConnections() {\n\t\tconst { peerConnections } = this;\n\n\t\tObject.keys(peerConnections).forEach(this.stopPeerConnection);\n\n\t\twindow.audioContext && window.audioContext.close();\n\t}\n\n\tsetAudioEnabled(enabled = true) {\n\t\tif (this.localStream != null) {\n\t\t\tthis.localStream.getAudioTracks().forEach(function (audio) {\n\t\t\t\taudio.enabled = enabled;\n\t\t\t});\n\t\t\tthis.audioEnabled.set(enabled);\n\t\t}\n\t}\n\n\tdisableAudio() {\n\t\tthis.setAudioEnabled(false);\n\t}\n\n\tenableAudio() {\n\t\tthis.setAudioEnabled(true);\n\t}\n\n\ttoggleAudio() {\n\t\tif (this.audioEnabled.get()) {\n\t\t\treturn this.disableAudio();\n\t\t}\n\t\treturn this.enableAudio();\n\t}\n\n\tsetVideoEnabled(enabled = true) {\n\t\tif (this.localStream != null) {\n\t\t\tthis.localStream.getVideoTracks().forEach(function (video) {\n\t\t\t\tvideo.enabled = enabled;\n\t\t\t});\n\t\t\tthis.videoEnabled.set(enabled);\n\t\t}\n\t}\n\n\tdisableScreenShare() {\n\t\tthis.setScreenShareEnabled(false);\n\t}\n\n\tenableScreenShare() {\n\t\tthis.setScreenShareEnabled(true);\n\t}\n\n\tsetScreenShareEnabled(enabled = true) {\n\t\tif (this.localStream != null) {\n\t\t\tthis.media.desktop = enabled;\n\t\t\tdelete this.localStream;\n\t\t\tthis.getLocalUserMedia((err) => {\n\t\t\t\tif (err != null) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tthis.screenShareEnabled.set(enabled);\n\t\t\t\tthis.stopAllPeerConnections();\n\t\t\t\tthis.joinCall();\n\t\t\t});\n\t\t}\n\t}\n\n\tdisableVideo() {\n\t\tthis.setVideoEnabled(false);\n\t}\n\n\tenableVideo() {\n\t\tthis.setVideoEnabled(true);\n\t}\n\n\ttoggleVideo() {\n\t\tif (this.videoEnabled.get()) {\n\t\t\treturn this.disableVideo();\n\t\t}\n\t\treturn this.enableVideo();\n\t}\n\n\tstop() {\n\t\tthis.active = false;\n\t\tthis.monitor = false;\n\t\tthis.remoteMonitoring = false;\n\t\tif (this.localStream != null && typeof this.localStream !== 'undefined') {\n\t\t\tthis.localStream.getTracks().forEach((track) => track.stop());\n\t\t}\n\t\tthis.localUrl.set(undefined);\n\t\tdelete this.localStream;\n\t\tthis.stopAllPeerConnections();\n\t}\n\n\t/*\n  \t\t@param media {Object}\n  \t\t\taudio {Boolean}\n  \t\t\tvideo {Boolean}\n   */\n\n\tstartCall(media = {}, ...args) {\n\t\tthis.log('startCall', [media, ...args]);\n\t\tthis.media = media;\n\t\tthis.getLocalUserMedia(() => {\n\t\t\tthis.active = true;\n\t\t\tthis.transport.startCall({\n\t\t\t\tmedia: this.media,\n\t\t\t});\n\t\t});\n\t}\n\n\tstartCallAsMonitor(media = {}, ...args) {\n\t\tthis.log('startCallAsMonitor', [media, ...args]);\n\t\tthis.media = media;\n\t\tthis.active = true;\n\t\tthis.monitor = true;\n\t\tthis.transport.startCall({\n\t\t\tmedia: this.media,\n\t\t\tmonitor: true,\n\t\t});\n\t}\n\n\t/*\n  \t\t@param data {Object}\n  \t\t\tfrom {String}\n  \t\t\tmonitor {Boolean}\n  \t\t\tmedia {Object}\n  \t\t\t\taudio {Boolean}\n  \t\t\t\tvideo {Boolean}\n   */\n\n\tonRemoteCall(data) {\n\t\tif (this.autoAccept === true) {\n\t\t\tMeteor.defer(() => {\n\t\t\t\tthis.joinCall({\n\t\t\t\t\tto: data.from,\n\t\t\t\t\tmonitor: data.monitor,\n\t\t\t\t\tmedia: data.media,\n\t\t\t\t});\n\t\t\t});\n\t\t\treturn;\n\t\t}\n\n\t\tconst user = Meteor.users.findOne(data.from);\n\t\tlet fromUsername = undefined;\n\t\tif (user && user.username) {\n\t\t\tfromUsername = user.username;\n\t\t}\n\t\tconst subscription = ChatSubscription.findOne({\n\t\t\trid: data.room,\n\t\t});\n\n\t\tlet icon;\n\t\tlet title;\n\t\tif (data.monitor === true) {\n\t\t\ticon = 'eye';\n\t\t\ttitle = t('WebRTC_monitor_call_from_%s', fromUsername);\n\t\t} else if (subscription && subscription.t === 'd') {\n\t\t\tif (data.media && data.media.video) {\n\t\t\t\ticon = 'videocam';\n\t\t\t\ttitle = t('WebRTC_direct_video_call_from_%s', fromUsername);\n\t\t\t} else {\n\t\t\t\ticon = 'phone';\n\t\t\t\ttitle = t('WebRTC_direct_audio_call_from_%s', fromUsername);\n\t\t\t}\n\t\t} else if (data.media && data.media.video) {\n\t\t\ticon = 'videocam';\n\t\t\ttitle = t('WebRTC_group_video_call_from_%s', subscription.name);\n\t\t} else {\n\t\t\ticon = 'phone';\n\t\t\ttitle = t('WebRTC_group_audio_call_from_%s', subscription.name);\n\t\t}\n\t\tmodal.open(\n\t\t\t{\n\t\t\t\ttitle: `<i class='icon-${icon} alert-icon success-color'></i>${title}`,\n\t\t\t\ttext: t('Do_you_want_to_accept'),\n\t\t\t\thtml: true,\n\t\t\t\tshowCancelButton: true,\n\t\t\t\tconfirmButtonText: t('Yes'),\n\t\t\t\tcancelButtonText: t('No'),\n\t\t\t},\n\t\t\t(isConfirm) => {\n\t\t\t\tif (isConfirm) {\n\t\t\t\t\tgoToRoomById(data.room);\n\t\t\t\t\treturn this.joinCall({\n\t\t\t\t\t\tto: data.from,\n\t\t\t\t\t\tmonitor: data.monitor,\n\t\t\t\t\t\tmedia: data.media,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tthis.stop();\n\t\t\t},\n\t\t);\n\t}\n\n\t/*\n  \t\t@param data {Object}\n  \t\t\tto {String}\n  \t\t\tmonitor {Boolean}\n  \t\t\tmedia {Object}\n  \t\t\t\taudio {Boolean}\n  \t\t\t\tvideo {Boolean}\n  \t\t\t\tdesktop {Boolean}\n   */\n\n\tjoinCall(data = {}, ...args) {\n\t\tdata.media = this.media;\n\t\tthis.log('joinCall', [data, ...args]);\n\t\tthis.getLocalUserMedia(() => {\n\t\t\tthis.remoteMonitoring = data.monitor;\n\t\t\tthis.active = true;\n\t\t\tthis.transport.joinCall(data);\n\t\t});\n\t}\n\n\tonRemoteJoin(data, ...args) {\n\t\tif (this.active !== true) {\n\t\t\treturn;\n\t\t}\n\t\tthis.log('onRemoteJoin', [data, ...args]);\n\t\tlet peerConnection = this.getPeerConnection(data.from);\n\n\t\t// needsRefresh = false\n\t\t// if peerConnection.iceConnectionState isnt 'new'\n\t\t// needsAudio = data.media.audio is true and peerConnection.remoteMedia.audio isnt true\n\t\t// needsVideo = data.media.video is true and peerConnection.remoteMedia.video isnt true\n\t\t// needsRefresh = needsAudio or needsVideo or data.media.desktop isnt peerConnection.remoteMedia.desktop\n\n\t\t// # if peerConnection.signalingState is \"have-local-offer\" or needsRefresh\n\n\t\tif (peerConnection.signalingState !== 'checking') {\n\t\t\tthis.stopPeerConnection(data.from);\n\t\t\tpeerConnection = this.getPeerConnection(data.from);\n\t\t}\n\t\tif (peerConnection.iceConnectionState !== 'new') {\n\t\t\treturn;\n\t\t}\n\t\tpeerConnection.remoteMedia = data.media;\n\t\tif (this.localStream) {\n\t\t\tpeerConnection.addStream(this.localStream);\n\t\t}\n\t\tconst onOffer = (offer) => {\n\t\t\tconst onLocalDescription = () => {\n\t\t\t\tthis.transport.sendDescription({\n\t\t\t\t\tto: data.from,\n\t\t\t\t\ttype: 'offer',\n\t\t\t\t\tts: peerConnection.createdAt,\n\t\t\t\t\tmedia: this.media,\n\t\t\t\t\tdescription: {\n\t\t\t\t\t\tsdp: offer.sdp,\n\t\t\t\t\t\ttype: offer.type,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tpeerConnection.setLocalDescription(new RTCSessionDescription(offer), onLocalDescription, this.onError);\n\t\t};\n\n\t\tif (data.monitor === true) {\n\t\t\tpeerConnection.createOffer(onOffer, this.onError, {\n\t\t\t\tmandatory: {\n\t\t\t\t\tOfferToReceiveAudio: data.media.audio,\n\t\t\t\t\tOfferToReceiveVideo: data.media.video,\n\t\t\t\t},\n\t\t\t});\n\t\t} else {\n\t\t\tpeerConnection.createOffer(onOffer, this.onError);\n\t\t}\n\t}\n\n\tonRemoteOffer(data, ...args) {\n\t\tif (this.active !== true) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.log('onRemoteOffer', [data, ...args]);\n\t\tlet peerConnection = this.getPeerConnection(data.from);\n\n\t\tif (['have-local-offer', 'stable'].includes(peerConnection.signalingState) && peerConnection.createdAt < data.ts) {\n\t\t\tthis.stopPeerConnection(data.from);\n\t\t\tpeerConnection = this.getPeerConnection(data.from);\n\t\t}\n\n\t\tif (peerConnection.iceConnectionState !== 'new') {\n\t\t\treturn;\n\t\t}\n\n\t\tpeerConnection.setRemoteDescription(new RTCSessionDescription(data.description));\n\n\t\ttry {\n\t\t\tif (this.localStream) {\n\t\t\t\tpeerConnection.addStream(this.localStream);\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.log(error);\n\t\t}\n\n\t\tconst onAnswer = (answer) => {\n\t\t\tconst onLocalDescription = () => {\n\t\t\t\tthis.transport.sendDescription({\n\t\t\t\t\tto: data.from,\n\t\t\t\t\ttype: 'answer',\n\t\t\t\t\tts: peerConnection.createdAt,\n\t\t\t\t\tdescription: {\n\t\t\t\t\t\tsdp: answer.sdp,\n\t\t\t\t\t\ttype: answer.type,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tpeerConnection.setLocalDescription(new RTCSessionDescription(answer), onLocalDescription, this.onError);\n\t\t};\n\n\t\tpeerConnection.createAnswer(onAnswer, this.onError);\n\t}\n\n\t/*\n  \t\t@param data {Object}\n  \t\t\tto {String}\n  \t\t\tfrom {String}\n  \t\t\tcandidate {RTCIceCandidate JSON encoded}\n   */\n\n\tonRemoteCandidate(data, ...args) {\n\t\tif (this.active !== true) {\n\t\t\treturn;\n\t\t}\n\t\tif (data.to !== this.selfId) {\n\t\t\treturn;\n\t\t}\n\t\tthis.log('onRemoteCandidate', [data, ...args]);\n\t\tconst peerConnection = this.getPeerConnection(data.from);\n\t\tif (\n\t\t\tpeerConnection.iceConnectionState !== 'closed' &&\n\t\t\tpeerConnection.iceConnectionState !== 'failed' &&\n\t\t\tpeerConnection.iceConnectionState !== 'disconnected' &&\n\t\t\tpeerConnection.iceConnectionState !== 'completed'\n\t\t) {\n\t\t\tpeerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));\n\t\t}\n\t\tdocument.querySelector('video#remoteVideo').srcObject = this.remoteItems.get()[0]?.url;\n\t}\n\n\t/*\n  \t\t@param data {Object}\n  \t\t\tto {String}\n  \t\t\tfrom {String}\n  \t\t\ttype {String} [offer, answer]\n  \t\t\tdescription {RTCSessionDescription JSON encoded}\n  \t\t\tts {Integer}\n  \t\t\tmedia {Object}\n  \t\t\t\taudio {Boolean}\n  \t\t\t\tvideo {Boolean}\n  \t\t\t\tdesktop {Boolean}\n   */\n\n\tonRemoteDescription(data, ...args) {\n\t\tif (this.active !== true) {\n\t\t\treturn;\n\t\t}\n\t\tif (data.to !== this.selfId) {\n\t\t\treturn;\n\t\t}\n\t\tthis.log('onRemoteDescription', [data, ...args]);\n\t\tconst peerConnection = this.getPeerConnection(data.from);\n\t\tif (data.type === 'offer') {\n\t\t\tpeerConnection.remoteMedia = data.media;\n\t\t\tthis.onRemoteOffer({\n\t\t\t\tfrom: data.from,\n\t\t\t\tts: data.ts,\n\t\t\t\tdescription: data.description,\n\t\t\t});\n\t\t} else {\n\t\t\tpeerConnection.setRemoteDescription(new RTCSessionDescription(data.description));\n\t\t}\n\t}\n}\n\nconst WebRTC = new (class {\n\tconstructor() {\n\t\tthis.instancesByRoomId = {};\n\t}\n\n\tgetInstanceByRoomId(rid, visitorId = null) {\n\t\tlet enabled = false;\n\t\tif (!visitorId) {\n\t\t\tconst subscription = ChatSubscription.findOne({ rid });\n\t\t\tif (!subscription) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tswitch (subscription.t) {\n\t\t\t\tcase 'd':\n\t\t\t\t\tenabled = settings.get('WebRTC_Enable_Direct');\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'p':\n\t\t\t\t\tenabled = settings.get('WebRTC_Enable_Private');\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'c':\n\t\t\t\t\tenabled = settings.get('WebRTC_Enable_Channel');\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'l':\n\t\t\t\t\tenabled = settings.get('Omnichannel_call_provider') === 'WebRTC';\n\t\t\t}\n\t\t} else {\n\t\t\tenabled = settings.get('Omnichannel_call_provider') === 'WebRTC';\n\t\t}\n\t\tenabled = enabled && settings.get('WebRTC_Enabled');\n\t\tif (enabled === false) {\n\t\t\treturn;\n\t\t}\n\t\tif (this.instancesByRoomId[rid] == null) {\n\t\t\tlet uid = Meteor.userId();\n\t\t\tlet autoAccept = false;\n\t\t\tif (visitorId) {\n\t\t\t\tuid = visitorId;\n\t\t\t\tautoAccept = true;\n\t\t\t}\n\t\t\tthis.instancesByRoomId[rid] = new WebRTCClass(uid, rid, autoAccept);\n\t\t}\n\t\treturn this.instancesByRoomId[rid];\n\t}\n})();\n\nMeteor.startup(function () {\n\tTracker.autorun(function () {\n\t\tif (Meteor.userId()) {\n\t\t\tNotifications.onUser(WEB_RTC_EVENTS.WEB_RTC, (type, data) => {\n\t\t\t\tif (data.room == null) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconst webrtc = WebRTC.getInstanceByRoomId(data.room);\n\t\t\t\twebrtc.onUserStream(type, data);\n\t\t\t});\n\t\t}\n\t});\n});\n\nexport { WebRTC };\n"]},"sourceType":"module","hash":"99c02f090b35ca58524c1f556bc1f1aa841eb789"}
