{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui/client/lib/fileUpload.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"app/ui/client/lib/fileUpload.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui/client/lib/fileUpload.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{}},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui/client/lib/fileUpload.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/ui/client/lib/fileUpload.js"}},"code":"var _regeneratorRuntime;\n\nmodule.link(\"@babel/runtime/regenerator\", {\n  default: function (v) {\n    _regeneratorRuntime = v;\n  }\n}, 0);\nmodule.export({\n  uploadFileWithMessage: function () {\n    return uploadFileWithMessage;\n  },\n  fileUpload: function () {\n    return fileUpload;\n  }\n});\nvar Tracker;\nmodule.link(\"meteor/tracker\", {\n  Tracker: function (v) {\n    Tracker = v;\n  }\n}, 0);\nvar Session;\nmodule.link(\"meteor/session\", {\n  Session: function (v) {\n    Session = v;\n  }\n}, 1);\nvar Random;\nmodule.link(\"meteor/random\", {\n  Random: function (v) {\n    Random = v;\n  }\n}, 2);\nvar Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 3);\nvar settings;\nmodule.link(\"../../../settings/client\", {\n  settings: function (v) {\n    settings = v;\n  }\n}, 4);\nvar UserAction, USER_ACTIVITIES;\nmodule.link(\"../index\", {\n  UserAction: function (v) {\n    UserAction = v;\n  },\n  USER_ACTIVITIES: function (v) {\n    USER_ACTIVITIES = v;\n  }\n}, 5);\nvar fileUploadIsValidContentType, APIClient;\nmodule.link(\"../../../utils\", {\n  fileUploadIsValidContentType: function (v) {\n    fileUploadIsValidContentType = v;\n  },\n  APIClient: function (v) {\n    APIClient = v;\n  }\n}, 6);\nvar imperativeModal;\nmodule.link(\"../../../../client/lib/imperativeModal\", {\n  imperativeModal: function (v) {\n    imperativeModal = v;\n  }\n}, 7);\nvar FileUploadModal;\nmodule.link(\"../../../../client/views/room/modals/FileUploadModal\", {\n  \"default\": function (v) {\n    FileUploadModal = v;\n  }\n}, 8);\nvar prependReplies;\nmodule.link(\"../../../../client/lib/utils/prependReplies\", {\n  prependReplies: function (v) {\n    prependReplies = v;\n  }\n}, 9);\nvar chatMessages;\nmodule.link(\"../views/app/room\", {\n  chatMessages: function (v) {\n    chatMessages = v;\n  }\n}, 10);\n\nvar uploadFileWithMessage = function () {\n  function _callee(rid, tmid, _ref) {\n    var description, fileName, msg, file, data, uploads, upload, _APIClient$upload, xhr, promise, _uploads, remainingUploads, _uploads2;\n\n    return _regeneratorRuntime.async(function () {\n      function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              description = _ref.description, fileName = _ref.fileName, msg = _ref.msg, file = _ref.file;\n              data = new FormData();\n              description && data.append('description', description);\n              msg && data.append('msg', msg);\n              tmid && data.append('tmid', tmid);\n              data.append('file', file.file, fileName);\n              uploads = Session.get('uploading') || [];\n              upload = {\n                id: Random.id(),\n                name: fileName,\n                percentage: 0\n              };\n              uploads.push(upload);\n              Session.set('uploading', uploads);\n              _APIClient$upload = APIClient.upload(\"v1/rooms.upload/\" + rid, {}, data, {\n                progress: function (progress) {\n                  var uploads = Session.get('uploading') || [];\n\n                  if (progress === 100) {\n                    return;\n                  }\n\n                  uploads.filter(function (u) {\n                    return u.id === upload.id;\n                  }).forEach(function (u) {\n                    u.percentage = Math.round(progress) || 0;\n                  });\n                  Session.set('uploading', uploads);\n                },\n                error: function (error) {\n                  var uploads = Session.get('uploading') || [];\n                  uploads.filter(function (u) {\n                    return u.id === upload.id;\n                  }).forEach(function (u) {\n                    u.error = error.message;\n                    u.percentage = 0;\n                  });\n                  Session.set('uploading', uploads);\n                }\n              }), xhr = _APIClient$upload.xhr, promise = _APIClient$upload.promise;\n\n              if (Session.get('uploading').length) {\n                UserAction.performContinuously(rid, USER_ACTIVITIES.USER_UPLOADING, {\n                  tmid: tmid\n                });\n              }\n\n              Tracker.autorun(function (computation) {\n                var isCanceling = Session.get(\"uploading-cancel-\" + upload.id);\n\n                if (!isCanceling) {\n                  return;\n                }\n\n                computation.stop();\n                Session.delete(\"uploading-cancel-\" + upload.id);\n                xhr.abort();\n                var uploads = Session.get('uploading') || {};\n                Session.set('uploading', uploads.filter(function (u) {\n                  return u.id !== upload.id;\n                }));\n              });\n              _context.prev = 13;\n              _context.next = 16;\n              return _regeneratorRuntime.awrap(promise);\n\n            case 16:\n              _uploads = Session.get('uploading') || [];\n              remainingUploads = Session.set('uploading', _uploads.filter(function (u) {\n                return u.id !== upload.id;\n              }));\n\n              if (!Session.get('uploading').length) {\n                UserAction.stop(rid, USER_ACTIVITIES.USER_UPLOADING, {\n                  tmid: tmid\n                });\n              }\n\n              return _context.abrupt(\"return\", remainingUploads);\n\n            case 22:\n              _context.prev = 22;\n              _context.t0 = _context[\"catch\"](13);\n              _uploads2 = Session.get('uploading') || [];\n\n              _uploads2.filter(function (u) {\n                return u.id === upload.id;\n              }).forEach(function (u) {\n                u.error = _context.t0.xhr && _context.t0.xhr.responseJSON && _context.t0.xhr.responseJSON.error || _context.t0.message;\n                u.percentage = 0;\n              });\n\n              if (!_uploads2.length) {\n                UserAction.stop(rid, USER_ACTIVITIES.USER_UPLOADING, {\n                  tmid: tmid\n                });\n              }\n\n              Session.set('uploading', _uploads2);\n\n            case 28:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }\n\n      return _callee$;\n    }(), null, null, [[13, 22]], Promise);\n  }\n\n  return _callee;\n}();\n\nvar fileUpload = function () {\n  function _callee2(files, input, _ref2) {\n    var rid, tmid, threadsEnabled, replies, mention, msg, key, messageBoxText, uploadNextFile;\n    return _regeneratorRuntime.async(function () {\n      function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              rid = _ref2.rid, tmid = _ref2.tmid;\n              threadsEnabled = settings.get('Threads_enabled');\n              files = [].concat(files);\n              replies = $(input).data('reply') || [];\n              mention = $(input).data('mention-user') || false;\n              msg = '';\n\n              if (!(!mention || !threadsEnabled)) {\n                _context2.next = 10;\n                break;\n              }\n\n              _context2.next = 9;\n              return _regeneratorRuntime.awrap(prependReplies('', replies, mention));\n\n            case 9:\n              msg = _context2.sent;\n\n            case 10:\n              if (mention && threadsEnabled && replies.length) {\n                tmid = replies[0]._id;\n              }\n\n              key = ['messagebox', rid, tmid].filter(Boolean).join('_');\n              messageBoxText = Meteor._localStorage.getItem(key) || '';\n\n              uploadNextFile = function () {\n                var file = files.pop();\n\n                if (!file) {\n                  return;\n                }\n\n                imperativeModal.open({\n                  component: FileUploadModal,\n                  props: {\n                    file: file.file,\n                    fileName: file.name,\n                    fileDescription: messageBoxText,\n                    onClose: function () {\n                      imperativeModal.close();\n                      uploadNextFile();\n                    },\n                    onSubmit: function (fileName, description) {\n                      uploadFileWithMessage(rid, tmid, {\n                        description: description,\n                        fileName: fileName,\n                        msg: msg || undefined,\n                        file: file\n                      });\n                      var localStorageKey = ['messagebox', rid, tmid].filter(Boolean).join('_');\n                      var chatMessageKey = [rid, tmid].filter(Boolean).join('-');\n                      var input = chatMessages[chatMessageKey].input;\n                      input.value = null;\n                      $(input).trigger('input');\n\n                      Meteor._localStorage.removeItem(localStorageKey);\n\n                      imperativeModal.close();\n                      uploadNextFile();\n                    },\n                    invalidContentType: file.file.type && !fileUploadIsValidContentType(file.file.type)\n                  }\n                });\n              };\n\n              uploadNextFile();\n\n            case 15:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }\n\n      return _callee2$;\n    }(), null, null, null, Promise);\n  }\n\n  return _callee2;\n}();","map":{"version":3,"sources":["app/ui/client/lib/fileUpload.js"],"names":["_regeneratorRuntime","module","link","default","v","export","uploadFileWithMessage","fileUpload","Tracker","Session","Random","Meteor","settings","UserAction","USER_ACTIVITIES","fileUploadIsValidContentType","APIClient","imperativeModal","FileUploadModal","prependReplies","chatMessages","rid","tmid","description","fileName","msg","file","data","FormData","append","uploads","get","upload","id","name","percentage","push","set","progress","filter","u","forEach","Math","round","error","message","xhr","promise","length","performContinuously","USER_UPLOADING","autorun","computation","isCanceling","stop","delete","abort","remainingUploads","responseJSON","files","input","threadsEnabled","concat","replies","$","mention","_id","key","Boolean","join","messageBoxText","_localStorage","getItem","uploadNextFile","pop","open","component","props","fileDescription","onClose","close","onSubmit","undefined","localStorageKey","chatMessageKey","value","trigger","removeItem","invalidContentType","type"],"mappings":"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","sourcesContent":["import { Tracker } from 'meteor/tracker';\nimport { Session } from 'meteor/session';\nimport { Random } from 'meteor/random';\nimport { Meteor } from 'meteor/meteor';\n\nimport { settings } from '../../../settings/client';\nimport { UserAction, USER_ACTIVITIES } from '../index';\nimport { fileUploadIsValidContentType, APIClient } from '../../../utils';\nimport { imperativeModal } from '../../../../client/lib/imperativeModal';\nimport FileUploadModal from '../../../../client/views/room/modals/FileUploadModal';\nimport { prependReplies } from '../../../../client/lib/utils/prependReplies';\nimport { chatMessages } from '../views/app/room';\n\nexport const uploadFileWithMessage = async (rid, tmid, { description, fileName, msg, file }) => {\n\tconst data = new FormData();\n\tdescription && data.append('description', description);\n\tmsg && data.append('msg', msg);\n\ttmid && data.append('tmid', tmid);\n\tdata.append('file', file.file, fileName);\n\n\tconst uploads = Session.get('uploading') || [];\n\n\tconst upload = {\n\t\tid: Random.id(),\n\t\tname: fileName,\n\t\tpercentage: 0,\n\t};\n\n\tuploads.push(upload);\n\tSession.set('uploading', uploads);\n\n\tconst { xhr, promise } = APIClient.upload(`v1/rooms.upload/${rid}`, {}, data, {\n\t\tprogress(progress) {\n\t\t\tconst uploads = Session.get('uploading') || [];\n\n\t\t\tif (progress === 100) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tuploads\n\t\t\t\t.filter((u) => u.id === upload.id)\n\t\t\t\t.forEach((u) => {\n\t\t\t\t\tu.percentage = Math.round(progress) || 0;\n\t\t\t\t});\n\t\t\tSession.set('uploading', uploads);\n\t\t},\n\t\terror(error) {\n\t\t\tconst uploads = Session.get('uploading') || [];\n\t\t\tuploads\n\t\t\t\t.filter((u) => u.id === upload.id)\n\t\t\t\t.forEach((u) => {\n\t\t\t\t\tu.error = error.message;\n\t\t\t\t\tu.percentage = 0;\n\t\t\t\t});\n\t\t\tSession.set('uploading', uploads);\n\t\t},\n\t});\n\tif (Session.get('uploading').length) {\n\t\tUserAction.performContinuously(rid, USER_ACTIVITIES.USER_UPLOADING, { tmid });\n\t}\n\n\tTracker.autorun((computation) => {\n\t\tconst isCanceling = Session.get(`uploading-cancel-${upload.id}`);\n\t\tif (!isCanceling) {\n\t\t\treturn;\n\t\t}\n\t\tcomputation.stop();\n\t\tSession.delete(`uploading-cancel-${upload.id}`);\n\n\t\txhr.abort();\n\n\t\tconst uploads = Session.get('uploading') || {};\n\t\tSession.set(\n\t\t\t'uploading',\n\t\t\tuploads.filter((u) => u.id !== upload.id),\n\t\t);\n\t});\n\n\ttry {\n\t\tawait promise;\n\t\tconst uploads = Session.get('uploading') || [];\n\t\tconst remainingUploads = Session.set(\n\t\t\t'uploading',\n\t\t\tuploads.filter((u) => u.id !== upload.id),\n\t\t);\n\n\t\tif (!Session.get('uploading').length) {\n\t\t\tUserAction.stop(rid, USER_ACTIVITIES.USER_UPLOADING, { tmid });\n\t\t}\n\t\treturn remainingUploads;\n\t} catch (error) {\n\t\tconst uploads = Session.get('uploading') || [];\n\t\tuploads\n\t\t\t.filter((u) => u.id === upload.id)\n\t\t\t.forEach((u) => {\n\t\t\t\tu.error = (error.xhr && error.xhr.responseJSON && error.xhr.responseJSON.error) || error.message;\n\t\t\t\tu.percentage = 0;\n\t\t\t});\n\t\tif (!uploads.length) {\n\t\t\tUserAction.stop(rid, USER_ACTIVITIES.USER_UPLOADING, { tmid });\n\t\t}\n\t\tSession.set('uploading', uploads);\n\t}\n};\n\nexport const fileUpload = async (files, input, { rid, tmid }) => {\n\tconst threadsEnabled = settings.get('Threads_enabled');\n\n\tfiles = [].concat(files);\n\n\tconst replies = $(input).data('reply') || [];\n\tconst mention = $(input).data('mention-user') || false;\n\n\tlet msg = '';\n\n\tif (!mention || !threadsEnabled) {\n\t\tmsg = await prependReplies('', replies, mention);\n\t}\n\n\tif (mention && threadsEnabled && replies.length) {\n\t\ttmid = replies[0]._id;\n\t}\n\n\tconst key = ['messagebox', rid, tmid].filter(Boolean).join('_');\n\tconst messageBoxText = Meteor._localStorage.getItem(key) || '';\n\n\tconst uploadNextFile = () => {\n\t\tconst file = files.pop();\n\t\tif (!file) {\n\t\t\treturn;\n\t\t}\n\n\t\timperativeModal.open({\n\t\t\tcomponent: FileUploadModal,\n\t\t\tprops: {\n\t\t\t\tfile: file.file,\n\t\t\t\tfileName: file.name,\n\t\t\t\tfileDescription: messageBoxText,\n\t\t\t\tonClose: () => {\n\t\t\t\t\timperativeModal.close();\n\t\t\t\t\tuploadNextFile();\n\t\t\t\t},\n\t\t\t\tonSubmit: (fileName, description) => {\n\t\t\t\t\tuploadFileWithMessage(rid, tmid, {\n\t\t\t\t\t\tdescription,\n\t\t\t\t\t\tfileName,\n\t\t\t\t\t\tmsg: msg || undefined,\n\t\t\t\t\t\tfile,\n\t\t\t\t\t});\n\t\t\t\t\tconst localStorageKey = ['messagebox', rid, tmid].filter(Boolean).join('_');\n\t\t\t\t\tconst chatMessageKey = [rid, tmid].filter(Boolean).join('-');\n\t\t\t\t\tconst { input } = chatMessages[chatMessageKey];\n\t\t\t\t\tinput.value = null;\n\t\t\t\t\t$(input).trigger('input');\n\t\t\t\t\tMeteor._localStorage.removeItem(localStorageKey);\n\t\t\t\t\timperativeModal.close();\n\t\t\t\t\tuploadNextFile();\n\t\t\t\t},\n\t\t\t\tinvalidContentType: file.file.type && !fileUploadIsValidContentType(file.file.type),\n\t\t\t},\n\t\t});\n\t};\n\n\tuploadNextFile();\n};\n"]},"sourceType":"module","hash":"6cf4fd21fa22d6a09e8409e8dd74269374afe967"}
