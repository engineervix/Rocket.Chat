{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/packages/jalik:ufs/ufs-server.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"packages/jalik:ufs/ufs-server.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/packages/jalik:ufs/ufs-server.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{}},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/packages/jalik:ufs/ufs-server.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/jalik:ufs/ufs-server.js"}},"code":"var _typeof;\n\nmodule.link(\"@babel/runtime/helpers/typeof\", {\n  default: function (v) {\n    _typeof = v;\n  }\n}, 0);\nvar Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 0);\nvar WebApp;\nmodule.link(\"meteor/webapp\", {\n  WebApp: function (v) {\n    WebApp = v;\n  }\n}, 1);\nvar SparkMD5;\nmodule.link(\"spark-md5\", {\n  \"default\": function (v) {\n    SparkMD5 = v;\n  }\n}, 2);\nvar UploadFS;\nmodule.link(\"./ufs\", {\n  UploadFS: function (v) {\n    UploadFS = v;\n  }\n}, 3);\n\nif (Meteor.isServer) {\n  var domain = Npm.require('domain');\n\n  var fs = Npm.require('fs'); // eslint-disable-next-line no-unused-vars\n\n\n  var http = Npm.require('http'); // eslint-disable-next-line no-unused-vars\n\n\n  var https = Npm.require('https');\n\n  var mkdirp = Npm.require('mkdirp');\n\n  var stream = Npm.require('stream');\n\n  var URL = Npm.require('url');\n\n  var zlib = Npm.require('zlib');\n\n  Meteor.startup(function () {\n    var path = UploadFS.config.tmpDir;\n    var mode = UploadFS.config.tmpDirPermissions;\n    fs.stat(path, function (err) {\n      if (err) {\n        // Create the temp directory\n        mkdirp(path, {\n          mode: mode\n        }, function (err) {\n          if (err) {\n            console.error(\"ufs: cannot create temp directory at \\\"\" + path + \"\\\" (\" + err.message + \")\");\n          } else {\n            console.log(\"ufs: temp directory created at \\\"\" + path + \"\\\"\");\n          }\n        });\n      } else {\n        // Set directory permissions\n        fs.chmod(path, mode, function (err) {\n          err && console.error(\"ufs: cannot set temp directory permissions \" + mode + \" (\" + err.message + \")\");\n        });\n      }\n    });\n  }); // Create domain to handle errors\n  // and possibly avoid server crashes.\n\n  var d = domain.create();\n  d.on('error', function (err) {\n    console.error(\"ufs: \" + err.message);\n  }); // Listen HTTP requests to serve files\n\n  WebApp.connectHandlers.use(function (req, res, next) {\n    // Quick check to see if request should be caught\n    if (!req.url.includes(\"/\" + UploadFS.config.storesPath + \"/\")) {\n      next();\n      return;\n    } // Remove store path\n\n\n    var parsedUrl = URL.parse(req.url);\n    var path = parsedUrl.pathname.substr(UploadFS.config.storesPath.length + 1);\n\n    var allowCORS = function () {\n      // res.setHeader('Access-Control-Allow-Origin', req.headers.origin);\n      res.setHeader('Access-Control-Allow-Methods', 'POST');\n      res.setHeader('Access-Control-Allow-Origin', '*');\n      res.setHeader('Access-Control-Allow-Headers', 'Content-Type');\n    };\n\n    if (req.method === 'OPTIONS') {\n      var regExp = new RegExp('^/([^/?]+)/([^/?]+)$');\n      var match = regExp.exec(path); // Request is not valid\n\n      if (match === null) {\n        res.writeHead(400);\n        res.end();\n        return;\n      } // Get store\n\n\n      var store = UploadFS.getStore(match[1]);\n\n      if (!store) {\n        res.writeHead(404);\n        res.end();\n        return;\n      } // If a store is found, go ahead and allow the origin\n\n\n      allowCORS();\n      next();\n    } else if (req.method === 'POST') {\n      // Get store\n      var _regExp = new RegExp('^/([^/?]+)/([^/?]+)$');\n\n      var _match = _regExp.exec(path); // Request is not valid\n\n\n      if (_match === null) {\n        res.writeHead(400);\n        res.end();\n        return;\n      } // Get store\n\n\n      var _store = UploadFS.getStore(_match[1]);\n\n      if (!_store) {\n        res.writeHead(404);\n        res.end();\n        return;\n      } // If a store is found, go ahead and allow the origin\n\n\n      allowCORS(); // Get file\n\n      var fileId = _match[2];\n\n      if (_store.getCollection().find({\n        _id: fileId\n      }).count() === 0) {\n        res.writeHead(404);\n        res.end();\n        return;\n      } // Check upload token\n\n\n      if (!_store.checkToken(req.query.token, fileId)) {\n        res.writeHead(403);\n        res.end();\n        return;\n      } // Check if duplicate\n\n\n      var unique = function (hash) {\n        var originalId = _store.getCollection().findOne({\n          hash: hash,\n          _id: {\n            $ne: fileId\n          }\n        });\n\n        return originalId ? originalId._id : false;\n      };\n\n      var spark = new SparkMD5.ArrayBuffer();\n      var tmpFile = UploadFS.getTempFilePath(fileId);\n      var ws = fs.createWriteStream(tmpFile, {\n        flags: 'a'\n      });\n      var fields = {\n        uploading: true\n      };\n      var progress = parseFloat(req.query.progress);\n\n      if (!isNaN(progress) && progress > 0) {\n        fields.progress = Math.min(progress, 1);\n      }\n\n      req.on('data', function (chunk) {\n        ws.write(chunk);\n        spark.append(chunk);\n      }); // eslint-disable-next-line no-unused-vars\n\n      req.on('error', function (err) {\n        res.writeHead(500);\n        res.end();\n      });\n      req.on('end', Meteor.bindEnvironment(function () {\n        // Update completed state without triggering hooks\n        fields.hash = spark.end();\n        fields.originalId = unique(fields.hash);\n\n        _store.getCollection().direct.update({\n          _id: fileId\n        }, {\n          $set: fields\n        });\n\n        ws.end();\n      }));\n      ws.on('error', function (err) {\n        console.error(\"ufs: cannot write chunk of file \\\"\" + fileId + \"\\\" (\" + err.message + \")\");\n        fs.unlink(tmpFile, function (err) {\n          err && console.error(\"ufs: cannot delete temp file \\\"\" + tmpFile + \"\\\" (\" + err.message + \")\");\n        });\n        res.writeHead(500);\n        res.end();\n      });\n      ws.on('finish', function () {\n        res.writeHead(204, {\n          'Content-Type': 'text/plain'\n        });\n        res.end();\n      });\n    } else if (req.method === 'GET') {\n      // Get store, file Id and file name\n      var _regExp2 = new RegExp('^/([^/?]+)/([^/?]+)(?:/([^/?]+))?$');\n\n      var _match2 = _regExp2.exec(path); // Avoid 504 Gateway timeout error\n      // if file is not handled by UploadFS.\n\n\n      if (_match2 === null) {\n        next();\n        return;\n      } // Get store\n\n\n      var storeName = _match2[1];\n\n      var _store2 = UploadFS.getStore(storeName);\n\n      if (!_store2) {\n        res.writeHead(404);\n        res.end();\n        return;\n      }\n\n      if (_store2.onRead !== null && _store2.onRead !== undefined && typeof _store2.onRead !== 'function') {\n        console.error(\"ufs: Store.onRead is not a function in store \\\"\" + storeName + \"\\\"\");\n        res.writeHead(500);\n        res.end();\n        return;\n      } // Remove file extension from file Id\n\n\n      var index = _match2[2].indexOf('.');\n\n      var _fileId = index !== -1 ? _match2[2].substr(0, index) : _match2[2]; // Get file from database\n\n\n      var file = _store2.getCollection().findOne({\n        _id: _fileId\n      });\n\n      if (!file) {\n        res.writeHead(404);\n        res.end();\n        return;\n      } // Simulate read speed\n\n\n      if (UploadFS.config.simulateReadDelay) {\n        Meteor._sleepForMs(UploadFS.config.simulateReadDelay);\n      }\n\n      d.run(function () {\n        // Check if the file can be accessed\n        if (_store2.onRead.call(_store2, _fileId, file, req, res) !== false) {\n          var options = {};\n          var status = 200; // Prepare response headers\n\n          var headers = {\n            'Content-Type': file.type,\n            'Content-Length': file.size\n          }; // Add ETag header\n\n          if (typeof file.etag === 'string') {\n            headers.ETag = file.etag;\n          } // Add Last-Modified header\n\n\n          if (file.modifiedAt instanceof Date) {\n            headers['Last-Modified'] = file.modifiedAt.toUTCString();\n          } else if (file.uploadedAt instanceof Date) {\n            headers['Last-Modified'] = file.uploadedAt.toUTCString();\n          } // Parse request headers\n\n\n          if (_typeof(req.headers) === 'object') {\n            // Compare ETag\n            if (req.headers['if-none-match']) {\n              if (file.etag === req.headers['if-none-match']) {\n                res.writeHead(304); // Not Modified\n\n                res.end();\n                return;\n              }\n            } // Compare file modification date\n\n\n            if (req.headers['if-modified-since']) {\n              var modifiedSince = new Date(req.headers['if-modified-since']);\n\n              if (file.modifiedAt instanceof Date && file.modifiedAt > modifiedSince || // eslint-disable-next-line no-mixed-operators\n              file.uploadedAt instanceof Date && file.uploadedAt > modifiedSince) {\n                res.writeHead(304); // Not Modified\n\n                res.end();\n                return;\n              }\n            } // Support range request\n\n\n            if (typeof req.headers.range === 'string') {\n              var range = req.headers.range; // Range is not valid\n\n              if (!range) {\n                res.writeHead(416);\n                res.end();\n                return;\n              }\n\n              var total = file.size;\n              var unit = range.substr(0, range.indexOf('='));\n\n              if (unit !== 'bytes') {\n                res.writeHead(416);\n                res.end();\n                return;\n              }\n\n              var ranges = range.substr(unit.length).replace(/[^0-9\\-,]/, '').split(',');\n\n              if (ranges.length > 1) {// todo: support multipart ranges: https://developer.mozilla.org/en-US/docs/Web/HTTP/Range_requests\n              } else {\n                var r = ranges[0].split('-');\n                var start = parseInt(r[0], 10);\n                var end = r[1] ? parseInt(r[1], 10) : total - 1; // Range is not valid\n\n                if (start < 0 || end >= total || start > end) {\n                  res.writeHead(416);\n                  res.end();\n                  return;\n                } // Update headers\n\n\n                headers['Content-Range'] = \"bytes \" + start + \"-\" + end + \"/\" + total;\n                headers['Content-Length'] = end - start + 1;\n                options.start = start;\n                options.end = end;\n              }\n\n              status = 206; // partial content\n            }\n          } else {\n            headers['Accept-Ranges'] = 'bytes';\n          } // Open the file stream\n\n\n          var rs = _store2.getReadStream(_fileId, file, options);\n\n          var _ws = new stream.PassThrough();\n\n          rs.on('error', Meteor.bindEnvironment(function (err) {\n            _store2.onReadError.call(_store2, err, _fileId, file);\n\n            res.end();\n          }));\n\n          _ws.on('error', Meteor.bindEnvironment(function (err) {\n            _store2.onReadError.call(_store2, err, _fileId, file);\n\n            res.end();\n          }));\n\n          _ws.on('close', function () {\n            // Close output stream at the end\n            _ws.emit('end');\n          }); // Transform stream\n\n\n          _store2.transformRead(rs, _ws, _fileId, file, req, headers); // Parse request headers\n\n\n          if (_typeof(req.headers) === 'object') {\n            // Compress data using if needed (ignore audio/video as they are already compressed)\n            if (typeof req.headers['accept-encoding'] === 'string' && !/^(audio|video)/.test(file.type)) {\n              var accept = req.headers['accept-encoding']; // Compress with gzip\n\n              if (accept.match(/\\bgzip\\b/)) {\n                headers['Content-Encoding'] = 'gzip';\n                delete headers['Content-Length'];\n                res.writeHead(status, headers);\n\n                _ws.pipe(zlib.createGzip()).pipe(res);\n\n                return;\n              } // Compress with deflate\n\n\n              if (accept.match(/\\bdeflate\\b/)) {\n                headers['Content-Encoding'] = 'deflate';\n                delete headers['Content-Length'];\n                res.writeHead(status, headers);\n\n                _ws.pipe(zlib.createDeflate()).pipe(res);\n\n                return;\n              }\n            }\n          } // Send raw data\n\n\n          if (!headers['Content-Encoding']) {\n            res.writeHead(status, headers);\n\n            _ws.pipe(res);\n          }\n        } else {\n          res.end();\n        }\n      });\n    } else {\n      next();\n    }\n  });\n}","map":{"version":3,"sources":["packages/jalik:ufs/ufs-server.js"],"names":["_typeof","module","link","default","v","Meteor","WebApp","SparkMD5","UploadFS","isServer","domain","Npm","require","fs","http","https","mkdirp","stream","URL","zlib","startup","path","config","tmpDir","mode","tmpDirPermissions","stat","err","console","error","message","log","chmod","d","create","on","connectHandlers","use","req","res","next","url","includes","storesPath","parsedUrl","parse","pathname","substr","length","allowCORS","setHeader","method","regExp","RegExp","match","exec","writeHead","end","store","getStore","fileId","getCollection","find","_id","count","checkToken","query","token","unique","hash","originalId","findOne","$ne","spark","ArrayBuffer","tmpFile","getTempFilePath","ws","createWriteStream","flags","fields","uploading","progress","parseFloat","isNaN","Math","min","chunk","write","append","bindEnvironment","direct","update","$set","unlink","storeName","onRead","undefined","index","indexOf","file","simulateReadDelay","_sleepForMs","run","call","options","status","headers","type","size","etag","ETag","modifiedAt","Date","toUTCString","uploadedAt","modifiedSince","range","total","unit","ranges","replace","split","r","start","parseInt","rs","getReadStream","PassThrough","onReadError","emit","transformRead","test","accept","pipe","createGzip","createDeflate"],"mappings":"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","sourcesContent":["/* eslint-disable no-undef */\n/*\n * The MIT License (MIT)\n *\n * Copyright (c) 2017 Karl STEIN\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy\n * of this software and associated documentation files (the \"Software\"), to deal\n * in the Software without restriction, including without limitation the rights\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n * copies of the Software, and to permit persons to whom the Software is\n * furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all\n * copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n * SOFTWARE.\n *\n */\nimport { Meteor } from 'meteor/meteor';\nimport { WebApp } from 'meteor/webapp';\n// eslint-disable-next-line import/no-unresolved\nimport SparkMD5 from 'spark-md5';\n\nimport { UploadFS } from './ufs';\n\nif (Meteor.isServer) {\n\tconst domain = Npm.require('domain');\n\tconst fs = Npm.require('fs');\n\t// eslint-disable-next-line no-unused-vars\n\tconst http = Npm.require('http');\n\t// eslint-disable-next-line no-unused-vars\n\tconst https = Npm.require('https');\n\tconst mkdirp = Npm.require('mkdirp');\n\tconst stream = Npm.require('stream');\n\tconst URL = Npm.require('url');\n\tconst zlib = Npm.require('zlib');\n\n\tMeteor.startup(() => {\n\t\tconst path = UploadFS.config.tmpDir;\n\t\tconst mode = UploadFS.config.tmpDirPermissions;\n\n\t\tfs.stat(path, (err) => {\n\t\t\tif (err) {\n\t\t\t\t// Create the temp directory\n\t\t\t\tmkdirp(path, { mode }, (err) => {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\tconsole.error(`ufs: cannot create temp directory at \"${path}\" (${err.message})`);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.log(`ufs: temp directory created at \"${path}\"`);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\t// Set directory permissions\n\t\t\t\tfs.chmod(path, mode, (err) => {\n\t\t\t\t\terr && console.error(`ufs: cannot set temp directory permissions ${mode} (${err.message})`);\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t});\n\n\t// Create domain to handle errors\n\t// and possibly avoid server crashes.\n\tconst d = domain.create();\n\n\td.on('error', (err) => {\n\t\tconsole.error(`ufs: ${err.message}`);\n\t});\n\n\t// Listen HTTP requests to serve files\n\tWebApp.connectHandlers.use((req, res, next) => {\n\t\t// Quick check to see if request should be caught\n\t\tif (!req.url.includes(`/${UploadFS.config.storesPath}/`)) {\n\t\t\tnext();\n\t\t\treturn;\n\t\t}\n\n\t\t// Remove store path\n\t\tconst parsedUrl = URL.parse(req.url);\n\t\tconst path = parsedUrl.pathname.substr(UploadFS.config.storesPath.length + 1);\n\n\t\tconst allowCORS = () => {\n\t\t\t// res.setHeader('Access-Control-Allow-Origin', req.headers.origin);\n\t\t\tres.setHeader('Access-Control-Allow-Methods', 'POST');\n\t\t\tres.setHeader('Access-Control-Allow-Origin', '*');\n\t\t\tres.setHeader('Access-Control-Allow-Headers', 'Content-Type');\n\t\t};\n\n\t\tif (req.method === 'OPTIONS') {\n\t\t\tconst regExp = new RegExp('^/([^/?]+)/([^/?]+)$');\n\t\t\tconst match = regExp.exec(path);\n\n\t\t\t// Request is not valid\n\t\t\tif (match === null) {\n\t\t\t\tres.writeHead(400);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Get store\n\t\t\tconst store = UploadFS.getStore(match[1]);\n\t\t\tif (!store) {\n\t\t\t\tres.writeHead(404);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// If a store is found, go ahead and allow the origin\n\t\t\tallowCORS();\n\n\t\t\tnext();\n\t\t} else if (req.method === 'POST') {\n\t\t\t// Get store\n\t\t\tconst regExp = new RegExp('^/([^/?]+)/([^/?]+)$');\n\t\t\tconst match = regExp.exec(path);\n\n\t\t\t// Request is not valid\n\t\t\tif (match === null) {\n\t\t\t\tres.writeHead(400);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Get store\n\t\t\tconst store = UploadFS.getStore(match[1]);\n\t\t\tif (!store) {\n\t\t\t\tres.writeHead(404);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// If a store is found, go ahead and allow the origin\n\t\t\tallowCORS();\n\n\t\t\t// Get file\n\t\t\tconst fileId = match[2];\n\t\t\tif (store.getCollection().find({ _id: fileId }).count() === 0) {\n\t\t\t\tres.writeHead(404);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Check upload token\n\t\t\tif (!store.checkToken(req.query.token, fileId)) {\n\t\t\t\tres.writeHead(403);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Check if duplicate\n\t\t\tconst unique = function (hash) {\n\t\t\t\tconst originalId = store.getCollection().findOne({ hash, _id: { $ne: fileId } });\n\t\t\t\treturn originalId ? originalId._id : false;\n\t\t\t};\n\n\t\t\tconst spark = new SparkMD5.ArrayBuffer();\n\t\t\tconst tmpFile = UploadFS.getTempFilePath(fileId);\n\t\t\tconst ws = fs.createWriteStream(tmpFile, { flags: 'a' });\n\t\t\tconst fields = { uploading: true };\n\t\t\tconst progress = parseFloat(req.query.progress);\n\t\t\tif (!isNaN(progress) && progress > 0) {\n\t\t\t\tfields.progress = Math.min(progress, 1);\n\t\t\t}\n\n\t\t\treq.on('data', (chunk) => {\n\t\t\t\tws.write(chunk);\n\t\t\t\tspark.append(chunk);\n\t\t\t});\n\t\t\t// eslint-disable-next-line no-unused-vars\n\t\t\treq.on('error', (err) => {\n\t\t\t\tres.writeHead(500);\n\t\t\t\tres.end();\n\t\t\t});\n\t\t\treq.on(\n\t\t\t\t'end',\n\t\t\t\tMeteor.bindEnvironment(() => {\n\t\t\t\t\t// Update completed state without triggering hooks\n\t\t\t\t\tfields.hash = spark.end();\n\t\t\t\t\tfields.originalId = unique(fields.hash);\n\t\t\t\t\tstore.getCollection().direct.update({ _id: fileId }, { $set: fields });\n\t\t\t\t\tws.end();\n\t\t\t\t}),\n\t\t\t);\n\t\t\tws.on('error', (err) => {\n\t\t\t\tconsole.error(`ufs: cannot write chunk of file \"${fileId}\" (${err.message})`);\n\t\t\t\tfs.unlink(tmpFile, (err) => {\n\t\t\t\t\terr && console.error(`ufs: cannot delete temp file \"${tmpFile}\" (${err.message})`);\n\t\t\t\t});\n\t\t\t\tres.writeHead(500);\n\t\t\t\tres.end();\n\t\t\t});\n\t\t\tws.on('finish', () => {\n\t\t\t\tres.writeHead(204, { 'Content-Type': 'text/plain' });\n\t\t\t\tres.end();\n\t\t\t});\n\t\t} else if (req.method === 'GET') {\n\t\t\t// Get store, file Id and file name\n\t\t\tconst regExp = new RegExp('^/([^/?]+)/([^/?]+)(?:/([^/?]+))?$');\n\t\t\tconst match = regExp.exec(path);\n\n\t\t\t// Avoid 504 Gateway timeout error\n\t\t\t// if file is not handled by UploadFS.\n\t\t\tif (match === null) {\n\t\t\t\tnext();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Get store\n\t\t\tconst storeName = match[1];\n\t\t\tconst store = UploadFS.getStore(storeName);\n\n\t\t\tif (!store) {\n\t\t\t\tres.writeHead(404);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (store.onRead !== null && store.onRead !== undefined && typeof store.onRead !== 'function') {\n\t\t\t\tconsole.error(`ufs: Store.onRead is not a function in store \"${storeName}\"`);\n\t\t\t\tres.writeHead(500);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Remove file extension from file Id\n\t\t\tconst index = match[2].indexOf('.');\n\t\t\tconst fileId = index !== -1 ? match[2].substr(0, index) : match[2];\n\n\t\t\t// Get file from database\n\t\t\tconst file = store.getCollection().findOne({ _id: fileId });\n\t\t\tif (!file) {\n\t\t\t\tres.writeHead(404);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Simulate read speed\n\t\t\tif (UploadFS.config.simulateReadDelay) {\n\t\t\t\tMeteor._sleepForMs(UploadFS.config.simulateReadDelay);\n\t\t\t}\n\n\t\t\td.run(() => {\n\t\t\t\t// Check if the file can be accessed\n\t\t\t\tif (store.onRead.call(store, fileId, file, req, res) !== false) {\n\t\t\t\t\tconst options = {};\n\t\t\t\t\tlet status = 200;\n\n\t\t\t\t\t// Prepare response headers\n\t\t\t\t\tconst headers = {\n\t\t\t\t\t\t'Content-Type': file.type,\n\t\t\t\t\t\t'Content-Length': file.size,\n\t\t\t\t\t};\n\n\t\t\t\t\t// Add ETag header\n\t\t\t\t\tif (typeof file.etag === 'string') {\n\t\t\t\t\t\theaders.ETag = file.etag;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Add Last-Modified header\n\t\t\t\t\tif (file.modifiedAt instanceof Date) {\n\t\t\t\t\t\theaders['Last-Modified'] = file.modifiedAt.toUTCString();\n\t\t\t\t\t} else if (file.uploadedAt instanceof Date) {\n\t\t\t\t\t\theaders['Last-Modified'] = file.uploadedAt.toUTCString();\n\t\t\t\t\t}\n\n\t\t\t\t\t// Parse request headers\n\t\t\t\t\tif (typeof req.headers === 'object') {\n\t\t\t\t\t\t// Compare ETag\n\t\t\t\t\t\tif (req.headers['if-none-match']) {\n\t\t\t\t\t\t\tif (file.etag === req.headers['if-none-match']) {\n\t\t\t\t\t\t\t\tres.writeHead(304); // Not Modified\n\t\t\t\t\t\t\t\tres.end();\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Compare file modification date\n\t\t\t\t\t\tif (req.headers['if-modified-since']) {\n\t\t\t\t\t\t\tconst modifiedSince = new Date(req.headers['if-modified-since']);\n\n\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t(file.modifiedAt instanceof Date && file.modifiedAt > modifiedSince) ||\n\t\t\t\t\t\t\t\t// eslint-disable-next-line no-mixed-operators\n\t\t\t\t\t\t\t\t(file.uploadedAt instanceof Date && file.uploadedAt > modifiedSince)\n\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\tres.writeHead(304); // Not Modified\n\t\t\t\t\t\t\t\tres.end();\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Support range request\n\t\t\t\t\t\tif (typeof req.headers.range === 'string') {\n\t\t\t\t\t\t\tconst { range } = req.headers;\n\n\t\t\t\t\t\t\t// Range is not valid\n\t\t\t\t\t\t\tif (!range) {\n\t\t\t\t\t\t\t\tres.writeHead(416);\n\t\t\t\t\t\t\t\tres.end();\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tconst total = file.size;\n\t\t\t\t\t\t\tconst unit = range.substr(0, range.indexOf('='));\n\n\t\t\t\t\t\t\tif (unit !== 'bytes') {\n\t\t\t\t\t\t\t\tres.writeHead(416);\n\t\t\t\t\t\t\t\tres.end();\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tconst ranges = range\n\t\t\t\t\t\t\t\t.substr(unit.length)\n\t\t\t\t\t\t\t\t.replace(/[^0-9\\-,]/, '')\n\t\t\t\t\t\t\t\t.split(',');\n\n\t\t\t\t\t\t\tif (ranges.length > 1) {\n\t\t\t\t\t\t\t\t// todo: support multipart ranges: https://developer.mozilla.org/en-US/docs/Web/HTTP/Range_requests\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tconst r = ranges[0].split('-');\n\t\t\t\t\t\t\t\tconst start = parseInt(r[0], 10);\n\t\t\t\t\t\t\t\tconst end = r[1] ? parseInt(r[1], 10) : total - 1;\n\n\t\t\t\t\t\t\t\t// Range is not valid\n\t\t\t\t\t\t\t\tif (start < 0 || end >= total || start > end) {\n\t\t\t\t\t\t\t\t\tres.writeHead(416);\n\t\t\t\t\t\t\t\t\tres.end();\n\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t// Update headers\n\t\t\t\t\t\t\t\theaders['Content-Range'] = `bytes ${start}-${end}/${total}`;\n\t\t\t\t\t\t\t\theaders['Content-Length'] = end - start + 1;\n\t\t\t\t\t\t\t\toptions.start = start;\n\t\t\t\t\t\t\t\toptions.end = end;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tstatus = 206; // partial content\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\theaders['Accept-Ranges'] = 'bytes';\n\t\t\t\t\t}\n\n\t\t\t\t\t// Open the file stream\n\t\t\t\t\tconst rs = store.getReadStream(fileId, file, options);\n\t\t\t\t\tconst ws = new stream.PassThrough();\n\n\t\t\t\t\trs.on(\n\t\t\t\t\t\t'error',\n\t\t\t\t\t\tMeteor.bindEnvironment((err) => {\n\t\t\t\t\t\t\tstore.onReadError.call(store, err, fileId, file);\n\t\t\t\t\t\t\tres.end();\n\t\t\t\t\t\t}),\n\t\t\t\t\t);\n\t\t\t\t\tws.on(\n\t\t\t\t\t\t'error',\n\t\t\t\t\t\tMeteor.bindEnvironment((err) => {\n\t\t\t\t\t\t\tstore.onReadError.call(store, err, fileId, file);\n\t\t\t\t\t\t\tres.end();\n\t\t\t\t\t\t}),\n\t\t\t\t\t);\n\t\t\t\t\tws.on('close', () => {\n\t\t\t\t\t\t// Close output stream at the end\n\t\t\t\t\t\tws.emit('end');\n\t\t\t\t\t});\n\n\t\t\t\t\t// Transform stream\n\t\t\t\t\tstore.transformRead(rs, ws, fileId, file, req, headers);\n\n\t\t\t\t\t// Parse request headers\n\t\t\t\t\tif (typeof req.headers === 'object') {\n\t\t\t\t\t\t// Compress data using if needed (ignore audio/video as they are already compressed)\n\t\t\t\t\t\tif (typeof req.headers['accept-encoding'] === 'string' && !/^(audio|video)/.test(file.type)) {\n\t\t\t\t\t\t\tconst accept = req.headers['accept-encoding'];\n\n\t\t\t\t\t\t\t// Compress with gzip\n\t\t\t\t\t\t\tif (accept.match(/\\bgzip\\b/)) {\n\t\t\t\t\t\t\t\theaders['Content-Encoding'] = 'gzip';\n\t\t\t\t\t\t\t\tdelete headers['Content-Length'];\n\t\t\t\t\t\t\t\tres.writeHead(status, headers);\n\t\t\t\t\t\t\t\tws.pipe(zlib.createGzip()).pipe(res);\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t// Compress with deflate\n\t\t\t\t\t\t\tif (accept.match(/\\bdeflate\\b/)) {\n\t\t\t\t\t\t\t\theaders['Content-Encoding'] = 'deflate';\n\t\t\t\t\t\t\t\tdelete headers['Content-Length'];\n\t\t\t\t\t\t\t\tres.writeHead(status, headers);\n\t\t\t\t\t\t\t\tws.pipe(zlib.createDeflate()).pipe(res);\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Send raw data\n\t\t\t\t\tif (!headers['Content-Encoding']) {\n\t\t\t\t\t\tres.writeHead(status, headers);\n\t\t\t\t\t\tws.pipe(res);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tres.end();\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\tnext();\n\t\t}\n\t});\n}\n"]},"sourceType":"module","hash":"513f3449d29f299feda01f8d7094f3bd955a2fb6"}
