{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/packages/rocketchat:streamer/client/client.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"packages/rocketchat:streamer/client/client.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/packages/rocketchat:streamer/client/client.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{}},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/packages/rocketchat:streamer/client/client.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/rocketchat:streamer/client/client.js"}},"code":"var _createClass;\n\nmodule.link(\"@babel/runtime/helpers/createClass\", {\n  default: function (v) {\n    _createClass = v;\n  }\n}, 0);\n\nvar _assertThisInitialized;\n\nmodule.link(\"@babel/runtime/helpers/assertThisInitialized\", {\n  default: function (v) {\n    _assertThisInitialized = v;\n  }\n}, 1);\n\nvar _inheritsLoose;\n\nmodule.link(\"@babel/runtime/helpers/inheritsLoose\", {\n  default: function (v) {\n    _inheritsLoose = v;\n  }\n}, 2);\n\n/* globals DDPCommon, EV */\n\n/* eslint-disable new-cap */\nvar NonEmptyString = Match.Where(function (x) {\n  check(x, String);\n  return x.length > 0;\n});\n\nvar StreamerCentral = /*#__PURE__*/function (_EV) {\n  _inheritsLoose(StreamerCentral, _EV);\n\n  function StreamerCentral() {\n    var _this;\n\n    _this = _EV.call(this) || this;\n    _this.instances = {};\n    _this.ddpConnections = {}; // since each Streamer instance can provide its own ddp connection, store them by streamer name\n\n    return _this;\n  }\n\n  var _proto = StreamerCentral.prototype;\n\n  _proto.setupDdpConnection = function () {\n    function setupDdpConnection(name, ddpConnection) {\n      var _this2 = this;\n\n      // make sure we only setup event listeners for each ddp connection once\n      if (ddpConnection.hasMeteorStreamerEventListeners) {\n        return;\n      }\n\n      ddpConnection._stream.on('message', function (raw_msg) {\n        var msg = DDPCommon.parseDDP(raw_msg);\n\n        if (msg && msg.msg === 'changed' && msg.collection && msg.fields && msg.fields.eventName && msg.fields.args) {\n          msg.fields.args.unshift(msg.fields.eventName);\n          msg.fields.args.unshift(msg.collection);\n\n          _this2.emit.apply(_this2, msg.fields.args);\n        }\n      }); // store ddp connection\n\n\n      this.storeDdpConnection(name, ddpConnection);\n    }\n\n    return setupDdpConnection;\n  }();\n\n  _proto.storeDdpConnection = function () {\n    function storeDdpConnection(name, ddpConnection) {\n      // mark the connection as setup for Streamer, and store it\n      ddpConnection.hasMeteorStreamerEventListeners = true;\n      this.ddpConnections[name] = ddpConnection;\n    }\n\n    return storeDdpConnection;\n  }();\n\n  return StreamerCentral;\n}(EV);\n\nMeteor.StreamerCentral = new StreamerCentral();\n\nMeteor.Streamer = /*#__PURE__*/function (_EV2) {\n  _inheritsLoose(Streamer, _EV2);\n\n  function Streamer(name) {\n    var _this3;\n\n    var _ref = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},\n        _ref$useCollection = _ref.useCollection,\n        useCollection = _ref$useCollection === void 0 ? false : _ref$useCollection,\n        _ref$ddpConnection = _ref.ddpConnection,\n        ddpConnection = _ref$ddpConnection === void 0 ? Meteor.connection : _ref$ddpConnection;\n\n    if (Meteor.StreamerCentral.instances[name]) {\n      console.warn('Streamer instance already exists:', name);\n      return Meteor.StreamerCentral.instances[name] || _assertThisInitialized(_this3);\n    }\n\n    Meteor.StreamerCentral.setupDdpConnection(name, ddpConnection);\n    _this3 = _EV2.call(this) || this;\n    _this3.ddpConnection = ddpConnection || Meteor.connection;\n    Meteor.StreamerCentral.instances[name] = _assertThisInitialized(_this3);\n    _this3.name = name;\n    _this3.useCollection = useCollection;\n    _this3.subscriptions = {};\n    Meteor.StreamerCentral.on(_this3.subscriptionName, function (eventName) {\n      if (_this3.subscriptions[eventName]) {\n        var _EV$prototype$emit;\n\n        for (var _len = arguments.length, args = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {\n          args[_key - 1] = arguments[_key];\n        }\n\n        _this3.subscriptions[eventName].lastMessage = args;\n\n        (_EV$prototype$emit = EV.prototype.emit).call.apply(_EV$prototype$emit, [_assertThisInitialized(_this3), eventName].concat(args));\n      }\n    });\n\n    _this3.ddpConnection._stream.on('reset', function () {\n      EV.prototype.emit.call(_assertThisInitialized(_this3), '__reconnect__');\n    });\n\n    return _this3;\n  }\n\n  var _proto2 = Streamer.prototype;\n\n  _proto2.stop = function () {\n    function stop(eventName) {\n      return this.subscriptions[eventName] && this.subscriptions[eventName].subscription && this.subscriptions[eventName].subscription.stop();\n    }\n\n    return stop;\n  }();\n\n  _proto2.stopAll = function () {\n    function stopAll() {\n      var _this4 = this;\n\n      Object.keys(this.subscriptions).forEach(function (eventName) {\n        return _this4.removeAllListeners(eventName);\n      });\n    }\n\n    return stopAll;\n  }();\n\n  _proto2.unsubscribe = function () {\n    function unsubscribe(eventName) {\n      delete this.subscriptions[eventName];\n      EV.prototype.removeAllListeners.call(this, eventName);\n    }\n\n    return unsubscribe;\n  }();\n\n  _proto2.subscribe = function () {\n    function subscribe(eventName, args) {\n      var _this5 = this;\n\n      return new Promise(function (resolve, reject) {\n        if (_this5.subscriptions[eventName]) {\n          return resolve();\n        }\n\n        var subscription = Tracker.nonreactive(function () {\n          return _this5.ddpConnection.subscribe(_this5.subscriptionName, eventName, {\n            useCollection: _this5.useCollection,\n            args: args\n          }, {\n            onStop: function () {\n              return reject(_this5.unsubscribe(eventName));\n            },\n            onReady: resolve\n          });\n        });\n        _this5.subscriptions[eventName] = {\n          subscription: subscription\n        };\n      });\n    }\n\n    return subscribe;\n  }();\n\n  _proto2.onReconnect = function () {\n    function onReconnect(fn) {\n      if (typeof fn === 'function') {\n        EV.prototype.on.call(this, '__reconnect__', fn);\n      }\n    }\n\n    return onReconnect;\n  }();\n\n  _proto2.getLastMessageFromEvent = function () {\n    function getLastMessageFromEvent(eventName) {\n      var subscription = this.subscriptions[eventName];\n\n      if (subscription && subscription.lastMessage) {\n        return subscription.lastMessage;\n      }\n    }\n\n    return getLastMessageFromEvent;\n  }();\n\n  _proto2.removeAllListeners = function () {\n    function removeAllListeners(eventName) {\n      EV.prototype.removeAllListeners.call(this, eventName);\n      return this.stop(eventName);\n    }\n\n    return removeAllListeners;\n  }();\n\n  _proto2.removeListener = function () {\n    function removeListener(eventName) {\n      var _EV$prototype$removeL;\n\n      if (this.listenerCount(eventName) === 1) {\n        this.stop(eventName);\n      }\n\n      for (var _len2 = arguments.length, args = new Array(_len2 > 1 ? _len2 - 1 : 0), _key2 = 1; _key2 < _len2; _key2++) {\n        args[_key2 - 1] = arguments[_key2];\n      }\n\n      (_EV$prototype$removeL = EV.prototype.removeListener).call.apply(_EV$prototype$removeL, [this, eventName].concat(args));\n    }\n\n    return removeListener;\n  }();\n\n  _proto2.on = function () {\n    function on(eventName) {\n      check(eventName, NonEmptyString);\n\n      for (var _len3 = arguments.length, args = new Array(_len3 > 1 ? _len3 - 1 : 0), _key3 = 1; _key3 < _len3; _key3++) {\n        args[_key3 - 1] = arguments[_key3];\n      }\n\n      var callback = args.pop();\n      check(callback, Function);\n      EV.prototype.on.call(this, eventName, callback);\n      return this.subscribe(eventName, args);\n    }\n\n    return on;\n  }();\n\n  _proto2.once = function () {\n    function once(eventName) {\n      var _this6 = this;\n\n      check(eventName, NonEmptyString);\n\n      for (var _len4 = arguments.length, args = new Array(_len4 > 1 ? _len4 - 1 : 0), _key4 = 1; _key4 < _len4; _key4++) {\n        args[_key4 - 1] = arguments[_key4];\n      }\n\n      var callback = args.pop();\n      check(callback, Function);\n      EV.prototype.once.call(this, eventName, function () {\n        callback.apply(void 0, arguments);\n\n        if (_this6.listenerCount(eventName) === 0) {\n          return _this6.stop(eventName);\n        }\n      });\n      return this.subscribe(eventName, args);\n    }\n\n    return once;\n  }();\n\n  _proto2.emit = function () {\n    function emit() {\n      var _this$ddpConnection;\n\n      for (var _len5 = arguments.length, args = new Array(_len5), _key5 = 0; _key5 < _len5; _key5++) {\n        args[_key5] = arguments[_key5];\n      }\n\n      (_this$ddpConnection = this.ddpConnection).call.apply(_this$ddpConnection, [this.subscriptionName].concat(args));\n    }\n\n    return emit;\n  }();\n\n  _createClass(Streamer, [{\n    key: \"name\",\n    get: function () {\n      return this._name;\n    },\n    set: function (name) {\n      check(name, String);\n      this._name = name;\n    }\n  }, {\n    key: \"subscriptionName\",\n    get: function () {\n      return \"stream-\" + this.name;\n    }\n  }, {\n    key: \"useCollection\",\n    get: function () {\n      return this._useCollection;\n    },\n    set: function (useCollection) {\n      check(useCollection, Boolean);\n      this._useCollection = useCollection;\n    }\n  }]);\n\n  return Streamer;\n}(EV);","map":{"version":3,"sources":["packages/rocketchat:streamer/client/client.js"],"names":["_createClass","module","link","default","v","_assertThisInitialized","_inheritsLoose","NonEmptyString","Match","Where","x","check","String","length","StreamerCentral","instances","ddpConnections","setupDdpConnection","name","ddpConnection","hasMeteorStreamerEventListeners","_stream","on","raw_msg","msg","DDPCommon","parseDDP","collection","fields","eventName","args","unshift","emit","apply","storeDdpConnection","EV","Meteor","Streamer","useCollection","connection","console","warn","subscriptions","subscriptionName","lastMessage","prototype","call","stop","subscription","stopAll","Object","keys","forEach","removeAllListeners","unsubscribe","subscribe","Promise","resolve","reject","Tracker","nonreactive","onStop","onReady","onReconnect","fn","getLastMessageFromEvent","removeListener","listenerCount","callback","pop","Function","once","_name","_useCollection","Boolean"],"mappings":"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","sourcesContent":["/* globals DDPCommon, EV */\n/* eslint-disable new-cap */\nconst NonEmptyString = Match.Where(function (x) {\n\tcheck(x, String);\n\treturn x.length > 0;\n});\n\nclass StreamerCentral extends EV {\n\tconstructor() {\n\t\tsuper();\n\n\t\tthis.instances = {};\n\t\tthis.ddpConnections = {};\t\t// since each Streamer instance can provide its own ddp connection, store them by streamer name\n\t}\n\n\tsetupDdpConnection(name, ddpConnection) {\n\t\t// make sure we only setup event listeners for each ddp connection once\n\t\tif (ddpConnection.hasMeteorStreamerEventListeners) {\n\t\t\treturn;\n\t\t}\n\t\tddpConnection._stream.on('message', (raw_msg) => {\n\t\t\tconst msg = DDPCommon.parseDDP(raw_msg);\n\t\t\tif (msg && msg.msg === 'changed' && msg.collection && msg.fields && msg.fields.eventName && msg.fields.args) {\n\t\t\t\tmsg.fields.args.unshift(msg.fields.eventName);\n\t\t\t\tmsg.fields.args.unshift(msg.collection);\n\t\t\t\tthis.emit.apply(this, msg.fields.args);\n\t\t\t}\n\t\t});\n\t\t// store ddp connection\n\t\tthis.storeDdpConnection(name, ddpConnection);\n\n\t}\n\n\tstoreDdpConnection(name, ddpConnection) {\n\t\t// mark the connection as setup for Streamer, and store it\n\t\tddpConnection.hasMeteorStreamerEventListeners = true;\n\t\tthis.ddpConnections[name] = ddpConnection;\n\t}\n}\n\nMeteor.StreamerCentral = new StreamerCentral;\n\nMeteor.Streamer = class Streamer extends EV {\n\tconstructor(name, { useCollection = false, ddpConnection = Meteor.connection } = {}) {\n\t\tif (Meteor.StreamerCentral.instances[name]) {\n\t\t\tconsole.warn('Streamer instance already exists:', name);\n\t\t\treturn Meteor.StreamerCentral.instances[name];\n\t\t}\n\t\tMeteor.StreamerCentral.setupDdpConnection(name, ddpConnection);\n\n\t\tsuper();\n\n\t\tthis.ddpConnection = ddpConnection || Meteor.connection;\n\n\t\tMeteor.StreamerCentral.instances[name] = this;\n\n\t\tthis.name = name;\n\t\tthis.useCollection = useCollection;\n\t\tthis.subscriptions = {};\n\n\t\tMeteor.StreamerCentral.on(this.subscriptionName, (eventName, ...args) => {\n\t\t\tif (this.subscriptions[eventName]) {\n\t\t\t\tthis.subscriptions[eventName].lastMessage = args;\n\t\t\t\tEV.prototype.emit.call(this, eventName, ...args);\n\t\t\t}\n\t\t});\n\n\t\tthis.ddpConnection._stream.on('reset', () => {\n\t\t\tEV.prototype.emit.call(this, '__reconnect__');\n\t\t});\n\t}\n\n\tget name() {\n\t\treturn this._name;\n\t}\n\n\tset name(name) {\n\t\tcheck(name, String);\n\t\tthis._name = name;\n\t}\n\n\tget subscriptionName() {\n\t\treturn `stream-${this.name}`;\n\t}\n\n\tget useCollection() {\n\t\treturn this._useCollection;\n\t}\n\n\tset useCollection(useCollection) {\n\t\tcheck(useCollection, Boolean);\n\t\tthis._useCollection = useCollection;\n\t}\n\n\tstop(eventName) {\n\t\treturn this.subscriptions[eventName] && this.subscriptions[eventName].subscription && this.subscriptions[eventName].subscription.stop();\n\t}\n\n\tstopAll() {\n\t\tObject.keys(this.subscriptions).forEach(eventName => this.removeAllListeners(eventName));\n\t}\n\n\tunsubscribe(eventName) {\n\t\tdelete this.subscriptions[eventName];\n\t\tEV.prototype.removeAllListeners.call(this, eventName);\n\t}\n\n\tsubscribe(eventName, args) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tif (this.subscriptions[eventName]) {\n\t\t\t\treturn resolve();\n\t\t\t}\n\t\t\tconst subscription = Tracker.nonreactive(() => this.ddpConnection.subscribe(\n\t\t\t\tthis.subscriptionName,\n\t\t\t\teventName,\n\t\t\t\t{ useCollection: this.useCollection, args },\n\t\t\t\t{\n\t\t\t\t\tonStop: () => reject(this.unsubscribe(eventName)),\n\t\t\t\t\tonReady: resolve\n\t\t\t\t}\n\t\t\t));\n\t\t\tthis.subscriptions[eventName] = { subscription };\n\t\t})\n\t}\n\n\tonReconnect(fn) {\n\t\tif (typeof fn === 'function') {\n\t\t\tEV.prototype.on.call(this, '__reconnect__', fn);\n\t\t}\n\t}\n\n\tgetLastMessageFromEvent(eventName) {\n\t\tconst subscription = this.subscriptions[eventName];\n\t\tif (subscription && subscription.lastMessage) {\n\t\t\treturn subscription.lastMessage;\n\t\t}\n\t}\n\n\tremoveAllListeners(eventName) {\n\t\tEV.prototype.removeAllListeners.call(this, eventName);\n\t\treturn this.stop(eventName);\n\t}\n\n\tremoveListener(eventName, ...args) {\n\t\tif (this.listenerCount(eventName) === 1) {\n\t\t\tthis.stop(eventName);\n\t\t}\n\t\tEV.prototype.removeListener.call(this, eventName, ...args);\n\t}\n\n\ton(eventName, ...args) {\n\t\tcheck(eventName, NonEmptyString);\n\n\t\tconst callback = args.pop();\n\t\tcheck(callback, Function);\n\n\t\tEV.prototype.on.call(this, eventName, callback);\n\n\t\treturn this.subscribe(eventName, args);\n\t}\n\n\tonce(eventName, ...args) {\n\t\tcheck(eventName, NonEmptyString);\n\n\t\tconst callback = args.pop();\n\t\tcheck(callback, Function);\n\n\t\tEV.prototype.once.call(this, eventName, (...args) => {\n\t\t\tcallback(...args);\n\t\t\tif (this.listenerCount(eventName) === 0) {\n\t\t\t\treturn this.stop(eventName);\n\t\t\t}\n\t\t});\n\n\t\treturn this.subscribe(eventName, args);\n\t}\n\n\temit(...args) {\n\t\tthis.ddpConnection.call(this.subscriptionName, ...args);\n\t}\n};\n"]},"sourceType":"module","hash":"b62871dbfde8d0103a6c7e8d09768f0c40b14d71"}
