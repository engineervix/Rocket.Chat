{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui-message/client/popup/messagePopupSlashCommandPreview.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"app/ui-message/client/popup/messagePopupSlashCommandPreview.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui-message/client/popup/messagePopupSlashCommandPreview.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui-message/client/popup/messagePopupSlashCommandPreview.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/ui-message/client/popup/messagePopupSlashCommandPreview.js"}},"code":"let _;\n\nmodule.link(\"underscore\", {\n  default(v) {\n    _ = v;\n  }\n\n}, 0);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 1);\nlet ReactiveVar;\nmodule.link(\"meteor/reactive-var\", {\n  ReactiveVar(v) {\n    ReactiveVar = v;\n  }\n\n}, 2);\nlet Template;\nmodule.link(\"meteor/templating\", {\n  Template(v) {\n    Template = v;\n  }\n\n}, 3);\nlet slashCommands;\nmodule.link(\"../../../utils\", {\n  slashCommands(v) {\n    slashCommands = v;\n  }\n\n}, 4);\nlet hasAtLeastOnePermission;\nmodule.link(\"../../../authorization\", {\n  hasAtLeastOnePermission(v) {\n    hasAtLeastOnePermission = v;\n  }\n\n}, 5);\nmodule.link(\"./messagePopupSlashCommandPreview.html\");\nconst keys = {\n  TAB: 9,\n  ENTER: 13,\n  ESC: 27,\n  ARROW_LEFT: 37,\n  ARROW_UP: 38,\n  ARROW_RIGHT: 39,\n  ARROW_DOWN: 40\n};\n\nfunction getCursorPosition(input) {\n  if (!input) {\n    return;\n  }\n\n  if (input.selectionStart) {\n    return input.selectionStart;\n  }\n\n  if (document.selection) {\n    input.focus();\n    const sel = document.selection.createRange();\n    const selLen = document.selection.createRange().text.length;\n    sel.moveStart('character', -input.value.length);\n    return sel.text.length - selLen;\n  }\n}\n\nTemplate.messagePopupSlashCommandPreview.onCreated(function () {\n  this.open = new ReactiveVar(false);\n  this.isLoading = new ReactiveVar(true);\n  this.preview = new ReactiveVar();\n  this.selectedItem = new ReactiveVar();\n  this.commandName = new ReactiveVar('');\n  this.commandArgs = new ReactiveVar(''); // regex ensures a command is entered into the input\n  // such as \"/testing \" before continuing\n\n  this.matchSelectorRegex = /(?:^)(\\/[\\w\\d\\S]+ )[^]*$/;\n  this.selectorRegex = /(\\/[\\w\\d\\S]+ )([^]*)$/;\n  this.replaceRegex = /(\\/[\\w\\d\\S]+ )[^]*$/; // WHAT'S THIS\n\n  this.dragging = false;\n  const template = this;\n  template.fetchPreviews = _.debounce(function _previewFetcher(cmd, args) {\n    const command = cmd;\n    const params = args;\n    const {\n      rid,\n      tmid\n    } = template.data;\n    Meteor.call('getSlashCommandPreviews', {\n      cmd,\n      params,\n      msg: {\n        rid,\n        tmid\n      }\n    }, function (err, preview) {\n      if (err) {\n        return;\n      }\n\n      if (!preview || !Array.isArray(preview.items)) {\n        template.preview.set({\n          i18nTitle: 'No_results_found_for',\n          items: []\n        });\n      } else {\n        template.preview.set(preview);\n      }\n\n      template.commandName.set(command);\n      template.commandArgs.set(params);\n      template.isLoading.set(false);\n      Meteor.defer(function () {\n        template.verifySelection();\n      });\n    });\n  }, 500);\n\n  template.enterKeyAction = () => {\n    const current = template.find('.popup-item.selected');\n\n    if (!current) {\n      return;\n    }\n\n    const selectedId = current.getAttribute('data-id');\n\n    if (!selectedId) {\n      return;\n    }\n\n    const cmd = template.commandName.curValue;\n    const params = template.commandArgs.curValue;\n\n    if (!cmd || !params) {\n      return;\n    }\n\n    const item = template.preview.curValue.items.find(i => i.id === selectedId);\n\n    if (!item) {\n      return;\n    }\n\n    const {\n      rid,\n      tmid\n    } = template.data;\n    Meteor.call('executeSlashCommandPreview', {\n      cmd,\n      params,\n      msg: {\n        rid,\n        tmid\n      }\n    }, item, function (err) {\n      if (err) {\n        console.warn(err);\n      }\n    });\n    template.open.set(false);\n    template.inputBox.value = '';\n    template.preview.set();\n    template.commandName.set('');\n    template.commandArgs.set('');\n  };\n\n  template.selectionLogic = () => {\n    const inputValueAtCursor = template.inputBox.value.substr(0, getCursorPosition(template.inputBox));\n\n    if (!template.matchSelectorRegex.test(inputValueAtCursor)) {\n      template.open.set(false);\n      return;\n    }\n\n    const matches = inputValueAtCursor.match(template.selectorRegex);\n    const cmd = matches[1].replace('/', '').trim().toLowerCase();\n    const command = slashCommands.commands[cmd]; // Ensure the command they're typing actually exists\n    // And it provides a command preview\n    // And if it provides a permission to check, they have permission to run the command\n\n    const {\n      rid\n    } = template.data;\n\n    if (!command || !command.providesPreview || command.permission && !hasAtLeastOnePermission(command.permission, rid)) {\n      template.open.set(false);\n      return;\n    }\n\n    const args = matches[2]; // Check to verify there are no additional arguments passed,\n    // Because we we don't care about what it if there isn't\n\n    if (!args) {\n      template.open.set(false);\n      return;\n    } // If they haven't changed a thing, show what we already got\n\n\n    if (template.commandName.curValue === cmd && template.commandArgs.curValue === args && template.preview.curValue) {\n      template.isLoading.set(false);\n      template.open.set(true);\n      return;\n    }\n\n    template.isLoading.set(true);\n    template.open.set(true); // Fetch and display them\n\n    template.fetchPreviews(cmd, args);\n  };\n\n  template.verifySelection = () => {\n    const current = template.find('.popup-item.selected');\n\n    if (!current) {\n      const first = template.find('.popup-item');\n\n      if (first) {\n        first.className += ' selected sidebar-item__popup-active';\n      }\n    }\n  }; // Typing data\n\n\n  template.onInputKeyup = event => {\n    if (template.open.curValue === true && event.which === keys.ESC) {\n      template.open.set(false);\n      event.preventDefault();\n      event.stopPropagation();\n      return;\n    }\n\n    if (event.which === keys.ARROW_UP || event.which === keys.ARROW_DOWN) {\n      // Arrow up and down are for navigating the choices\n      return;\n    }\n\n    template.selectionLogic();\n  }; // Using the keyboard to navigate the options\n\n\n  template.onInputKeydown = event => {\n    if (!template.open.curValue || template.isLoading.curValue) {\n      return;\n    }\n\n    if (event.which === keys.ENTER) {\n      // || event.which === keys.TAB) { <-- does using tab to select make sense?\n      template.enterKeyAction();\n      event.preventDefault();\n      event.stopPropagation();\n      return;\n    }\n\n    if (event.which === keys.ARROW_UP) {\n      template.up();\n      event.preventDefault();\n      event.stopPropagation();\n      return;\n    }\n\n    if (event.which === keys.ARROW_DOWN) {\n      template.down();\n      event.preventDefault();\n      event.stopPropagation();\n    }\n  };\n\n  template.up = () => {\n    const current = template.find('.popup-item.selected');\n    const previous = $(current).prev('.popup-item')[0] || template.find('.popup-item:last-child');\n\n    if (previous != null) {\n      current.className = current.className.replace(/\\sselected/, '').replace('sidebar-item__popup-active', '');\n      previous.className += ' selected sidebar-item__popup-active';\n    }\n  };\n\n  template.down = () => {\n    const current = template.find('.popup-item.selected');\n    const next = $(current).next('.popup-item')[0] || template.find('.popup-item');\n\n    if (next && next.classList.contains('popup-item')) {\n      current.className = current.className.replace(/\\sselected/, '').replace('sidebar-item__popup-active', '');\n      next.className += ' selected sidebar-item__popup-active';\n    }\n  };\n\n  template.onFocus = () => {\n    template.clickingItem = false;\n\n    if (template.open.curValue) {\n      return;\n    }\n\n    template.selectionLogic();\n  };\n\n  template.onBlur = () => {\n    if (template.clickingItem) {\n      return;\n    }\n\n    return template.open.set(false);\n  };\n});\nTemplate.messagePopupSlashCommandPreview.onRendered(function _messagePopupSlashCommandPreviewRendered() {\n  if (!this.data.getInput) {\n    throw Error('Somethign wrong happened.');\n  }\n\n  this.inputBox = this.data.getInput();\n  $(this.inputBox).on('keyup', this.onInputKeyup.bind(this));\n  $(this.inputBox).on('keydown', this.onInputKeydown.bind(this));\n  $(this.inputBox).on('focus', this.onFocus.bind(this));\n  $(this.inputBox).on('blur', this.onBlur.bind(this));\n  const self = this;\n  self.autorun(() => {\n    setTimeout(self.selectionLogic, 500);\n  });\n});\nTemplate.messagePopupSlashCommandPreview.onDestroyed(function () {\n  $(this.inputBox).off('keyup', this.onInputKeyup);\n  $(this.inputBox).off('keydown', this.onInputKeydown);\n  $(this.inputBox).off('focus', this.onFocus);\n  $(this.inputBox).off('blur', this.onBlur);\n});\nTemplate.messagePopupSlashCommandPreview.events({\n  'mouseenter .popup-item, mousedown .popup-item, touchstart .popup-item'(e) {\n    if (e.currentTarget.className.includes('selected')) {\n      return;\n    }\n\n    const template = Template.instance();\n    const current = template.find('.popup-item.selected');\n\n    if (current) {\n      current.className = current.className.replace(/\\sselected/, '').replace('sidebar-item__popup-active', '');\n    }\n\n    e.currentTarget.className += ' selected sidebar-item__popup-active';\n  },\n\n  'mousedown .popup-item, touchstart .popup-item'() {\n    const template = Template.instance();\n    template.clickingItem = true;\n  },\n\n  'mouseup .popup-item, touchend .popup-item'() {\n    const template = Template.instance();\n\n    if (template.dragging) {\n      template.dragging = false;\n      return;\n    }\n\n    template.clickingItem = false;\n    template.enterKeyAction();\n  },\n\n  'touchmove .popup-item'(e) {\n    e.stopPropagation();\n    const template = Template.instance();\n    template.dragging = true;\n  }\n\n});\nTemplate.messagePopupSlashCommandPreview.helpers({\n  isOpen() {\n    return Template.instance().open.get(); // && ((Template.instance().hasData.get() || (Template.instance().data.emptyTemplate != null)) || !Template.instance().parentTemplate(1).subscriptionsReady());\n  },\n\n  getArgs() {\n    return Template.instance().commandArgs.get();\n  },\n\n  isLoading() {\n    return Template.instance().isLoading.get();\n  },\n\n  isType(actual, expected) {\n    return actual === expected;\n  },\n\n  preview() {\n    return Template.instance().preview.get();\n  }\n\n});","map":{"version":3,"sources":["app/ui-message/client/popup/messagePopupSlashCommandPreview.js"],"names":["_","module","link","default","v","Meteor","ReactiveVar","Template","slashCommands","hasAtLeastOnePermission","keys","TAB","ENTER","ESC","ARROW_LEFT","ARROW_UP","ARROW_RIGHT","ARROW_DOWN","getCursorPosition","input","selectionStart","document","selection","focus","sel","createRange","selLen","text","length","moveStart","value","messagePopupSlashCommandPreview","onCreated","open","isLoading","preview","selectedItem","commandName","commandArgs","matchSelectorRegex","selectorRegex","replaceRegex","dragging","template","fetchPreviews","debounce","_previewFetcher","cmd","args","command","params","rid","tmid","data","call","msg","err","Array","isArray","items","set","i18nTitle","defer","verifySelection","enterKeyAction","current","find","selectedId","getAttribute","curValue","item","i","id","console","warn","inputBox","selectionLogic","inputValueAtCursor","substr","test","matches","match","replace","trim","toLowerCase","commands","providesPreview","permission","first","className","onInputKeyup","event","which","preventDefault","stopPropagation","onInputKeydown","up","down","previous","$","prev","next","classList","contains","onFocus","clickingItem","onBlur","onRendered","_messagePopupSlashCommandPreviewRendered","getInput","Error","on","bind","self","autorun","setTimeout","onDestroyed","off","events","e","currentTarget","includes","instance","helpers","isOpen","get","getArgs","isType","actual","expected"],"mappings":"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","sourcesContent":["import _ from 'underscore';\nimport { Meteor } from 'meteor/meteor';\nimport { ReactiveVar } from 'meteor/reactive-var';\nimport { Template } from 'meteor/templating';\n\nimport { slashCommands } from '../../../utils';\nimport { hasAtLeastOnePermission } from '../../../authorization';\nimport './messagePopupSlashCommandPreview.html';\n\nconst keys = {\n\tTAB: 9,\n\tENTER: 13,\n\tESC: 27,\n\tARROW_LEFT: 37,\n\tARROW_UP: 38,\n\tARROW_RIGHT: 39,\n\tARROW_DOWN: 40,\n};\n\nfunction getCursorPosition(input) {\n\tif (!input) {\n\t\treturn;\n\t}\n\n\tif (input.selectionStart) {\n\t\treturn input.selectionStart;\n\t}\n\tif (document.selection) {\n\t\tinput.focus();\n\t\tconst sel = document.selection.createRange();\n\t\tconst selLen = document.selection.createRange().text.length;\n\t\tsel.moveStart('character', -input.value.length);\n\t\treturn sel.text.length - selLen;\n\t}\n}\n\nTemplate.messagePopupSlashCommandPreview.onCreated(function () {\n\tthis.open = new ReactiveVar(false);\n\tthis.isLoading = new ReactiveVar(true);\n\tthis.preview = new ReactiveVar();\n\tthis.selectedItem = new ReactiveVar();\n\tthis.commandName = new ReactiveVar('');\n\tthis.commandArgs = new ReactiveVar('');\n\n\t// regex ensures a command is entered into the input\n\t// such as \"/testing \" before continuing\n\tthis.matchSelectorRegex = /(?:^)(\\/[\\w\\d\\S]+ )[^]*$/;\n\tthis.selectorRegex = /(\\/[\\w\\d\\S]+ )([^]*)$/;\n\tthis.replaceRegex = /(\\/[\\w\\d\\S]+ )[^]*$/; // WHAT'S THIS\n\n\tthis.dragging = false;\n\n\tconst template = this;\n\ttemplate.fetchPreviews = _.debounce(function _previewFetcher(cmd, args) {\n\t\tconst command = cmd;\n\t\tconst params = args;\n\t\tconst { rid, tmid } = template.data;\n\t\tMeteor.call('getSlashCommandPreviews', { cmd, params, msg: { rid, tmid } }, function (err, preview) {\n\t\t\tif (err) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!preview || !Array.isArray(preview.items)) {\n\t\t\t\ttemplate.preview.set({\n\t\t\t\t\ti18nTitle: 'No_results_found_for',\n\t\t\t\t\titems: [],\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\ttemplate.preview.set(preview);\n\t\t\t}\n\n\t\t\ttemplate.commandName.set(command);\n\t\t\ttemplate.commandArgs.set(params);\n\t\t\ttemplate.isLoading.set(false);\n\n\t\t\tMeteor.defer(function () {\n\t\t\t\ttemplate.verifySelection();\n\t\t\t});\n\t\t});\n\t}, 500);\n\n\ttemplate.enterKeyAction = () => {\n\t\tconst current = template.find('.popup-item.selected');\n\n\t\tif (!current) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst selectedId = current.getAttribute('data-id');\n\n\t\tif (!selectedId) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst cmd = template.commandName.curValue;\n\t\tconst params = template.commandArgs.curValue;\n\n\t\tif (!cmd || !params) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst item = template.preview.curValue.items.find((i) => i.id === selectedId);\n\n\t\tif (!item) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst { rid, tmid } = template.data;\n\t\tMeteor.call('executeSlashCommandPreview', { cmd, params, msg: { rid, tmid } }, item, function (err) {\n\t\t\tif (err) {\n\t\t\t\tconsole.warn(err);\n\t\t\t}\n\t\t});\n\n\t\ttemplate.open.set(false);\n\t\ttemplate.inputBox.value = '';\n\t\ttemplate.preview.set();\n\t\ttemplate.commandName.set('');\n\t\ttemplate.commandArgs.set('');\n\t};\n\n\ttemplate.selectionLogic = () => {\n\t\tconst inputValueAtCursor = template.inputBox.value.substr(0, getCursorPosition(template.inputBox));\n\n\t\tif (!template.matchSelectorRegex.test(inputValueAtCursor)) {\n\t\t\ttemplate.open.set(false);\n\t\t\treturn;\n\t\t}\n\n\t\tconst matches = inputValueAtCursor.match(template.selectorRegex);\n\t\tconst cmd = matches[1].replace('/', '').trim().toLowerCase();\n\t\tconst command = slashCommands.commands[cmd];\n\n\t\t// Ensure the command they're typing actually exists\n\t\t// And it provides a command preview\n\t\t// And if it provides a permission to check, they have permission to run the command\n\t\tconst { rid } = template.data;\n\t\tif (!command || !command.providesPreview || (command.permission && !hasAtLeastOnePermission(command.permission, rid))) {\n\t\t\ttemplate.open.set(false);\n\t\t\treturn;\n\t\t}\n\n\t\tconst args = matches[2];\n\n\t\t// Check to verify there are no additional arguments passed,\n\t\t// Because we we don't care about what it if there isn't\n\t\tif (!args) {\n\t\t\ttemplate.open.set(false);\n\t\t\treturn;\n\t\t}\n\n\t\t// If they haven't changed a thing, show what we already got\n\t\tif (template.commandName.curValue === cmd && template.commandArgs.curValue === args && template.preview.curValue) {\n\t\t\ttemplate.isLoading.set(false);\n\t\t\ttemplate.open.set(true);\n\t\t\treturn;\n\t\t}\n\n\t\ttemplate.isLoading.set(true);\n\t\ttemplate.open.set(true);\n\n\t\t// Fetch and display them\n\t\ttemplate.fetchPreviews(cmd, args);\n\t};\n\n\ttemplate.verifySelection = () => {\n\t\tconst current = template.find('.popup-item.selected');\n\n\t\tif (!current) {\n\t\t\tconst first = template.find('.popup-item');\n\n\t\t\tif (first) {\n\t\t\t\tfirst.className += ' selected sidebar-item__popup-active';\n\t\t\t}\n\t\t}\n\t};\n\n\t// Typing data\n\ttemplate.onInputKeyup = (event) => {\n\t\tif (template.open.curValue === true && event.which === keys.ESC) {\n\t\t\ttemplate.open.set(false);\n\t\t\tevent.preventDefault();\n\t\t\tevent.stopPropagation();\n\t\t\treturn;\n\t\t}\n\n\t\tif (event.which === keys.ARROW_UP || event.which === keys.ARROW_DOWN) {\n\t\t\t// Arrow up and down are for navigating the choices\n\t\t\treturn;\n\t\t}\n\n\t\ttemplate.selectionLogic();\n\t};\n\n\t// Using the keyboard to navigate the options\n\ttemplate.onInputKeydown = (event) => {\n\t\tif (!template.open.curValue || template.isLoading.curValue) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (event.which === keys.ENTER) {\n\t\t\t// || event.which === keys.TAB) { <-- does using tab to select make sense?\n\t\t\ttemplate.enterKeyAction();\n\t\t\tevent.preventDefault();\n\t\t\tevent.stopPropagation();\n\t\t\treturn;\n\t\t}\n\n\t\tif (event.which === keys.ARROW_UP) {\n\t\t\ttemplate.up();\n\t\t\tevent.preventDefault();\n\t\t\tevent.stopPropagation();\n\t\t\treturn;\n\t\t}\n\n\t\tif (event.which === keys.ARROW_DOWN) {\n\t\t\ttemplate.down();\n\t\t\tevent.preventDefault();\n\t\t\tevent.stopPropagation();\n\t\t}\n\t};\n\n\ttemplate.up = () => {\n\t\tconst current = template.find('.popup-item.selected');\n\t\tconst previous = $(current).prev('.popup-item')[0] || template.find('.popup-item:last-child');\n\n\t\tif (previous != null) {\n\t\t\tcurrent.className = current.className.replace(/\\sselected/, '').replace('sidebar-item__popup-active', '');\n\t\t\tprevious.className += ' selected sidebar-item__popup-active';\n\t\t}\n\t};\n\n\ttemplate.down = () => {\n\t\tconst current = template.find('.popup-item.selected');\n\t\tconst next = $(current).next('.popup-item')[0] || template.find('.popup-item');\n\n\t\tif (next && next.classList.contains('popup-item')) {\n\t\t\tcurrent.className = current.className.replace(/\\sselected/, '').replace('sidebar-item__popup-active', '');\n\t\t\tnext.className += ' selected sidebar-item__popup-active';\n\t\t}\n\t};\n\n\ttemplate.onFocus = () => {\n\t\ttemplate.clickingItem = false;\n\t\tif (template.open.curValue) {\n\t\t\treturn;\n\t\t}\n\n\t\ttemplate.selectionLogic();\n\t};\n\n\ttemplate.onBlur = () => {\n\t\tif (template.clickingItem) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn template.open.set(false);\n\t};\n});\n\nTemplate.messagePopupSlashCommandPreview.onRendered(function _messagePopupSlashCommandPreviewRendered() {\n\tif (!this.data.getInput) {\n\t\tthrow Error('Somethign wrong happened.');\n\t}\n\n\tthis.inputBox = this.data.getInput();\n\t$(this.inputBox).on('keyup', this.onInputKeyup.bind(this));\n\t$(this.inputBox).on('keydown', this.onInputKeydown.bind(this));\n\t$(this.inputBox).on('focus', this.onFocus.bind(this));\n\t$(this.inputBox).on('blur', this.onBlur.bind(this));\n\n\tconst self = this;\n\tself.autorun(() => {\n\t\tsetTimeout(self.selectionLogic, 500);\n\t});\n});\n\nTemplate.messagePopupSlashCommandPreview.onDestroyed(function () {\n\t$(this.inputBox).off('keyup', this.onInputKeyup);\n\t$(this.inputBox).off('keydown', this.onInputKeydown);\n\t$(this.inputBox).off('focus', this.onFocus);\n\t$(this.inputBox).off('blur', this.onBlur);\n});\n\nTemplate.messagePopupSlashCommandPreview.events({\n\t'mouseenter .popup-item, mousedown .popup-item, touchstart .popup-item'(e) {\n\t\tif (e.currentTarget.className.includes('selected')) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst template = Template.instance();\n\t\tconst current = template.find('.popup-item.selected');\n\t\tif (current) {\n\t\t\tcurrent.className = current.className.replace(/\\sselected/, '').replace('sidebar-item__popup-active', '');\n\t\t}\n\n\t\te.currentTarget.className += ' selected sidebar-item__popup-active';\n\t},\n\t'mousedown .popup-item, touchstart .popup-item'() {\n\t\tconst template = Template.instance();\n\t\ttemplate.clickingItem = true;\n\t},\n\t'mouseup .popup-item, touchend .popup-item'() {\n\t\tconst template = Template.instance();\n\t\tif (template.dragging) {\n\t\t\ttemplate.dragging = false;\n\t\t\treturn;\n\t\t}\n\n\t\ttemplate.clickingItem = false;\n\t\ttemplate.enterKeyAction();\n\t},\n\t'touchmove .popup-item'(e) {\n\t\te.stopPropagation();\n\t\tconst template = Template.instance();\n\t\ttemplate.dragging = true;\n\t},\n});\n\nTemplate.messagePopupSlashCommandPreview.helpers({\n\tisOpen() {\n\t\treturn Template.instance().open.get(); // && ((Template.instance().hasData.get() || (Template.instance().data.emptyTemplate != null)) || !Template.instance().parentTemplate(1).subscriptionsReady());\n\t},\n\tgetArgs() {\n\t\treturn Template.instance().commandArgs.get();\n\t},\n\tisLoading() {\n\t\treturn Template.instance().isLoading.get();\n\t},\n\tisType(actual, expected) {\n\t\treturn actual === expected;\n\t},\n\tpreview() {\n\t\treturn Template.instance().preview.get();\n\t},\n});\n"]},"sourceType":"module","hash":"a35a7fe4a71782c488395f33a1049c5e7d89a5c6"}
