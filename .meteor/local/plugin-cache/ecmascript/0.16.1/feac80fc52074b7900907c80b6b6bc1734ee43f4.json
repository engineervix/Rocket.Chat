{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui-message/client/messageBox/messageBox.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"app/ui-message/client/messageBox/messageBox.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui-message/client/messageBox/messageBox.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{}},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui-message/client/messageBox/messageBox.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/ui-message/client/messageBox/messageBox.js"}},"code":"var _regeneratorRuntime;\n\nmodule.link(\"@babel/runtime/regenerator\", {\n  default: function (v) {\n    _regeneratorRuntime = v;\n  }\n}, 0);\n\nvar _toConsumableArray;\n\nmodule.link(\"@babel/runtime/helpers/toConsumableArray\", {\n  default: function (v) {\n    _toConsumableArray = v;\n  }\n}, 1);\nvar Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 0);\nvar ReactiveVar;\nmodule.link(\"meteor/reactive-var\", {\n  ReactiveVar: function (v) {\n    ReactiveVar = v;\n  }\n}, 1);\nvar ReactiveDict;\nmodule.link(\"meteor/reactive-dict\", {\n  ReactiveDict: function (v) {\n    ReactiveDict = v;\n  }\n}, 2);\nvar Session;\nmodule.link(\"meteor/session\", {\n  Session: function (v) {\n    Session = v;\n  }\n}, 3);\nvar Template;\nmodule.link(\"meteor/templating\", {\n  Template: function (v) {\n    Template = v;\n  }\n}, 4);\nvar Tracker;\nmodule.link(\"meteor/tracker\", {\n  Tracker: function (v) {\n    Tracker = v;\n  }\n}, 5);\nvar moment;\nmodule.link(\"moment\", {\n  \"default\": function (v) {\n    moment = v;\n  }\n}, 6);\nvar setupAutogrow;\nmodule.link(\"./messageBoxAutogrow\", {\n  setupAutogrow: function (v) {\n    setupAutogrow = v;\n  }\n}, 7);\nvar formattingButtons, applyFormatting;\nmodule.link(\"./messageBoxFormatting\", {\n  formattingButtons: function (v) {\n    formattingButtons = v;\n  },\n  applyFormatting: function (v) {\n    applyFormatting = v;\n  }\n}, 8);\nvar EmojiPicker;\nmodule.link(\"../../../emoji\", {\n  EmojiPicker: function (v) {\n    EmojiPicker = v;\n  }\n}, 9);\nvar Users;\nmodule.link(\"../../../models\", {\n  Users: function (v) {\n    Users = v;\n  }\n}, 10);\nvar settings;\nmodule.link(\"../../../settings\", {\n  settings: function (v) {\n    settings = v;\n  }\n}, 11);\nvar fileUpload, KonchatNotification;\nmodule.link(\"../../../ui\", {\n  fileUpload: function (v) {\n    fileUpload = v;\n  },\n  KonchatNotification: function (v) {\n    KonchatNotification = v;\n  }\n}, 12);\nvar messageBox, popover;\nmodule.link(\"../../../ui-utils\", {\n  messageBox: function (v) {\n    messageBox = v;\n  },\n  popover: function (v) {\n    popover = v;\n  }\n}, 13);\nvar t, getUserPreference;\nmodule.link(\"../../../utils/client\", {\n  t: function (v) {\n    t = v;\n  },\n  getUserPreference: function (v) {\n    getUserPreference = v;\n  }\n}, 14);\nmodule.link(\"./messageBoxActions\");\nmodule.link(\"./messageBoxReplyPreview\");\nmodule.link(\"./userActionIndicator.ts\");\nmodule.link(\"./messageBoxAudioMessage\");\nmodule.link(\"./messageBoxNotSubscribed\");\nmodule.link(\"./messageBox.html\");\nmodule.link(\"./messageBoxReadOnly\");\nvar getImageExtensionFromMime;\nmodule.link(\"../../../../lib/getImageExtensionFromMime\", {\n  getImageExtensionFromMime: function (v) {\n    getImageExtensionFromMime = v;\n  }\n}, 15);\nvar keyCodes;\nmodule.link(\"../../../../client/lib/utils/keyCodes\", {\n  keyCodes: function (v) {\n    keyCodes = v;\n  }\n}, 16);\nvar isRTL;\nmodule.link(\"../../../../client/lib/utils/isRTL\", {\n  isRTL: function (v) {\n    isRTL = v;\n  }\n}, 17);\nvar call;\nmodule.link(\"../../../../client/lib/utils/call\", {\n  call: function (v) {\n    call = v;\n  }\n}, 18);\nvar roomCoordinator;\nmodule.link(\"../../../../client/lib/rooms/roomCoordinator\", {\n  roomCoordinator: function (v) {\n    roomCoordinator = v;\n  }\n}, 19);\nTemplate.messageBox.onCreated(function () {\n  var _this = this;\n\n  this.state = new ReactiveDict();\n  this.popupConfig = new ReactiveVar(null);\n  this.replyMessageData = new ReactiveVar();\n  this.isMicrophoneDenied = new ReactiveVar(true);\n  this.isSendIconVisible = new ReactiveVar(false);\n\n  this.set = function (value) {\n    var input = _this.input;\n\n    if (!input) {\n      return;\n    }\n\n    input.value = value;\n    $(input).trigger('change').trigger('input');\n  };\n\n  this.insertNewLine = function () {\n    var input = _this.input,\n        autogrow = _this.autogrow;\n\n    if (!input) {\n      return;\n    }\n\n    if (document.selection) {\n      input.focus();\n      var sel = document.selection.createRange();\n      sel.text = '\\n';\n    } else if (input.selectionStart || input.selectionStart === 0) {\n      var newPosition = input.selectionStart + 1;\n      var before = input.value.substring(0, input.selectionStart);\n      var after = input.value.substring(input.selectionEnd, input.value.length);\n      input.value = before + \"\\n\" + after;\n      input.selectionStart = newPosition;\n      input.selectionEnd = newPosition;\n    } else {\n      input.value += '\\n';\n    }\n\n    $(input).trigger('change').trigger('input');\n    input.blur();\n    input.focus();\n    autogrow.update();\n  };\n\n  this.send = function (event) {\n    var input = _this.input;\n\n    if (!input) {\n      return;\n    }\n\n    var autogrow = _this.autogrow,\n        _this$data = _this.data,\n        rid = _this$data.rid,\n        tmid = _this$data.tmid,\n        onSend = _this$data.onSend,\n        tshow = _this$data.tshow;\n    var value = input.value;\n\n    _this.set('');\n\n    if (!onSend) {\n      return;\n    }\n\n    onSend.call(_this.data, event, {\n      rid: rid,\n      tmid: tmid,\n      value: value,\n      tshow: tshow\n    }, function () {\n      autogrow.update();\n      input.focus();\n    });\n  };\n});\nTemplate.messageBox.onRendered(function () {\n  var _this2 = this;\n\n  var inputSetup = false;\n  this.autorun(function () {\n    var _Template$currentData = Template.currentData(),\n        rid = _Template$currentData.rid,\n        subscription = _Template$currentData.subscription;\n\n    var room = Session.get(\"roomData\" + rid);\n\n    if (!inputSetup) {\n      var $input = $(_this2.find('.js-input-message'));\n      _this2.source = $input[0];\n\n      if (_this2.source) {\n        inputSetup = true;\n      }\n\n      $input.on('dataChange', function () {\n        var messages = $input.data('reply') || [];\n\n        _this2.replyMessageData.set(messages);\n      });\n    }\n\n    if (!room) {\n      return _this2.state.set({\n        room: false,\n        isBlockedOrBlocker: false,\n        mustJoinWithCode: false\n      });\n    }\n\n    var isBlocked = room && room.t === 'd' && subscription && subscription.blocked;\n    var isBlocker = room && room.t === 'd' && subscription && subscription.blocker;\n    var isBlockedOrBlocker = isBlocked || isBlocker;\n    var mustJoinWithCode = !subscription && room.joinCodeRequired;\n    return _this2.state.set({\n      room: false,\n      isBlockedOrBlocker: isBlockedOrBlocker,\n      mustJoinWithCode: mustJoinWithCode\n    });\n  });\n  this.autorun(function () {\n    var _Template$currentData2 = Template.currentData(),\n        rid = _Template$currentData2.rid,\n        tmid = _Template$currentData2.tmid,\n        onInputChanged = _Template$currentData2.onInputChanged,\n        onResize = _Template$currentData2.onResize;\n\n    Tracker.afterFlush(function () {\n      var input = _this2.find('.js-input-message');\n\n      if (_this2.input === input) {\n        return;\n      }\n\n      _this2.input = input;\n      onInputChanged && onInputChanged(input);\n\n      if (input && rid) {\n        _this2.popupConfig.set({\n          rid: rid,\n          tmid: tmid,\n          getInput: function () {\n            return input;\n          }\n        });\n      } else {\n        _this2.popupConfig.set(null);\n      }\n\n      if (_this2.autogrow) {\n        _this2.autogrow.destroy();\n\n        _this2.autogrow = null;\n      }\n\n      if (!input) {\n        return;\n      }\n\n      var shadow = _this2.find('.js-input-message-shadow');\n\n      _this2.autogrow = setupAutogrow(input, shadow, onResize);\n    });\n  });\n});\nTemplate.messageBox.onDestroyed(function () {\n  if (!this.autogrow) {\n    return;\n  }\n\n  this.autogrow.destroy();\n});\nTemplate.messageBox.helpers({\n  isAnonymousOrMustJoinWithCode: function () {\n    var instance = Template.instance();\n\n    var _Template$currentData3 = Template.currentData(),\n        rid = _Template$currentData3.rid;\n\n    if (!rid) {\n      return false;\n    }\n\n    var isAnonymous = !Meteor.userId();\n    return isAnonymous || instance.state.get('mustJoinWithCode');\n  },\n  isWritable: function () {\n    var _Template$currentData4 = Template.currentData(),\n        rid = _Template$currentData4.rid,\n        subscription = _Template$currentData4.subscription;\n\n    if (!rid) {\n      return true;\n    }\n\n    var isBlockedOrBlocker = Template.instance().state.get('isBlockedOrBlocker');\n\n    if (isBlockedOrBlocker) {\n      return false;\n    }\n\n    if (subscription !== null && subscription !== void 0 && subscription.onHold) {\n      return false;\n    }\n\n    var isReadOnly = roomCoordinator.readOnly(rid, Users.findOne({\n      _id: Meteor.userId()\n    }, {\n      fields: {\n        username: 1\n      }\n    }));\n    var isArchived = roomCoordinator.archived(rid) || subscription && subscription.t === 'd' && subscription.archived;\n    return !isReadOnly && !isArchived;\n  },\n  popupConfig: function () {\n    return Template.instance().popupConfig.get();\n  },\n  input: function () {\n    return Template.instance().input;\n  },\n  replyMessageData: function () {\n    return Template.instance().replyMessageData.get();\n  },\n  isEmojiEnabled: function () {\n    return getUserPreference(Meteor.userId(), 'useEmojis');\n  },\n  maxMessageLength: function () {\n    return settings.get('Message_AllowConvertLongMessagesToAttachment') ? null : settings.get('Message_MaxAllowedSize');\n  },\n  isSendIconVisible: function () {\n    return Template.instance().isSendIconVisible.get();\n  },\n  canSend: function () {\n    var _Template$currentData5 = Template.currentData(),\n        rid = _Template$currentData5.rid;\n\n    if (!rid) {\n      return true;\n    }\n\n    return roomCoordinator.verifyCanSendMessage(rid);\n  },\n  actions: function () {\n    var actionGroups = messageBox.actions.get();\n    return Object.values(actionGroups).reduce(function (actions, actionGroup) {\n      return [].concat(_toConsumableArray(actions), _toConsumableArray(actionGroup));\n    }, []);\n  },\n  formattingButtons: function () {\n    return formattingButtons.filter(function (_ref) {\n      var condition = _ref.condition;\n      return !condition || condition();\n    });\n  },\n  isBlockedOrBlocker: function () {\n    return Template.instance().state.get('isBlockedOrBlocker');\n  },\n  onHold: function () {\n    var _Template$currentData6 = Template.currentData(),\n        rid = _Template$currentData6.rid,\n        subscription = _Template$currentData6.subscription;\n\n    return rid && !!(subscription !== null && subscription !== void 0 && subscription.onHold);\n  },\n  isSubscribed: function () {\n    var _Template$currentData7 = Template.currentData(),\n        subscription = _Template$currentData7.subscription;\n\n    return !!subscription;\n  }\n});\n\nvar handleFormattingShortcut = function (event, instance) {\n  var isMacOS = navigator.platform.indexOf('Mac') !== -1;\n  var isCmdOrCtrlPressed = isMacOS && event.metaKey || !isMacOS && event.ctrlKey;\n\n  if (!isCmdOrCtrlPressed) {\n    return false;\n  }\n\n  var key = event.key.toLowerCase();\n\n  var _ref2 = formattingButtons.filter(function (_ref3) {\n    var condition = _ref3.condition;\n    return !condition || condition();\n  }).find(function (_ref4) {\n    var command = _ref4.command;\n    return command === key;\n  }) || {},\n      pattern = _ref2.pattern;\n\n  if (!pattern) {\n    return false;\n  }\n\n  var input = instance.input;\n  applyFormatting(pattern, input);\n  return true;\n};\n\nvar sendOnEnter;\nvar sendOnEnterActive;\nTracker.autorun(function () {\n  sendOnEnter = getUserPreference(Meteor.userId(), 'sendOnEnter');\n  sendOnEnterActive = sendOnEnter == null || sendOnEnter === 'normal' || sendOnEnter === 'desktop' && Meteor.Device.isDesktop();\n});\n\nvar handleSubmit = function (event, instance) {\n  var keyCode = event.which;\n  var isSubmitKey = keyCode === keyCodes.CARRIAGE_RETURN || keyCode === keyCodes.NEW_LINE;\n\n  if (!isSubmitKey) {\n    return false;\n  }\n\n  var withModifier = event.shiftKey || event.ctrlKey || event.altKey || event.metaKey;\n  var isSending = sendOnEnterActive && !withModifier || !sendOnEnterActive && withModifier;\n\n  if (isSending) {\n    instance.send(event);\n    return true;\n  }\n\n  instance.insertNewLine();\n  return true;\n};\n\nTemplate.messageBox.events({\n  'click .js-join': function () {\n    function _callee(event) {\n      var joinCodeInput, joinCode;\n      return _regeneratorRuntime.async(function () {\n        function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                event.stopPropagation();\n                event.preventDefault();\n                joinCodeInput = Template.instance().find('[name=joinCode]');\n                joinCode = joinCodeInput && joinCodeInput.value;\n                _context.next = 6;\n                return _regeneratorRuntime.awrap(call('joinRoom', this.rid, joinCode));\n\n              case 6:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }\n\n        return _callee$;\n      }(), null, this, null, Promise);\n    }\n\n    return _callee;\n  }(),\n  'click .js-emoji-picker': function (event, instance) {\n    event.stopPropagation();\n    event.preventDefault();\n\n    if (!getUserPreference(Meteor.userId(), 'useEmojis')) {\n      return;\n    }\n\n    if (EmojiPicker.isOpened()) {\n      EmojiPicker.close();\n      return;\n    }\n\n    EmojiPicker.open(instance.source, function (emoji) {\n      var emojiValue = \":\" + emoji + \": \";\n      var input = instance.input;\n      var caretPos = input.selectionStart;\n      var textAreaTxt = input.value;\n      input.focus();\n\n      if (!document.execCommand || !document.execCommand('insertText', false, emojiValue)) {\n        instance.set(textAreaTxt.substring(0, caretPos) + emojiValue + textAreaTxt.substring(caretPos));\n        input.focus();\n      }\n\n      input.selectionStart = caretPos + emojiValue.length;\n      input.selectionEnd = caretPos + emojiValue.length;\n    });\n  },\n  'focus .js-input-message': function () {\n    KonchatNotification.removeRoomNotification(this.rid);\n  },\n  'keydown .js-input-message': function (event, instance) {\n    var isEventHandled = handleFormattingShortcut(event, instance) || handleSubmit(event, instance);\n\n    if (isEventHandled) {\n      event.preventDefault();\n      event.stopPropagation();\n      return;\n    }\n\n    var rid = this.rid,\n        tmid = this.tmid,\n        onKeyDown = this.onKeyDown;\n    onKeyDown && onKeyDown.call(this, event, {\n      rid: rid,\n      tmid: tmid\n    });\n  },\n  'keyup .js-input-message': function (event) {\n    var rid = this.rid,\n        tmid = this.tmid,\n        onKeyUp = this.onKeyUp;\n    onKeyUp && onKeyUp.call(this, event, {\n      rid: rid,\n      tmid: tmid\n    });\n  },\n  'paste .js-input-message': function (event, instance) {\n    var rid = this.rid,\n        tmid = this.tmid;\n    var input = instance.input,\n        autogrow = instance.autogrow;\n    setTimeout(function () {\n      return autogrow && autogrow.update();\n    }, 50);\n\n    if (!event.originalEvent.clipboardData) {\n      return;\n    }\n\n    var items = _toConsumableArray(event.originalEvent.clipboardData.items);\n\n    if (items.some(function (_ref5) {\n      var kind = _ref5.kind,\n          type = _ref5.type;\n      return kind === 'string' && type === 'text/plain';\n    })) {\n      return;\n    }\n\n    var files = items.filter(function (item) {\n      return item.kind === 'file' && item.type.indexOf('image/') !== -1;\n    }).map(function (item) {\n      var fileItem = item.getAsFile();\n      var imageExtension = getImageExtensionFromMime(fileItem.type);\n      var extension = imageExtension ? \".\" + imageExtension : '';\n      return {\n        file: fileItem,\n        name: \"Clipboard - \" + moment().format(settings.get('Message_TimeAndDateFormat')) + extension\n      };\n    }).filter(function (_ref6) {\n      var file = _ref6.file;\n      return file !== null;\n    });\n\n    if (files.length) {\n      event.preventDefault();\n      fileUpload(files, input, {\n        rid: rid,\n        tmid: tmid\n      });\n    }\n  },\n  'input .js-input-message': function (event, instance) {\n    var input = instance.input;\n\n    if (!input) {\n      return;\n    }\n\n    instance.isSendIconVisible.set(!!input.value);\n\n    if (input.value.length > 0) {\n      input.dir = isRTL(input.value) ? 'rtl' : 'ltr';\n    }\n\n    var rid = this.rid,\n        tmid = this.tmid,\n        onValueChanged = this.onValueChanged;\n    onValueChanged && onValueChanged.call(this, event, {\n      rid: rid,\n      tmid: tmid\n    });\n  },\n  'propertychange .js-input-message': function (event, instance) {\n    if (event.originalEvent.propertyName !== 'value') {\n      return;\n    }\n\n    var input = instance.input;\n\n    if (!input) {\n      return;\n    }\n\n    instance.sendIconDisabled.set(!!input.value);\n\n    if (input.value.length > 0) {\n      input.dir = isRTL(input.value) ? 'rtl' : 'ltr';\n    }\n\n    var rid = this.rid,\n        tmid = this.tmid,\n        onValueChanged = this.onValueChanged;\n    onValueChanged && onValueChanged.call(this, event, {\n      rid: rid,\n      tmid: tmid\n    });\n  },\n  'click .js-send': function () {\n    function _callee2(event, instance) {\n      return _regeneratorRuntime.async(function () {\n        function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                instance.send(event);\n\n              case 1:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }\n\n        return _callee2$;\n      }(), null, null, null, Promise);\n    }\n\n    return _callee2;\n  }(),\n  'click .js-action-menu': function (event, instance) {\n    var groups = messageBox.actions.get();\n    var config = {\n      popoverClass: 'message-box',\n      columns: [{\n        groups: Object.keys(groups).map(function (group) {\n          var items = [];\n          groups[group].forEach(function (item) {\n            items.push({\n              icon: item.icon,\n              name: t(item.label),\n              type: 'messagebox-action',\n              id: item.id\n            });\n          });\n          return {\n            title: t(group),\n            items: items\n          };\n        })\n      }],\n      offsetVertical: 10,\n      direction: 'top-inverted',\n      currentTarget: event.currentTarget.firstElementChild.firstElementChild,\n      data: {\n        rid: this.rid,\n        tmid: this.tmid,\n        prid: this.subscription.prid,\n        messageBox: instance.firstNode\n      },\n      activeElement: event.currentTarget\n    };\n    popover.open(config);\n  },\n  'click .js-message-actions .js-message-action': function (event, instance) {\n    var _this3 = this;\n\n    var id = event.currentTarget.dataset.id;\n    var actions = messageBox.actions.getById(id);\n    actions.filter(function (_ref7) {\n      var action = _ref7.action;\n      return !!action;\n    }).forEach(function (_ref8) {\n      var action = _ref8.action;\n      action.call(null, {\n        rid: _this3.rid,\n        tmid: _this3.tmid,\n        messageBox: instance.firstNode,\n        prid: _this3.subscription.prid,\n        event: event\n      });\n    });\n  },\n  'click .js-format': function (event, instance) {\n    event.preventDefault();\n    event.stopPropagation();\n    var id = event.currentTarget.dataset.id;\n\n    var _ref9 = formattingButtons.filter(function (_ref10) {\n      var condition = _ref10.condition;\n      return !condition || condition();\n    }).find(function (_ref11) {\n      var label = _ref11.label;\n      return label === id;\n    }) || {},\n        pattern = _ref9.pattern;\n\n    if (!pattern) {\n      return;\n    }\n\n    applyFormatting(pattern, instance.input);\n  }\n});","map":{"version":3,"sources":["app/ui-message/client/messageBox/messageBox.js"],"names":["_regeneratorRuntime","module","link","default","v","_toConsumableArray","Meteor","ReactiveVar","ReactiveDict","Session","Template","Tracker","moment","setupAutogrow","formattingButtons","applyFormatting","EmojiPicker","Users","settings","fileUpload","KonchatNotification","messageBox","popover","t","getUserPreference","getImageExtensionFromMime","keyCodes","isRTL","call","roomCoordinator","onCreated","state","popupConfig","replyMessageData","isMicrophoneDenied","isSendIconVisible","set","value","input","$","trigger","insertNewLine","autogrow","document","selection","focus","sel","createRange","text","selectionStart","newPosition","before","substring","after","selectionEnd","length","blur","update","send","event","data","rid","tmid","onSend","tshow","onRendered","inputSetup","autorun","currentData","subscription","room","get","$input","find","source","on","messages","isBlockedOrBlocker","mustJoinWithCode","isBlocked","blocked","isBlocker","blocker","joinCodeRequired","onInputChanged","onResize","afterFlush","getInput","destroy","shadow","onDestroyed","helpers","isAnonymousOrMustJoinWithCode","instance","isAnonymous","userId","isWritable","onHold","isReadOnly","readOnly","findOne","_id","fields","username","isArchived","archived","isEmojiEnabled","maxMessageLength","canSend","verifyCanSendMessage","actions","actionGroups","Object","values","reduce","actionGroup","filter","condition","isSubscribed","handleFormattingShortcut","isMacOS","navigator","platform","indexOf","isCmdOrCtrlPressed","metaKey","ctrlKey","key","toLowerCase","command","pattern","sendOnEnter","sendOnEnterActive","Device","isDesktop","handleSubmit","keyCode","which","isSubmitKey","CARRIAGE_RETURN","NEW_LINE","withModifier","shiftKey","altKey","isSending","events","stopPropagation","preventDefault","joinCodeInput","joinCode","isOpened","close","open","emoji","emojiValue","caretPos","textAreaTxt","execCommand","removeRoomNotification","isEventHandled","onKeyDown","onKeyUp","setTimeout","originalEvent","clipboardData","items","some","kind","type","files","item","map","fileItem","getAsFile","imageExtension","extension","file","name","format","dir","onValueChanged","propertyName","sendIconDisabled","groups","config","popoverClass","columns","keys","group","forEach","push","icon","label","id","title","offsetVertical","direction","currentTarget","firstElementChild","prid","firstNode","activeElement","dataset","getById","action"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { ReactiveVar } from 'meteor/reactive-var';\nimport { ReactiveDict } from 'meteor/reactive-dict';\nimport { Session } from 'meteor/session';\nimport { Template } from 'meteor/templating';\nimport { Tracker } from 'meteor/tracker';\nimport moment from 'moment';\n\nimport { setupAutogrow } from './messageBoxAutogrow';\nimport { formattingButtons, applyFormatting } from './messageBoxFormatting';\nimport { EmojiPicker } from '../../../emoji';\nimport { Users } from '../../../models';\nimport { settings } from '../../../settings';\nimport { fileUpload, KonchatNotification } from '../../../ui';\nimport { messageBox, popover } from '../../../ui-utils';\nimport { t, getUserPreference } from '../../../utils/client';\nimport './messageBoxActions';\nimport './messageBoxReplyPreview';\nimport './userActionIndicator.ts';\nimport './messageBoxAudioMessage';\nimport './messageBoxNotSubscribed';\nimport './messageBox.html';\nimport './messageBoxReadOnly';\nimport { getImageExtensionFromMime } from '../../../../lib/getImageExtensionFromMime';\nimport { keyCodes } from '../../../../client/lib/utils/keyCodes';\nimport { isRTL } from '../../../../client/lib/utils/isRTL';\nimport { call } from '../../../../client/lib/utils/call';\nimport { roomCoordinator } from '../../../../client/lib/rooms/roomCoordinator';\n\nTemplate.messageBox.onCreated(function () {\n\tthis.state = new ReactiveDict();\n\tthis.popupConfig = new ReactiveVar(null);\n\tthis.replyMessageData = new ReactiveVar();\n\tthis.isMicrophoneDenied = new ReactiveVar(true);\n\tthis.isSendIconVisible = new ReactiveVar(false);\n\n\tthis.set = (value) => {\n\t\tconst { input } = this;\n\t\tif (!input) {\n\t\t\treturn;\n\t\t}\n\n\t\tinput.value = value;\n\t\t$(input).trigger('change').trigger('input');\n\t};\n\n\tthis.insertNewLine = () => {\n\t\tconst { input, autogrow } = this;\n\t\tif (!input) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (document.selection) {\n\t\t\tinput.focus();\n\t\t\tconst sel = document.selection.createRange();\n\t\t\tsel.text = '\\n';\n\t\t} else if (input.selectionStart || input.selectionStart === 0) {\n\t\t\tconst newPosition = input.selectionStart + 1;\n\t\t\tconst before = input.value.substring(0, input.selectionStart);\n\t\t\tconst after = input.value.substring(input.selectionEnd, input.value.length);\n\t\t\tinput.value = `${before}\\n${after}`;\n\t\t\tinput.selectionStart = newPosition;\n\t\t\tinput.selectionEnd = newPosition;\n\t\t} else {\n\t\t\tinput.value += '\\n';\n\t\t}\n\t\t$(input).trigger('change').trigger('input');\n\n\t\tinput.blur();\n\t\tinput.focus();\n\t\tautogrow.update();\n\t};\n\n\tthis.send = (event) => {\n\t\tconst { input } = this;\n\n\t\tif (!input) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst {\n\t\t\tautogrow,\n\t\t\tdata: { rid, tmid, onSend, tshow },\n\t\t} = this;\n\t\tconst { value } = input;\n\t\tthis.set('');\n\n\t\tif (!onSend) {\n\t\t\treturn;\n\t\t}\n\n\t\tonSend.call(this.data, event, { rid, tmid, value, tshow }, () => {\n\t\t\tautogrow.update();\n\t\t\tinput.focus();\n\t\t});\n\t};\n});\n\nTemplate.messageBox.onRendered(function () {\n\tlet inputSetup = false;\n\n\tthis.autorun(() => {\n\t\tconst { rid, subscription } = Template.currentData();\n\t\tconst room = Session.get(`roomData${rid}`);\n\n\t\tif (!inputSetup) {\n\t\t\tconst $input = $(this.find('.js-input-message'));\n\t\t\tthis.source = $input[0];\n\t\t\tif (this.source) {\n\t\t\t\tinputSetup = true;\n\t\t\t}\n\t\t\t$input.on('dataChange', () => {\n\t\t\t\tconst messages = $input.data('reply') || [];\n\t\t\t\tthis.replyMessageData.set(messages);\n\t\t\t});\n\t\t}\n\n\t\tif (!room) {\n\t\t\treturn this.state.set({\n\t\t\t\troom: false,\n\t\t\t\tisBlockedOrBlocker: false,\n\t\t\t\tmustJoinWithCode: false,\n\t\t\t});\n\t\t}\n\n\t\tconst isBlocked = room && room.t === 'd' && subscription && subscription.blocked;\n\t\tconst isBlocker = room && room.t === 'd' && subscription && subscription.blocker;\n\t\tconst isBlockedOrBlocker = isBlocked || isBlocker;\n\n\t\tconst mustJoinWithCode = !subscription && room.joinCodeRequired;\n\n\t\treturn this.state.set({\n\t\t\troom: false,\n\t\t\tisBlockedOrBlocker,\n\t\t\tmustJoinWithCode,\n\t\t});\n\t});\n\n\tthis.autorun(() => {\n\t\tconst { rid, tmid, onInputChanged, onResize } = Template.currentData();\n\n\t\tTracker.afterFlush(() => {\n\t\t\tconst input = this.find('.js-input-message');\n\n\t\t\tif (this.input === input) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.input = input;\n\t\t\tonInputChanged && onInputChanged(input);\n\n\t\t\tif (input && rid) {\n\t\t\t\tthis.popupConfig.set({\n\t\t\t\t\trid,\n\t\t\t\t\ttmid,\n\t\t\t\t\tgetInput: () => input,\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tthis.popupConfig.set(null);\n\t\t\t}\n\n\t\t\tif (this.autogrow) {\n\t\t\t\tthis.autogrow.destroy();\n\t\t\t\tthis.autogrow = null;\n\t\t\t}\n\n\t\t\tif (!input) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst shadow = this.find('.js-input-message-shadow');\n\t\t\tthis.autogrow = setupAutogrow(input, shadow, onResize);\n\t\t});\n\t});\n});\n\nTemplate.messageBox.onDestroyed(function () {\n\tif (!this.autogrow) {\n\t\treturn;\n\t}\n\n\tthis.autogrow.destroy();\n});\n\nTemplate.messageBox.helpers({\n\tisAnonymousOrMustJoinWithCode() {\n\t\tconst instance = Template.instance();\n\t\tconst { rid } = Template.currentData();\n\t\tif (!rid) {\n\t\t\treturn false;\n\t\t}\n\t\tconst isAnonymous = !Meteor.userId();\n\t\treturn isAnonymous || instance.state.get('mustJoinWithCode');\n\t},\n\tisWritable() {\n\t\tconst { rid, subscription } = Template.currentData();\n\t\tif (!rid) {\n\t\t\treturn true;\n\t\t}\n\n\t\tconst isBlockedOrBlocker = Template.instance().state.get('isBlockedOrBlocker');\n\n\t\tif (isBlockedOrBlocker) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (subscription?.onHold) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst isReadOnly = roomCoordinator.readOnly(rid, Users.findOne({ _id: Meteor.userId() }, { fields: { username: 1 } }));\n\t\tconst isArchived = roomCoordinator.archived(rid) || (subscription && subscription.t === 'd' && subscription.archived);\n\n\t\treturn !isReadOnly && !isArchived;\n\t},\n\tpopupConfig() {\n\t\treturn Template.instance().popupConfig.get();\n\t},\n\tinput() {\n\t\treturn Template.instance().input;\n\t},\n\treplyMessageData() {\n\t\treturn Template.instance().replyMessageData.get();\n\t},\n\tisEmojiEnabled() {\n\t\treturn getUserPreference(Meteor.userId(), 'useEmojis');\n\t},\n\tmaxMessageLength() {\n\t\treturn settings.get('Message_AllowConvertLongMessagesToAttachment') ? null : settings.get('Message_MaxAllowedSize');\n\t},\n\tisSendIconVisible() {\n\t\treturn Template.instance().isSendIconVisible.get();\n\t},\n\tcanSend() {\n\t\tconst { rid } = Template.currentData();\n\t\tif (!rid) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn roomCoordinator.verifyCanSendMessage(rid);\n\t},\n\tactions() {\n\t\tconst actionGroups = messageBox.actions.get();\n\t\treturn Object.values(actionGroups).reduce((actions, actionGroup) => [...actions, ...actionGroup], []);\n\t},\n\tformattingButtons() {\n\t\treturn formattingButtons.filter(({ condition }) => !condition || condition());\n\t},\n\tisBlockedOrBlocker() {\n\t\treturn Template.instance().state.get('isBlockedOrBlocker');\n\t},\n\tonHold() {\n\t\tconst { rid, subscription } = Template.currentData();\n\t\treturn rid && !!subscription?.onHold;\n\t},\n\tisSubscribed() {\n\t\tconst { subscription } = Template.currentData();\n\t\treturn !!subscription;\n\t},\n});\n\nconst handleFormattingShortcut = (event, instance) => {\n\tconst isMacOS = navigator.platform.indexOf('Mac') !== -1;\n\tconst isCmdOrCtrlPressed = (isMacOS && event.metaKey) || (!isMacOS && event.ctrlKey);\n\n\tif (!isCmdOrCtrlPressed) {\n\t\treturn false;\n\t}\n\n\tconst key = event.key.toLowerCase();\n\n\tconst { pattern } = formattingButtons.filter(({ condition }) => !condition || condition()).find(({ command }) => command === key) || {};\n\n\tif (!pattern) {\n\t\treturn false;\n\t}\n\n\tconst { input } = instance;\n\tapplyFormatting(pattern, input);\n\treturn true;\n};\n\nlet sendOnEnter;\nlet sendOnEnterActive;\n\nTracker.autorun(() => {\n\tsendOnEnter = getUserPreference(Meteor.userId(), 'sendOnEnter');\n\tsendOnEnterActive = sendOnEnter == null || sendOnEnter === 'normal' || (sendOnEnter === 'desktop' && Meteor.Device.isDesktop());\n});\n\nconst handleSubmit = (event, instance) => {\n\tconst { which: keyCode } = event;\n\n\tconst isSubmitKey = keyCode === keyCodes.CARRIAGE_RETURN || keyCode === keyCodes.NEW_LINE;\n\n\tif (!isSubmitKey) {\n\t\treturn false;\n\t}\n\n\tconst withModifier = event.shiftKey || event.ctrlKey || event.altKey || event.metaKey;\n\tconst isSending = (sendOnEnterActive && !withModifier) || (!sendOnEnterActive && withModifier);\n\n\tif (isSending) {\n\t\tinstance.send(event);\n\t\treturn true;\n\t}\n\n\tinstance.insertNewLine();\n\treturn true;\n};\n\nTemplate.messageBox.events({\n\tasync 'click .js-join'(event) {\n\t\tevent.stopPropagation();\n\t\tevent.preventDefault();\n\n\t\tconst joinCodeInput = Template.instance().find('[name=joinCode]');\n\t\tconst joinCode = joinCodeInput && joinCodeInput.value;\n\n\t\tawait call('joinRoom', this.rid, joinCode);\n\t},\n\t'click .js-emoji-picker'(event, instance) {\n\t\tevent.stopPropagation();\n\t\tevent.preventDefault();\n\n\t\tif (!getUserPreference(Meteor.userId(), 'useEmojis')) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (EmojiPicker.isOpened()) {\n\t\t\tEmojiPicker.close();\n\t\t\treturn;\n\t\t}\n\n\t\tEmojiPicker.open(instance.source, (emoji) => {\n\t\t\tconst emojiValue = `:${emoji}: `;\n\n\t\t\tconst { input } = instance;\n\n\t\t\tconst caretPos = input.selectionStart;\n\t\t\tconst textAreaTxt = input.value;\n\n\t\t\tinput.focus();\n\t\t\tif (!document.execCommand || !document.execCommand('insertText', false, emojiValue)) {\n\t\t\t\tinstance.set(textAreaTxt.substring(0, caretPos) + emojiValue + textAreaTxt.substring(caretPos));\n\t\t\t\tinput.focus();\n\t\t\t}\n\n\t\t\tinput.selectionStart = caretPos + emojiValue.length;\n\t\t\tinput.selectionEnd = caretPos + emojiValue.length;\n\t\t});\n\t},\n\t'focus .js-input-message'() {\n\t\tKonchatNotification.removeRoomNotification(this.rid);\n\t},\n\t'keydown .js-input-message'(event, instance) {\n\t\tconst isEventHandled = handleFormattingShortcut(event, instance) || handleSubmit(event, instance);\n\n\t\tif (isEventHandled) {\n\t\t\tevent.preventDefault();\n\t\t\tevent.stopPropagation();\n\t\t\treturn;\n\t\t}\n\n\t\tconst { rid, tmid, onKeyDown } = this;\n\t\tonKeyDown && onKeyDown.call(this, event, { rid, tmid });\n\t},\n\t'keyup .js-input-message'(event) {\n\t\tconst { rid, tmid, onKeyUp } = this;\n\t\tonKeyUp && onKeyUp.call(this, event, { rid, tmid });\n\t},\n\t'paste .js-input-message'(event, instance) {\n\t\tconst { rid, tmid } = this;\n\t\tconst { input, autogrow } = instance;\n\n\t\tsetTimeout(() => autogrow && autogrow.update(), 50);\n\n\t\tif (!event.originalEvent.clipboardData) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst items = [...event.originalEvent.clipboardData.items];\n\n\t\tif (items.some(({ kind, type }) => kind === 'string' && type === 'text/plain')) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst files = items\n\t\t\t.filter((item) => item.kind === 'file' && item.type.indexOf('image/') !== -1)\n\t\t\t.map((item) => {\n\t\t\t\tconst fileItem = item.getAsFile();\n\n\t\t\t\tconst imageExtension = getImageExtensionFromMime(fileItem.type);\n\n\t\t\t\tconst extension = imageExtension ? `.${imageExtension}` : '';\n\n\t\t\t\treturn {\n\t\t\t\t\tfile: fileItem,\n\t\t\t\t\tname: `Clipboard - ${moment().format(settings.get('Message_TimeAndDateFormat'))}${extension}`,\n\t\t\t\t};\n\t\t\t})\n\t\t\t.filter(({ file }) => file !== null);\n\n\t\tif (files.length) {\n\t\t\tevent.preventDefault();\n\t\t\tfileUpload(files, input, { rid, tmid });\n\t\t}\n\t},\n\t'input .js-input-message'(event, instance) {\n\t\tconst { input } = instance;\n\t\tif (!input) {\n\t\t\treturn;\n\t\t}\n\n\t\tinstance.isSendIconVisible.set(!!input.value);\n\n\t\tif (input.value.length > 0) {\n\t\t\tinput.dir = isRTL(input.value) ? 'rtl' : 'ltr';\n\t\t}\n\n\t\tconst { rid, tmid, onValueChanged } = this;\n\t\tonValueChanged && onValueChanged.call(this, event, { rid, tmid });\n\t},\n\t'propertychange .js-input-message'(event, instance) {\n\t\tif (event.originalEvent.propertyName !== 'value') {\n\t\t\treturn;\n\t\t}\n\n\t\tconst { input } = instance;\n\t\tif (!input) {\n\t\t\treturn;\n\t\t}\n\n\t\tinstance.sendIconDisabled.set(!!input.value);\n\n\t\tif (input.value.length > 0) {\n\t\t\tinput.dir = isRTL(input.value) ? 'rtl' : 'ltr';\n\t\t}\n\n\t\tconst { rid, tmid, onValueChanged } = this;\n\t\tonValueChanged && onValueChanged.call(this, event, { rid, tmid });\n\t},\n\tasync 'click .js-send'(event, instance) {\n\t\tinstance.send(event);\n\t},\n\t'click .js-action-menu'(event, instance) {\n\t\tconst groups = messageBox.actions.get();\n\t\tconst config = {\n\t\t\tpopoverClass: 'message-box',\n\t\t\tcolumns: [\n\t\t\t\t{\n\t\t\t\t\tgroups: Object.keys(groups).map((group) => {\n\t\t\t\t\t\tconst items = [];\n\t\t\t\t\t\tgroups[group].forEach((item) => {\n\t\t\t\t\t\t\titems.push({\n\t\t\t\t\t\t\t\ticon: item.icon,\n\t\t\t\t\t\t\t\tname: t(item.label),\n\t\t\t\t\t\t\t\ttype: 'messagebox-action',\n\t\t\t\t\t\t\t\tid: item.id,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\ttitle: t(group),\n\t\t\t\t\t\t\titems,\n\t\t\t\t\t\t};\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t\toffsetVertical: 10,\n\t\t\tdirection: 'top-inverted',\n\t\t\tcurrentTarget: event.currentTarget.firstElementChild.firstElementChild,\n\t\t\tdata: {\n\t\t\t\trid: this.rid,\n\t\t\t\ttmid: this.tmid,\n\t\t\t\tprid: this.subscription.prid,\n\t\t\t\tmessageBox: instance.firstNode,\n\t\t\t},\n\t\t\tactiveElement: event.currentTarget,\n\t\t};\n\n\t\tpopover.open(config);\n\t},\n\t'click .js-message-actions .js-message-action'(event, instance) {\n\t\tconst { id } = event.currentTarget.dataset;\n\t\tconst actions = messageBox.actions.getById(id);\n\t\tactions\n\t\t\t.filter(({ action }) => !!action)\n\t\t\t.forEach(({ action }) => {\n\t\t\t\taction.call(null, {\n\t\t\t\t\trid: this.rid,\n\t\t\t\t\ttmid: this.tmid,\n\t\t\t\t\tmessageBox: instance.firstNode,\n\t\t\t\t\tprid: this.subscription.prid,\n\t\t\t\t\tevent,\n\t\t\t\t});\n\t\t\t});\n\t},\n\t'click .js-format'(event, instance) {\n\t\tevent.preventDefault();\n\t\tevent.stopPropagation();\n\n\t\tconst { id } = event.currentTarget.dataset;\n\t\tconst { pattern } = formattingButtons.filter(({ condition }) => !condition || condition()).find(({ label }) => label === id) || {};\n\n\t\tif (!pattern) {\n\t\t\treturn;\n\t\t}\n\n\t\tapplyFormatting(pattern, instance.input);\n\t},\n});\n"]},"sourceType":"module","hash":"feac80fc52074b7900907c80b6b6bc1734ee43f4"}
