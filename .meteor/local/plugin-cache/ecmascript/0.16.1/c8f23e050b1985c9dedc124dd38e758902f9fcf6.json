{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/views/admin/import/ImportProgressPage.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"client/views/admin/import/ImportProgressPage.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/views/admin/import/ImportProgressPage.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/client/views/admin/import/ImportProgressPage.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/views/admin/import/ImportProgressPage.js"}},"code":"let Box, Margins, Throbber;\nmodule.link(\"@rocket.chat/fuselage\", {\n  Box(v) {\n    Box = v;\n  },\n\n  Margins(v) {\n    Margins = v;\n  },\n\n  Throbber(v) {\n    Throbber = v;\n  }\n\n}, 0);\nlet useSafely;\nmodule.link(\"@rocket.chat/fuselage-hooks\", {\n  useSafely(v) {\n    useSafely = v;\n  }\n\n}, 1);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 2);\nlet React, useEffect, useState, useMemo;\nmodule.link(\"react\", {\n  default(v) {\n    React = v;\n  },\n\n  useEffect(v) {\n    useEffect = v;\n  },\n\n  useState(v) {\n    useState = v;\n  },\n\n  useMemo(v) {\n    useMemo = v;\n  }\n\n}, 3);\nlet s;\nmodule.link(\"underscore.string\", {\n  default(v) {\n    s = v;\n  }\n\n}, 4);\nlet ProgressStep, ImportingStartedStates;\nmodule.link(\"../../../../app/importer/lib/ImporterProgressStep\", {\n  ProgressStep(v) {\n    ProgressStep = v;\n  },\n\n  ImportingStartedStates(v) {\n    ImportingStartedStates = v;\n  }\n\n}, 5);\nlet Page;\nmodule.link(\"../../../components/Page\", {\n  default(v) {\n    Page = v;\n  }\n\n}, 6);\nlet useRoute;\nmodule.link(\"../../../contexts/RouterContext\", {\n  useRoute(v) {\n    useRoute = v;\n  }\n\n}, 7);\nlet useEndpoint;\nmodule.link(\"../../../contexts/ServerContext\", {\n  useEndpoint(v) {\n    useEndpoint = v;\n  }\n\n}, 8);\nlet useToastMessageDispatch;\nmodule.link(\"../../../contexts/ToastMessagesContext\", {\n  useToastMessageDispatch(v) {\n    useToastMessageDispatch = v;\n  }\n\n}, 9);\nlet useTranslation;\nmodule.link(\"../../../contexts/TranslationContext\", {\n  useTranslation(v) {\n    useTranslation = v;\n  }\n\n}, 10);\nlet useErrorHandler;\nmodule.link(\"./useErrorHandler\", {\n  useErrorHandler(v) {\n    useErrorHandler = v;\n  }\n\n}, 11);\n\nfunction ImportProgressPage() {\n  const t = useTranslation();\n  const dispatchToastMessage = useToastMessageDispatch();\n  const handleError = useErrorHandler();\n  const [importerKey, setImporterKey] = useSafely(useState(null));\n  const [step, setStep] = useSafely(useState('Loading...'));\n  const [completed, setCompleted] = useSafely(useState(0));\n  const [total, setTotal] = useSafely(useState(0));\n  const getCurrentImportOperation = useEndpoint('GET', 'getCurrentImportOperation');\n  const getImportProgress = useEndpoint('GET', 'getImportProgress');\n  const importHistoryRoute = useRoute('admin-import');\n  const prepareImportRoute = useRoute('admin-import-prepare');\n  useEffect(() => {\n    const loadCurrentOperation = async () => {\n      try {\n        const {\n          operation\n        } = await getCurrentImportOperation();\n\n        if (!operation.valid) {\n          importHistoryRoute.push();\n          return;\n        }\n\n        if (!ImportingStartedStates.includes(operation.status)) {\n          prepareImportRoute.push();\n          return;\n        }\n\n        setImporterKey(operation.importerKey);\n        setCompleted(operation.count.completed);\n        setTotal(operation.count.total);\n      } catch (error) {\n        handleError(error, t('Failed_To_Load_Import_Data'));\n        importHistoryRoute.push();\n      }\n    };\n\n    loadCurrentOperation();\n  }, [getCurrentImportOperation, handleError, importHistoryRoute, prepareImportRoute, setCompleted, setImporterKey, setTotal, t]);\n  useEffect(() => {\n    if (!importerKey) {\n      return;\n    }\n\n    const handleProgressUpdated = _ref => {\n      let {\n        key,\n        step,\n        count: {\n          completed = 0,\n          total = 0\n        } = {}\n      } = _ref;\n\n      if (key.toLowerCase() !== importerKey) {\n        return;\n      }\n\n      switch (step) {\n        case ProgressStep.DONE:\n          dispatchToastMessage({\n            type: 'success',\n            message: t(step[0].toUpperCase() + step.slice(1))\n          });\n          importHistoryRoute.push();\n          return;\n\n        case ProgressStep.ERROR:\n        case ProgressStep.CANCELLED:\n          handleError(t(step[0].toUpperCase() + step.slice(1)));\n          importHistoryRoute.push();\n          return;\n\n        default:\n          setStep(step);\n          setCompleted(completed);\n          setTotal(total);\n          break;\n      }\n    };\n\n    const streamer = new Meteor.Streamer('importers');\n\n    const loadImportProgress = async () => {\n      try {\n        const progress = await getImportProgress();\n\n        if (!progress) {\n          dispatchToastMessage({\n            type: 'warning',\n            message: t('Importer_not_in_progress')\n          });\n          prepareImportRoute.push();\n          return;\n        }\n\n        streamer.on('progress', handleProgressUpdated);\n        handleProgressUpdated(progress);\n      } catch (error) {\n        handleError(error, t('Failed_To_Load_Import_Data'));\n        importHistoryRoute.push();\n      }\n    };\n\n    loadImportProgress();\n    return () => {\n      streamer.removeListener('progress', handleProgressUpdated);\n    };\n  }, [dispatchToastMessage, getImportProgress, handleError, importHistoryRoute, importerKey, prepareImportRoute, setCompleted, setStep, setTotal, t]);\n  const progressRate = useMemo(() => {\n    if (total === 0) {\n      return null;\n    }\n\n    return completed / total * 100;\n  }, [completed, total]);\n  return /*#__PURE__*/React.createElement(Page, null, /*#__PURE__*/React.createElement(Page.Header, {\n    title: t('Importing_Data')\n  }), /*#__PURE__*/React.createElement(Page.ScrollableContentWithShadow, null, /*#__PURE__*/React.createElement(Box, {\n    marginInline: \"auto\",\n    marginBlock: \"neg-x24\",\n    width: \"full\",\n    maxWidth: \"x580\"\n  }, /*#__PURE__*/React.createElement(Margins, {\n    block: \"x24\"\n  }, /*#__PURE__*/React.createElement(Box, {\n    is: \"p\",\n    fontScale: \"p2\"\n  }, t(step[0].toUpperCase() + step.slice(1))), progressRate ? /*#__PURE__*/React.createElement(Box, {\n    display: \"flex\",\n    justifyContent: \"center\"\n  }, /*#__PURE__*/React.createElement(Box, {\n    is: \"progress\",\n    value: completed,\n    max: total,\n    marginInlineEnd: \"x24\"\n  }), /*#__PURE__*/React.createElement(Box, {\n    is: \"span\",\n    fontScale: \"p2\"\n  }, completed, \"/\", total, \" (\", s.numberFormat(progressRate, 0), \"%)\")) : /*#__PURE__*/React.createElement(Throbber, {\n    justifyContent: \"center\"\n  })))));\n}\n\nmodule.exportDefault(ImportProgressPage);","map":{"version":3,"sources":["client/views/admin/import/ImportProgressPage.js"],"names":["Box","Margins","Throbber","module","link","v","useSafely","Meteor","React","useEffect","useState","useMemo","default","s","ProgressStep","ImportingStartedStates","Page","useRoute","useEndpoint","useToastMessageDispatch","useTranslation","useErrorHandler","ImportProgressPage","t","dispatchToastMessage","handleError","importerKey","setImporterKey","step","setStep","completed","setCompleted","total","setTotal","getCurrentImportOperation","getImportProgress","importHistoryRoute","prepareImportRoute","loadCurrentOperation","operation","valid","push","includes","status","count","error","handleProgressUpdated","key","toLowerCase","DONE","type","message","toUpperCase","slice","ERROR","CANCELLED","streamer","Streamer","loadImportProgress","progress","on","removeListener","progressRate","numberFormat","exportDefault"],"mappings":"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","sourcesContent":["import { Box, Margins, Throbber } from '@rocket.chat/fuselage';\nimport { useSafely } from '@rocket.chat/fuselage-hooks';\nimport { Meteor } from 'meteor/meteor';\nimport React, { useEffect, useState, useMemo } from 'react';\nimport s from 'underscore.string';\n\nimport { ProgressStep, ImportingStartedStates } from '../../../../app/importer/lib/ImporterProgressStep';\nimport Page from '../../../components/Page';\nimport { useRoute } from '../../../contexts/RouterContext';\nimport { useEndpoint } from '../../../contexts/ServerContext';\nimport { useToastMessageDispatch } from '../../../contexts/ToastMessagesContext';\nimport { useTranslation } from '../../../contexts/TranslationContext';\nimport { useErrorHandler } from './useErrorHandler';\n\nfunction ImportProgressPage() {\n\tconst t = useTranslation();\n\tconst dispatchToastMessage = useToastMessageDispatch();\n\tconst handleError = useErrorHandler();\n\n\tconst [importerKey, setImporterKey] = useSafely(useState(null));\n\tconst [step, setStep] = useSafely(useState('Loading...'));\n\tconst [completed, setCompleted] = useSafely(useState(0));\n\tconst [total, setTotal] = useSafely(useState(0));\n\n\tconst getCurrentImportOperation = useEndpoint('GET', 'getCurrentImportOperation');\n\tconst getImportProgress = useEndpoint('GET', 'getImportProgress');\n\n\tconst importHistoryRoute = useRoute('admin-import');\n\tconst prepareImportRoute = useRoute('admin-import-prepare');\n\n\tuseEffect(() => {\n\t\tconst loadCurrentOperation = async () => {\n\t\t\ttry {\n\t\t\t\tconst { operation } = await getCurrentImportOperation();\n\n\t\t\t\tif (!operation.valid) {\n\t\t\t\t\timportHistoryRoute.push();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (!ImportingStartedStates.includes(operation.status)) {\n\t\t\t\t\tprepareImportRoute.push();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tsetImporterKey(operation.importerKey);\n\t\t\t\tsetCompleted(operation.count.completed);\n\t\t\t\tsetTotal(operation.count.total);\n\t\t\t} catch (error) {\n\t\t\t\thandleError(error, t('Failed_To_Load_Import_Data'));\n\t\t\t\timportHistoryRoute.push();\n\t\t\t}\n\t\t};\n\n\t\tloadCurrentOperation();\n\t}, [getCurrentImportOperation, handleError, importHistoryRoute, prepareImportRoute, setCompleted, setImporterKey, setTotal, t]);\n\n\tuseEffect(() => {\n\t\tif (!importerKey) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst handleProgressUpdated = ({ key, step, count: { completed = 0, total = 0 } = {} }) => {\n\t\t\tif (key.toLowerCase() !== importerKey) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tswitch (step) {\n\t\t\t\tcase ProgressStep.DONE:\n\t\t\t\t\tdispatchToastMessage({\n\t\t\t\t\t\ttype: 'success',\n\t\t\t\t\t\tmessage: t(step[0].toUpperCase() + step.slice(1)),\n\t\t\t\t\t});\n\t\t\t\t\timportHistoryRoute.push();\n\t\t\t\t\treturn;\n\n\t\t\t\tcase ProgressStep.ERROR:\n\t\t\t\tcase ProgressStep.CANCELLED:\n\t\t\t\t\thandleError(t(step[0].toUpperCase() + step.slice(1)));\n\t\t\t\t\timportHistoryRoute.push();\n\t\t\t\t\treturn;\n\n\t\t\t\tdefault:\n\t\t\t\t\tsetStep(step);\n\t\t\t\t\tsetCompleted(completed);\n\t\t\t\t\tsetTotal(total);\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t};\n\n\t\tconst streamer = new Meteor.Streamer('importers');\n\n\t\tconst loadImportProgress = async () => {\n\t\t\ttry {\n\t\t\t\tconst progress = await getImportProgress();\n\n\t\t\t\tif (!progress) {\n\t\t\t\t\tdispatchToastMessage({ type: 'warning', message: t('Importer_not_in_progress') });\n\t\t\t\t\tprepareImportRoute.push();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tstreamer.on('progress', handleProgressUpdated);\n\t\t\t\thandleProgressUpdated(progress);\n\t\t\t} catch (error) {\n\t\t\t\thandleError(error, t('Failed_To_Load_Import_Data'));\n\t\t\t\timportHistoryRoute.push();\n\t\t\t}\n\t\t};\n\n\t\tloadImportProgress();\n\n\t\treturn () => {\n\t\t\tstreamer.removeListener('progress', handleProgressUpdated);\n\t\t};\n\t}, [\n\t\tdispatchToastMessage,\n\t\tgetImportProgress,\n\t\thandleError,\n\t\timportHistoryRoute,\n\t\timporterKey,\n\t\tprepareImportRoute,\n\t\tsetCompleted,\n\t\tsetStep,\n\t\tsetTotal,\n\t\tt,\n\t]);\n\n\tconst progressRate = useMemo(() => {\n\t\tif (total === 0) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn (completed / total) * 100;\n\t}, [completed, total]);\n\n\treturn (\n\t\t<Page>\n\t\t\t<Page.Header title={t('Importing_Data')} />\n\n\t\t\t<Page.ScrollableContentWithShadow>\n\t\t\t\t<Box marginInline='auto' marginBlock='neg-x24' width='full' maxWidth='x580'>\n\t\t\t\t\t<Margins block='x24'>\n\t\t\t\t\t\t<Box is='p' fontScale='p2'>\n\t\t\t\t\t\t\t{t(step[0].toUpperCase() + step.slice(1))}\n\t\t\t\t\t\t</Box>\n\t\t\t\t\t\t{progressRate ? (\n\t\t\t\t\t\t\t<Box display='flex' justifyContent='center'>\n\t\t\t\t\t\t\t\t<Box is='progress' value={completed} max={total} marginInlineEnd='x24' />\n\t\t\t\t\t\t\t\t<Box is='span' fontScale='p2'>\n\t\t\t\t\t\t\t\t\t{completed}/{total} ({s.numberFormat(progressRate, 0)}%)\n\t\t\t\t\t\t\t\t</Box>\n\t\t\t\t\t\t\t</Box>\n\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t<Throbber justifyContent='center' />\n\t\t\t\t\t\t)}\n\t\t\t\t\t</Margins>\n\t\t\t\t</Box>\n\t\t\t</Page.ScrollableContentWithShadow>\n\t\t</Page>\n\t);\n}\n\nexport default ImportProgressPage;\n"]},"sourceType":"module","hash":"c8f23e050b1985c9dedc124dd38e758902f9fcf6"}
