{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui-message/client/messageBox/messageBoxAudioMessage.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"app/ui-message/client/messageBox/messageBoxAudioMessage.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui-message/client/messageBox/messageBoxAudioMessage.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{}},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui-message/client/messageBox/messageBoxAudioMessage.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/ui-message/client/messageBox/messageBoxAudioMessage.js"}},"code":"var _regeneratorRuntime;\n\nmodule.link(\"@babel/runtime/regenerator\", {\n  default: function (v) {\n    _regeneratorRuntime = v;\n  }\n}, 0);\nvar ReactiveVar;\nmodule.link(\"meteor/reactive-var\", {\n  ReactiveVar: function (v) {\n    ReactiveVar = v;\n  }\n}, 0);\nvar Template;\nmodule.link(\"meteor/templating\", {\n  Template: function (v) {\n    Template = v;\n  }\n}, 1);\nvar settings;\nmodule.link(\"../../../settings\", {\n  settings: function (v) {\n    settings = v;\n  }\n}, 2);\nvar AudioRecorder, fileUpload, USER_ACTIVITIES, UserAction;\nmodule.link(\"../../../ui\", {\n  AudioRecorder: function (v) {\n    AudioRecorder = v;\n  },\n  fileUpload: function (v) {\n    fileUpload = v;\n  },\n  USER_ACTIVITIES: function (v) {\n    USER_ACTIVITIES = v;\n  },\n  UserAction: function (v) {\n    UserAction = v;\n  }\n}, 3);\nvar t;\nmodule.link(\"../../../utils\", {\n  t: function (v) {\n    t = v;\n  }\n}, 4);\nmodule.link(\"./messageBoxAudioMessage.html\");\n\nvar startRecording = function () {\n  function _callee(rid, tmid) {\n    return _regeneratorRuntime.async(function () {\n      function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              _context.prev = 0;\n              _context.next = 3;\n              return _regeneratorRuntime.awrap(AudioRecorder.start());\n\n            case 3:\n              UserAction.performContinuously(rid, USER_ACTIVITIES.USER_RECORDING, {\n                tmid: tmid\n              });\n              _context.next = 9;\n              break;\n\n            case 6:\n              _context.prev = 6;\n              _context.t0 = _context[\"catch\"](0);\n              throw _context.t0;\n\n            case 9:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }\n\n      return _callee$;\n    }(), null, null, [[0, 6]], Promise);\n  }\n\n  return _callee;\n}();\n\nvar stopRecording = function () {\n  function _callee2(rid, tmid) {\n    var result;\n    return _regeneratorRuntime.async(function () {\n      function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              _context2.next = 2;\n              return _regeneratorRuntime.awrap(new Promise(function (resolve) {\n                return AudioRecorder.stop(resolve);\n              }));\n\n            case 2:\n              result = _context2.sent;\n              UserAction.stop(rid, USER_ACTIVITIES.USER_RECORDING, {\n                tmid: tmid\n              });\n              return _context2.abrupt(\"return\", result);\n\n            case 5:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }\n\n      return _callee2$;\n    }(), null, null, null, Promise);\n  }\n\n  return _callee2;\n}();\n\nvar recordingInterval = new ReactiveVar(null);\nvar recordingRoomId = new ReactiveVar(null);\n\nvar clearIntervalVariables = function () {\n  if (recordingInterval.get()) {\n    clearInterval(recordingInterval.get());\n    recordingInterval.set(null);\n    recordingRoomId.set(null);\n  }\n};\n\nvar cancelRecording = function () {\n  function _callee3(instance, rid, tmid) {\n    var blob;\n    return _regeneratorRuntime.async(function () {\n      function _callee3$(_context3) {\n        while (1) {\n          switch (_context3.prev = _context3.next) {\n            case 0:\n              clearIntervalVariables();\n              instance.time.set('00:00');\n              _context3.next = 4;\n              return _regeneratorRuntime.awrap(stopRecording(rid, tmid));\n\n            case 4:\n              blob = _context3.sent;\n              instance.state.set(null);\n              return _context3.abrupt(\"return\", blob);\n\n            case 7:\n            case \"end\":\n              return _context3.stop();\n          }\n        }\n      }\n\n      return _callee3$;\n    }(), null, null, null, Promise);\n  }\n\n  return _callee3;\n}();\n\nTemplate.messageBoxAudioMessage.onCreated(function () {\n  function _callee4() {\n    var _this = this;\n\n    var permissionStatus;\n    return _regeneratorRuntime.async(function () {\n      function _callee4$(_context4) {\n        while (1) {\n          switch (_context4.prev = _context4.next) {\n            case 0:\n              this.state = new ReactiveVar(null);\n              this.time = new ReactiveVar('00:00');\n              this.isMicrophoneDenied = new ReactiveVar(false);\n\n              if (!navigator.permissions) {\n                _context4.next = 16;\n                break;\n              }\n\n              _context4.prev = 4;\n              _context4.next = 7;\n              return _regeneratorRuntime.awrap(navigator.permissions.query({\n                name: 'microphone'\n              }));\n\n            case 7:\n              permissionStatus = _context4.sent;\n              this.isMicrophoneDenied.set(permissionStatus.state === 'denied');\n\n              permissionStatus.onchange = function () {\n                _this.isMicrophoneDenied.set(permissionStatus.state === 'denied');\n              };\n\n              return _context4.abrupt(\"return\");\n\n            case 13:\n              _context4.prev = 13;\n              _context4.t0 = _context4[\"catch\"](4);\n              console.warn(_context4.t0);\n\n            case 16:\n              if (!(!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices)) {\n                _context4.next = 19;\n                break;\n              }\n\n              this.isMicrophoneDenied.set(true);\n              return _context4.abrupt(\"return\");\n\n            case 19:\n              _context4.prev = 19;\n              _context4.next = 22;\n              return _regeneratorRuntime.awrap(navigator.mediaDevices.enumerateDevices());\n\n            case 22:\n              if (_context4.sent.some(function (_ref) {\n                var kind = _ref.kind;\n                return kind === 'audioinput';\n              })) {\n                _context4.next = 25;\n                break;\n              }\n\n              this.isMicrophoneDenied.set(true);\n              return _context4.abrupt(\"return\");\n\n            case 25:\n              _context4.next = 30;\n              break;\n\n            case 27:\n              _context4.prev = 27;\n              _context4.t1 = _context4[\"catch\"](19);\n              console.warn(_context4.t1);\n\n            case 30:\n            case \"end\":\n              return _context4.stop();\n          }\n        }\n      }\n\n      return _callee4$;\n    }(), null, this, [[4, 13], [19, 27]], Promise);\n  }\n\n  return _callee4;\n}());\nTemplate.messageBoxAudioMessage.onDestroyed(function () {\n  function _callee5() {\n    var _this$data, rid, tmid;\n\n    return _regeneratorRuntime.async(function () {\n      function _callee5$(_context5) {\n        while (1) {\n          switch (_context5.prev = _context5.next) {\n            case 0:\n              if (!(this.state.get() === 'recording')) {\n                _context5.next = 4;\n                break;\n              }\n\n              _this$data = this.data, rid = _this$data.rid, tmid = _this$data.tmid;\n              _context5.next = 4;\n              return _regeneratorRuntime.awrap(cancelRecording(this, rid, tmid));\n\n            case 4:\n            case \"end\":\n              return _context5.stop();\n          }\n        }\n      }\n\n      return _callee5$;\n    }(), null, this, null, Promise);\n  }\n\n  return _callee5;\n}());\nTemplate.messageBoxAudioMessage.helpers({\n  isAllowed: function () {\n    return AudioRecorder.isSupported() && !Template.instance().isMicrophoneDenied.get() && settings.get('FileUpload_Enabled') && settings.get('Message_AudioRecorderEnabled') && (!settings.get('FileUpload_MediaTypeBlackList') || !settings.get('FileUpload_MediaTypeBlackList').match(/audio\\/mp3|audio\\/\\*/i)) && (!settings.get('FileUpload_MediaTypeWhiteList') || settings.get('FileUpload_MediaTypeWhiteList').match(/audio\\/mp3|audio\\/\\*/i));\n  },\n  stateClass: function () {\n    if (recordingRoomId.get() && recordingRoomId.get() !== Template.currentData().rid) {\n      return 'rc-message-box__audio-message--busy';\n    }\n\n    var state = Template.instance().state.get();\n    return state && \"rc-message-box__audio-message--\" + state;\n  },\n  time: function () {\n    return Template.instance().time.get();\n  }\n});\nTemplate.messageBoxAudioMessage.events({\n  'click .js-audio-message-record': function () {\n    function _callee6(event, instance) {\n      var startTime;\n      return _regeneratorRuntime.async(function () {\n        function _callee6$(_context6) {\n          while (1) {\n            switch (_context6.prev = _context6.next) {\n              case 0:\n                event.preventDefault();\n\n                if (!(recordingRoomId.get() && recordingRoomId.get() !== this.rid)) {\n                  _context6.next = 3;\n                  break;\n                }\n\n                return _context6.abrupt(\"return\");\n\n              case 3:\n                instance.state.set('recording');\n                _context6.prev = 4;\n                _context6.next = 7;\n                return _regeneratorRuntime.awrap(startRecording(this.rid, this.tmid));\n\n              case 7:\n                startTime = new Date();\n                recordingInterval.set(setInterval(function () {\n                  var now = new Date();\n                  var distance = (now.getTime() - startTime.getTime()) / 1000;\n                  var minutes = Math.floor(distance / 60);\n                  var seconds = Math.floor(distance % 60);\n                  instance.time.set(String(minutes).padStart(2, '0') + \":\" + String(seconds).padStart(2, '0'));\n                }, 1000));\n                recordingRoomId.set(this.rid);\n                _context6.next = 17;\n                break;\n\n              case 12:\n                _context6.prev = 12;\n                _context6.t0 = _context6[\"catch\"](4);\n                console.log(_context6.t0);\n                instance.isMicrophoneDenied.set(true);\n                instance.state.set(null);\n\n              case 17:\n              case \"end\":\n                return _context6.stop();\n            }\n          }\n        }\n\n        return _callee6$;\n      }(), null, this, [[4, 12]], Promise);\n    }\n\n    return _callee6;\n  }(),\n  'click .js-audio-message-cancel': function () {\n    function _callee7(event, instance) {\n      return _regeneratorRuntime.async(function () {\n        function _callee7$(_context7) {\n          while (1) {\n            switch (_context7.prev = _context7.next) {\n              case 0:\n                event.preventDefault();\n                _context7.next = 3;\n                return _regeneratorRuntime.awrap(cancelRecording(instance, this.rid, this.tmid));\n\n              case 3:\n              case \"end\":\n                return _context7.stop();\n            }\n          }\n        }\n\n        return _callee7$;\n      }(), null, this, null, Promise);\n    }\n\n    return _callee7;\n  }(),\n  'click .js-audio-message-done': function () {\n    function _callee8(event, instance) {\n      var rid, tmid, blob;\n      return _regeneratorRuntime.async(function () {\n        function _callee8$(_context8) {\n          while (1) {\n            switch (_context8.prev = _context8.next) {\n              case 0:\n                event.preventDefault();\n                instance.state.set('loading');\n                rid = this.rid, tmid = this.tmid;\n                _context8.next = 5;\n                return _regeneratorRuntime.awrap(cancelRecording(instance, rid, tmid));\n\n              case 5:\n                blob = _context8.sent;\n                _context8.next = 8;\n                return _regeneratorRuntime.awrap(fileUpload([{\n                  file: blob,\n                  type: 'video',\n                  name: t('Audio record') + \".mp3\"\n                }], {\n                  input: blob\n                }, {\n                  rid: rid,\n                  tmid: tmid\n                }));\n\n              case 8:\n              case \"end\":\n                return _context8.stop();\n            }\n          }\n        }\n\n        return _callee8$;\n      }(), null, this, null, Promise);\n    }\n\n    return _callee8;\n  }()\n});","map":{"version":3,"sources":["app/ui-message/client/messageBox/messageBoxAudioMessage.js"],"names":["_regeneratorRuntime","module","link","default","v","ReactiveVar","Template","settings","AudioRecorder","fileUpload","USER_ACTIVITIES","UserAction","t","startRecording","rid","tmid","start","performContinuously","USER_RECORDING","stopRecording","Promise","resolve","stop","result","recordingInterval","recordingRoomId","clearIntervalVariables","get","clearInterval","set","cancelRecording","instance","time","blob","state","messageBoxAudioMessage","onCreated","isMicrophoneDenied","navigator","permissions","query","name","permissionStatus","onchange","console","warn","mediaDevices","enumerateDevices","some","kind","onDestroyed","data","helpers","isAllowed","isSupported","match","stateClass","currentData","events","event","preventDefault","startTime","Date","setInterval","now","distance","getTime","minutes","Math","floor","seconds","String","padStart","log","file","type","input"],"mappings":"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","sourcesContent":["import { ReactiveVar } from 'meteor/reactive-var';\nimport { Template } from 'meteor/templating';\n\nimport { settings } from '../../../settings';\nimport { AudioRecorder, fileUpload, USER_ACTIVITIES, UserAction } from '../../../ui';\nimport { t } from '../../../utils';\nimport './messageBoxAudioMessage.html';\n\nconst startRecording = async (rid, tmid) => {\n\ttry {\n\t\tawait AudioRecorder.start();\n\t\tUserAction.performContinuously(rid, USER_ACTIVITIES.USER_RECORDING, { tmid });\n\t} catch (error) {\n\t\tthrow error;\n\t}\n};\n\nconst stopRecording = async (rid, tmid) => {\n\tconst result = await new Promise((resolve) => AudioRecorder.stop(resolve));\n\tUserAction.stop(rid, USER_ACTIVITIES.USER_RECORDING, { tmid });\n\treturn result;\n};\n\nconst recordingInterval = new ReactiveVar(null);\nconst recordingRoomId = new ReactiveVar(null);\n\nconst clearIntervalVariables = () => {\n\tif (recordingInterval.get()) {\n\t\tclearInterval(recordingInterval.get());\n\t\trecordingInterval.set(null);\n\t\trecordingRoomId.set(null);\n\t}\n};\n\nconst cancelRecording = async (instance, rid, tmid) => {\n\tclearIntervalVariables();\n\n\tinstance.time.set('00:00');\n\n\tconst blob = await stopRecording(rid, tmid);\n\n\tinstance.state.set(null);\n\n\treturn blob;\n};\n\nTemplate.messageBoxAudioMessage.onCreated(async function () {\n\tthis.state = new ReactiveVar(null);\n\tthis.time = new ReactiveVar('00:00');\n\tthis.isMicrophoneDenied = new ReactiveVar(false);\n\n\tif (navigator.permissions) {\n\t\ttry {\n\t\t\tconst permissionStatus = await navigator.permissions.query({ name: 'microphone' });\n\t\t\tthis.isMicrophoneDenied.set(permissionStatus.state === 'denied');\n\t\t\tpermissionStatus.onchange = () => {\n\t\t\t\tthis.isMicrophoneDenied.set(permissionStatus.state === 'denied');\n\t\t\t};\n\t\t\treturn;\n\t\t} catch (error) {\n\t\t\tconsole.warn(error);\n\t\t}\n\t}\n\n\tif (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {\n\t\tthis.isMicrophoneDenied.set(true);\n\t\treturn;\n\t}\n\n\ttry {\n\t\tif (!(await navigator.mediaDevices.enumerateDevices()).some(({ kind }) => kind === 'audioinput')) {\n\t\t\tthis.isMicrophoneDenied.set(true);\n\t\t\treturn;\n\t\t}\n\t} catch (error) {\n\t\tconsole.warn(error);\n\t}\n});\n\nTemplate.messageBoxAudioMessage.onDestroyed(async function () {\n\tif (this.state.get() === 'recording') {\n\t\tconst { rid, tmid } = this.data;\n\t\tawait cancelRecording(this, rid, tmid);\n\t}\n});\n\nTemplate.messageBoxAudioMessage.helpers({\n\tisAllowed() {\n\t\treturn (\n\t\t\tAudioRecorder.isSupported() &&\n\t\t\t!Template.instance().isMicrophoneDenied.get() &&\n\t\t\tsettings.get('FileUpload_Enabled') &&\n\t\t\tsettings.get('Message_AudioRecorderEnabled') &&\n\t\t\t(!settings.get('FileUpload_MediaTypeBlackList') || !settings.get('FileUpload_MediaTypeBlackList').match(/audio\\/mp3|audio\\/\\*/i)) &&\n\t\t\t(!settings.get('FileUpload_MediaTypeWhiteList') || settings.get('FileUpload_MediaTypeWhiteList').match(/audio\\/mp3|audio\\/\\*/i))\n\t\t);\n\t},\n\n\tstateClass() {\n\t\tif (recordingRoomId.get() && recordingRoomId.get() !== Template.currentData().rid) {\n\t\t\treturn 'rc-message-box__audio-message--busy';\n\t\t}\n\n\t\tconst state = Template.instance().state.get();\n\t\treturn state && `rc-message-box__audio-message--${state}`;\n\t},\n\n\ttime() {\n\t\treturn Template.instance().time.get();\n\t},\n});\n\nTemplate.messageBoxAudioMessage.events({\n\tasync 'click .js-audio-message-record'(event, instance) {\n\t\tevent.preventDefault();\n\n\t\tif (recordingRoomId.get() && recordingRoomId.get() !== this.rid) {\n\t\t\treturn;\n\t\t}\n\n\t\tinstance.state.set('recording');\n\n\t\ttry {\n\t\t\tawait startRecording(this.rid, this.tmid);\n\t\t\tconst startTime = new Date();\n\t\t\trecordingInterval.set(\n\t\t\t\tsetInterval(() => {\n\t\t\t\t\tconst now = new Date();\n\t\t\t\t\tconst distance = (now.getTime() - startTime.getTime()) / 1000;\n\t\t\t\t\tconst minutes = Math.floor(distance / 60);\n\t\t\t\t\tconst seconds = Math.floor(distance % 60);\n\t\t\t\t\tinstance.time.set(`${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`);\n\t\t\t\t}, 1000),\n\t\t\t);\n\t\t\trecordingRoomId.set(this.rid);\n\t\t} catch (error) {\n\t\t\tconsole.log(error);\n\t\t\tinstance.isMicrophoneDenied.set(true);\n\t\t\tinstance.state.set(null);\n\t\t}\n\t},\n\n\tasync 'click .js-audio-message-cancel'(event, instance) {\n\t\tevent.preventDefault();\n\n\t\tawait cancelRecording(instance, this.rid, this.tmid);\n\t},\n\n\tasync 'click .js-audio-message-done'(event, instance) {\n\t\tevent.preventDefault();\n\n\t\tinstance.state.set('loading');\n\n\t\tconst { rid, tmid } = this;\n\t\tconst blob = await cancelRecording(instance, rid, tmid);\n\n\t\tawait fileUpload([{ file: blob, type: 'video', name: `${t('Audio record')}.mp3` }], { input: blob }, { rid, tmid });\n\t},\n});\n"]},"sourceType":"module","hash":"c4c549fb617ff43c2ba591eb5f8c8e00d411eeed"}
